---
import Layout from "./Layout.astro";
import BackToUtilities from "../components/ui/BackToUtilities.astro";
import RelatedUtilities from "../components/utilidades/RelatedUtilities.astro";
import AppLinksBanner from "../components/utilidades/AppLinksBanner.astro";
import UtilityStructuredData from "../components/utilidades/UtilityStructuredData.astro";
import FAQSection from "../components/utilidades/FAQSection.astro";
import WidgetCreator from "../components/utilidades/WidgetCreator.astro";
import { sections } from "../data/utilities";
import { getWidgetHtml } from "../utils/widget";

interface AppLinks {
    android?: string;
    ios?: string;
}

interface FAQItem {
    question: string;
    answer: string;
}

interface HowToStep {
    name: string;
    text: string;
    url?: string;
    image?: string;
}

interface Props {
    title: string;
    description: string;
    image?: string;
    category?: string;
    gradientFrom?: string;
    gradientTo?: string;
    appLinks?: AppLinks;
    appSlug?: string;
    faqItems?: FAQItem[];
    howToSteps?: HowToStep[];
    hideWidget?: boolean;
}

const {
    title,
    description,
    image,
    category: propCategory,
    gradientFrom = "from-slate-100",
    gradientTo = "to-white",
    appLinks,
    appSlug,
    faqItems,
    howToSteps,
    hideWidget = false,
} = Astro.props;

const currentPath = Astro.url.pathname;

const normalize = (path: string) => path.replace(/\/+$/, "");
const targetPath = normalize(currentPath);

let category = propCategory;
let sectionTheme;

if (!category) {
    const foundSection = sections.find((section) =>
        section.utilities.some((u) => normalize(u.href) === targetPath)
    );
    if (foundSection) {
        category = foundSection.title;
    }
}

const isWidget = Astro.url.searchParams.get("widget") === "true";
const hasBanner = !!(appSlug || appLinks?.android || appLinks?.ios);
---

<Layout title={title} description={description} image={image} fullWidth={true}>
    <UtilityStructuredData
        title={title}
        description={description}
        url={currentPath}
        category={category}
        faqItems={faqItems}
        howToSteps={howToSteps}
        slot="head"
    />
    <link
        rel="alternate"
        type="application/json+oembed"
        href={`${Astro.url.origin}/api/oembed.json?url=${encodeURIComponent(`${Astro.url.origin}${Astro.url.pathname}`)}`}
        title={title}
        slot="head"
    />
    <div class="relative min-h-screen overflow-x-clip utility-layout-wrapper">
        <div
            class={`absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] ${gradientFrom} via-white ${gradientTo} dark:from-slate-900/40 dark:via-zinc-950 dark:to-black -z-10`}
        >
        </div>

        {
            (appSlug || appLinks?.android || appLinks?.ios) && (
                <div class="sticky top-[60px] z-40 transition-all duration-300 w-full">
                    <AppLinksBanner
                        appSlug={appSlug}
                        android={appLinks?.android}
                        ios={appLinks?.ios}
                    />
                </div>
            )
        }

        <div
            class="max-w-6xl mx-auto px-4 sm:px-6 relative focus:outline-none pt-12 sm:pt-20 utility-main-wrapper"
        >
            <div class="text-center utility-header-area">
                <BackToUtilities class="mb-8" />
                <slot name="header">
                    <h1 class="text-5xl md:text-7xl font-black tracking-tighter mb-6">
                        {title}
                    </h1>
                    <p
                        class="text-xl text-slate-600 dark:text-slate-400 max-w-2xl mx-auto font-light"
                    >
                        {description}
                    </p>
                </slot>
            </div>

            <div class="mt-12 utility-tool-container">
                <slot />
            </div>

            {!hideWidget && <WidgetCreator title={title} url={currentPath} />}

            {
                faqItems && faqItems.length > 0 && (
                    <div class="no-widget-hidden">
                        <FAQSection items={faqItems} />
                    </div>
                )
            }

            <div
                class="prose prose-lg dark:prose-invert mx-auto mb-20 prose-headings:font-bold prose-a:text-indigo-600 dark:prose-a:text-indigo-400 no-widget-hidden"
            >
                <slot name="seo" />
            </div>

            <div class="max-w-4xl mx-auto mb-16 no-widget-hidden">
                <slot name="bibliography" />
            </div>

            <div class="no-widget-hidden">
                <RelatedUtilities category={category ?? ""} currentPath={currentPath} />
            </div>
        </div>
    </div>
</Layout>

<script is:inline define:vars={{ hasBanner }}>
    const isWidget = new URLSearchParams(window.location.search).get("widget") === "true";
    if (isWidget) {
        document.documentElement.classList.add("is-widget");
        document.body.classList.add("is-widget");

        const urlParams = new URLSearchParams(window.location.search);

        const theme = urlParams.get("theme");
        if (theme === "dark") {
            document.documentElement.classList.add("dark");
        } else if (theme === "light") {
            document.documentElement.classList.remove("dark");
        }

        const id =
            urlParams.get("id") ||
            `jjlmoya-widget-${window.location.pathname.split("/").filter(Boolean).pop() || "utility"}`;

        const report = () => {
            const container = document.querySelector(".utility-tool-container");
            const banner = document.querySelector(".sticky");

            let h = 0;
            if (container) {
                
                const rect = container.getBoundingClientRect();
                h = rect.height;

                
                if (hasBanner && banner) {
                    const bh = banner.getBoundingClientRect().height;
                    
                    if (bh > 10) h += bh;
                }
            } else {
                h = document.body.scrollHeight;
            }

            if (h > 50) {
                
                window.parent.postMessage({ jjlmoyaHeight: Math.round(h), jjlmoyaId: id }, "*");
            }
        };

        report();
        const itv = setInterval(report, 600);
        setTimeout(() => clearInterval(itv), 5000);
        window.addEventListener("load", report);

        const container = document.querySelector(".utility-tool-container");
        const obs = new ResizeObserver(report);
        if (container) {
            obs.observe(container);
        } else if (document.body) {
            obs.observe(document.body);
        }
    }
</script>

<style is:global>
    html.is-widget,
    body.is-widget,
    body.is-widget main,
    body.is-widget .relative.min-h-screen {
        background: transparent !important;
        background-color: transparent !important;
        background-image: none !important;
        min-height: auto !important;
    }

    body.is-widget div[class*="fixed"][class*="-z-10"],
    body.is-widget div[class*="bg-[radial-gradient"],
    body.is-widget div[class*="bg-[linear-gradient"] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }

    body.is-widget nav,
    body.is-widget footer:not(.utility-tool-container *),
    body.is-widget .no-widget-hidden,
    body.is-widget header,
    body.is-widget .utility-header-area,
    body.is-widget [slot="header"],
    body.is-widget .BackToUtilities,
    body.is-widget .prose {
        display: none !important;
    }

    
    body.is-widget .animate-in:not(.utility-tool-container *) {
        display: none !important;
    }

    
    body.is-widget .utility-tool-container .animate-in:not(.hidden) {
        opacity: 1 !important;
        visibility: visible !important;
        animation: none !important;
    }

    body.is-widget .pt-12,
    body.is-widget .pt-15,
    body.is-widget .sm\:pt-20,
    body.is-widget main {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    body.is-widget .utility-tool-container {
        margin-top: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }

    body.is-widget .utility-main-wrapper {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }

    body.is-widget .utility-layout-wrapper,
    body.is-widget .utility-layout-wrapper > div[class*="absolute"] {
        min-height: 0 !important;
        height: auto !important;
        display: none !important;
    }

    body.is-widget .utility-layout-wrapper {
        display: block !important;
    }

    
    body.is-widget .max-w-6xl,
    body.is-widget .max-w-5xl,
    body.is-widget .max-w-4xl,
    body.is-widget .max-w-3xl,
    body.is-widget .max-w-2xl {
        max-width: 100% !important;
        width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }

    body.is-widget .utility-tool-container button[class*="rounded-"],
    body.is-widget .utility-tool-container input[class*="rounded-"],
    body.is-widget .utility-tool-container div.active[class*="rounded-"] {
    }

    body.is-widget .sticky {
        position: relative !important;
        top: 0 !important;
    }
</style>
