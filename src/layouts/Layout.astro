---
import "../styles/global.css";
import SEO from "../components/SEO.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Toast from "../components/ui/Toast.astro";
import Search from "../components/search/Search.astro";

import "@fontsource/inter/300.css";
import "@fontsource/inter/400.css";
import "@fontsource/inter/600.css";
import "@fontsource/inter/900.css";
import "@fontsource/fredoka-one";

interface Props {
    title: string;
    description?: string;
    image?: string;
    bodyClass?: string;
    showBackground?: boolean;
    mainClass?: string;
    headerClass?: string;
    footerClass?: string;
    fullWidth?: boolean;
}

const {
    title,
    description,
    image,
    bodyClass = "",
    showBackground = true,
    fullWidth = false,
    headerClass = "",
    footerClass = "",
} = Astro.props;

const mainClass = Astro.props.mainClass || (fullWidth ? "pt-15" : "pt-15 px-4");
---

<!doctype html>
<html lang="es">
    <head>
        <SEO title={title} description={description} image={image} />

        <script>
            import { handleGlobalShare } from "../utils/share";

            document.addEventListener("DOMContentLoaded", () => {
                document.removeEventListener("click", handleGlobalShare);
                document.addEventListener("click", handleGlobalShare);
            });

            (function registerFootprint() {
                if (navigator.userAgent.includes("vercel")) {
                    return;
                }

                const STORAGE_KEY = "jjlmoya_footprint_v5";
                const APPS_SCRIPT_URL =
                    "https://script.google.com/macros/s/AKfycbwCYuz1UvpKD60u8L9B6WIewL8tEHdPP4pTnXN5GcNAXd3XPh4bvJw0n86mLEBMrRE3Yg/exec";

                const SYNC_THRESHOLDS = [1, 10, 25, 50, 100, 250, 500, 1000, 2500, 5000, 10000];

                let storedData: any = {};
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (raw) storedData = JSON.parse(raw);
                } catch (e) {
                    console.error("Error parsing footprint data", e);
                }

                const visits = (storedData.visits || 0) + 1;

                const shouldSync = SYNC_THRESHOLDS.includes(visits);

                function generateColor(str: string) {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        hash = str.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    const h = Math.abs(hash % 360);
                    const s = 65 + (Math.abs(hash) % 20);
                    const l = 55 + (Math.abs(hash) % 15);
                    return `hsl(${h}, ${s}%, ${l}%)`;
                }

                const baseData = {
                    ua: navigator.userAgent,
                    screen: `${window.screen.width}x${window.screen.height}`,
                    lang: navigator.language,
                    path: window.location.pathname,
                    id:
                        storedData.id ||
                        `SR-${Math.random().toString(36).substring(7).toUpperCase()}`,
                    color:
                        storedData.color ||
                        generateColor(
                            navigator.userAgent + window.screen.width + Date.now() + Math.random()
                        ),
                    visits: visits,
                    lastVisit: new Date().toISOString(),
                };

                localStorage.setItem(
                    STORAGE_KEY,
                    JSON.stringify({
                        ...storedData,
                        ...baseData,
                        registered: true,
                    })
                );

                if (shouldSync) {
                    console.log(`ðŸ‘£ Sincronizando huella digital (Visita #${visits})...`);

                    fetch(APPS_SCRIPT_URL, {
                        method: "POST",
                        mode: "no-cors",
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify(baseData),
                    })
                        .then(() => {
                            console.log("ðŸ‘£ Datos sincronizados con el Archivo Central.");
                        })
                        .catch(() => {});
                } else {
                    console.log(
                        `ðŸ‘£ Visita registrada localmente (#${visits}). SincronizaciÃ³n pendiente.`
                    );
                }
            })();
        </script>
    </head>
    <body
        class={`min-h-screen flex flex-col antialiased text-slate-900 bg-slate-50 transition-colors duration-300 ${bodyClass}`}
    >
        {
            showBackground && (
                <>
                    <div class="fixed inset-0 -z-10 h-full w-full bg-[linear-gradient(to_right,#8080800a_1px,transparent_1px),linear-gradient(to_bottom,#8080800a_1px,transparent_1px)] bg-[size:14px_24px]" />
                    <div class="fixed inset-0 -z-10 h-full w-full bg-[radial-gradient(circle_800px_at_100%_200px,rgba(29,78,216,0.15),transparent)]" />
                </>
            )
        }

        <Header className={headerClass} />

        <main class={`flex-grow ${mainClass}`}>
            <slot />
        </main>

        <Toast />
        <Footer className={footerClass} />
        <Search />
    </body>
</html>
