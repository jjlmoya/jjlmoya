---
import { Icon } from "astro-icon/components";
---

<div class="w-full max-w-4xl mx-auto p-4 font-sans text-slate-900 dark:text-slate-100">
    <div
        class="bg-white dark:bg-slate-900 rounded-3xl p-8 shadow-xl border border-slate-200 dark:border-slate-800"
    >
        
        <div class="flex items-center gap-4 mb-8">
            <div
                class="p-3 bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 rounded-2xl"
            >
                <Icon name="mdi:sine-wave" class="w-8 h-8" />
            </div>
            <div>
                <h2 class="text-3xl font-black tracking-tight">Generador de Tonos</h2>
                <p class="text-slate-500 text-sm">Crea frecuencias puras para test de audio.</p>
            </div>
        </div>

        
        <div
            class="relative w-full h-48 bg-black rounded-2xl overflow-hidden mb-8 shadow-inner border border-slate-900"
        >
            <canvas id="osc-canvas" class="w-full h-full"></canvas>
            <div
                class="absolute top-4 right-4 text-xs font-mono text-rose-500 animate-pulse"
                id="hz-display"
            >
                440 Hz
            </div>
        </div>

        
        <div class="space-y-8">
            
            <div class="space-y-2">
                <div class="flex justify-between items-end">
                    <label class="font-bold text-sm uppercase tracking-wider text-slate-500"
                        >Frecuencia</label
                    >
                    <div class="flex items-center gap-2">
                        <button
                            class="freq-preset px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs hover:bg-slate-200 transition-colors"
                            data-val="60">60Hz</button
                        >
                        <button
                            class="freq-preset px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs hover:bg-slate-200 transition-colors"
                            data-val="440">440Hz</button
                        >
                        <button
                            class="freq-preset px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs hover:bg-slate-200 transition-colors"
                            data-val="1000">1kHz</button
                        >
                    </div>
                </div>
                
                <input
                    type="range"
                    id="freq-slider"
                    min="20"
                    max="20000"
                    value="440"
                    step="1"
                    class="w-full h-4 bg-slate-200 dark:bg-slate-700 rounded-full appearance-none cursor-pointer accent-rose-500 hover:accent-rose-400 transition-all"
                />
                <div class="flex justify-between text-[10px] text-slate-400 font-mono">
                    <span>20Hz (Subgrave)</span>
                    <span>20kHz (Ultrasonido)</span>
                </div>
            </div>

            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <div class="space-y-2">
                    <label class="font-bold text-sm uppercase tracking-wider text-slate-500"
                        >Forma de Onda</label
                    >
                    <div class="grid grid-cols-4 gap-2">
                        <button
                            class="type-btn p-3 rounded-xl bg-rose-500 text-white shadow-lg shadow-rose-500/30 ring-2 ring-rose-500 transition-all"
                            data-type="sine"
                            title="Sinusoidal"
                        >
                            <Icon name="mdi:sine-wave" class="w-6 h-6 mx-auto" />
                        </button>
                        <button
                            class="type-btn p-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200 transition-all"
                            data-type="square"
                            title="Cuadrada"
                        >
                            <Icon name="mdi:square-wave" class="w-6 h-6 mx-auto" />
                        </button>
                        <button
                            class="type-btn p-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200 transition-all"
                            data-type="sawtooth"
                            title="Diente de Sierra"
                        >
                            <Icon name="mdi:sawtooth-wave" class="w-6 h-6 mx-auto" />
                        </button>
                        <button
                            class="type-btn p-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200 transition-all"
                            data-type="triangle"
                            title="Triangular"
                        >
                            <Icon name="mdi:triangle-wave" class="w-6 h-6 mx-auto" />
                        </button>
                    </div>
                </div>

                
                <div class="space-y-2">
                    <label class="font-bold text-sm uppercase tracking-wider text-slate-500"
                        >Volumen</label
                    >
                    <div
                        class="flex items-center gap-4 bg-slate-100 dark:bg-slate-800/50 p-3 rounded-xl"
                    >
                        <Icon name="mdi:volume-high" class="w-5 h-5 text-slate-400" />
                        <input
                            type="range"
                            id="vol-slider"
                            min="0"
                            max="1"
                            value="0.5"
                            step="0.01"
                            class="w-full h-2 bg-slate-300 dark:bg-slate-600 rounded-full appearance-none cursor-pointer accent-slate-500"
                        />
                    </div>
                </div>
            </div>

            
            <button
                id="toggle-btn"
                class="w-full py-6 rounded-2xl bg-rose-600 hover:bg-rose-500 text-white font-black text-xl shadow-xl shadow-rose-600/20 active:scale-[0.98] transition-all flex items-center justify-center gap-3"
            >
                <Icon name="mdi:play" class="w-8 h-8" id="play-icon" />
                <Icon name="mdi:stop" class="w-8 h-8 hidden" id="stop-icon" />
                <span id="btn-text">REPRODUCIR TONO</span>
            </button>
        </div>
    </div>
</div>

<script>
    
    let audioCtx: AudioContext | null = null;
    let oscillator: OscillatorNode | null = null;
    let gainNode: GainNode | null = null;
    let analyser: AnalyserNode | null = null;
    let isPlaying = false;
    let waveform: OscillatorType = "sine";

    
    const canvas = document.getElementById("osc-canvas") as HTMLCanvasElement;
    const canvasCtx = canvas?.getContext("2d");

    
    const els = {
        freq: document.getElementById("freq-slider") as HTMLInputElement,
        vol: document.getElementById("vol-slider") as HTMLInputElement,
        btn: document.getElementById("toggle-btn"),
        playIcon: document.getElementById("play-icon"),
        stopIcon: document.getElementById("stop-icon"),
        btnText: document.getElementById("btn-text"),
        hzDisplay: document.getElementById("hz-display"),
        typeBtns: document.querySelectorAll(".type-btn"),
        presets: document.querySelectorAll(".freq-preset"),
    };

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
        }
    }

    function toggle() {
        initAudio();
        if (audioCtx?.state === "suspended") audioCtx.resume();

        if (isPlaying) {
            stop();
        } else {
            start();
        }
    }

    function start() {
        if (!audioCtx || !analyser) return;

        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();

        oscillator.type = waveform;
        oscillator.frequency.value = parseInt(els.freq.value);
        gainNode.gain.value = parseFloat(els.vol.value);

        oscillator.connect(gainNode);
        gainNode.connect(analyser); 
        analyser.connect(audioCtx.destination); 

        oscillator.start();
        isPlaying = true;
        updateUI(true);
        drawVisualizer();
    }

    function stop() {
        if (oscillator) {
            oscillator.stop();
            oscillator.disconnect();
            oscillator = null;
        }
        isPlaying = false;
        updateUI(false);
    }

    function updateParams() {
        if (oscillator) oscillator.frequency.value = parseInt(els.freq.value);
        if (gainNode) gainNode.gain.value = parseFloat(els.vol.value);
        if (oscillator) oscillator.type = waveform;

        if (els.hzDisplay) els.hzDisplay.textContent = `${els.freq.value} Hz`;
    }

    function updateUI(playing: boolean) {
        if (playing) {
            els.playIcon?.classList.add("hidden");
            els.stopIcon?.classList.remove("hidden");
            if (els.btnText) els.btnText.textContent = "DETENER";
            els.btn?.classList.remove("bg-rose-600", "hover:bg-rose-500", "shadow-rose-600/20");
            els.btn?.classList.add("bg-slate-800", "hover:bg-slate-700", "shadow-slate-800/20");
        } else {
            els.playIcon?.classList.remove("hidden");
            els.stopIcon?.classList.add("hidden");
            if (els.btnText) els.btnText.textContent = "REPRODUCIR TONO";
            els.btn?.classList.add("bg-rose-600", "hover:bg-rose-500", "shadow-rose-600/20");
            els.btn?.classList.remove("bg-slate-800", "hover:bg-slate-700", "shadow-slate-800/20");
        }
    }

    
    function drawVisualizer() {
        if (!isPlaying || !analyser || !canvasCtx) return;

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteTimeDomainData(dataArray);

        
        const rect = (canvas.parentNode as HTMLElement)?.getBoundingClientRect();
        if (rect && (canvas.width !== rect.width || canvas.height !== rect.height)) {
            canvas.width = rect.width;
            canvas.height = rect.height;
        }

        const width = canvas.width;
        const height = canvas.height;

        canvasCtx.fillStyle = "rgb(0, 0, 0)";
        canvasCtx.fillRect(0, 0, width, height);
        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = "rgb(244, 63, 94)"; 
        canvasCtx.beginPath();

        const sliceWidth = (width * 1.0) / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
            const v = dataArray[i] / 128.0;
            const y = (v * height) / 2;

            if (i === 0) canvasCtx.moveTo(x, y);
            else canvasCtx.lineTo(x, y);

            x += sliceWidth;
        }

        canvasCtx.lineTo(canvas.width, canvas.height / 2);
        canvasCtx.stroke();

        requestAnimationFrame(drawVisualizer);
    }

    
    els.btn?.addEventListener("click", toggle);

    els.freq.addEventListener("input", updateParams);
    els.vol.addEventListener("input", updateParams);

    els.typeBtns.forEach((btn) => {
        btn.addEventListener("click", (e) => {
            const t = (e.currentTarget as HTMLElement).getAttribute("data-type");
            if (t) {
                waveform = t as OscillatorType;
                updateParams();

                
                els.typeBtns.forEach((b) => {
                    b.classList.remove("bg-rose-500", "text-white", "shadow-lg", "ring-2");
                    b.classList.add("bg-slate-100", "dark:bg-slate-800", "text-slate-500");
                });
                (e.currentTarget as HTMLElement).classList.add(
                    "bg-rose-500",
                    "text-white",
                    "shadow-lg",
                    "ring-2"
                );
                (e.currentTarget as HTMLElement).classList.remove(
                    "bg-slate-100",
                    "dark:bg-slate-800",
                    "text-slate-500"
                );
            }
        });
    });

    els.presets.forEach((p) => {
        p.addEventListener("click", (e) => {
            const val = (e.target as HTMLElement).getAttribute("data-val");
            if (val) {
                els.freq.value = val;
                updateParams();
            }
        });
    });
</script>
