---
import { Icon } from "astro-icon/components";
---

<div
    id="final-card"
    class="bg-slate-900 rounded-[2.5rem] p-8 md:p-12 text-white min-h-[500px] relative overflow-hidden shadow-2xl transition-all duration-700 border-4 border-slate-800 flex flex-col items-center justify-center text-center"
>
    <div
        class="absolute inset-0 bg-gradient-to-br from-slate-800 to-slate-950 -z-10"
        id="result-bg"
    >
    </div>

    <div
        id="empty-state"
        class="flex flex-col items-center space-y-6 transition-opacity duration-300"
    >
        <div
            class="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center text-slate-600"
        >
            <Icon name="mdi:timer-sand" class="w-10 h-10" />
        </div>
        <div class="space-y-2">
            <h3 class="text-2xl font-bold text-slate-400">Todo listo</h3>
            <p class="text-slate-500">Selecciona envase y nevera para calcular.</p>
        </div>
    </div>

    <div
        id="result-state"
        class="hidden flex-col items-center opacity-0 transition-opacity duration-500 w-full"
    >
        <div class="relative mb-8">
            <div class="absolute -inset-8 bg-blue-500/20 rounded-full blur-2xl animate-pulse"></div>
            <span
                id="result-time"
                class="relative text-9xl font-black text-white tracking-tighter tabular-nums drop-shadow-2xl"
                >--</span
            >
            <span class="absolute -right-6 bottom-4 text-2xl font-bold text-slate-500">min</span>
        </div>

        <div class="space-y-2 mb-12">
            <p class="text-sm font-bold uppercase tracking-widest text-blue-400">Hora estimada</p>
            <p id="finish-time" class="text-3xl font-bold text-white">--:--</p>
        </div>

        <div class="grid grid-cols-2 gap-4 w-full text-left">
            <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                <div class="text-xs text-slate-400 uppercase font-bold mb-1">Método</div>
                <div class="text-white font-bold" id="res-method">-</div>
            </div>
            <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                <div class="text-xs text-slate-400 uppercase font-bold mb-1">Envase</div>
                <div class="text-white font-bold" id="res-container">-</div>
            </div>
        </div>
    </div>

    <div class="absolute inset-0 overflow-hidden pointer-events-none -z-10">
        <div class="absolute inset-0 bg-[url('/images/noise.png')] opacity-5 mix-blend-overlay">
        </div>
        <div id="bubbles-container"></div>
    </div>
</div>

<style>
    /* Bubbles Animation */
    :global(.bubble) {
        position: absolute;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
</style>

<script>
    import {
        calculateCoolingTime,
        getFinishTime,
        LABELS,
        type CoolingState,
    } from "../logic/cooling";

    const els = {
        emptyState: document.getElementById("empty-state") as HTMLElement,
        resultState: document.getElementById("result-state") as HTMLElement,
        resultTime: document.getElementById("result-time") as HTMLElement,
        finishTime: document.getElementById("finish-time") as HTMLElement,
        resContainer: document.getElementById("res-container") as HTMLElement,
        resMethod: document.getElementById("res-method") as HTMLElement,
        resultBg: document.getElementById("result-bg") as HTMLElement,
        bubblesContainer: document.getElementById("bubbles-container") as HTMLElement,
    };

    function updateVisuals(minutes: number, state: CoolingState) {
        if (!state.container || !state.location) {
            if (els.emptyState) els.emptyState.classList.remove("hidden");
            if (els.resultState) {
                els.resultState.classList.add("hidden");
                els.resultState.classList.remove("flex");
            }
            return;
        }

        if (els.emptyState) els.emptyState.classList.add("hidden");
        if (els.resultState) {
            els.resultState.classList.remove("hidden");
            els.resultState.classList.add("flex");
            setTimeout(() => els.resultState.classList.remove("opacity-0"), 10);
        }

        if (els.resContainer) els.resContainer.innerText = LABELS[state.container];
        if (els.resMethod) els.resMethod.innerText = LABELS[state.location];

        if (minutes === 0) {
            if (els.resultTime) {
                els.resultTime.innerText = "0";
                els.resultTime.classList.add("text-emerald-400");
            }
            if (els.finishTime) els.finishTime.innerText = "¡Ya está fría!";
        } else if (minutes > 300) {
            if (els.resultTime) {
                els.resultTime.innerText = "∞";
                els.resultTime.classList.add("text-red-400");
            }
            if (els.finishTime) els.finishTime.innerText = "Nunca llegará";
        } else {
            if (els.resultTime) {
                els.resultTime.innerText = minutes.toString();
                els.resultTime.classList.remove("text-emerald-400", "text-red-400");
                els.resultTime.classList.add("text-white");
            }
            if (els.finishTime) els.finishTime.innerText = getFinishTime(minutes);
        }

        if (els.resultBg) {
            if (minutes < 30) {
                els.resultBg.className =
                    "absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-emerald-900/50 to-slate-950 transition-colors duration-1000 -z-10";
            } else if (minutes < 60) {
                els.resultBg.className =
                    "absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-cyan-900/50 to-slate-950 transition-colors duration-1000 -z-10";
            } else {
                els.resultBg.className =
                    "absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/50 to-slate-950 transition-colors duration-1000 -z-10";
            }
        }
    }

    document.addEventListener("beer-calculator-change", (e) => {
        const state = (e as CustomEvent).detail as CoolingState;
        const minutes = calculateCoolingTime(state);
        updateVisuals(minutes, state);
    });

    function createBubbles() {
        const container = els.bubblesContainer;
        if (!container) return;

        for (let i = 0; i < 20; i++) {
            const b = document.createElement("div");
            b.classList.add("bubble");
            const size = Math.random() * 6 + 2;
            b.style.width = `${size}px`;
            b.style.height = `${size}px`;
            b.style.left = `${Math.random() * 100}%`;
            b.style.animation = `rise ${Math.random() * 5 + 3}s infinite ease-in ${Math.random() * 5}s`;
            container.appendChild(b);
        }

        if (!document.getElementById("bubble-style")) {
            const style = document.createElement("style");
            style.id = "bubble-style";
            style.innerHTML = `
                @keyframes rise {
                    0% { transform: translateY(100vh) scale(0); opacity: 0; }
                    50% { opacity: 0.5; }
                    100% { transform: translateY(-100px) scale(1); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    createBubbles();
</script>
