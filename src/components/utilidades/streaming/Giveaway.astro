---
import { Icon } from "astro-icon/components";
---

<div
    id="main-grid"
    class="w-full max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 xl:grid-cols-12 gap-6 font-sans"
>
    
    <div
        id="sidebar-panel"
        class="xl:col-span-4 flex flex-col gap-4 h-[800px] transition-all duration-500"
    >
        
        <div
            class="bg-white dark:bg-slate-900 rounded-3xl p-6 shadow-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-4 relative overflow-hidden group flex-shrink-0"
        >
            <div
                class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
            >
                <Icon name="mdi:account-group" class="w-24 h-24 text-indigo-500" />
            </div>
            <div>
                <h2
                    class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400"
                >
                    Total Participantes Únicos
                </h2>
                <div class="flex items-baseline gap-2 mt-1">
                    <span
                        id="count-display"
                        class="text-5xl font-black text-slate-800 dark:text-white tracking-tighter"
                        >0</span
                    >
                    <span
                        class="text-sm font-medium text-emerald-500 bg-emerald-100 dark:bg-emerald-900/30 px-2 py-0.5 rounded-full hidden"
                        id="ready-badge">LISTO</span
                    >
                </div>
            </div>
        </div>

        
        <div
            class="flex-1 bg-white dark:bg-slate-900 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden relative"
        >
            
            <div class="flex border-b border-slate-100 dark:border-slate-800 relative z-20">
                <button
                    id="tab-participants-btn"
                    class="flex-1 py-4 text-sm font-bold text-center border-b-2 border-indigo-500 text-indigo-600 dark:text-indigo-400 bg-slate-50 dark:bg-slate-800/50 transition-colors cursor-pointer outline-none focus:bg-slate-100 dark:focus:bg-slate-800"
                    type="button"
                >
                    Participantes
                </button>
                <button
                    id="tab-settings-btn"
                    class="flex-1 py-4 text-sm font-medium text-center border-b-2 border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors cursor-pointer outline-none focus:bg-slate-100 dark:focus:bg-slate-800"
                    type="button"
                >
                    Configuración
                </button>
            </div>

            
            <div id="tab-participants-view" class="flex-1 flex flex-col min-h-0">
                <div
                    class="p-2 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center gap-2"
                >
                    <label
                        class="cursor-pointer px-3 py-1.5 rounded-lg text-xs font-bold bg-indigo-50 hover:bg-indigo-100 dark:bg-indigo-900/30 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 transition-colors flex items-center gap-2"
                    >
                        <Icon name="mdi:file-upload-outline" class="w-4 h-4" />
                        Importar Archivo
                        <input
                            type="file"
                            id="file-import"
                            accept=".txt,.csv,.json"
                            class="hidden"
                        />
                    </label>

                    <button
                        id="clear-btn"
                        class="text-slate-400 hover:text-red-500 transition-colors p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20"
                        title="Borrar todo"
                    >
                        <Icon name="mdi:trash-can-outline" class="w-4 h-4" />
                    </button>
                </div>

                <div class="relative flex-1 group min-h-0">
                    <textarea
                        id="participants-input"
                        class="w-full h-full p-4 bg-transparent border-0 focus:ring-0 resize-none font-mono text-xs md:text-sm leading-relaxed text-slate-600 dark:text-slate-300 placeholder:text-slate-300 dark:placeholder:text-slate-700 outline-none"
                        placeholder="Escribe o pega los nombres aquí...
Juan Pérez
Maria García
@usuario_twitch"
                        spellcheck="false"></textarea>
                    <div
                        class="absolute bottom-0 left-0 w-full h-8 bg-gradient-to-t from-white dark:from-slate-900 to-transparent pointer-events-none"
                    >
                    </div>
                </div>

                <div
                    class="p-2 bg-slate-50 dark:bg-slate-950/30 border-t border-slate-100 dark:border-slate-800 text-[10px] text-slate-400 flex justify-between items-center"
                >
                    <span>1 participante por línea</span>
                    <span id="line-count">0 líneas</span>
                </div>
            </div>

            
            <div
                id="tab-settings-view"
                class="hidden flex-1 flex-col min-h-0 p-6 overflow-y-auto custom-scrollbar"
            >
                
                <div class="mb-8">
                    <h3
                        class="text-xs font-bold uppercase text-slate-400 mb-4 flex items-center gap-2"
                    >
                        <Icon name="mdi:filter-variant" /> Filtros
                    </h3>

                    <div class="space-y-4">
                        <label
                            class="flex items-center justify-between cursor-pointer group p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-800"
                        >
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300"
                                >Permitir Duplicados</span
                            >
                            <div class="relative">
                                <input type="checkbox" id="opt-duplicates" class="peer sr-only" />
                                <div
                                    class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"
                                >
                                </div>
                            </div>
                        </label>

                        <label
                            class="flex items-center justify-between cursor-pointer group p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-800"
                        >
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300"
                                >Número de Ganadores</span
                            >
                            <input
                                type="number"
                                id="opt-winner-count"
                                min="1"
                                max="50"
                                value="1"
                                class="w-16 text-center bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg py-1 text-sm font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none"
                            />
                        </label>

                        <label
                            class="flex items-center justify-between cursor-pointer group p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-800"
                        >
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300"
                                >Auto-Eliminar Ganador</span
                            >
                            <div class="relative">
                                <input type="checkbox" id="opt-auto-remove" class="peer sr-only" />
                                <div
                                    class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-red-500"
                                >
                                </div>
                            </div>
                        </label>

                        <div>
                            <span
                                class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 block"
                                >Lista Negra (Excluir)</span
                            >
                            <textarea
                                id="blacklist-input"
                                class="w-full h-32 p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 text-xs font-mono text-slate-600 dark:text-slate-400 focus:ring-2 focus:ring-indigo-500 outline-none resize-none"
                                placeholder="Nombres prohibidos (uno por línea)..."></textarea>
                            <p class="text-[10px] text-slate-400 mt-1">
                                Estos usuarios no entrarán en el sorteo.
                            </p>
                        </div>
                    </div>
                </div>

                
                <div>
                    <h3
                        class="text-xs font-bold uppercase text-slate-400 mb-4 flex items-center gap-2"
                    >
                        <Icon name="mdi:auto-fix" /> Efectos de Escena
                    </h3>

                    <div class="space-y-3">
                        <label
                            class="flex items-center justify-between cursor-pointer group p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-800"
                        >
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300"
                                >Cuenta Atrás (3s)</span
                            >
                            <div class="relative">
                                <input
                                    type="checkbox"
                                    id="opt-countdown"
                                    class="peer sr-only"
                                    checked
                                />
                                <div
                                    class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"
                                >
                                </div>
                            </div>
                        </label>

                        <label
                            class="flex items-center justify-between cursor-pointer group p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-800"
                        >
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300"
                                >Confeti de Victoria</span
                            >
                            <div class="relative">
                                <input
                                    type="checkbox"
                                    id="opt-confetti"
                                    class="peer sr-only"
                                    checked
                                />
                                <div
                                    class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"
                                >
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    
    <div
        id="stage-panel"
        class="xl:col-span-8 h-[600px] xl:h-[800px] relative group/stage transition-all duration-500 ease-in-out"
    >
        
        <button
            id="zen-toggle"
            class="absolute top-6 left-6 z-50 p-2 rounded-full text-slate-400 bg-white/5 dark:bg-black/20 hover:bg-white dark:hover:bg-black/50 hover:text-indigo-500 backdrop-blur-md transition-all duration-300 opacity-0 group-hover/stage:opacity-100 focus:opacity-100"
            title="Modo Cine (Ocultar Panel)"
        >
            <svg
                id="icon-zen-open"
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><rect width="18" height="18" x="3" y="3" rx="2"></rect><path d="M9 3v18"
                ></path></svg
            >
            <svg
                id="icon-zen-close"
                class="hidden"
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><path d="M15 3h6v18h-6"></path><path d="M10 9l-3 3 3 3"></path></svg
            >
        </button>

        <div
            class="absolute inset-0 bg-slate-900 rounded-[2rem] shadow-2xl overflow-hidden border-4 border-slate-800 ring-1 ring-white/10 flex flex-col"
        >
            
            <div class="absolute top-0 right-0 p-6 z-10 flex gap-2">
                <div
                    id="ready-badge"
                    class="hidden bg-emerald-500/10 border border-emerald-500/20 backdrop-blur-md text-emerald-400 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider shadow-[0_0_15px_rgba(16,185,129,0.2)] animate-pulse"
                >
                    Ready
                </div>
            </div>

            
            <div class="h-12 bg-slate-950 flex items-center px-6 gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-green-500/50"></div>
                <div class="ml-auto text-xs font-mono text-slate-600 uppercase tracking-widest">
                    LIVE STUDIO v2.0
                </div>
            </div>

            
            <div
                class="flex-1 relative bg-gradient-to-br from-slate-900 via-[#0f1021] to-black flex items-center justify-center perspective-1000 overflow-hidden"
            >
                
                <div
                    class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:4rem_4rem] [mask-image:radial-gradient(ellipse_at_center,black_40%,transparent_80%)]"
                >
                </div>

                
                <div
                    class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[500px] bg-indigo-600/20 blur-[120px] rounded-full pointer-events-none mix-blend-screen"
                >
                </div>

                
                <div class="relative z-10 w-full max-w-4xl text-center px-4">
                    
                    <div
                        id="state-empty"
                        class="transition-all duration-500 opacity-100 transform translate-y-0"
                    >
                        <div
                            class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-slate-800/50 border border-slate-700/50 mb-6 animate-pulse"
                        >
                            <Icon name="mdi:ticket-outline" class="w-10 h-10 text-slate-500" />
                        </div>
                        <h2 class="text-3xl font-bold text-slate-700 dark:text-slate-600">
                            Esperando participantes...
                        </h2>
                    </div>

                    
                    <div
                        id="state-countdown"
                        class="hidden absolute inset-0 flex items-center justify-center z-50 pointer-events-none"
                    >
                        <div
                            class="text-[15rem] font-black text-white/10 scale-150 blur-sm select-none"
                            id="countdown-number"
                        >
                            3
                        </div>
                    </div>

                    
                    <div id="state-active" class="hidden transform transition-all duration-300">
                        <div
                            class="mb-8 font-mono text-indigo-400 text-sm tracking-[0.5em] uppercase opacity-70"
                        >
                            GANADOR
                        </div>

                        
                        <div class="relative py-12">
                            
                            <div
                                class="absolute top-0 left-0 w-full h-full hidden"
                                id="winner-glitch"
                            >
                            </div>

                            <h1
                                id="main-display"
                                class="text-6xl md:text-8xl lg:text-9xl font-black text-white tracking-tight drop-shadow-[0_0_50px_rgba(79,70,229,0.5)] select-all leading-tight break-words max-w-full"
                            >
                                ???
                            </h1>
                        </div>

                        
                        <div
                            id="multi-results"
                            class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full h-full overflow-y-auto max-h-[400px] p-4 custom-scrollbar"
                        >
                        </div>

                        
                        <div
                            id="winner-actions"
                            class="hidden mt-12 flex justify-center gap-4 animate-fade-in-up"
                        >
                            <button
                                id="btn-reroll"
                                class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-full font-bold text-sm transition-colors border border-slate-700"
                            >
                                Repetir Sorteo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            
            <div
                class="h-24 bg-slate-900 border-t border-slate-800 flex items-center justify-center px-8 relative z-20"
            >
                <button id="trigger-btn" class="group relative w-full max-w-md" disabled>
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-xl blur opacity-25 group-hover:opacity-75 transition-opacity duration-500 group-disabled:opacity-0"
                    >
                    </div>
                    <div
                        class="relative h-14 bg-white dark:bg-slate-950 rounded-xl border border-slate-200 dark:border-slate-800 flex items-center justify-center gap-3 overflow-hidden group-active:scale-[0.98] transition-transform"
                    >
                        
                        <span
                            class="font-black text-xl tracking-wide bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 group-disabled:text-slate-600 group-disabled:from-transparent group-disabled:to-transparent transition-all uppercase"
                        >
                            Iniciar Sorteo
                        </span>
                        <Icon
                            name="mdi:arrow-right"
                            class="w-6 h-6 text-purple-500 group-disabled:text-slate-600 transition-colors"
                        />

                        
                        <div
                            class="absolute top-0 -left-full w-1/2 h-full bg-white/20 -skew-x-12 group-hover:animate-shine"
                        >
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>


<div class="max-w-7xl mx-auto px-6 mt-12 font-sans">
    <div class="border-t border-slate-200 dark:border-slate-800 pt-8">
        <h3
            class="text-lg font-bold text-slate-900 dark:text-slate-200 mb-6 flex items-center gap-2"
        >
            <Icon name="mdi:history" class="w-5 h-5 opacity-50" />
            Historial de esta sesión
        </h3>
        <div id="history-list" class="flex flex-wrap gap-3">
            <span class="text-sm text-slate-500 italic">Aún no hay ganadores...</span>
        </div>
    </div>
</div>

<script>
    import { GiveawayEngine } from "../../../lib/utilidades/streaming/GiveawayEngine";

    const engine = new GiveawayEngine();

    const els = {
        input: document.getElementById("participants-input") as HTMLTextAreaElement,
        blacklistInput: document.getElementById("blacklist-input") as HTMLTextAreaElement,
        countDisplay: document.getElementById("count-display"),
        lineCount: document.getElementById("line-count"),
        readyBadge: document.getElementById("ready-badge"),
        triggerBtn: document.getElementById("trigger-btn") as HTMLButtonElement,
        clearBtn: document.getElementById("clear-btn"),
        fileImport: document.getElementById("file-import") as HTMLInputElement,

        tabParticipantsBtn: document.getElementById("tab-participants-btn"),
        tabSettingsBtn: document.getElementById("tab-settings-btn"),
        tabParticipantsView: document.getElementById("tab-participants-view"),
        tabSettingsView: document.getElementById("tab-settings-view"),

        stateEmpty: document.getElementById("state-empty"),
        stateActive: document.getElementById("state-active"),
        stateCountdown: document.getElementById("state-countdown"),

        mainDisplay: document.getElementById("main-display"),
        countdownNumber: document.getElementById("countdown-number"),
        winnerActions: document.getElementById("winner-actions"),
        btnReroll: document.getElementById("btn-reroll"),
        historyList: document.getElementById("history-list"),

        optCountdown: document.getElementById("opt-countdown") as HTMLInputElement,
        optConfetti: document.getElementById("opt-confetti") as HTMLInputElement,

        optDuplicates: document.getElementById("opt-duplicates") as HTMLInputElement,
        optWinnerCount: document.getElementById("opt-winner-count") as HTMLInputElement,
        optAutoRemove: document.getElementById("opt-auto-remove") as HTMLInputElement,
        multiResults: document.getElementById("multi-results"),

        mainGrid: document.getElementById("main-grid"),
        sidebarPanel: document.getElementById("sidebar-panel"),
        stagePanel: document.getElementById("stage-panel"),
        zenToggle: document.getElementById("zen-toggle"),
    };

    let isRunning = false;
    let audioContext: AudioContext | null = null;
    let isZenMode = false;

    function toggleZenMode() {
        isZenMode = !isZenMode;
        if (isZenMode) {
            els.sidebarPanel?.classList.add("hidden");

            els.stagePanel?.classList.remove("xl:col-span-8");
            els.stagePanel?.classList.add("xl:col-span-12");

            document.getElementById("icon-zen-open")?.classList.add("hidden");
            document.getElementById("icon-zen-close")?.classList.remove("hidden");
        } else {
            els.sidebarPanel?.classList.remove("hidden");

            els.stagePanel?.classList.remove("xl:col-span-12");
            els.stagePanel?.classList.add("xl:col-span-8");

            document.getElementById("icon-zen-open")?.classList.remove("hidden");
            document.getElementById("icon-zen-close")?.classList.add("hidden");
        }
    }

    els.zenToggle?.addEventListener("click", toggleZenMode);

    function updateStats() {
        if (els.optDuplicates) engine.setAllowDuplicates(els.optDuplicates.checked);
        if (els.blacklistInput) engine.setBlacklistFromText(els.blacklistInput.value);
        if (els.input) engine.setParticipantsFromText(els.input.value);

        const count = engine.getCount();

        if (els.countDisplay) els.countDisplay.textContent = count.toString();
        if (els.lineCount && els.input)
            els.lineCount.textContent = `${els.input.value.split("\n").filter((l) => l.trim().length > 0).length} líneas`;

        const isValid = count > 1;

        if (els.readyBadge) {
            els.readyBadge.classList.toggle("hidden", !isValid);
        }

        if (els.triggerBtn) {
            els.triggerBtn.disabled = !isValid || isRunning;
        }

        if (count > 0) {
            if (els.stateEmpty) els.stateEmpty.classList.add("opacity-0", "translate-y-4");
        } else {
            if (els.stateEmpty) els.stateEmpty.classList.remove("opacity-0", "translate-y-4");
            if (els.stateActive) els.stateActive.classList.add("hidden");
        }
    }

    function switchTab(tab: "participants" | "settings") {
        if (!els.tabParticipantsView || !els.tabSettingsView) return;

        const activeClass = [
            "border-indigo-500",
            "text-indigo-600",
            "dark:text-indigo-400",
            "bg-slate-50",
            "dark:bg-slate-800/50",
        ];
        const inactiveClass = [
            "border-transparent",
            "text-slate-500",
            "hover:text-slate-700",
            "dark:text-slate-400",
        ];

        if (tab === "participants") {
            els.tabParticipantsView.classList.remove("hidden");
            els.tabParticipantsView.classList.add("flex");
            els.tabSettingsView.classList.add("hidden");
            els.tabSettingsView.classList.remove("flex");

            els.tabParticipantsBtn?.classList.add(...activeClass);
            els.tabParticipantsBtn?.classList.remove(...inactiveClass);
            els.tabSettingsBtn?.classList.remove(...activeClass);
            els.tabSettingsBtn?.classList.add(...inactiveClass);
        } else {
            els.tabSettingsView.classList.remove("hidden");
            els.tabSettingsView.classList.add("flex");
            els.tabParticipantsView.classList.add("hidden");
            els.tabParticipantsView.classList.remove("flex");

            els.tabSettingsBtn?.classList.add(...activeClass);
            els.tabSettingsBtn?.classList.remove(...inactiveClass);
            els.tabParticipantsBtn?.classList.remove(...activeClass);
            els.tabParticipantsBtn?.classList.add(...inactiveClass);
        }
    }

    function handleFileSelect(e: Event) {
        const file = (e.target as HTMLInputElement).files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            const text = event.target?.result as string;
            if (els.input) {
                const prefix = els.input.value.length > 0 ? "\n" : "";
                els.input.value += prefix + text;
                updateStats();
                switchTab("participants");
            }
        };
        reader.readAsText(file);

        (e.target as HTMLInputElement).value = "";
    }

    function playBeep(frequency = 440, duration = 0.1, type: OscillatorType = "sine") {
        if (!audioContext)
            audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(frequency, audioContext.currentTime);
        gain.gain.setValueAtTime(0.1, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.start();
        osc.stop(audioContext.currentTime + duration);
    }

    async function runCountdownSequence() {
        if (!els.stateCountdown || !els.countdownNumber) return;
        els.stateCountdown.classList.remove("hidden");
        for (let i = 3; i > 0; i--) {
            els.countdownNumber.textContent = i.toString();
            els.countdownNumber.classList.remove("animate-ping-slow");
            void els.countdownNumber.offsetWidth;
            els.countdownNumber.classList.add("animate-ping-slow");
            playBeep(600 + i * 100, 0.1, "square");
            await new Promise((r) => setTimeout(r, 1000));
        }
        els.stateCountdown.classList.add("hidden");
    }

    function triggerConfetti() {
        const colors = ["#6366f1", "#a855f7", "#ec4899", "#fbbf24", "#34d399"];
        const container = document.querySelector(".perspective-1000");
        if (!container) return;
        for (let i = 0; i < 100; i++) {
            const p = document.createElement("div");
            p.classList.add("absolute", "w-3", "h-3", "rounded-full", "z-50");
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            p.style.left = "50%";
            p.style.top = "50%";
            const angle = Math.random() * Math.PI * 2;
            const velocity = 150 + Math.random() * 400;
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;
            const rot = Math.random() * 360;
            p.style.transition = `transform 1.5s cubic-bezier(0.1, 1, 0.2, 1), opacity 1.5s ease-out`;
            p.style.opacity = "1";
            p.style.transform = `translate(0, 0) rotate(0deg) scale(0.5)`;
            container.appendChild(p);
            requestAnimationFrame(() => {
                p.getBoundingClientRect();
                p.style.transform = `translate(${tx}px, ${ty}px) rotate(${rot}deg) scale(1)`;
                p.style.opacity = "0";
            });
            setTimeout(() => {
                p.remove();
            }, 1500);
        }
    }

    function addToHistory(names: string | string[]) {
        if (els.historyList && els.historyList.querySelector("span.italic")) {
            els.historyList.innerHTML = "";
        }

        const list = Array.isArray(names) ? names : [names];

        list.forEach((name) => {
            const badge = document.createElement("div");
            badge.className =
                "animate-in fade-in zoom-in duration-300 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full px-4 py-1.5 text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2 shadow-sm";
            badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span>${name}`;
            els.historyList?.prepend(badge);
        });
    }

    async function startRoll() {
        if (isRunning) return;

        const participants = engine.getParticipants();
        if (participants.length < 1) return;

        const winnerCount = parseInt(els.optWinnerCount?.value || "1");
        if (winnerCount < 1) return;
        if (winnerCount > participants.length && !els.optDuplicates?.checked) {
            alert(
                `No hay suficientes participantes únicos (${participants.length}) para elegir ${winnerCount} ganadores.`
            );
            return;
        }

        isRunning = true;
        els.triggerBtn.disabled = true;

        if (els.stateEmpty) els.stateEmpty.classList.add("hidden");
        if (els.stateActive) els.stateActive.classList.add("hidden");
        if (els.winnerActions) els.winnerActions.classList.add("hidden");

        if (els.mainDisplay) {
            els.mainDisplay.textContent = "???";
            els.mainDisplay.classList.remove(
                "hidden",
                "text-emerald-400",
                "scale-110",
                "transition-transform",
                "duration-500"
            );
            els.mainDisplay.classList.add("text-white");
            els.mainDisplay.style.textShadow = "none";
        }

        if (els.multiResults) {
            els.multiResults.classList.add("hidden");
            els.multiResults.innerHTML = "";
        }

        if (els.optCountdown.checked) {
            await runCountdownSequence();
        }

        if (els.stateActive) els.stateActive.classList.remove("hidden");

        const totalDuration = 2500;
        const startTime = Date.now();
        const animate = () => {
            const now = Date.now();
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / totalDuration, 1);
            const ease = 1 - Math.pow(1 - progress, 3);

            if (progress < 1) {
                if (Math.random() > ease * 0.8) {
                    const rand = participants[Math.floor(Math.random() * participants.length)];
                    if (els.mainDisplay) els.mainDisplay.textContent = rand;
                    playBeep(200, 0.03, "sawtooth");
                }
                requestAnimationFrame(animate);
            } else {
                const winners = engine.pickWinners(winnerCount);

                if (winners.length === 1) {
                    if (els.mainDisplay) {
                        els.mainDisplay.textContent = winners[0];
                        els.mainDisplay.classList.add(
                            "scale-110",
                            "transition-transform",
                            "duration-500",
                            "text-emerald-400"
                        );
                        els.mainDisplay.style.textShadow =
                            "0 0 40px rgba(52,211,153,0.8), 0 0 80px rgba(52,211,153,0.4)";
                    }
                } else {
                    if (els.mainDisplay) els.mainDisplay.classList.add("hidden");
                    if (els.multiResults) {
                        els.multiResults.classList.remove("hidden");

                        els.multiResults.innerHTML = winners
                            .map(
                                (w, i) => `
                            <div class="animate-in zoom-in duration-500 delay-${i * 100} bg-slate-800/80 border border-slate-700/50 p-4 rounded-xl flex items-center justify-center relative overflow-hidden group">
                                <div class="absolute inset-0 bg-emerald-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <span class="text-xl md:text-2xl font-bold text-white break-all z-10">${w}</span>
                                <div class="absolute top-0 left-0 text-[10px] font-mono text-slate-500 p-1.5 leading-none">#${i + 1}</div>
                            </div>
                        `
                            )
                            .join("");
                    }
                }

                if (els.optConfetti.checked) triggerConfetti();
                playBeep(880, 0.4, "sine");

                addToHistory(winners);

                if (els.winnerActions) els.winnerActions.classList.remove("hidden");
                isRunning = false;
                els.triggerBtn.disabled = false;
            }
        };
        animate();
    }

    els.input.addEventListener("input", updateStats);
    els.blacklistInput?.addEventListener("input", updateStats);
    els.optDuplicates?.addEventListener("change", updateStats);
    els.fileImport?.addEventListener("change", handleFileSelect);

    els.tabParticipantsBtn?.addEventListener("click", () => switchTab("participants"));
    els.tabSettingsBtn?.addEventListener("click", () => switchTab("settings"));

    els.clearBtn?.addEventListener("click", () => {
        els.input.value = "";
        updateStats();
        if (els.mainDisplay) els.mainDisplay.textContent = "???";
        if (els.stateActive) els.stateActive.classList.add("hidden");
        if (els.stateEmpty) els.stateEmpty.classList.remove("hidden", "opacity-0", "translate-y-4");
    });

    els.triggerBtn.addEventListener("click", startRoll);
    els.btnReroll?.addEventListener("click", startRoll);

    updateStats();
</script>

<style>
    @keyframes shine {
        100% {
            left: 125%;
        }
    }
    .animate-shine {
        animation: shine 1s;
    }

    .animate-ping-slow {
        animation: ping-scale 0.5s cubic-bezier(0, 0, 0.2, 1) infinite;
    }

    @keyframes ping-scale {
        0% {
            transform: scale(1);
            opacity: 0.8;
        }
        50% {
            transform: scale(1.4);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 0.8;
        }
    }

    .perspective-1000 {
        perspective: 1000px;
    }

    /* Custom Scrollbar for textarea */
    textarea::-webkit-scrollbar {
        width: 8px;
    }
    textarea::-webkit-scrollbar-track {
        background: transparent;
    }
    textarea::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.3);
        border-radius: 4px;
    }
    textarea::-webkit-scrollbar-thumb:hover {
        background-color: rgba(156, 163, 175, 0.5);
    }
</style>
