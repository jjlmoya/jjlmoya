---
import { Icon } from "astro-icon/components";
---

<div class="w-full max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 xl:grid-cols-12 gap-6 font-sans">
    <!-- LEFT PANEL: CONFIGURATION & INPUT -->
    <div class="xl:col-span-4 flex flex-col gap-4 h-auto xl:h-[800px]">
        <!-- Stats Card -->
        <div
            class="bg-white dark:bg-slate-900 rounded-3xl p-6 shadow-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-4 relative overflow-hidden group"
        >
            <div
                class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
            >
                <Icon name="mdi:account-group" class="w-24 h-24 text-indigo-500" />
            </div>
            <div>
                <h2
                    class="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400"
                >
                    Total Participantes
                </h2>
                <div class="flex items-baseline gap-2 mt-1">
                    <span
                        id="count-display"
                        class="text-5xl font-black text-slate-800 dark:text-white tracking-tighter"
                        >0</span
                    >
                    <span
                        class="text-sm font-medium text-emerald-500 bg-emerald-100 dark:bg-emerald-900/30 px-2 py-0.5 rounded-full hidden"
                        id="ready-badge">LISTO</span
                    >
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div
            class="flex-1 bg-white dark:bg-slate-900 rounded-3xl shadow-xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden relative"
        >
            <div
                class="p-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center backdrop-blur-sm z-10"
            >
                <div class="flex gap-2">
                    <button
                        id="tab-input"
                        class="px-3 py-1.5 rounded-lg text-sm font-bold bg-white dark:bg-slate-800 shadow-sm text-slate-700 dark:text-slate-200 ring-1 ring-slate-200 dark:ring-slate-700"
                        >Lista</button
                    >
                    <button
                        class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 transition-colors"
                        disabled
                        title="Próximamente">Importar</button
                    >
                </div>
                <button
                    id="clear-btn"
                    class="text-slate-400 hover:text-red-500 transition-colors p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
                    title="Borrar todo"
                >
                    <Icon name="mdi:trash-can-outline" class="w-5 h-5" />
                </button>
            </div>

            <div class="relative flex-1 group">
                <textarea
                    id="participants-input"
                    class="w-full h-full p-4 bg-transparent border-0 focus:ring-0 resize-none font-mono text-sm leading-relaxed text-slate-600 dark:text-slate-300 placeholder:text-slate-300 dark:placeholder:text-slate-700 outline-none"
                    placeholder="Escribe o pega los nombres aquí...
Juan Pérez
Maria García
@usuario_twitch"
                    spellcheck="false"></textarea>
                <!-- Corner gradient for scrolling vibe -->
                <div
                    class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white dark:from-slate-900 to-transparent pointer-events-none"
                >
                </div>
            </div>

            <div
                class="p-3 bg-slate-50 dark:bg-slate-950/30 border-t border-slate-100 dark:border-slate-800 text-xs text-slate-400 flex justify-between items-center"
            >
                <span>1 nombre por línea</span>
                <span id="line-count">0 líneas</span>
            </div>
        </div>

        <!-- Options -->
        <div
            class="bg-white dark:bg-slate-900 rounded-3xl p-5 shadow-xl border border-slate-200 dark:border-slate-800 grid grid-cols-2 gap-4"
        >
            <label class="flex items-center gap-3 cursor-pointer group">
                <div class="relative">
                    <input type="checkbox" id="opt-countdown" class="peer sr-only" checked />
                    <div
                        class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"
                    >
                    </div>
                </div>
                <span
                    class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors"
                    >Cuenta atrás</span
                >
            </label>

            <label class="flex items-center gap-3 cursor-pointer group">
                <div class="relative">
                    <input type="checkbox" id="opt-confetti" class="peer sr-only" checked />
                    <div
                        class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"
                    >
                    </div>
                </div>
                <span
                    class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors"
                    >Confeti</span
                >
            </label>
        </div>
    </div>

    <!-- CENTER PANEL: STAGE -->
    <div class="xl:col-span-8 h-[600px] xl:h-[800px] relative">
        <div
            class="absolute inset-0 bg-slate-900 rounded-[2rem] shadow-2xl overflow-hidden border-4 border-slate-800 ring-1 ring-white/10 flex flex-col"
        >
            <!-- Window Controls Decoration -->
            <div class="h-12 bg-slate-950 flex items-center px-6 gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-green-500/50"></div>
                <div class="ml-auto text-xs font-mono text-slate-600 uppercase tracking-widest">
                    LIVE STUDIO v2.0
                </div>
            </div>

            <!-- Main Stage -->
            <div
                class="flex-1 relative bg-gradient-to-br from-slate-900 via-[#0f1021] to-black flex items-center justify-center perspective-1000 overflow-hidden"
            >
                <!-- Background Grid Animation -->
                <div
                    class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:4rem_4rem] [mask-image:radial-gradient(ellipse_at_center,black_40%,transparent_80%)]"
                >
                </div>

                <!-- Spotlight -->
                <div
                    class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[500px] bg-indigo-600/20 blur-[120px] rounded-full pointer-events-none mix-blend-screen"
                >
                </div>

                <!-- THE CONTENT -->
                <div class="relative z-10 w-full max-w-4xl text-center px-4">
                    <!-- Empty State -->
                    <div
                        id="state-empty"
                        class="transition-all duration-500 opacity-100 transform translate-y-0"
                    >
                        <div
                            class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-slate-800/50 border border-slate-700/50 mb-6 animate-pulse"
                        >
                            <Icon name="mdi:ticket-outline" class="w-10 h-10 text-slate-500" />
                        </div>
                        <h2 class="text-3xl font-bold text-slate-700 dark:text-slate-600">
                            Esperando participantes...
                        </h2>
                    </div>

                    <!-- Countdown Overlay -->
                    <div
                        id="state-countdown"
                        class="hidden absolute inset-0 flex items-center justify-center z-50 pointer-events-none"
                    >
                        <div
                            class="text-[15rem] font-black text-white/10 scale-150 blur-sm select-none"
                            id="countdown-number"
                        >
                            3
                        </div>
                    </div>

                    <!-- Rolling State / Winner State -->
                    <div id="state-active" class="hidden transform transition-all duration-300">
                        <div
                            class="mb-8 font-mono text-indigo-400 text-sm tracking-[0.5em] uppercase opacity-70"
                        >
                            GANADOR
                        </div>

                        <!-- The Name Container -->
                        <div class="relative py-12">
                            <!-- Glitch layers -->
                            <div
                                class="absolute top-0 left-0 w-full h-full hidden"
                                id="winner-glitch"
                            >
                            </div>

                            <h1
                                id="main-display"
                                class="text-6xl md:text-8xl lg:text-9xl font-black text-white tracking-tight drop-shadow-[0_0_50px_rgba(79,70,229,0.5)] select-all leading-tight break-words max-w-full"
                            >
                                ???
                            </h1>
                        </div>

                        <!-- Action Buttons (Reset/Reroll) -->
                        <div
                            id="winner-actions"
                            class="hidden mt-12 flex justify-center gap-4 animate-fade-in-up"
                        >
                            <button
                                id="btn-reroll"
                                class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-full font-bold text-sm transition-colors border border-slate-700"
                            >
                                Repetir Sorteo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Control Bar -->
            <div
                class="h-24 bg-slate-900 border-t border-slate-800 flex items-center justify-center px-8 relative z-20"
            >
                <button id="trigger-btn" class="group relative w-full max-w-md" disabled>
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-xl blur opacity-25 group-hover:opacity-75 transition-opacity duration-500 group-disabled:opacity-0"
                    >
                    </div>
                    <div
                        class="relative h-14 bg-white dark:bg-slate-950 rounded-xl border border-slate-200 dark:border-slate-800 flex items-center justify-center gap-3 overflow-hidden group-active:scale-[0.98] transition-transform"
                    >
                        <!-- Button Content -->
                        <span
                            class="font-black text-xl tracking-wide bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 group-disabled:text-slate-600 group-disabled:from-transparent group-disabled:to-transparent transition-all uppercase"
                        >
                            Iniciar Sorteo
                        </span>
                        <Icon
                            name="mdi:arrow-right"
                            class="w-6 h-6 text-purple-500 group-disabled:text-slate-600 transition-colors"
                        />

                        <!-- Shine Effect -->
                        <div
                            class="absolute top-0 -left-full w-1/2 h-full bg-white/20 -skew-x-12 group-hover:animate-shine"
                        >
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- History Log (Below Fold) -->
<div class="max-w-7xl mx-auto px-6 mt-12 font-sans">
    <div class="border-t border-slate-200 dark:border-slate-800 pt-8">
        <h3
            class="text-lg font-bold text-slate-900 dark:text-slate-200 mb-6 flex items-center gap-2"
        >
            <Icon name="mdi:history" class="w-5 h-5 opacity-50" />
            Historial de esta sesión
        </h3>
        <div id="history-list" class="flex flex-wrap gap-3">
            <span class="text-sm text-slate-500 italic">Aún no hay ganadores...</span>
        </div>
    </div>
</div>

<script>
    import { GiveawayEngine } from "../../../lib/utilidades/streaming/GiveawayEngine";

    // Initialize Engine
    const engine = new GiveawayEngine();

    // DOM Elements
    const els = {
        input: document.getElementById("participants-input") as HTMLTextAreaElement,
        countDisplay: document.getElementById("count-display"),
        lineCount: document.getElementById("line-count"),
        readyBadge: document.getElementById("ready-badge"),
        triggerBtn: document.getElementById("trigger-btn") as HTMLButtonElement,
        clearBtn: document.getElementById("clear-btn"),

        stateEmpty: document.getElementById("state-empty"),
        stateActive: document.getElementById("state-active"),
        stateCountdown: document.getElementById("state-countdown"),

        mainDisplay: document.getElementById("main-display"),
        countdownNumber: document.getElementById("countdown-number"),
        winnerActions: document.getElementById("winner-actions"),
        btnReroll: document.getElementById("btn-reroll"),
        historyList: document.getElementById("history-list"),

        optCountdown: document.getElementById("opt-countdown") as HTMLInputElement,
        optConfetti: document.getElementById("opt-confetti") as HTMLInputElement,
    };

    let isRunning = false;
    let audioContext: AudioContext | null = null;

    // --- LOGIC ---

    function updateStats() {
        const text = els.input.value;
        engine.setParticipantsFromText(text);
        const count = engine.getCount();

        // Update Count
        if (els.countDisplay) els.countDisplay.textContent = count.toString();
        if (els.lineCount) els.lineCount.textContent = `${text.split("\n").length} líneas`;

        // Update UI State based on validity
        const isValid = count > 1;

        if (els.readyBadge) {
            els.readyBadge.classList.toggle("hidden", !isValid);
        }

        if (els.triggerBtn) {
            els.triggerBtn.disabled = !isValid || isRunning;
        }

        // Toggle Empty State Visibility
        if (count > 0) {
            if (els.stateEmpty) els.stateEmpty.classList.add("opacity-0", "translate-y-4");
        } else {
            if (els.stateEmpty) els.stateEmpty.classList.remove("opacity-0", "translate-y-4");
            if (els.stateActive) els.stateActive.classList.add("hidden");
        }
    }

    function addToHistory(name: string) {
        // Remove default text if present
        if (els.historyList && els.historyList.querySelector("span.italic")) {
            els.historyList.innerHTML = "";
        }

        const badge = document.createElement("div");
        badge.className =
            "animate-in fade-in zoom-in duration-300 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full px-4 py-1.5 text-sm font-medium text-slate-700 dark:text-slate-300 flex items-center gap-2 shadow-sm";
        badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span>${name}`;

        els.historyList?.prepend(badge);
    }

    // --- ANIMATION & EFFECTS ---

    // Simple beep synthesizer
    function playBeep(frequency = 440, duration = 0.1, type: OscillatorType = "sine") {
        if (!audioContext)
            audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();

        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();

        osc.type = type;
        osc.frequency.setValueAtTime(frequency, audioContext.currentTime);

        gain.gain.setValueAtTime(0.1, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

        osc.connect(gain);
        gain.connect(audioContext.destination);

        osc.start();
        osc.stop(audioContext.currentTime + duration);
    }

    async function runCountdownSequence() {
        if (!els.stateCountdown || !els.countdownNumber) return;

        els.stateCountdown.classList.remove("hidden");

        for (let i = 3; i > 0; i--) {
            els.countdownNumber.textContent = i.toString();
            els.countdownNumber.classList.remove("animate-ping-slow");
            void els.countdownNumber.offsetWidth; // trigger reflow
            els.countdownNumber.classList.add("animate-ping-slow");
            playBeep(600 + i * 100, 0.1, "square");
            await new Promise((r) => setTimeout(r, 1000));
        }

        els.stateCountdown.classList.add("hidden");
    }

    function triggerConfetti() {
        const colors = ["#6366f1", "#a855f7", "#ec4899", "#fbbf24", "#34d399"];

        // Append to the main stage container for better visibility
        const container = document.querySelector(".perspective-1000");
        if (!container) return;

        for (let i = 0; i < 100; i++) {
            const p = document.createElement("div");
            p.classList.add("absolute", "w-3", "h-3", "rounded-full", "z-50");
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

            // Start from center
            p.style.left = "50%";
            p.style.top = "50%";

            // Random explosion trajectory
            const angle = Math.random() * Math.PI * 2;
            // Variable distance
            const velocity = 150 + Math.random() * 400;

            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;

            // Add some rotation
            const rot = Math.random() * 360;

            p.style.transition = `transform 1.5s cubic-bezier(0.1, 1, 0.2, 1), opacity 1.5s ease-out`;
            p.style.opacity = "1";
            p.style.transform = `translate(0, 0) rotate(0deg) scale(0.5)`;

            container.appendChild(p);

            // Animate
            requestAnimationFrame(() => {
                // Force reflow
                p.getBoundingClientRect();
                p.style.transform = `translate(${tx}px, ${ty}px) rotate(${rot}deg) scale(1)`;
                p.style.opacity = "0";
            });

            // Cleanup
            setTimeout(() => {
                p.remove();
            }, 1500);
        }
    }

    async function startRoll() {
        if (isRunning) return;

        const participants = engine.getParticipants();
        if (participants.length < 1) return;

        isRunning = true;
        els.triggerBtn.disabled = true;
        els.input.parentElement?.classList.add("opacity-50", "pointer-events-none");

        // Prepare Stage
        if (els.stateEmpty) els.stateEmpty.classList.add("hidden");
        // Hide active state briefly during countdown if we are re-rolling
        if (els.stateActive) els.stateActive.classList.add("hidden");
        if (els.winnerActions) els.winnerActions.classList.add("hidden");

        // Reset styles for rolling
        if (els.mainDisplay) {
            els.mainDisplay.textContent = "???"; // Reset text
            els.mainDisplay.classList.remove(
                "text-indigo-400",
                "scale-110",
                "transition-transform",
                "duration-500"
            );
            els.mainDisplay.classList.add("text-white");
            els.mainDisplay.style.textShadow = "none";
        }

        // Countdown
        if (els.optCountdown.checked) {
            await runCountdownSequence();
        }

        // Now show active state for rolling
        if (els.stateActive) els.stateActive.classList.remove("hidden");

        // The Rolling Animation (Digital Blur)
        const totalDuration = 2500; // ms
        const startTime = Date.now();
        let frameId;

        const animate = () => {
            const now = Date.now();
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / totalDuration, 1);

            // Ease out function for slowing down
            const ease = 1 - Math.pow(1 - progress, 3);

            if (progress < 1) {
                // Random name switching
                // Switch speed decreases as we get closer to end
                if (Math.random() > ease * 0.8) {
                    // update less frequently at start? No, update MORE frequently at start.
                    // Actually we want high frequency update always, just visual blur
                    const rand = participants[Math.floor(Math.random() * participants.length)];
                    if (els.mainDisplay) els.mainDisplay.textContent = rand;
                    playBeep(200, 0.03, "sawtooth"); // tick sound
                }

                frameId = requestAnimationFrame(animate);
            } else {
                // FINISH
                const winner = engine.pickWinner();
                if (els.mainDisplay && winner) {
                    els.mainDisplay.textContent = winner;
                    els.mainDisplay.classList.add(
                        "scale-110",
                        "transition-transform",
                        "duration-500"
                    );
                    // Add glow effect class/color change
                    els.mainDisplay.style.textShadow =
                        "0 0 40px rgba(168,85,247,0.8), 0 0 80px rgba(168,85,247,0.4)";
                }

                if (els.optConfetti.checked) triggerConfetti();
                playBeep(880, 0.4, "sine"); // Success sound

                if (winner) addToHistory(winner);

                if (els.winnerActions) els.winnerActions.classList.remove("hidden");

                isRunning = false;
                els.triggerBtn.disabled = false;
                els.input.parentElement?.classList.remove("opacity-50", "pointer-events-none");
            }
        };

        animate();
    }

    // --- EVENTS ---

    // Auto-resize / stats update
    els.input.addEventListener("input", updateStats);

    els.clearBtn?.addEventListener("click", () => {
        els.input.value = "";
        updateStats();
        if (els.mainDisplay) els.mainDisplay.textContent = "???";
        if (els.stateActive) els.stateActive.classList.add("hidden");
        if (els.stateEmpty) els.stateEmpty.classList.remove("hidden", "opacity-0", "translate-y-4");
    });

    els.triggerBtn.addEventListener("click", startRoll);
    els.btnReroll?.addEventListener("click", startRoll);

    // Init
    updateStats();
</script>

<style>
    @keyframes shine {
        100% {
            left: 125%;
        }
    }
    .animate-shine {
        animation: shine 1s;
    }

    .animate-ping-slow {
        animation: ping-scale 0.5s cubic-bezier(0, 0, 0.2, 1) infinite;
    }

    @keyframes ping-scale {
        0% {
            transform: scale(1);
            opacity: 0.8;
        }
        50% {
            transform: scale(1.4);
            opacity: 1;
        }
        100% {
            transform: scale(1);
            opacity: 0.8;
        }
    }

    .perspective-1000 {
        perspective: 1000px;
    }

    /* Custom Scrollbar for textarea */
    textarea::-webkit-scrollbar {
        width: 8px;
    }
    textarea::-webkit-scrollbar-track {
        background: transparent;
    }
    textarea::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.3);
        border-radius: 4px;
    }
    textarea::-webkit-scrollbar-thumb:hover {
        background-color: rgba(156, 163, 175, 0.5);
    }
</style>
