---
import { Icon } from "astro-icon/components";
---

<div class="max-w-4xl mx-auto p-4 md:p-8">
    <div
        class="relative bg-white/80 backdrop-blur-xl rounded-[2rem] p-8 md:p-12 shadow-2xl border border-white/50 ring-1 ring-pink-200 overflow-hidden min-h-[500px] flex flex-col items-center justify-center text-center"
    >
        <div
            class="absolute top-0 right-0 -translate-y-1/2 translate-x-1/2 w-96 h-96 bg-pink-300/20 rounded-full blur-3xl pointer-events-none"
        >
        </div>
        <div
            class="absolute bottom-0 left-0 translate-y-1/2 -translate-x-1/2 w-96 h-96 bg-rose-300/20 rounded-full blur-3xl pointer-events-none"
        >
        </div>

        <div
            class="relative z-10 w-full max-w-7xl min-h-[200px] flex flex-col lg:flex-row items-stretch lg:items-center justify-center gap-4 mb-12 perspective-1000"
        >
            <div
                id="part-1"
                class="excuse-slot flex-1 min-w-[200px] bg-white/60 backdrop-blur rounded-2xl p-6 border-2 border-pink-100 shadow-lg flex items-center justify-center text-center transform transition-all duration-300 hover:scale-105 hover:bg-white hover:border-pink-300 group"
            >
                <span
                    class="text-placeholder text-slate-400 font-mono text-xs uppercase tracking-widest absolute top-2 left-1/2 -translate-x-1/2 opacity-50"
                    >Sujeto</span
                >
                <p
                    class="slot-text text-2xl md:text-3xl font-black text-pink-600 leading-tight break-words w-full"
                >
                    ...
                </p>
            </div>

            <Icon name="mdi:plus" class="hidden lg:block text-slate-300 size-8 shrink-0" />
            <div class="lg:hidden flex justify-center text-slate-300">
                <Icon name="mdi:arrow-down" class="size-6" />
            </div>

            <div
                id="part-2"
                class="excuse-slot flex-1 min-w-[200px] bg-white/60 backdrop-blur rounded-2xl p-6 border-2 border-rose-100 shadow-lg flex items-center justify-center text-center transform transition-all duration-300 hover:scale-105 hover:bg-white hover:border-rose-300 group"
            >
                <span
                    class="text-placeholder text-slate-400 font-mono text-xs uppercase tracking-widest absolute top-2 left-1/2 -translate-x-1/2 opacity-50"
                    >Acción</span
                >
                <p
                    class="slot-text text-2xl md:text-3xl font-black text-rose-600 leading-tight break-words w-full"
                >
                    ...
                </p>
            </div>

            <Icon name="mdi:arrow-right" class="hidden lg:block text-slate-300 size-8 shrink-0" />
            <div class="lg:hidden flex justify-center text-slate-300">
                <Icon name="mdi:arrow-down" class="size-6" />
            </div>

            <div
                id="part-3"
                class="excuse-slot flex-1 min-w-[200px] bg-white/60 backdrop-blur rounded-2xl p-6 border-2 border-slate-100 shadow-lg flex items-center justify-center text-center transform transition-all duration-300 hover:scale-105 hover:bg-white hover:border-slate-300 group"
            >
                <span
                    class="text-placeholder text-slate-400 font-mono text-xs uppercase tracking-widest absolute top-2 left-1/2 -translate-x-1/2 opacity-50"
                    >Víctima</span
                >
                <p
                    class="slot-text text-2xl md:text-3xl font-black text-slate-700 leading-tight break-words w-full"
                >
                    ...
                </p>
            </div>
        </div>

        <div class="relative z-10 flex flex-col gap-6 items-center">
            <button
                id="generate-btn"
                class="group relative px-10 py-5 bg-slate-900 rounded-2xl text-white font-black text-xl shadow-2xl shadow-pink-500/20 hover:shadow-pink-500/40 transition-all hover:-translate-y-1 active:translate-y-0 overflow-hidden ring-4 ring-transparent hover:ring-pink-500/50"
            >
                <span class="relative flex items-center gap-3 z-10">
                    <Icon name="mdi:creation" class="size-6 animate-pulse" />
                    GENERAR EXCUSA
                </span>
                <div
                    class="absolute inset-0 bg-gradient-to-r from-pink-500 via-rose-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                >
                </div>
            </button>

            <button
                id="copy-btn"
                class="text-slate-400 text-sm font-bold hover:text-pink-600 transition-colors flex items-center gap-2 opacity-0 pointer-events-none transform translate-y-2"
            >
                <Icon name="mdi:content-copy" class="size-4" />
                Copiar esta locura
            </button>
        </div>
    </div>
</div>

<style>
    .blur-text {
        filter: blur(3px);
        opacity: 0.7;
        transform: scale(0.95);
    }
    .slot-text {
        transition: all 0.1s;
    }
</style>

<script>
    import { EXCUSE_DATA } from "./data/excuses";

    const els = {
        p1: document.querySelector("#part-1 .slot-text"),
        p2: document.querySelector("#part-2 .slot-text"),
        p3: document.querySelector("#part-3 .slot-text"),
        genBtn: document.getElementById("generate-btn"),
        copyBtn: document.getElementById("copy-btn"),
    };

    let generatedText = "";

    function runSlot(element: HTMLElement, options: string[], duration: number) {
        return new Promise<string>((resolve) => {
            const interval = 50;
            const steps = duration / interval;
            let currentStep = 0;

            element.classList.add("blur-text");

            const timer = setInterval(() => {
                const randomText = options[Math.floor(Math.random() * options.length)];
                element.innerText = randomText;
                currentStep++;

                if (currentStep >= steps) {
                    clearInterval(timer);
                    element.classList.remove("blur-text");

                    const final = options[Math.floor(Math.random() * options.length)];
                    element.innerText = final;
                    resolve(final);
                }
            }, interval);
        });
    }

    async function generateExcuse() {
        if (!els.p1 || !els.p2 || !els.p3 || !els.genBtn) return;
        if (!EXCUSE_DATA || !EXCUSE_DATA.starts) {
            console.error("Critical: EXCUSE_DATA not loaded", EXCUSE_DATA);
            return;
        }

        els.genBtn.setAttribute("disabled", "true");
        els.genBtn.style.opacity = "0.7";
        if (els.copyBtn) {
            els.copyBtn.classList.add("opacity-0", "pointer-events-none", "translate-y-2");
        }

        const promise1 = runSlot(els.p1 as HTMLElement, EXCUSE_DATA.starts, 800);
        const promise2 = runSlot(els.p2 as HTMLElement, EXCUSE_DATA.middles, 1400);
        const promise3 = runSlot(els.p3 as HTMLElement, EXCUSE_DATA.ends, 2000);

        const [res1, res2, res3] = await Promise.all([promise1, promise2, promise3]);

        generatedText = `${res1} ${res2} ${res3}`;

        els.genBtn.removeAttribute("disabled");
        els.genBtn.style.opacity = "1";
        if (els.copyBtn) {
            els.copyBtn.classList.remove("opacity-0", "pointer-events-none", "translate-y-2");

            els.copyBtn.onclick = () => {
                navigator.clipboard.writeText(generatedText);
                const original = els.copyBtn!.innerHTML;
                els.copyBtn!.innerHTML = `<span class="text-emerald-600 font-bold flex items-center gap-2">¡Copiado!</span>`;
                setTimeout(() => (els.copyBtn!.innerHTML = original), 2000);
            };
        }
    }

    els.genBtn?.addEventListener("click", generateExcuse);

    if (els.p1) els.p1.innerHTML = "?";
    if (els.p2) els.p2.innerHTML = "?";
    if (els.p3) els.p3.innerHTML = "?";
</script>
