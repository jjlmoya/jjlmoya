---
import { Icon } from "astro-icon/components";
---

<div class="microwave-detector-container max-w-4xl mx-auto p-4 sm:p-8" id="microwave-detector-root">
    
    <div
        id="initial-modal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/95 backdrop-blur-md"
    >
        <div
            class="bg-white dark:bg-slate-800 rounded-3xl p-8 max-w-md w-full shadow-2xl border border-slate-700 text-center animate-in zoom-in-95 duration-300"
        >
            <div
                class="bg-amber-100 dark:bg-amber-900/40 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"
            >
                <Icon name="mdi:wifi-alert" class="w-12 h-12 text-amber-500" />
            </div>
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">
                Requisito de Física
            </h2>
            <p class="text-slate-600 dark:text-slate-400 mb-8 leading-relaxed">
                Este detector utiliza la interferencia en la banda de **2.4GHz** (la frecuencia de
                los microondas).
                <br /><br />
                Para que funcione, asegúrate de estar conectado a una red **WiFi 2.4GHz** (no 5GHz/6GHz)
                o usa tu teléfono cerca del aparato.
            </p>
            <button
                id="start-btn"
                class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-bold transition-all shadow-lg shadow-indigo-600/20 active:scale-95"
            >
                Entendido, Iniciar Escaneo
            </button>
        </div>
    </div>

    <div
        class="bg-black rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-800 p-6 sm:p-10 relative"
    >
        
        <div class="flex justify-between items-start mb-8">
            <div>
                <span
                    class="text-rose-500 font-mono text-xs uppercase tracking-[0.3em] font-bold mb-1 block"
                    >RF Interference Monitor</span
                >
                <h3 class="text-white text-3xl font-black italic tracking-tighter">
                    MW-LEAK DETECTOR v2.0
                </h3>
            </div>
            <div
                class="flex items-center gap-2 bg-slate-900/50 px-4 py-2 rounded-full border border-slate-800"
            >
                <div id="status-dot" class="w-3 h-3 rounded-full bg-slate-600 animate-pulse"></div>
                <span id="status-text" class="text-slate-400 font-mono text-[10px] uppercase"
                    >Estático</span
                >
            </div>
        </div>

        
        <div
            class="relative aspect-video sm:aspect-[21/9] bg-slate-950 rounded-2xl border border-slate-800 overflow-hidden mb-8 group"
        >
            
            <canvas id="interference-canvas" class="w-full h-full opacity-60"></canvas>

            
            <div
                class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
            >
                <div
                    class="text-[120px] sm:text-[180px] font-black italic tracking-tighter text-white opacity-5 select-none leading-none"
                    id="big-value-bg"
                >
                    00
                </div>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span
                        class="text-rose-500 font-mono text-[40px] sm:text-[60px] font-black"
                        id="jitter-value">0.0</span
                    >
                    <span
                        class="text-slate-500 font-mono text-xs uppercase tracking-widest mt-[-10px]"
                        >ms / jitter</span
                    >
                </div>
            </div>

            
            <div
                class="absolute inset-0 pointer-events-none z-10 opacity-20"
                style="background-image: linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px); background-size: 40px 40px;"
            >
            </div>
        </div>

        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-end">
            <div>
                <div
                    id="verdict-container"
                    class="p-6 rounded-2xl border border-slate-800 bg-slate-900/50 transition-colors duration-500"
                >
                    <h4
                        class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2"
                        id="verdict-label"
                    >
                        Sistema Listado
                    </h4>
                    <p class="text-white font-medium" id="verdict-description">
                        Conecta para iniciar el análisis térmico de interferencia.
                    </p>
                </div>

                <div class="mt-4 flex items-center gap-4 text-slate-500">
                    <div class="flex items-center gap-2 text-xs font-mono">
                        <Icon name="mdi:pulse" class="w-4 h-4" />
                        LAT: <span id="latency-val">0ms</span>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div
                    class="flex items-center justify-between text-xs font-mono text-slate-500 uppercase tracking-widest px-2"
                >
                    <span>Audio Feedback</span>
                    <span id="audio-status">ON</span>
                </div>
                <button
                    id="toggle-audio-btn"
                    class="w-full h-12 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 border border-slate-700 transition-all flex items-center justify-center gap-2"
                >
                    <Icon name="mdi:volume-high" class="w-5 h-5" />
                    MUTE / UNMUTE
                </button>
            </div>
        </div>

        
        <div
            class="absolute inset-0 pointer-events-none z-20 opacity-[0.03] overflow-hidden rounded-[2.5rem]"
        >
            <div class="h-1 bg-white w-full animate-scanline"></div>
        </div>
    </div>
</div>

<script>
    import { MicrowaveEngine } from "./MicrowaveEngine";

    const root = document.getElementById("microwave-detector-root");
    if (root) {
        const startBtn = document.getElementById("start-btn");
        const modal = document.getElementById("initial-modal");
        const canvas = document.getElementById("interference-canvas") as HTMLCanvasElement;
        const ctx = canvas.getContext("2d");

        const jitterDisplay = document.getElementById("jitter-value");
        const bigValueBg = document.getElementById("big-value-bg");
        const latencyVal = document.getElementById("latency-val");
        const verdictLabel = document.getElementById("verdict-label");
        const verdictDesc = document.getElementById("verdict-description");
        const verdictContainer = document.getElementById("verdict-container");
        const statusDot = document.getElementById("status-dot");
        const statusText = document.getElementById("status-text");
        const toggleAudioBtn = document.getElementById("toggle-audio-btn");

        const engine = new MicrowaveEngine();
        let running = false;
        let audioEnabled = true;
        let audioCtx: AudioContext | null = null;

        const history: number[] = new Array(60).fill(0);

        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
        }

        function drawGraph() {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.beginPath();
            ctx.strokeStyle = "#4f46e5";
            ctx.lineWidth = 3;
            ctx.lineJoin = "round";

            const step = canvas.width / (history.length - 1);
            const maxHistory = Math.max(...history, 50);

            history.forEach((val, i) => {
                const x = i * step;
                const y = canvas.height - (val / maxHistory) * canvas.height * 0.8 - 20;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, "rgba(79, 70, 229, 0.2)");
            gradient.addColorStop(1, "transparent");
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.fillStyle = gradient;
            ctx.fill();
        }

        async function playClick(intensity: number) {
            if (!audioEnabled) return;
            if (!audioCtx)
                audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = "square";
            osc.frequency.setValueAtTime(40 + Math.random() * 20, audioCtx.currentTime);

            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.05);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }

        async function scan() {
            if (!running) return;

            const result = await engine.measurePing();
            history.push(result.jitter);
            history.shift();

            if (jitterDisplay) jitterDisplay.textContent = result.jitter.toFixed(1);
            if (bigValueBg)
                bigValueBg.textContent = Math.floor(result.jitter).toString().padStart(2, "0");
            if (latencyVal) latencyVal.textContent = `${Math.floor(result.latency)}ms`;

            const level = MicrowaveEngine.getInterferenceLevel(result.jitter);
            if (verdictLabel) verdictLabel.textContent = level.label;
            if (verdictDesc) verdictDesc.textContent = level.description;

            
            const colorMap = {
                emerald: "bg-emerald-500/10 border-emerald-500/30 text-emerald-500",
                yellow: "bg-yellow-500/10 border-yellow-500/30 text-yellow-500",
                orange: "bg-orange-500/10 border-orange-500/30 text-orange-500",
                red: "bg-red-500/20 border-red-500/50 text-red-500 border-2",
            };

            if (verdictContainer) {
                const colorKey = level.color as keyof typeof colorMap;
                verdictContainer.className = `p-6 rounded-2xl border transition-all duration-300 ${colorMap[colorKey] || "border-slate-800"}`;
            }

            if (statusDot) {
                statusDot.className = `w-3 h-3 rounded-full animate-pulse bg-${level.color}-500`;
            }

            
            if (result.jitter > 1) {
                playClick(result.jitter);
            }

            drawGraph();
            setTimeout(scan, 200 + Math.random() * 100);
        }

        startBtn?.addEventListener("click", () => {
            modal?.classList.add("hidden");
            running = true;
            resizeCanvas();
            if (statusText) statusText.textContent = "Scanning...";
            scan();
        });

        toggleAudioBtn?.addEventListener("click", () => {
            audioEnabled = !audioEnabled;
            const statusLabel = document.getElementById("audio-status");
            if (statusLabel) statusLabel.textContent = audioEnabled ? "ON" : "OFF";
        });

        window.addEventListener("resize", resizeCanvas);
    }
</script>

<style>
    @keyframes scanline {
        0% {
            transform: translateY(-100%);
        }
        100% {
            transform: translateY(1000%);
        }
    }
    .animate-scanline {
        animation: scanline 4s linear infinite;
    }
</style>
