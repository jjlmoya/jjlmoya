---

---

<div
    class="relative w-full h-[85vh] min-h-[600px] rounded-3xl overflow-hidden bg-slate-900 shadow-2xl border border-slate-800 font-sans select-none"
    id="asteroid-app"
>
    <div id="game-map" class="absolute inset-0 z-0 bg-slate-100" style="touch-action: none;"></div>

    <div
        id="map-target-overlay"
        class="absolute inset-0 z-10 pointer-events-none opacity-0 transition-opacity duration-300 bg-emerald-500/5 flex items-center justify-center"
    >
        <div class="w-full h-px bg-emerald-500/20 absolute"></div>
        <div class="h-full w-px bg-emerald-500/20 absolute"></div>
        <div class="border-2 border-emerald-500/30 w-[80%] h-[80%] rounded-3xl absolute"></div>
    </div>

    <div
        class="absolute top-4 left-0 w-full z-30 flex flex-col items-center pointer-events-none px-4"
    >
        <div class="pointer-events-auto mb-2">
            <button
                id="gps-btn"
                class="bg-white/90 backdrop-blur-xl text-slate-700 px-4 py-2 rounded-full text-xs font-bold border border-white/40 shadow-lg flex items-center gap-2 hover:scale-105 transition-transform"
            >
                <div id="gps-dot" class="w-2 h-2 rounded-full bg-slate-400"></div>
                <span id="gps-text">Activar GPS</span>
            </button>
        </div>

        <div
            id="verdict-pill"
            class="translate-y-[-20px] opacity-0 transition-all duration-500 pointer-events-auto max-w-full"
        >
            <div
                id="verdict-container"
                class="bg-slate-800 text-white px-5 py-3 rounded-2xl shadow-xl flex items-center gap-3 backdrop-blur-md border border-white/10"
            >
                <div id="verdict-icon" class="w-6 h-6 shrink-0 flex items-center justify-center">
                </div>
                <div class="text-left leading-none">
                    <div
                        id="verdict-label"
                        class="font-bold text-[9px] uppercase tracking-widest opacity-60 mb-0.5"
                    >
                        Análisis
                    </div>
                    <div
                        id="verdict-text"
                        class="font-black text-lg italic uppercase font-mono whitespace-nowrap"
                    >
                        --
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div
        class="hidden md:flex absolute top-6 left-6 bottom-6 w-80 z-30 flex-col pointer-events-none"
    >
        <div
            class="bg-white/90 backdrop-blur-2xl border border-white/40 shadow-[0_8px_32px_rgba(0,0,0,0.1)] rounded-[2rem] p-5 flex flex-col gap-4 pointer-events-auto h-full overflow-hidden"
            id="desktop-lab"
        >
            <div
                class="flex items-center justify-between pb-2 border-b border-slate-200/60 shrink-0"
            >
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white shadow-lg shadow-orange-500/30"
                    >
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"
                            ><path
                                d="M12,2L11,7H13L12,2M6.5,5.27L5.77,6L9.5,9.73L10.23,9L6.5,5.27M17.5,5.27L13.77,9L14.5,9.73L18.23,6L17.5,5.27M2,11V13H7V11H2M17,11V13H22V11H17M9.5,14.27L5.77,18L6.5,18.73L10.23,15L9.5,14.27M14.5,14.27L13.77,15L17.5,18.73L18.23,18L14.5,14.27M11,17L12,22L13,17H11Z"
                            ></path></svg
                        >
                    </div>
                    <div>
                        <h2 class="font-black text-slate-800 text-base leading-none">Asteroid</h2>
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.2em]"
                            >Factory</span
                        >
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto pr-1 custom-scrollbar space-y-6" id="lab-content">
                <div
                    class="relative group cursor-grab active:cursor-grabbing transform hover:scale-[1.02] transition-transform"
                    id="drag-source-desktop"
                >
                    <div
                        class="absolute inset-0 bg-gradient-to-tr from-slate-100 to-white rounded-3xl border border-slate-200 shadow-inner"
                    >
                    </div>
                    <div
                        class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center z-10 pointer-events-none"
                    >
                        <span
                            class="bg-black/80 text-white text-[10px] font-bold px-3 py-1 rounded-full backdrop-blur-md shadow-lg transform -translate-y-8"
                            >ARRASTRA AL MAPA</span
                        >
                    </div>

                    <div
                        class="relative h-40 flex items-center justify-center overflow-hidden rounded-3xl"
                    >
                        <div
                            class="absolute inset-0"
                            style="background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; opacity: 0.5;"
                        >
                        </div>
                        <div
                            id="asteroid-visual"
                            class="w-20 h-20 rounded-full shadow-[10px_10px_30px_rgba(0,0,0,0.2),-5px_-5px_15px_rgba(255,255,255,0.8)] relative transition-transform duration-300"
                        >
                            <div
                                id="asteroid-surface"
                                class="absolute inset-0 rounded-full bg-slate-700 overflow-hidden border-2 border-white/20"
                            >
                                <div
                                    class="absolute top-0 right-0 w-full h-full bg-gradient-to-bl from-white/40 to-black/50"
                                >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label
                        class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"
                    >
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"
                            ><path
                                d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z"
                            ></path></svg
                        >
                        Datos Históricos
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <button
                            class="preset-btn relative overflow-hidden bg-white hover:bg-orange-50/50 border border-slate-200 hover:border-orange-300 rounded-2xl p-3 text-left transition-all duration-300 hover:shadow-lg hover:-translate-y-1 group"
                            data-dia="20"
                            data-vel="19"
                            data-comp="rock"
                        >
                            <div
                                class="text-[11px] font-black text-slate-700 group-hover:text-orange-600 mb-0.5 relative z-10"
                            >
                                CHELYABINSK
                            </div>
                            <div
                                class="text-[9px] font-medium text-slate-400 font-mono relative z-10"
                            >
                                20m · Aéreo
                            </div>
                        </button>
                        <button
                            class="preset-btn relative overflow-hidden bg-white hover:bg-orange-50/50 border border-slate-200 hover:border-orange-300 rounded-2xl p-3 text-left transition-all duration-300 hover:shadow-lg hover:-translate-y-1 group"
                            data-dia="50"
                            data-vel="15"
                            data-comp="rock"
                        >
                            <div
                                class="text-[11px] font-black text-slate-700 group-hover:text-orange-600 mb-0.5 relative z-10"
                            >
                                TUNGUSKA
                            </div>
                            <div
                                class="text-[9px] font-medium text-slate-400 font-mono relative z-10"
                            >
                                50m · Bosque
                            </div>
                        </button>
                        <button
                            class="preset-btn relative overflow-hidden bg-white hover:bg-cyan-50/50 border border-slate-200 hover:border-cyan-300 rounded-2xl p-3 text-left transition-all duration-300 hover:shadow-lg hover:-translate-y-1 group"
                            data-dia="200"
                            data-vel="25"
                            data-comp="ice"
                        >
                            <div
                                class="text-[11px] font-black text-slate-700 group-hover:text-cyan-600 mb-0.5 relative z-10"
                            >
                                3I ATLAS
                            </div>
                            <div
                                class="text-[9px] font-medium text-slate-400 font-mono relative z-10"
                            >
                                200m · Cometa
                            </div>
                        </button>
                        <button
                            class="preset-btn relative overflow-hidden bg-white hover:bg-red-50/50 border border-slate-200 hover:border-red-300 rounded-2xl p-3 text-left transition-all duration-300 hover:shadow-lg hover:-translate-y-1 group"
                            data-dia="10000"
                            data-vel="20"
                            data-comp="rock"
                        >
                            <div
                                class="text-[11px] font-black text-slate-700 group-hover:text-red-600 mb-0.5 relative z-10"
                            >
                                CHICXULUB
                            </div>
                            <div
                                class="text-[9px] font-medium text-slate-400 font-mono relative z-10"
                            >
                                10km · E.L.E.
                            </div>
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-slate-50 rounded-2xl p-3 border border-slate-100">
                        <div class="flex justify-between items-end mb-2">
                            <label
                                class="text-[10px] font-bold text-slate-400 uppercase tracking-wider"
                                >Diámetro</label
                            >
                            <span id="display-size" class="text-sm font-black text-slate-700"
                                >100m</span
                            >
                        </div>
                        <input
                            type="range"
                            id="input-size"
                            min="10"
                            max="5000"
                            step="10"
                            value="100"
                            class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
                        />
                    </div>

                    <div class="bg-slate-50 rounded-2xl p-3 border border-slate-100">
                        <div class="flex justify-between items-end mb-2">
                            <label
                                class="text-[10px] font-bold text-slate-400 uppercase tracking-wider"
                                >Velocidad</label
                            >
                            <span id="display-velocity" class="text-sm font-black text-slate-700"
                                >20 km/s</span
                            >
                        </div>
                        <input
                            type="range"
                            id="input-velocity"
                            min="10"
                            max="70"
                            step="1"
                            value="20"
                            class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                        />
                    </div>

                    <div>
                        <label
                            class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block"
                            >Composición</label
                        >
                        <div class="grid grid-cols-3 gap-2">
                            <button
                                class="mat-btn active p-2 rounded-xl border border-slate-100 bg-slate-50 hover:bg-white transition-all flex flex-col items-center gap-1 group"
                                data-type="rock"
                            >
                                <div
                                    class="w-4 h-4 rounded-full bg-slate-500 shadow-sm group-hover:scale-110 transition-transform"
                                >
                                </div>
                                <span class="text-[9px] font-bold text-slate-500 uppercase"
                                    >Roca</span
                                >
                            </button>
                            <button
                                class="mat-btn p-2 rounded-xl border border-slate-100 bg-slate-50 hover:bg-white transition-all flex flex-col items-center gap-1 group"
                                data-type="iron"
                            >
                                <div
                                    class="w-4 h-4 rounded-full bg-slate-800 shadow-sm group-hover:scale-110 transition-transform"
                                >
                                </div>
                                <span class="text-[9px] font-bold text-slate-500 uppercase"
                                    >Hierro</span
                                >
                            </button>
                            <button
                                class="mat-btn p-2 rounded-xl border border-slate-100 bg-slate-50 hover:bg-white transition-all flex flex-col items-center gap-1 group"
                                data-type="ice"
                            >
                                <div
                                    class="w-4 h-4 rounded-full bg-cyan-300 shadow-sm group-hover:scale-110 transition-transform"
                                >
                                </div>
                                <span class="text-[9px] font-bold text-slate-500 uppercase"
                                    >Hielo</span
                                >
                            </button>
                        </div>
                    </div>
                </div>

                <button
                    id="clear-btn"
                    class="w-full py-3 rounded-xl bg-slate-100 text-slate-400 hover:text-red-500 hover:bg-red-50 font-bold text-xs uppercase tracking-wider transition-all flex items-center justify-center gap-2 shrink-0"
                >
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"
                        ><path
                            d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"
                        ></path></svg
                    >
                    Limpiar todo
                </button>
            </div>
        </div>
    </div>

    <div
        class="md:hidden absolute bottom-6 left-4 right-4 z-40 bg-white/90 backdrop-blur-xl rounded-[2.5rem] shadow-[0_8px_32px_rgba(0,0,0,0.12)] border border-white/60 p-2 flex items-center justify-between pointer-events-auto pb-safe ring-1 ring-slate-900/5"
    >
        <div class="flex items-center gap-3 pl-1">
            <div class="relative flex flex-col items-center group">
                <div
                    id="drag-source-mobile"
                    class="w-16 h-16 bg-slate-100 rounded-full shadow-lg border border-white flex items-center justify-center cursor-grab active:cursor-grabbing relative overflow-hidden active:scale-95 transition-all ring-4 ring-transparent active:ring-orange-100/50"
                >
                    <div
                        class="w-full h-full absolute opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-400 to-transparent"
                    >
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-slate-800 shadow-inner relative z-10 border border-slate-600 group-active:scale-90 transition-transform"
                    >
                    </div>

                    <div
                        class="absolute inset-0 flex items-center justify-center z-20 pointer-events-none opacity-0 group-active:opacity-100 transition-opacity"
                    >
                        <svg class="w-8 h-8 text-white/80" fill="currentColor" viewBox="0 0 24 24"
                            ><path
                                d="M13,11V5.9L16.29,9.19L17.71,7.78L12.71,2.78L12,2.07L11.29,2.78L6.29,7.78L7.71,9.19L11,5.9V11H5.9L9.19,7.71L7.78,6.29L2.78,11.29L2.07,12L2.78,12.71L7.78,17.71L9.19,16.29L5.9,13H11V18.1L7.71,14.81L6.29,16.23L11.29,21.22L12,21.93L12.71,21.22L17.71,16.23L16.29,14.81L13,18.1V13H18.1L14.81,16.29L16.23,17.71L21.22,12.71L21.93,12L21.22,11.29L16.23,6.29L14.81,7.71L18.1,11H13Z"
                            ></path></svg
                        >
                    </div>
                </div>
                <div
                    class="absolute -top-3 bg-slate-800 text-white text-[9px] font-black tracking-widest px-2 py-0.5 rounded-full shadow-lg scale-90"
                >
                    ASTEROID
                </div>
            </div>

            <button
                id="config-trigger"
                class="w-12 h-12 bg-slate-50 hover:bg-slate-100 text-slate-500 rounded-full border border-slate-200 flex items-center justify-center active:scale-95 transition-all shadow-sm group relative"
            >
                <svg
                    class="w-6 h-6 group-hover:rotate-90 transition-transform duration-500"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                    ><path
                        d="M19.14,12.94C19.14,12.78 19.14,12.61 19.14,12.45C19.14,12.29 19.14,12.12 19.14,11.96C19.14,11.79 19.14,11.63 19.14,11.46L21.46,9.65L19.46,6.19L16.55,7.35C16.55,7.19 16.55,7 16.55,6.86C15.93,5.77 15.1,4.86 14.07,4.2L14.07,1.25H10.07L10.07,4.21C9.03,4.87 8.2,5.78 7.58,6.87C7.58,7.03 7.58,7.2 7.58,7.36L4.68,6.2L2.68,9.66L5,11.47C5,11.64 5,11.8 5,11.97C5,12.13 5,12.3 5,12.46L2.68,14.27L4.68,17.73L7.58,16.57C8.2,17.66 9.03,18.57 10.07,19.23L10.07,22.19H14.07L14.07,19.22C15.1,18.56 15.93,17.65 16.55,16.56L19.46,17.72L21.46,14.26L19.14,12.45V12.94ZM12.07,15.75C9.97,15.75 8.27,14.05 8.27,11.95C8.27,9.85 9.97,8.15 12.07,8.15C14.17,8.15 15.87,9.85 15.87,11.95C15.87,14.05 14.17,15.75 12.07,15.75Z"
                    ></path></svg
                >
            </button>
        </div>

        <div class="h-8 w-px bg-slate-200 mx-2"></div>

        <div class="flex items-center gap-3 pr-1 justify-end">
            <button
                id="clear-btn-mobile"
                class="w-12 h-12 bg-slate-50 hover:bg-slate-100 text-slate-400 hover:text-red-500 rounded-full border border-slate-200 flex items-center justify-center active:scale-95 transition-all shadow-sm"
            >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"
                    ><path
                        d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"
                    ></path></svg
                >
            </button>

            <div class="relative flex flex-col items-center group">
                <div
                    id="drag-person-mobile"
                    class="w-16 h-16 bg-blue-50/50 rounded-full shadow-lg border border-white flex items-center justify-center cursor-grab active:cursor-grabbing relative overflow-hidden active:scale-95 transition-all ring-4 ring-transparent active:ring-blue-100/50"
                >
                    <svg
                        class="w-8 h-8 text-blue-500 drop-shadow-sm group-active:scale-110 transition-transform"
                        fill="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"
                        ></path></svg
                    >
                </div>

                <div
                    class="absolute -top-3 bg-blue-500 text-white text-[9px] font-black tracking-widest px-3 py-0.5 rounded-full shadow-lg scale-90"
                >
                    YO
                </div>
            </div>
        </div>
    </div>

    <div
        id="mobile-drawer"
        class="md:hidden absolute inset-x-0 bottom-0 z-50 bg-white rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transform translate-y-full transition-transform duration-300 pb-20 flex flex-col max-h-[85vh]"
    >
        <div class="w-full flex justify-center pt-3 pb-1" id="drawer-handle">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
        </div>
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
            <h3 class="font-black text-slate-800 text-lg">Configuración</h3>
            <button id="close-drawer" class="bg-slate-100 p-2 rounded-full text-slate-500">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"
                    ><path
                        d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"
                    ></path></svg
                >
            </button>
        </div>

        <div id="mobile-drawer-content" class="overflow-y-auto px-6 py-4 space-y-6"></div>
    </div>

    <div class="hidden md:flex absolute top-6 left-1/2 ml-36 z-30 pointer-events-none">
        <div
            id="drag-person-desktop"
            class="bg-white/80 backdrop-blur-xl shadow-lg border border-white/40 rounded-full w-10 h-10 flex items-center justify-center cursor-grab active:cursor-grabbing hover:bg-white hover:scale-110 pointer-events-auto pointer-events-auto"
            title="Arrastra al mapa"
        >
            <svg class="w-5 h-5 text-slate-700" fill="currentColor" viewBox="0 0 24 24"
                ><path
                    d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"
                ></path></svg
            >
        </div>
    </div>

    <div
        id="info-panel"
        class="absolute top-20 right-4 left-4 md:left-auto md:top-6 md:right-6 md:w-72 z-40 pointer-events-none translate-x-10 md:translate-x-10 opacity-0 transition-all duration-300"
    >
        <div
            class="bg-white/95 backdrop-blur-2xl border border-white/40 shadow-2xl rounded-3xl p-6 pointer-events-auto"
        >
            <button
                id="close-info"
                class="absolute top-4 right-4 text-slate-400 bg-slate-100 rounded-full p-1"
                ><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"
                    ><path
                        d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"
                    ></path></svg
                ></button
            >

            <div class="flex items-center gap-2 mb-4">
                <div id="info-dot" class="w-3 h-3 rounded-full bg-slate-500 shadow-sm"></div>
                <div>
                    <h3 class="font-black text-slate-800 text-sm uppercase leading-none">
                        Impact Data
                    </h3>
                    <span
                        id="info-type"
                        class="text-[9px] font-bold text-slate-400 uppercase tracking-wider"
                        >Analysis</span
                    >
                </div>
            </div>

            <div class="space-y-4">
                <div
                    class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-4 text-white shadow-lg"
                >
                    <div class="text-[10px] font-bold text-white/40 uppercase mb-1">
                        Energía TNT
                    </div>
                    <div class="text-2xl font-black text-white leading-none" id="info-energy">
                        --
                    </div>
                </div>
                <div class="space-y-2 text-xs font-mono">
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="text-slate-400">Cráter</span>
                        <span class="font-bold text-slate-700" id="info-crater">-- km</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="text-slate-400">Bola Fuego</span>
                        <span class="font-bold text-orange-600" id="info-thermal">-- km</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-slate-100">
                        <span class="text-slate-400">Onda Choque</span>
                        <span class="font-bold text-blue-600" id="info-shock">-- km</span>
                    </div>
                </div>
                <button
                    id="delete-info"
                    class="w-full py-3 bg-red-50 text-red-500 border border-red-100 rounded-xl text-xs font-bold hover:bg-red-500 hover:text-white transition-all shadow-sm mt-2"
                    >ELIMINAR IMPACTO</button
                >
            </div>
        </div>
    </div>
</div>

<div
    id="drag-ghost"
    class="fixed pointer-events-none z-[9999] opacity-0 transition-opacity duration-75"
>
    <div class="w-24 h-24 rounded-full bg-orange-500/30 blur-xl absolute inset-0 animate-pulse">
    </div>
    <div
        class="w-24 h-24 rounded-full bg-slate-800 shadow-2xl border-2 border-white/20 relative overflow-hidden transform scale-75"
    >
        <div id="ghost-texture" class="absolute inset-0 bg-slate-600"></div>
    </div>
</div>

<div
    id="drag-person-ghost"
    class="fixed pointer-events-none z-[9999] opacity-0 transition-opacity duration-75 text-blue-600 drop-shadow-2xl"
>
    <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 24 24"
        ><path
            d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"
        ></path></svg
    >
</div>

<div style="display: none;">
    <div id="icon-safe">
        <svg class="w-6 h-6 text-emerald-100" fill="currentColor" viewBox="0 0 24 24"
            ><path
                d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M10,17L6,13L7.41,11.59L10,14.17L16.59,7.58L18,9L10,17Z"
            ></path></svg
        >
    </div>
    <div id="icon-shock">
        <svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 24 24"
            ><path
                d="M3,12A9,9 0 0,0 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3A9,9 0 0,0 3,12M5,12A7,7 0 0,1 12,5A7,7 0 0,1 19,12A7,7 0 0,1 12,19A7,7 0 0,1 5,12M11,17H13V15H11V17M11,13H13V7H11V13Z"
            ></path></svg
        >
    </div>
    <div id="icon-burn">
        <svg class="w-6 h-6 text-orange-400" fill="currentColor" viewBox="0 0 24 24"
            ><path
                d="M17.66,11.2C17.43,10.9 17.15,10.64 16.89,10.38C16.22,9.78 15.46,9.35 14.82,8.72C13.33,7.26 13,4.85 13.95,3C13,3.23 12.17,3.75 11.46,4.32C8.87,6.4 7.85,10.07 9.07,13.22C9.11,13.32 9.15,13.42 9.15,13.55C9.15,13.77 9,13.97 8.8,14.05C8.57,14.15 8.33,14.09 8.14,13.93C8.08,13.88 8.04,13.83 8,13.76C6.87,12.33 6.69,10.28 7.45,8.64C5.78,10 4.87,12.3 5,14.47C5.06,14.97 5.12,15.47 5.29,15.97C5.43,16.57 5.7,17.17 6,17.7C7.08,19.43 8.95,20.67 10.96,20.92C13.1,21.19 15.39,20.8 17.03,19.32C18.86,17.66 19.5,15 18.56,12.72L18.43,12.46C18.22,12 17.66,11.2 17.66,11.2Z"
            ></path></svg
        >
    </div>
    <div id="icon-death">
        <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 24 24"
            ><path
                d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"
            ></path></svg
        >
    </div>
    <div id="icon-person">
        <div class="relative flex items-center justify-center w-10 h-10 group cursor-grab">
            <div class="absolute inset-0 bg-blue-500 rounded-full opacity-20 animate-pulse">
            </div><div
                class="absolute inset-0 bg-white rounded-full scale-75 shadow-lg border-2 border-blue-500 flex items-center justify-center"
            >
                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24"
                    ><path
                        d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"
                    ></path></svg
                >
            </div><div
                class="absolute -bottom-8 bg-black/80 text-white text-[9px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity"
            >
                TÚ
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    .mat-btn.active {
        background: #f8fafc;
        border-color: #94a3b8;
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    :global(.leaflet-marker-draggable) {
        cursor: grab !important;
    }
    :global(.leaflet-marker-dragging) {
        cursor: grabbing !important;
    }
</style>

<script>
    import L from "leaflet";
    import { ImpactPhysics, type Composition } from "./logic/impactPhysics";

    let map: L.Map;
    let userMarker: L.Marker | null = null;
    let userPos: { lat: number; lng: number } | null = null;
    let isGhostDragging = false;
    let isPersonDragging = false;
    let isDraggingMarker = false;

    const impacts: {
        id: string;
        circles: L.LayerGroup;
        marker: L.Marker;
        data: any;
        config: typeof config;
    }[] = [];

    const config = {
        diameter: 100,
        velocity: 20,
        composition: "rock" as Composition,
        name: "Custom Asteroid",
    };

    function init() {
        map = L.map("game-map", {
            zoomControl: false,
            attributionControl: false,
            dragging: true,
        }).setView([40.4168, -3.7038], 6);

        L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
            subdomains: "abcd",
            maxZoom: 20,
            attribution: "&copy; OpenStreetMap &copy; CARTO",
        }).addTo(map);

        setupDesktopControls();
        setupMobileControls();
        setupGhostDrag();
        setupPersonDrag();
        setupGPS();

        map.on("click", () => {
            if (!isDraggingMarker) closeInfoPanel();

            map.dragging.enable();
        });
    }

    function setupDesktopControls() {
        bindControls(document);
    }

    function setupMobileControls() {
        const drawerContent = document.getElementById("mobile-drawer-content");
        const originalContent = document.getElementById("lab-content");
        if (drawerContent && originalContent) {
            drawerContent.innerHTML = originalContent.innerHTML;

            const dragSourceMobile = drawerContent.querySelector("#drag-source-desktop");
            if (dragSourceMobile) dragSourceMobile.remove();

            bindControls(drawerContent as HTMLElement);
        }

        const drawer = document.getElementById("mobile-drawer");
        const trigger = document.getElementById("config-trigger");
        const close = document.getElementById("close-drawer");
        const handle = document.getElementById("drawer-handle");
        const clearMobile = document.getElementById("clear-btn-mobile");

        const openDrawer = () => drawer?.classList.remove("translate-y-full");
        const closeDrawer = () => drawer?.classList.add("translate-y-full");

        trigger?.addEventListener("click", openDrawer);
        close?.addEventListener("click", closeDrawer);
        handle?.addEventListener("click", closeDrawer);
        clearMobile?.addEventListener("click", clearAll);
    }

    function bindControls(scope: Document | HTMLElement) {
        const sizeInputs = document.querySelectorAll('input[type="range"][id="input-size"]');
        const velInputs = document.querySelectorAll('input[type="range"][id="input-velocity"]');
        const matBtns = document.querySelectorAll(".mat-btn");
        const presetBtns = document.querySelectorAll(".preset-btn");
        const clearBtns = document.querySelectorAll("#clear-btn");

        const updateAllUI = () => {
            const displaysSize = document.querySelectorAll("#display-size");
            const displaysVel = document.querySelectorAll("#display-velocity");

            displaysSize.forEach(
                (el) =>
                    (el.textContent =
                        config.diameter >= 1000
                            ? `${(config.diameter / 1000).toFixed(1)} km`
                            : `${config.diameter} m`)
            );
            displaysVel.forEach((el) => (el.textContent = `${config.velocity} km/s`));

            sizeInputs.forEach(
                (el) => ((el as HTMLInputElement).value = config.diameter.toString())
            );
            velInputs.forEach(
                (el) => ((el as HTMLInputElement).value = config.velocity.toString())
            );

            const visuals = document.querySelectorAll("#asteroid-visual");
            const surfaces = document.querySelectorAll("#asteroid-surface");
            const scale = 1 + (config.diameter / 5000) * 0.5;

            visuals.forEach((el) => ((el as HTMLElement).style.transform = `scale(${scale})`));

            let colorClass = "bg-slate-500";
            if (config.composition === "ice") colorClass = "bg-cyan-300";
            if (config.composition === "iron") colorClass = "bg-slate-800";

            surfaces.forEach(
                (el) =>
                    (el.className = `absolute inset-0 rounded-full overflow-hidden transition-colors duration-300 ${colorClass}`)
            );

            matBtns.forEach((btn) => {
                if (btn.getAttribute("data-type") === config.composition)
                    btn.classList.add("active");
                else btn.classList.remove("active");
            });
        };

        sizeInputs.forEach((el) => {
            el.addEventListener("input", (e) => {
                config.diameter = parseInt((e.target as HTMLInputElement).value);
                updateAllUI();
            });
        });

        velInputs.forEach((el) => {
            el.addEventListener("input", (e) => {
                config.velocity = parseInt((e.target as HTMLInputElement).value);
                updateAllUI();
            });
        });

        matBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                config.composition = btn.getAttribute("data-type") as Composition;
                updateAllUI();
            });
        });

        presetBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                config.diameter = parseInt(btn.getAttribute("data-dia")!);
                config.velocity = parseInt(btn.getAttribute("data-vel")!);
                config.composition = btn.getAttribute("data-comp") as Composition;
                updateAllUI();
            });
        });

        clearBtns.forEach((btn) => btn.addEventListener("click", clearAll));
    }

    function setupGhostDrag() {
        const sourceDesktop = document.getElementById("drag-source-desktop");

        const sourceMobile = document.getElementById("drag-source-mobile");

        const attachDrag = (source: HTMLElement | null) => {
            if (!source) return;
            const start = (e: MouseEvent | TouchEvent) => {
                e.preventDefault();
                const x = (e as MouseEvent).clientX || (e as TouchEvent).touches[0].clientX;
                const y = (e as MouseEvent).clientY || (e as TouchEvent).touches[0].clientY;

                isGhostDragging = true;
                const ghost = document.getElementById("drag-ghost");
                const ghostTexture = document.getElementById("ghost-texture");
                const targetOverlay = document.getElementById("map-target-overlay");

                ghost!.style.opacity = "1";
                ghost!.style.left = `${x - 48}px`;
                ghost!.style.top = `${y - 48}px`;

                let colorClass = "bg-slate-500";
                if (config.composition === "ice") colorClass = "bg-cyan-300";
                if (config.composition === "iron") colorClass = "bg-slate-800";
                ghostTexture!.className = `absolute inset-0 ${colorClass}`;
                targetOverlay!.style.opacity = "1";

                window.addEventListener("mousemove", onMove);
                window.addEventListener("mouseup", onEnd);
                window.addEventListener("touchmove", onTouchMove, { passive: false });
                window.addEventListener("touchend", onEnd);
            };
            source.addEventListener("mousedown", start);
            source.addEventListener("touchstart", start);
        };

        attachDrag(sourceDesktop);
        attachDrag(sourceMobile);

        function onMove(e: MouseEvent) {
            if (!isGhostDragging) return;
            moveGhost(e.clientX, e.clientY);
        }

        function onTouchMove(e: TouchEvent) {
            if (!isGhostDragging) return;
            e.preventDefault();
            moveGhost(e.touches[0].clientX, e.touches[0].clientY);
        }

        function moveGhost(x: number, y: number) {
            const ghost = document.getElementById("drag-ghost");
            ghost!.style.left = `${x - 48}px`;
            ghost!.style.top = `${y - 48}px`;
        }

        function onEnd(e: MouseEvent | TouchEvent) {
            if (!isGhostDragging) return;
            isGhostDragging = false;
            const ghost = document.getElementById("drag-ghost");
            const targetOverlay = document.getElementById("map-target-overlay");
            ghost!.style.opacity = "0";
            targetOverlay!.style.opacity = "0";

            const clientX =
                (e as MouseEvent).clientX || (e as TouchEvent).changedTouches[0].clientX;
            const clientY =
                (e as MouseEvent).clientY || (e as TouchEvent).changedTouches[0].clientY;

            const point = map.mouseEventToContainerPoint({ clientX, clientY } as MouseEvent);
            const latlng = map.containerPointToLatLng(point);
            spawnImpact(latlng);

            window.removeEventListener("mousemove", onMove);
            window.removeEventListener("mouseup", onEnd);
            window.removeEventListener("touchmove", onTouchMove);
            window.removeEventListener("touchend", onEnd);
        }
    }

    function setupPersonDrag() {
        const sourceDesktop = document.getElementById("drag-person-desktop");
        const sourceMobile = document.getElementById("drag-person-mobile");

        const attachDrag = (source: HTMLElement | null) => {
            if (!source) return;
            const start = (e: MouseEvent | TouchEvent) => {
                e.preventDefault();
                const x = (e as MouseEvent).clientX || (e as TouchEvent).touches[0].clientX;
                const y = (e as MouseEvent).clientY || (e as TouchEvent).touches[0].clientY;

                isPersonDragging = true;
                const ghost = document.getElementById("drag-person-ghost");
                ghost!.style.opacity = "1";
                ghost!.style.left = `${x - 32}px`;
                ghost!.style.top = `${y - 32}px`;

                window.addEventListener("mousemove", onMove);
                window.addEventListener("mouseup", onEnd);
                window.addEventListener("touchmove", onTouchMove, { passive: false });
                window.addEventListener("touchend", onEnd);
            };
            source.addEventListener("mousedown", start);
            source.addEventListener("touchstart", start);
        };

        attachDrag(sourceDesktop);
        attachDrag(sourceMobile);

        function onMove(e: MouseEvent) {
            if (!isPersonDragging) return;
            const ghost = document.getElementById("drag-person-ghost");
            ghost!.style.left = `${e.clientX - 32}px`;
            ghost!.style.top = `${e.clientY - 32}px`;
        }

        function onTouchMove(e: TouchEvent) {
            if (!isPersonDragging) return;
            e.preventDefault();
            const ghost = document.getElementById("drag-person-ghost");
            ghost!.style.left = `${e.touches[0].clientX - 32}px`;
            ghost!.style.top = `${e.touches[0].clientY - 32}px`;
        }

        function onEnd(e: MouseEvent | TouchEvent) {
            if (!isPersonDragging) return;
            isPersonDragging = false;
            const ghost = document.getElementById("drag-person-ghost");
            ghost!.style.opacity = "0";

            const clientX =
                (e as MouseEvent).clientX || (e as TouchEvent).changedTouches[0].clientX;
            const clientY =
                (e as MouseEvent).clientY || (e as TouchEvent).changedTouches[0].clientY;

            const point = map.mouseEventToContainerPoint({ clientX, clientY } as MouseEvent);
            const latlng = map.containerPointToLatLng(point);
            updateUserLocation(latlng);

            window.removeEventListener("mousemove", onMove);
            window.removeEventListener("mouseup", onEnd);
            window.removeEventListener("touchmove", onTouchMove);
            window.removeEventListener("touchend", onEnd);
        }
    }

    function updateUserLocation(latlng: L.LatLng) {
        userPos = { lat: latlng.lat, lng: latlng.lng };

        if (userMarker) {
            userMarker.setLatLng(latlng);
        } else {
            const iconHtml = document.getElementById("icon-person")?.innerHTML || "";
            const pIcon = L.divIcon({
                className: "bg-transparent border-none",
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                html: iconHtml,
            });

            userMarker = L.marker(latlng, {
                icon: pIcon,
                draggable: true,
                zIndexOffset: 1000,
            }).addTo(map);

            userMarker.on("dragstart", () => {
                map.dragging.disable();
            });
            userMarker.on("drag", (e) => {
                const newPos = (e.target as L.Marker).getLatLng();
                userPos = { lat: newPos.lat, lng: newPos.lng };
                updateVerdict();
            });
            userMarker.on("dragend", () => {
                map.dragging.enable();
                updateVerdict();
            });
        }

        document.getElementById("gps-text")!.textContent = "Manual";
        document.getElementById("gps-dot")!.classList.add("bg-blue-500", "animate-pulse");
        document.getElementById("gps-dot")!.classList.remove("bg-slate-400", "bg-green-500");

        updateVerdict();
    }

    function spawnImpact(latlng: L.LatLng) {
        const impactConfig = { ...config };

        const physics = ImpactPhysics.calculate({
            diameter: impactConfig.diameter,
            velocity: impactConfig.velocity * 1000,
            composition: impactConfig.composition,
            distance: 0,
        });

        const id = Date.now().toString();
        const group = L.layerGroup();

        renderCircles(latlng, physics, group);
        group.addTo(map);

        let color = "#64748b";
        if (impactConfig.composition === "ice") color = "#67e8f9";
        if (impactConfig.composition === "iron") color = "#1e293b";

        const markerIcon = L.divIcon({
            className: "bg-transparent border-none",
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            html: `<div class="w-8 h-8 rounded-full shadow-lg border-2 border-white flex items-center justify-center cursor-grab active:cursor-grabbing hover:scale-125 transition-transform duration-200" style="background-color: ${color}">
                    <div class="w-2 h-2 bg-white rounded-full opacity-50"></div>
                   </div>`,
        });

        const marker = L.marker(latlng, { icon: markerIcon, draggable: true }).addTo(map);

        const impactObj = { id, circles: group, marker, data: physics, config: impactConfig };
        impacts.push(impactObj);

        marker.on("click", () => {
            showInfo(impactObj);
        });

        marker.on("dragstart", () => {
            isDraggingMarker = true;
            map.dragging.disable();
            closeInfoPanel();
        });

        marker.on("drag", (e) => {
            const newPos = (e.target as L.Marker).getLatLng();
            group.clearLayers();
            renderCircles(newPos, physics, group);
            updateVerdict();
        });

        marker.on("dragend", (e) => {
            isDraggingMarker = false;
            map.dragging.enable();
            const newPos = (e.target as L.Marker).getLatLng();
            group.clearLayers();
            renderCircles(newPos, physics, group);
            showInfo(impactObj);
            updateVerdict();
        });

        updateVerdict();
    }

    function renderCircles(latlng: L.LatLng, physics: any, group: L.LayerGroup) {
        L.circle(latlng, {
            radius: physics.craterDiameter / 2,
            color: "#ef4444",
            fillColor: "#ef4444",
            fillOpacity: 0.6,
            weight: 0,
        }).addTo(group);
        L.circle(latlng, {
            radius: physics.thermalRadius,
            color: "#f97316",
            fillColor: "#f97316",
            fillOpacity: 0.15,
            weight: 1,
            dashArray: "5 5",
        }).addTo(group);
        L.circle(latlng, {
            radius: physics.shockwave1psi,
            color: "#3b82f6",
            fillColor: "#3b82f6",
            fillOpacity: 0.05,
            weight: 1,
        }).addTo(group);
    }

    function showInfo(impact: { id: string; data: any; config: typeof config }) {
        const panel = document.getElementById("info-panel");

        document.getElementById("info-energy")!.textContent = impact.data.megatons.toFixed(1);
        document.getElementById("info-crater")!.textContent =
            (impact.data.craterDiameter / 1000).toFixed(2) + " km";
        document.getElementById("info-thermal")!.textContent =
            (impact.data.thermalRadius / 1000).toFixed(2) + " km";
        document.getElementById("info-shock")!.textContent =
            (impact.data.shockwave1psi / 1000).toFixed(2) + " km";

        const dot = document.getElementById("info-dot");
        let colorClass = "bg-slate-500";
        if (impact.config.composition === "ice") colorClass = "bg-cyan-300";
        if (impact.config.composition === "iron") colorClass = "bg-slate-800";
        dot!.className = `w-3 h-3 rounded-full shadow-sm ${colorClass}`;

        document.getElementById("info-type")!.textContent = impact.config.composition.toUpperCase();

        panel!.classList.remove("translate-x-10", "opacity-0");
        document.getElementById("close-info")!.onclick = closeInfoPanel;

        const delBtn = document.getElementById("delete-info");
        const newDelBtn = delBtn!.cloneNode(true);
        delBtn!.parentNode!.replaceChild(newDelBtn, delBtn!);

        newDelBtn.addEventListener("click", () => {
            deleteImpact(impact.id);
            closeInfoPanel();
        });
    }

    function closeInfoPanel() {
        document.getElementById("info-panel")!.classList.add("translate-x-10", "opacity-0");
    }

    function deleteImpact(id: string) {
        const idx = impacts.findIndex((i) => i.id === id);
        if (idx !== -1) {
            map.removeLayer(impacts[idx].circles);
            map.removeLayer(impacts[idx].marker);
            impacts.splice(idx, 1);
            updateVerdict();
        }
    }

    function clearAll() {
        impacts.forEach((i) => {
            map.removeLayer(i.circles);
            map.removeLayer(i.marker);
        });
        impacts.length = 0;
        updateVerdict();
        closeInfoPanel();
    }

    function setupGPS() {
        const btn = document.getElementById("gps-btn");
        btn?.addEventListener("click", () => {
            document.getElementById("gps-text")!.textContent = "Buscando...";
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const ll = new L.LatLng(pos.coords.latitude, pos.coords.longitude);
                    updateUserLocation(ll);
                    document.getElementById("gps-text")!.textContent = "GPS Activo";
                    document.getElementById("gps-dot")!.classList.add("bg-green-500");
                    document.getElementById("gps-dot")!.classList.remove("bg-blue-500");
                    map.flyTo(ll, 9);
                },
                () => {
                    document.getElementById("gps-text")!.textContent = "Error GPS";
                }
            );
        });
    }

    function updateVerdict() {
        const pill = document.getElementById("verdict-pill");
        if (!userPos || impacts.length === 0) {
            pill!.classList.add("opacity-0", "translate-y-[-20px]");
            return;
        }

        let worst = "safe";
        for (const imp of impacts) {
            const d = map.distance(userPos, imp.marker.getLatLng());
            if (d < imp.data.craterDiameter / 2) worst = "vaporized";
            else if (d < imp.data.thermalRadius && worst !== "vaporized") worst = "burned";
            else if (d < imp.data.shockwave1psi && worst === "safe") worst = "shook";
        }

        pill!.classList.remove("opacity-0", "translate-y-[-20px]");

        const container = document.getElementById("verdict-container");
        const vText = document.getElementById("verdict-text");
        const vIcon = document.getElementById("verdict-icon");
        const vLabel = document.getElementById("verdict-label");

        const configs = {
            safe: {
                text: "ZONA SEGURA",
                label: "Sin amenazas detectadas",
                color: "text-emerald-100",
                bg: "bg-emerald-900/90 border-emerald-500/30",
                iconId: "icon-safe",
            },
            shook: {
                text: "ONDA DE CHOQUE",
                label: "Daños estructurales",
                color: "text-blue-400",
                bg: "bg-blue-900/90 border-blue-500/30",
                iconId: "icon-shock",
            },
            burned: {
                text: "RADIACIÓN TÉRMICA",
                label: "Peligro extremo",
                color: "text-orange-400",
                bg: "bg-orange-900/90 border-orange-500/30",
                iconId: "icon-burn",
            },
            vaporized: {
                text: "ZONA CERO",
                label: "Impacto directo",
                color: "text-red-500",
                bg: "bg-red-950/90 border-red-500/50 shadow-red-900/50",
                iconId: "icon-death",
            },
        };

        const c = configs[worst as keyof typeof configs];
        vText!.textContent = c.text;
        vLabel!.textContent = c.label;
        vText!.className = `font-black text-lg italic uppercase font-mono whitespace-nowrap ${c.color} drop-shadow-sm`;
        container!.className = `${c.bg} px-5 py-3 rounded-2xl shadow-xl flex items-center gap-3 backdrop-blur-md border transform transition-all duration-300`;
        const iconSource = document.getElementById(c.iconId);
        vIcon!.innerHTML = iconSource ? iconSource.innerHTML : "";
    }

    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
    else init();
</script>
