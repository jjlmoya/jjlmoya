---
import { IngredientRepository } from "./data/IngredientRepository";

import { Icon } from "astro-icon/components";
import { COCKTAIL_PRESETS } from "./data/Presets";

const allIngredients = IngredientRepository.getAll();
---

<div
    class="cocktail-balancer-app max-w-6xl mx-auto px-4 py-8 text-slate-800 dark:text-slate-100 font-sans"
>
    <div
        class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800"
    >
        <h2 class="text-xl font-bold flex items-center gap-2">
            <span class="text-indigo-500 text-2xl"><Icon name="mdi:scale-balance" /></span>
            Cocktail Balancer <span
                class="text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 rounded-full"
                >v2.0</span
            >
        </h2>

        <div class="flex items-center gap-3">
            <button
                id="open-presets-btn"
                class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 text-slate-600 dark:text-slate-300 rounded-xl transition-colors font-medium text-sm"
            >
                <Icon name="mdi:book-open-page-variant" /> Recetas
            </button>
            <button
                id="save-recipe-btn"
                class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl transition-colors font-bold text-sm shadow-lg shadow-indigo-500/20"
            >
                <Icon name="mdi:content-save" /> Guardar
            </button>
            <button
                id="reset-btn"
                class="flex items-center gap-2 px-4 py-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors text-sm font-bold ml-2"
            >
                <Icon name="mdi:trash-can-outline" />
            </button>
        </div>
    </div>

    <div class="grid lg:grid-cols-12 gap-8 items-start">
        <div class="lg:col-span-7 flex flex-col gap-6">
            <div id="recipe-container" class="space-y-4 min-h-[300px]">
                <div
                    id="empty-state"
                    class="flex flex-col items-center justify-center py-16 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-3xl bg-slate-50/50 dark:bg-slate-800/50"
                >
                    <div
                        class="w-20 h-20 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-500 rounded-full flex items-center justify-center text-4xl mb-4"
                    >
                        <Icon name="mdi:flask-outline" />
                    </div>
                    <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200">
                        Tu Mesa de Trabajo está Vacía
                    </h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-6 max-w-xs text-center">
                        Añade ingredientes para analizar el equilibrio de tu cóctel en tiempo real.
                    </p>
                    <button
                        id="add-first-btn"
                        class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-transform active:scale-95 flex items-center gap-2"
                    >
                        <Icon name="mdi:plus-circle" class="text-xl" /> Añadir Ingrediente
                    </button>
                </div>
            </div>

            <button
                id="open-modal-btn"
                class="hidden w-full py-4 border-2 border-dashed border-slate-300 dark:border-slate-700 text-slate-500 hover:border-indigo-500 hover:text-indigo-500 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 group"
            >
                <Icon
                    name="mdi:plus-circle-outline"
                    class="text-2xl group-hover:scale-110 transition-transform"
                />
                Añadir Otro Ingrediente
            </button>
        </div>

        <div class="lg:col-span-5 space-y-6 sticky top-8">
            <div
                class="bg-white dark:bg-slate-900 rounded-[2rem] p-6 shadow-xl shadow-slate-200/50 dark:shadow-black/40 border border-slate-100 dark:border-slate-800 relative overflow-hidden"
            >
                <div
                    class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"
                >
                </div>

                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">
                        Perfil de Sabor
                    </h3>
                    <div
                        class="px-3 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-xs font-bold text-slate-500"
                        id="stat-abv-badge"
                    >
                        0.0% ABV
                    </div>
                </div>

                <div class="relative w-full aspect-square max-w-[280px] mx-auto">
                    <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-xl">
                        <polygon
                            points="100,20 176,75 147,164 53,164 24,75"
                            fill="none"
                            class="stroke-slate-200 dark:stroke-slate-700"
                            stroke-width="1"></polygon>
                        <polygon
                            points="100,36 161,80 138,151 62,151 39,80"
                            fill="none"
                            class="stroke-slate-100 dark:stroke-slate-800"
                            stroke-width="1"></polygon>
                        <polygon
                            points="100,52 146,85 128,138 72,138 54,85"
                            fill="none"
                            class="stroke-slate-100 dark:stroke-slate-800"
                            stroke-width="1"></polygon>
                        <polygon
                            points="100,68 130,90 119,126 81,126 70,90"
                            fill="none"
                            class="stroke-slate-50 dark:stroke-slate-800/50"
                            stroke-width="1"></polygon>

                        <line
                            x1="100"
                            y1="100"
                            x2="100"
                            y2="20"
                            class="stroke-slate-200 dark:stroke-slate-700"
                            stroke-width="1"></line>

                        <line
                            x1="100"
                            y1="100"
                            x2="176"
                            y2="75"
                            class="stroke-slate-200 dark:stroke-slate-700"
                            stroke-width="1"></line>

                        <line
                            x1="100"
                            y1="100"
                            x2="147"
                            y2="164"
                            class="stroke-slate-200 dark:stroke-slate-700"
                            stroke-width="1"></line>

                        <line
                            x1="100"
                            y1="100"
                            x2="53"
                            y2="164"
                            class="stroke-slate-200 dark:stroke-slate-700"
                            stroke-width="1"></line>

                        <line
                            x1="100"
                            y1="100"
                            x2="24"
                            y2="75"
                            class="stroke-slate-200 dark:stroke-slate-700"
                            stroke-width="1"></line>

                        <polygon
                            id="radar-shape"
                            points="100,100 100,100 100,100 100,100 100,100"
                            class="fill-indigo-500/20 stroke-indigo-500 transition-all duration-700 ease-[cubic-bezier(0.25,0.4,0.25,1)]"
                            stroke-width="2"
                            stroke-linejoin="round"></polygon>

                        <circle
                            id="pt-sweet"
                            cx="100"
                            cy="100"
                            r="3"
                            class="fill-indigo-600 transition-all duration-700 ease-[cubic-bezier(0.25,0.4,0.25,1)]"
                        ></circle>
                        <circle
                            id="pt-bitter"
                            cx="100"
                            cy="100"
                            r="3"
                            class="fill-indigo-600 transition-all duration-700 ease-[cubic-bezier(0.25,0.4,0.25,1)]"
                        ></circle>
                        <circle
                            id="pt-complex"
                            cx="100"
                            cy="100"
                            r="3"
                            class="fill-indigo-600 transition-all duration-700 ease-[cubic-bezier(0.25,0.4,0.25,1)]"
                        ></circle>
                        <circle
                            id="pt-alc"
                            cx="100"
                            cy="100"
                            r="3"
                            class="fill-indigo-600 transition-all duration-700 ease-[cubic-bezier(0.25,0.4,0.25,1)]"
                        ></circle>
                        <circle
                            id="pt-acid"
                            cx="100"
                            cy="100"
                            r="3"
                            class="fill-indigo-600 transition-all duration-700 ease-[cubic-bezier(0.25,0.4,0.25,1)]"
                        ></circle>
                    </svg>

                    <span
                        class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 text-[10px] uppercase font-bold text-slate-400 tracking-widest bg-white dark:bg-slate-900 px-1"
                        >Dulce</span
                    >
                    <span
                        class="absolute top-[35%] right-0 translate-x-2 text-[10px] uppercase font-bold text-slate-400 tracking-widest"
                        >Amargo</span
                    >
                    <span
                        class="absolute bottom-[15%] right-0 translate-x-2 text-[10px] uppercase font-bold text-slate-400 tracking-widest"
                        >Complejo</span
                    >
                    <span
                        class="absolute bottom-[15%] left-0 -translate-x-2 text-[10px] uppercase font-bold text-slate-400 tracking-widest"
                        >Alcohol</span
                    >
                    <span
                        class="absolute top-[35%] left-0 -translate-x-4 text-[10px] uppercase font-bold text-slate-400 tracking-widest"
                        >Ácido</span
                    >
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div
                    class="bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 text-center"
                >
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Volumen</div>
                    <div class="text-xl font-black text-slate-700 dark:text-slate-200">
                        <span id="stat-vol">0</span><span
                            class="text-xs font-normal text-slate-400 ml-1">ml</span
                        >
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 text-center"
                >
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Azúcar</div>
                    <div class="text-xl font-black text-amber-500">
                        <span id="stat-sugar">0</span><span
                            class="text-xs font-normal text-slate-400 ml-1">g</span
                        >
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 flex flex-col items-center justify-center"
                >
                    <div class="text-xs text-slate-400 uppercase font-bold mb-2">Color</div>
                    <div
                        class="w-8 h-8 rounded-full shadow-inner ring-2 ring-slate-100 dark:ring-slate-700 overflow-hidden relative"
                    >
                        <div
                            id="sim-color-bg"
                            class="absolute inset-0 bg-transparent transition-colors duration-500"
                        >
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="bg-white dark:bg-slate-900 rounded-[2rem] p-6 shadow-xl shadow-slate-200/50 dark:shadow-black/40 border border-slate-100 dark:border-slate-800"
            >
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest">
                        Ley del Sour
                    </h3>
                    <div id="balance-verdict" class="text-base font-black text-slate-300">--</div>
                </div>

                <div class="relative h-4 bg-slate-100 dark:bg-slate-800 rounded-full mb-8 mx-2">
                    <div
                        class="absolute left-0 top-0 h-full w-[30%] bg-gradient-to-r from-lime-500/20 to-lime-500/5 rounded-l-full"
                    >
                    </div>
                    <div
                        class="absolute right-0 top-0 h-full w-[30%] bg-gradient-to-l from-amber-500/20 to-amber-500/5 rounded-r-full"
                    >
                    </div>
                    <div
                        class="absolute left-1/2 top-0 h-full w-1 bg-slate-300/50 -translate-x-1/2"
                    >
                    </div>

                    <div
                        id="balance-needle"
                        class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-6 h-6 bg-white dark:bg-slate-700 border-4 border-slate-800 dark:border-white rounded-full shadow-lg transition-all duration-500 z-10"
                        style="left: 50%;"
                    >
                    </div>
                </div>

                <div
                    class="flex justify-between text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1"
                >
                    <span class="text-lime-600">Ácido (Dry)</span>
                    <span class="text-slate-300">Equilibrio</span>
                    <span class="text-amber-600">Dulce (Sweet)</span>
                </div>
            </div>

            <div
                id="fix-box"
                class="hidden bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-2xl p-5 animate-fade-in"
            >
                <div class="flex gap-4">
                    <div
                        class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 flex-shrink-0 flex items-center justify-center text-xl"
                    >
                        <Icon name="mdi:lightbulb-on-outline" />
                    </div>
                    <div>
                        <h4 class="font-bold text-indigo-900 dark:text-indigo-200 mb-1">
                            Sugerencia de la IA
                        </h4>
                        <p
                            id="fix-text"
                            class="text-sm text-indigo-800/80 dark:text-indigo-300 leading-relaxed"
                        >
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <dialog
        id="ingredient-modal"
        class="m-auto backdrop:bg-slate-900/40 backdrop:backdrop-blur-sm bg-transparent p-0 w-full max-w-2xl text-left rounded-3xl shadow-2xl open:animate-zoom-in"
    >
        <div
            class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3xl overflow-hidden shadow-2xl max-h-[85vh] flex flex-col"
        >
            <div
                class="p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50/80 dark:bg-slate-900/80 backdrop-blur sticky top-0 z-10"
            >
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Añadir Ingrediente</h3>
                    <button
                        id="close-modal-btn"
                        class="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition-colors"
                    >
                        <Icon name="mdi:close" class="text-xl" />
                    </button>
                </div>
                <div class="relative">
                    <Icon
                        name="mdi:magnify"
                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xl"
                    />
                    <input
                        type="text"
                        id="modal-search"
                        placeholder="Buscar ron, lima, sirope..."
                        class="w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors"
                    />
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {
                        allIngredients.map((ing) => (
                            <button
                                class="ingredient-select-btn flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 border border-transparent hover:border-indigo-200 dark:hover:border-indigo-800 rounded-xl transition-all text-left group"
                                data-id={ing.id}
                            >
                                <div
                                    class={`w-10 h-10 rounded-lg flex items-center justify-center text-lg shadow-sm
                                ${
                                    ing.type === "spirit"
                                        ? "bg-indigo-100 text-indigo-600"
                                        : ing.type === "citrus"
                                          ? "bg-lime-100 text-lime-600"
                                          : ing.type === "syrup"
                                            ? "bg-amber-100 text-amber-600"
                                            : "bg-slate-200 text-slate-600"
                                }`}
                                >
                                    <Icon
                                        name={
                                            ing.type === "spirit"
                                                ? "mdi:glass-cocktail"
                                                : ing.type === "citrus"
                                                  ? "mdi:fruit-citrus"
                                                  : ing.type === "syrup"
                                                    ? "mdi:spoon-sugar"
                                                    : ing.type === "bitter"
                                                      ? "mdi:water-percent"
                                                      : "mdi:bottle-tonic"
                                        }
                                    />
                                </div>
                                <div>
                                    <div class="font-bold text-slate-700 dark:text-slate-200 group-hover:text-indigo-700 dark:group-hover:text-indigo-300">
                                        {ing.name}
                                    </div>
                                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">
                                        {ing.type} • {ing.abv}%
                                    </div>
                                </div>
                            </button>
                        ))
                    }
                </div>
            </div>
        </div>
    </dialog>

    <dialog
        id="presets-modal"
        class="m-auto backdrop:bg-slate-900/40 backdrop:backdrop-blur-sm bg-transparent p-0 w-full max-w-4xl text-left rounded-3xl shadow-2xl open:animate-zoom-in"
    >
        <div
            class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3xl overflow-hidden shadow-2xl max-h-[85vh] flex flex-col"
        >
            <div
                class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center"
            >
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <Icon name="mdi:book-open-variant" class="text-indigo-500" /> Recetas & Presets
                </h3>
                <button
                    id="close-presets-btn"
                    class="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full"
                    ><Icon name="mdi:close" /></button
                >
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-slate-50 dark:bg-black/20">
                <div id="saved-section" class="mb-8 hidden">
                    <h4 class="text-xs font-bold uppercase text-slate-400 tracking-widest mb-4">
                        Mis Guardadas
                    </h4>
                    <div
                        id="saved-grid"
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                    >
                    </div>
                </div>

                <h4 class="text-xs font-bold uppercase text-slate-400 tracking-widest mb-4">
                    Clásicos
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {
                        COCKTAIL_PRESETS.map((p) => (
                            <button
                                class="preset-load-btn flex flex-col gap-2 p-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-indigo-500 rounded-xl text-left transition-all shadow-sm hover:shadow-md"
                                data-preset-id={p.id}
                            >
                                <div class="flex items-center gap-2 text-indigo-500 mb-1">
                                    <Icon name={p.icon} />{" "}
                                    <span class="font-bold text-slate-800 dark:text-white">
                                        {p.name}
                                    </span>
                                </div>
                                <p class="text-xs text-slate-500 line-clamp-2">{p.description}</p>
                            </button>
                        ))
                    }
                </div>
            </div>
        </div>
    </dialog>

    <dialog
        id="confirm-modal"
        class="m-auto backdrop:bg-slate-900/40 backdrop:backdrop-blur-sm bg-transparent p-0 w-full max-w-sm text-center rounded-3xl shadow-2xl open:animate-zoom-in"
    >
        <div
            class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3xl p-6 flex flex-col items-center gap-4"
        >
            <div
                class="w-16 h-16 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center text-3xl mb-2"
            >
                <Icon name="mdi:alert-circle-outline" />
            </div>
            <div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">¿Borrar todo?</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm mt-2">
                    Esta acción eliminará todos los ingredientes de tu mesa de trabajo. No se puede
                    deshacer.
                </p>
            </div>
            <div class="flex gap-3 w-full mt-2">
                <button
                    id="cancel-reset-btn"
                    class="flex-1 py-3 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-xl font-bold transition-colors"
                >
                    Cancelar
                </button>
                <button
                    id="confirm-reset-btn"
                    class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold transition-colors shadow-lg shadow-red-500/20"
                >
                    Borrar
                </button>
            </div>
        </div>
    </dialog>

    <div style="display:none">
        <div id="tpl-icon-trash"><Icon name="mdi:trash-can-outline" /></div>
    </div>
</div>

<script>
    import { IngredientRepository } from "./data/IngredientRepository";
    import { BalanceCalculator } from "./services/BalanceCalculator";
    import { COCKTAIL_PRESETS } from "./data/Presets";

    interface RecipeItem {
        uId: string;
        id: string;
        vol: number;
    }

    interface SavedRecipe {
        id: number;
        name: string;
        recipe: RecipeItem[];
        date: string;
    }

    class CocktailApp {
        recipe: RecipeItem[] = [];
        STORAGE_KEY = "cocktail_tool_current";
        SAVED_KEY = "cocktail_tool_saved";

        constructor() {
            this.init();
        }

        init() {
            this.bindEvents();
            this.loadState();
        }

        loadState() {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (saved) {
                try {
                    this.recipe = JSON.parse(saved);
                } catch (e) {
                    this.recipe = [];
                }
            }
            this.refreshUI();
        }

        saveState() {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.recipe));
        }

        addIngredient(id: string) {
            const ing = IngredientRepository.getById(id.toString());
            if (!ing) return;

            let vol = 30;
            if (ing.type === "spirit") vol = 45;
            if (ing.type === "citrus") vol = 22.5;
            if (ing.type === "syrup") vol = 15;
            if (ing.type === "bitter") vol = 2;

            this.recipe.push({
                uId: Math.random().toString(36).substr(2, 9),
                id: id.toString(),
                vol: vol,
            });

            this.saveState();
            this.refreshUI();
        }

        removeIngredient(uId: string) {
            this.recipe = this.recipe.filter((item) => item.uId !== uId);
            this.saveState();
            this.refreshUI();
        }

        updateVolume(uId: string, newVol: string) {
            const item = this.recipe.find((i) => i.uId === uId);
            if (item) {
                item.vol = parseFloat(newVol);
                this.saveState();
                this.updateDashboard();
            }
        }

        reset() {
            const modal = document.getElementById("confirm-modal") as HTMLDialogElement;
            if (modal) modal.showModal();
        }

        refreshUI() {
            this.renderList();
            this.updateDashboard();
            this.updateControlsVisibility();
        }

        renderList() {
            const container = document.getElementById("recipe-container")!;
            const emptyState = document.getElementById("empty-state")!;

            if (this.recipe.length === 0) {
                emptyState.style.display = "flex";
                Array.from(container.children).forEach((child) => {
                    if (child.id !== "empty-state") child.remove();
                });
                return;
            } else {
                emptyState.style.display = "none";
            }

            Array.from(container.children).forEach((child) => {
                if (child.id !== "empty-state") child.remove();
            });

            const trashIcon = document.getElementById("tpl-icon-trash")!.innerHTML;

            this.recipe.forEach((item) => {
                const ing = IngredientRepository.getById(item.id);
                if (!ing) return;

                const row = document.createElement("div");
                row.className =
                    "bg-white dark:bg-slate-900 rounded-2xl p-4 shadow-sm border border-slate-100 dark:border-slate-800 animate-slide-up";
                row.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="font-bold text-slate-700 dark:text-slate-200">${ing.name}</div>
                            <span class="text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-slate-500 font-bold uppercase">${ing.type}</span>
                        </div>
                        <button class="text-slate-300 hover:text-red-500 transition-colors btn-remove" data-uid="${item.uId}">${trashIcon}</button>
                    </div>
                    <div class="flex items-center gap-4">
                        <input type="range" class="flex-1 input-range accent-indigo-600 h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer"
                            min="0" max="90" step="0.5" value="${item.vol}" data-uid="${item.uId}">
                        <div class="relative w-20">
                            <input type="number" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 text-right font-mono font-bold text-slate-700 dark:text-gray-200 focus:outline-none focus:border-indigo-500 input-number"
                             value="${item.vol}" data-uid="${item.uId}">
                            <span class="absolute right-8 top-1/2 -translate-y-1/2 text-xs text-slate-400 pointer-events-none">ml</span>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });

            container.querySelectorAll<HTMLElement>(".btn-remove").forEach((b) => {
                b.addEventListener("click", (e) =>
                    this.removeIngredient((e.currentTarget as HTMLElement).dataset.uid!)
                );
            });
            container
                .querySelectorAll<HTMLInputElement>(".input-range, .input-number")
                .forEach((i) => {
                    i.addEventListener("input", (e) =>
                        this.updateVolume(
                            (e.target as HTMLElement).dataset.uid!,
                            (e.target as HTMLInputElement).value
                        )
                    );
                });
        }

        updateDashboard() {
            const calcItems = this.recipe
                .map((r) => ({
                    ingredient: IngredientRepository.getById(r.id),
                    volumeMl: r.vol,
                }))
                .filter((c) => c.ingredient && c.ingredient !== undefined) as {
                ingredient: any;
                volumeMl: number;
            }[];

            const stats = BalanceCalculator.calculate(calcItems);

            const volEl = document.getElementById("stat-vol");
            if (volEl) volEl.innerText = Math.round(stats.totalVolumeMl).toString();

            const abvBadge = document.getElementById("stat-abv-badge");
            if (abvBadge) abvBadge.innerText = stats.finalAbv.toFixed(1) + "% ABV";

            const sugarEl = document.getElementById("stat-sugar");
            if (sugarEl) sugarEl.innerText = Math.round(stats.totalSugarGrams).toString();

            const colorEl = document.getElementById("sim-color-bg");
            if (colorEl) colorEl.style.backgroundColor = stats.finalColor;

            this.renderRadar(stats);

            const verdict = BalanceCalculator.getBalanceDescription(stats);
            const verdictEl = document.getElementById("balance-verdict");
            const needleEl = document.getElementById("balance-needle");

            if (verdictEl && needleEl) {
                if (this.recipe.length === 0) {
                    verdictEl.innerText = "--";
                    verdictEl.className = "text-base font-black text-slate-300";
                    needleEl.style.left = "50%";
                } else {
                    verdictEl.innerText = verdict.label;
                    verdictEl.className = `text-base font-black ${verdict.color}`;

                    let percent = (stats.balanceRatio / 15) * 100;
                    percent = Math.max(2, Math.min(98, percent));
                    needleEl.style.left = `${percent}%`;
                }
            }

            const fixBox = document.getElementById("fix-box");
            const fixText = document.getElementById("fix-text");
            if (fixBox && fixText) {
                if (this.recipe.length > 0 && (stats.balanceRatio < 5 || stats.balanceRatio > 10)) {
                    fixBox.classList.remove("hidden");
                    const fix = BalanceCalculator.getFixSuggestion(stats);
                    if (fix) {
                        const actionText = fix.action === "add_sugar" ? "Muy Ácido" : "Muy Dulce";
                        fixText.innerHTML = `<strong class="text-indigo-600">${actionText}:</strong> Prueba añadiendo <span class="font-mono bg-white px-1 rounded border border-indigo-100">${fix.amount}</span>.`;
                    }
                } else {
                    fixBox.classList.add("hidden");
                }
            }
        }

        renderRadar(stats: any) {
            const R = 80;
            const C = 100;
            const rad = (deg: number) => (deg * Math.PI) / 180;

            const vSweet = Math.min((stats.sugarConcentration / 18) * 100, 100);
            const vBitter = Math.min((stats.bitternessIndex / 8) * 100, 100);
            const vComplex = Math.min((stats.complexityIndex / 8) * 100, 100);
            const vAlc = Math.min((stats.finalAbv / 40) * 100, 100);
            const vAcid = Math.min((stats.acidConcentration / 1.5) * 100, 100);

            const getPt = (val: number, deg: number) => ({
                x: C + (val / 100) * R * Math.cos(rad(deg)),
                y: C + (val / 100) * R * Math.sin(rad(deg)),
            });

            const pSweet = getPt(vSweet, -90);
            const pBitter = getPt(vBitter, -18);
            const pComplex = getPt(vComplex, 54);
            const pAlc = getPt(vAlc, 126);
            const pAcid = getPt(vAcid, 198);

            const shape = document.getElementById("radar-shape");
            if (shape) {
                shape.setAttribute(
                    "points",
                    `${pSweet.x},${pSweet.y} ${pBitter.x},${pBitter.y} ${pComplex.x},${pComplex.y} ${pAlc.x},${pAlc.y} ${pAcid.x},${pAcid.y}`
                );
            }

            const setDot = (id: string, pt: { x: number; y: number }) => {
                const el = document.getElementById(id);
                if (el) {
                    el.setAttribute("cx", pt.x.toString());
                    el.setAttribute("cy", pt.y.toString());
                }
            };
            setDot("pt-sweet", pSweet);
            setDot("pt-bitter", pBitter);
            setDot("pt-complex", pComplex);
            setDot("pt-alc", pAlc);
            setDot("pt-acid", pAcid);
        }

        updateControlsVisibility() {
            const addBtn = document.getElementById("open-modal-btn")!;
            if (this.recipe.length > 0) addBtn.classList.remove("hidden");
            else addBtn.classList.add("hidden");
        }

        bindEvents() {
            const ingModal = document.getElementById("ingredient-modal") as HTMLDialogElement;
            const presetsModal = document.getElementById("presets-modal") as HTMLDialogElement;

            const openIng = () => {
                ingModal.showModal();
                const search = document.getElementById("modal-search");
                if (search) search.focus();
            };
            document.getElementById("open-modal-btn")!.onclick = openIng;
            document.getElementById("add-first-btn")!.onclick = openIng;
            document.getElementById("close-modal-btn")!.onclick = () => ingModal.close();

            document.getElementById("open-presets-btn")!.onclick = () => {
                this.renderSavedRecipes();
                presetsModal.showModal();
            };
            document.getElementById("close-presets-btn")!.onclick = () => presetsModal.close();

            [ingModal, presetsModal].forEach((m) => {
                m.addEventListener("click", (e) => {
                    const rect = m.getBoundingClientRect();
                    if (
                        e.clientY < rect.top ||
                        e.clientY > rect.bottom ||
                        e.clientX < rect.left ||
                        e.clientX > rect.right
                    ) {
                        m.close();
                    }
                });
            });

            document.getElementById("modal-search")!.addEventListener("input", (e) => {
                const term = (e.target as HTMLInputElement).value.toLowerCase();
                document.querySelectorAll<HTMLElement>(".ingredient-select-btn").forEach((btn) => {
                    const text = btn.innerText.toLowerCase();
                    btn.style.display = text.includes(term) ? "flex" : "none";
                });
            });

            document.querySelectorAll<HTMLElement>(".ingredient-select-btn").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    this.addIngredient(btn.dataset.id!);
                    ingModal.close();

                    const search = document.getElementById("modal-search") as HTMLInputElement;
                    if (search) search.value = "";
                    document
                        .querySelectorAll<HTMLElement>(".ingredient-select-btn")
                        .forEach((b) => (b.style.display = "flex"));
                });
            });

            document.getElementById("reset-btn")!.onclick = () => this.reset();

            document.getElementById("save-recipe-btn")!.onclick = () => this.saveToBook();

            document.querySelectorAll<HTMLElement>(".preset-load-btn").forEach((btn) => {
                btn.onclick = () => this.loadPreset(btn.dataset.presetId!);
            });

            const confirmModal = document.getElementById("confirm-modal") as HTMLDialogElement;
            document.getElementById("cancel-reset-btn")!.onclick = () => confirmModal.close();
            document.getElementById("confirm-reset-btn")!.onclick = () => {
                this.recipe = [];
                this.saveState();
                this.refreshUI();
                confirmModal.close();
            };

            confirmModal.addEventListener("click", (e) => {
                const rect = confirmModal.getBoundingClientRect();
                if (
                    e.clientY < rect.top ||
                    e.clientY > rect.bottom ||
                    e.clientX < rect.left ||
                    e.clientX > rect.right
                ) {
                    confirmModal.close();
                }
            });
        }

        saveToBook() {
            if (this.recipe.length === 0) return alert("Nada que guardar.");
            const name = prompt("Nombre de tu receta:");
            if (!name) return;

            const saved = JSON.parse(localStorage.getItem(this.SAVED_KEY) || "[]");
            saved.push({
                id: Date.now(),
                name,
                recipe: this.recipe,
                date: new Date().toLocaleDateString(),
            });
            localStorage.setItem(this.SAVED_KEY, JSON.stringify(saved));
            alert("Guardado!");
        }

        renderSavedRecipes() {
            const container = document.getElementById("saved-grid")!;
            const section = document.getElementById("saved-section")!;
            const saved: SavedRecipe[] = JSON.parse(localStorage.getItem(this.SAVED_KEY) || "[]");

            if (saved.length === 0) {
                section.classList.add("hidden");
                return;
            }
            section.classList.remove("hidden");
            container.innerHTML = saved
                .map(
                    (r) => `
                <div class="saved-recipe-card bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-indigo-500 group relative" data-id="${r.id}">
                    <div class="font-bold text-slate-700 dark:text-slate-200">${r.name}</div>
                    <div class="text-xs text-slate-400">${r.recipe.length} ingredientes • ${r.date}</div>
                    <button class="absolute top-2 right-2 text-slate-300 hover:text-red-500 delete-saved p-2" data-id="${r.id}">
                        ${document.getElementById("tpl-icon-trash")!.innerHTML}
                    </button>
                </div>
            `
                )
                .join("");

            container.querySelectorAll<HTMLElement>(".saved-recipe-card").forEach((card) => {
                card.addEventListener("click", (e) => {
                    const target = e.target as HTMLElement;
                    if (target.closest(".delete-saved")) return;
                    this.loadSaved(card.dataset.id!);
                });
            });
            container.querySelectorAll<HTMLElement>(".delete-saved").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    if (confirm("Borrar?")) {
                        const savedList: SavedRecipe[] = JSON.parse(
                            localStorage.getItem(this.SAVED_KEY)!
                        );
                        const newSaved = savedList.filter((s) => s.id != parseInt(btn.dataset.id!));
                        localStorage.setItem(this.SAVED_KEY, JSON.stringify(newSaved));
                        this.renderSavedRecipes();
                    }
                });
            });
        }

        loadSaved(id: string) {
            const saved: SavedRecipe[] = JSON.parse(localStorage.getItem(this.SAVED_KEY) || "[]");
            const r = saved.find((s) => s.id == parseInt(id));
            if (r) {
                this.recipe = r.recipe;
                this.saveState();
                this.refreshUI();
                (document.getElementById("presets-modal") as HTMLDialogElement).close();
            }
        }

        loadPreset(presetId: string) {
            const p = COCKTAIL_PRESETS.find((x) => x.id === presetId);
            if (p) {
                this.recipe = p.ingredients.map((pi) => ({
                    uId: Math.random().toString(36).substr(2, 9),
                    id: pi.id,
                    vol: pi.vol,
                }));
                this.saveState();
                this.refreshUI();
                (document.getElementById("presets-modal") as HTMLDialogElement).close();
            }
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        new CocktailApp();
    });
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #334155;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .animate-slide-up {
        animation: slideUp 0.3s ease-out forwards;
    }

    @keyframes zoomIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    .open\:animate-zoom-in[open] {
        animation: zoomIn 0.2s ease-out forwards;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: #4f46e5;
        margin-top: -6px;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: #e2e8f0;
        border-radius: 2px;
    }
    .dark input[type="range"]::-webkit-slider-runnable-track {
        background: #334155;
    }
</style>
