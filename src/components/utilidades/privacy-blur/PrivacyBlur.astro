---
import { Icon } from "astro-icon/components";
---

<div class="w-full max-w-6xl mx-auto px-4 py-8 flex flex-col gap-6">
    <div
        class="sticky top-4 z-40 bg-white/90 dark:bg-zinc-900/90 backdrop-blur-xl rounded-2xl p-4 shadow-2xl border border-white/20 ring-1 ring-black/5 flex flex-col md:flex-row items-center justify-between gap-4 transition-all duration-300"
        id="controlsPanel"
    >
        <div
            class="flex items-center justify-center w-full md:w-auto gap-2 p-1.5 bg-zinc-100 dark:bg-zinc-800 rounded-xl overflow-x-auto"
        >
            <button
                title="Pixelar"
                class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all bg-white dark:bg-zinc-700 shadow-sm text-zinc-900 dark:text-white tool-btn min-w-[90px]"
                data-tool="pixel"
            >
                <Icon name="mdi:grid" class="w-4 h-4" />
                <span class="inline">Pixel</span>
            </button>
            <button
                title="Desenfocar"
                class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all text-zinc-500 hover:text-zinc-900 dark:hover:text-zinc-200 tool-btn min-w-[90px]"
                data-tool="blur"
            >
                <Icon name="mdi:blur" class="w-4 h-4" />
                <span class="inline">Blur</span>
            </button>
            <button
                title="Sólido"
                class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all text-zinc-500 hover:text-zinc-900 dark:hover:text-zinc-200 tool-btn min-w-[90px]"
                data-tool="solid"
            >
                <Icon name="mdi:square" class="w-4 h-4" />
                <span class="inline">Tapado</span>
            </button>
        </div>

        <div
            class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start px-2 md:px-0"
        >
            <div class="flex items-center gap-3 flex-1 md:flex-initial">
                <Icon name="mdi:tune" class="w-5 h-5 text-zinc-400 flex-shrink-0" />
                <div class="relative w-full md:w-[150px] flex items-center">
                    <input
                        type="range"
                        id="intensity"
                        min="0"
                        max="50"
                        value="10"
                        class="w-full h-2 bg-zinc-200 dark:bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-indigo-600 active:accent-indigo-500 touch-none"
                        aria-label="Intensidad del efecto"
                    />
                </div>
            </div>

            <div class="h-8 w-px bg-zinc-200 dark:bg-zinc-700 hidden md:block"></div>

            <button
                id="btnAutoFace"
                class="flex items-center gap-2 px-4 py-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 rounded-xl hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors text-sm font-medium whitespace-nowrap"
                title="Detectar Caras Automáticamente (Local)"
            >
                <Icon name="mdi:face-recognition" class="w-5 h-5 flex-shrink-0" />
                <span class="hidden sm:inline">Auto Detect</span>
            </button>
        </div>

        <div
            class="flex items-center gap-2 w-full md:w-auto justify-between md:justify-end border-t md:border-t-0 border-zinc-100 dark:border-zinc-800 pt-3 md:pt-0"
        >
            <div class="flex items-center gap-2">
                <button
                    id="btnUndo"
                    class="p-2.5 rounded-xl bg-zinc-100 dark:bg-zinc-800 text-zinc-500 hover:text-zinc-900 dark:hover:text-white transition-colors disabled:opacity-30 disabled:cursor-not-allowed hover:bg-zinc-200 dark:hover:bg-zinc-700"
                    title="Deshacer (Ctrl+Z)"
                    disabled
                >
                    <Icon name="mdi:undo" class="w-5 h-5" />
                </button>
            </div>

            <button
                id="btnDownload"
                class="flex-1 md:flex-initial flex items-center justify-center gap-2 px-6 py-2.5 bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 rounded-xl font-bold shadow-lg hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                disabled
            >
                <Icon name="mdi:download" class="w-5 h-5" />
                <span>Guardar</span>
            </button>
        </div>
    </div>

    <div
        id="workspace"
        class="relative min-h-[50vh] md:min-h-[60vh] rounded-3xl border-4 border-dashed border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/50 flex items-center justify-center overflow-hidden transition-all duration-300 group"
    >
        <input type="file" id="uploadInput" accept="image/*" class="hidden" />

        <div
            id="emptyState"
            class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer p-6 transition-all duration-300 hover:bg-zinc-100 dark:hover:bg-zinc-800/50"
        >
            <div
                class="w-20 h-20 md:w-24 md:h-24 bg-white dark:bg-zinc-800 rounded-3xl shadow-xl flex items-center justify-center mb-6 group-hover:scale-110 group-hover:rotate-3 transition-all duration-500"
            >
                <Icon
                    name="mdi:cloud-upload"
                    class="w-8 h-8 md:w-10 md:h-10 text-indigo-500 group-hover:text-violet-500 transition-colors"
                />
            </div>

            <h3
                class="text-2xl md:text-3xl font-bold text-zinc-800 dark:text-zinc-100 mb-3 text-center"
            >
                Editor de Privacidad
            </h3>
            <p
                class="text-zinc-500 dark:text-zinc-400 text-center text-base md:text-lg max-w-md mx-auto mb-8"
            >
                Arrastra tu imagen aquí o haz clic para empezar
            </p>

            <div
                class="flex flex-wrap justify-center items-center gap-4 text-xs md:text-sm text-zinc-400 font-medium"
            >
                <span
                    class="flex items-center gap-2 px-3 py-1.5 bg-zinc-200/50 dark:bg-zinc-800/50 rounded-full"
                >
                    <Icon name="mdi:shield-check" class="w-4 h-4 text-green-500" />
                    100% Local
                </span>
                <span
                    class="flex items-center gap-2 px-3 py-1.5 bg-zinc-200/50 dark:bg-zinc-800/50 rounded-full"
                >
                    <Icon name="mdi:flash" class="w-4 h-4 text-amber-500" />
                    Offline
                </span>
            </div>
        </div>

        <div
            id="loader"
            class="hidden absolute inset-0 z-50 bg-white/90 dark:bg-black/90 flex flex-col items-center justify-center backdrop-blur-md transition-opacity"
        >
            <div class="relative">
                <div
                    class="w-16 h-16 border-4 border-indigo-200 dark:border-indigo-900 rounded-full"
                >
                </div>
                <div
                    class="w-16 h-16 border-4 border-t-indigo-600 rounded-full animate-spin absolute inset-0"
                >
                </div>

                <Icon
                    name="mdi:face-recognition"
                    class="w-6 h-6 text-indigo-600 absolute inset-0 m-auto animate-pulse"
                />
            </div>
            <p
                class="mt-6 text-zinc-600 dark:text-zinc-300 font-medium animate-pulse"
                id="loaderText"
            >
                Iniciando...
            </p>
        </div>

        <div
            id="canvasContainer"
            class="hidden relative z-10 p-2 md:p-4 max-w-full max-h-full flex items-center justify-center"
        >
            <canvas
                id="mainCanvas"
                class="max-w-full max-h-[70vh] w-auto h-auto object-contain rounded-lg shadow-2xl ring-1 ring-black/10 crosshair-cursor"
            ></canvas>
        </div>
    </div>
</div>

<script is:inline src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"
></script>

<script>
    import { ImageEditorEngine } from "./ImageEditorEngine";

    document.addEventListener("DOMContentLoaded", () => {
        const engine = new ImageEditorEngine(
            "mainCanvas",
            "loader",
            "loaderText",
            "btnUndo",
            "canvasContainer",
            "emptyState",
            "btnDownload"
        );

        const uploadInput = document.getElementById("uploadInput") as HTMLInputElement;
        const workspace = document.getElementById("workspace") as HTMLElement;

        uploadInput.addEventListener("change", (e) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (file) engine.loadImage(file);
        });

        document.getElementById("emptyState")?.addEventListener("click", () => {
            uploadInput.click();
        });

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
            workspace.addEventListener(
                eventName,
                (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                },
                false
            );
        });

        ["dragenter", "dragover"].forEach(() =>
            workspace.classList.add(
                "border-indigo-500",
                "bg-indigo-50",
                "dark:bg-indigo-900/20",
                "scale-[0.99]"
            )
        );
        ["dragleave", "drop"].forEach(() =>
            workspace.classList.remove(
                "border-indigo-500",
                "bg-indigo-50",
                "dark:bg-indigo-900/20",
                "scale-[0.99]"
            )
        );

        workspace.addEventListener("drop", (e) => {
            const files = e.dataTransfer?.files;
            if (files && files.length > 0) engine.loadImage(files[0]);
        });

        document.querySelectorAll(".tool-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const target = (e.currentTarget as HTMLElement).closest(".tool-btn") as HTMLElement;

                document.querySelectorAll(".tool-btn").forEach((b) => {
                    b.classList.remove(
                        "bg-white",
                        "dark:bg-zinc-700",
                        "shadow-sm",
                        "text-zinc-900",
                        "dark:text-white"
                    );
                    b.classList.add("text-zinc-500");
                });
                target.classList.remove("text-zinc-500");
                target.classList.add(
                    "bg-white",
                    "dark:bg-zinc-700",
                    "shadow-sm",
                    "text-zinc-900",
                    "dark:text-white"
                );

                engine.setTool(target.dataset.tool || "pixel");
            });
        });

        document.getElementById("intensity")?.addEventListener("input", (e) => {
            engine.setIntensity(+(e.target as HTMLInputElement).value);
        });

        document.getElementById("btnUndo")?.addEventListener("click", () => engine.undo());
        document.getElementById("btnDownload")?.addEventListener("click", () => engine.download());
        document
            .getElementById("btnAutoFace")
            ?.addEventListener("click", () => engine.detectFaces());

        document.addEventListener("keydown", (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === "z") {
                e.preventDefault();
                engine.undo();
            }
        });
    });
</script>
