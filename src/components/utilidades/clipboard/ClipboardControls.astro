---
import { Icon } from "astro-icon/components";
---

<div
    id="controls-container"
    class="flex gap-4 mt-8 justify-center hidden opacity-0 transition-opacity duration-500"
>
    <button
        id="btn-clear"
        class="px-6 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors flex items-center gap-2"
    >
        <Icon name="mdi:trash-can-outline" class="w-5 h-5" />
        Limpiar
    </button>

    <button
        id="btn-download"
        class="p-4 rounded-xl bg-[var(--color-accent)] text-white shadow-lg shadow-[var(--color-accent)]/30 hover:shadow-[var(--color-accent)]/50 hover:-translate-y-0.5 transition-all flex items-center justify-center"
        title="Descargar imagen"
    >
        <Icon name="mdi:download" class="w-6 h-6" />
    </button>
</div>

<script>
    const container = document.getElementById("controls-container");
    const btnClear = document.getElementById("btn-clear");
    const btnDownload = document.getElementById("btn-download");

    let currentBlob: Blob | null = null;
    let currentTimestamp: Date | null = null;

    document.addEventListener("clipboard-image-pasted", ((e: CustomEvent) => {
        if (container) {
            currentBlob = e.detail.blob;
            currentTimestamp = e.detail.timestamp;

            container.classList.remove("hidden");

            setTimeout(() => {
                container.classList.remove("opacity-0");
            }, 10);
        }
    }) as EventListener);

    btnClear?.addEventListener("click", () => {
        if (container) {
            container.classList.add("opacity-0");
            setTimeout(() => {
                container.classList.add("hidden");
            }, 500);

            currentBlob = null;
            currentTimestamp = null;
            document.dispatchEvent(new CustomEvent("clipboard-clear"));
        }
    });

    btnDownload?.addEventListener("click", () => {
        if (!currentBlob || !currentTimestamp) return;

        const url = URL.createObjectURL(currentBlob);
        const a = document.createElement("a");

        const year = currentTimestamp.getFullYear();
        const month = String(currentTimestamp.getMonth() + 1).padStart(2, "0");
        const day = String(currentTimestamp.getDate()).padStart(2, "0");
        const hours = String(currentTimestamp.getHours()).padStart(2, "0");
        const minutes = String(currentTimestamp.getMinutes()).padStart(2, "0");
        const seconds = String(currentTimestamp.getSeconds()).padStart(2, "0");

        const filename = `clipboard-${year}-${month}-${day}-${hours}-${minutes}-${seconds}.png`;

        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
</script>
