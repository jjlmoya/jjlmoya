---

---

<div
    class="relative w-full max-w-lg mx-auto bg-slate-900 rounded-[2rem] overflow-hidden shadow-2xl border border-slate-800"
>
    <div class="relative h-64 w-full bg-slate-100 flex items-center justify-center overflow-hidden">
        <img
            src="/images/utilities/cricket-thermometer.png"
            alt="Cricket on Thermometer Watercolor"
            class="object-cover w-full h-full"
        />
        <div
            class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent opacity-90"
        >
        </div>
    </div>

    <div class="p-8 -mt-20 relative z-10 flex flex-col items-center">
        <div class="relative mb-8 group">
            <div
                class="absolute -inset-4 bg-emerald-500/20 rounded-full blur-2xl transition-opacity opacity-0 group-[.has-value]:opacity-100 duration-1000"
            >
            </div>

            <div
                class="w-48 h-48 bg-slate-800 rounded-full border-4 border-slate-700 flex flex-col items-center justify-center shadow-xl relative overflow-hidden"
            >
                <div class="z-10 text-center">
                    <span
                        id="temp-value"
                        class="text-5xl font-mono font-bold text-white transition-all">--</span
                    >
                    <span class="text-2xl text-emerald-400 font-bold">Â°C</span>
                    <div id="bpm-label" class="text-xs text-slate-500 mt-2 opacity-100">
                        Esperando...
                    </div>
                </div>

                <div
                    id="thermometer-fill"
                    class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-blue-500 via-emerald-500 to-red-500 transition-all duration-1000 ease-out opacity-20 h-0"
                >
                </div>
            </div>
        </div>

        <button
            id="tap-btn"
            class="w-full max-w-xs aspect-square rounded-full bg-gradient-to-br from-lime-500 to-emerald-600 shadow-lg shadow-emerald-900/50 flex flex-col items-center justify-center transform active:scale-95 transition-all duration-150 border-4 border-emerald-400/30 group mb-6 hover:shadow-emerald-500/20 hover:scale-105"
        >
            <span class="text-4xl pointer-events-none mb-2">ðŸ¦—</span>
            <span class="text-xl font-bold text-white uppercase tracking-widest pointer-events-none"
                >TAP</span
            >
            <span class="text-xs text-emerald-100 pointer-events-none opacity-80"
                >Cada vez que oigas un chirrido</span
            >
        </button>

        <div class="flex gap-4">
            <button
                id="reset-btn"
                class="px-6 py-2 rounded-full border border-slate-700 text-slate-400 hover:bg-slate-800 hover:text-white transition-colors text-sm"
            >
                Reiniciar
            </button>
            <button
                id="audio-toggle-btn"
                class="px-6 py-2 rounded-full border border-slate-700 text-slate-400 hover:bg-slate-800 hover:text-emerald-400 transition-colors text-sm flex items-center gap-2"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                    ></path>
                </svg>
                <span id="audio-status-text">Sonido: Off</span>
            </button>
        </div>
    </div>
</div>

<script>
    class CricketThermometer {
        private tapBtn = document.getElementById("tap-btn") as HTMLButtonElement;
        private resetBtn = document.getElementById("reset-btn") as HTMLButtonElement;
        private audioBtn = document.getElementById("audio-toggle-btn") as HTMLButtonElement;
        private audioStatusText = document.getElementById("audio-status-text") as HTMLElement;
        private tempValue = document.getElementById("temp-value") as HTMLElement;
        private bpmLabel = document.getElementById("bpm-label") as HTMLElement;
        private fill = document.getElementById("thermometer-fill") as HTMLElement;
        private resultContainer = this.tempValue.closest(".group") as HTMLElement;

        private taps: number[] = [];
        private maxTapsToKeep = 5;
        private resetTimeout: number | undefined;
        private lastTapTime = 0;

        private ctx: AudioContext | null = null;
        private isAudioEnabled = false;
        private isPlayingLoop = false;
        private loopInterval: number | undefined;
        private currentBPM = 0;

        constructor() {
            this.initEvents();
        }

        private initEvents() {
            this.tapBtn.addEventListener("touchstart", (e) => {
                e.preventDefault();
                this.handleTap();
            });
            this.tapBtn.addEventListener("mousedown", (e) => {
                this.handleTap();
            });

            document.addEventListener("keydown", (e) => {
                if (e.code === "Space") {
                    e.preventDefault();
                    this.tapBtn.classList.add("scale-95");
                    this.handleTap();
                }
            });
            document.addEventListener("keyup", (e) => {
                if (e.code === "Space") {
                    this.tapBtn.classList.remove("scale-95");
                }
            });

            this.resetBtn.addEventListener("click", () => this.reset());

            this.audioBtn.addEventListener("click", () => {
                this.isAudioEnabled = !this.isAudioEnabled;
                this.updateAudioUI();
                if (this.isAudioEnabled) {
                    this.initAudioContext();
                    this.updateChirpLoop();
                } else {
                    this.stopChirpLoop();
                }
            });
        }

        private handleTap() {
            const now = Date.now();

            if (!this.ctx) {
                this.initAudioContext();
            } else if (this.ctx.state === "suspended") {
                this.ctx.resume();
            }

            this.playClickSound();

            if (now - this.lastTapTime > 3000 && this.lastTapTime !== 0) {
                this.taps = [];
            }
            this.lastTapTime = now;

            this.taps.push(now);
            if (this.taps.length > this.maxTapsToKeep) {
                this.taps.shift();
            }

            this.calculate();
        }

        private calculate() {
            if (this.taps.length < 2) {
                this.bpmLabel.textContent = "Sigue pulsando...";
                return;
            }

            let totalInterval = 0;
            for (let i = 1; i < this.taps.length; i++) {
                totalInterval += this.taps[i] - this.taps[i - 1];
            }
            const avgInterval = totalInterval / (this.taps.length - 1);

            const bpm = 60000 / avgInterval;
            this.currentBPM = bpm;

            const temperature = 10 + (bpm - 40) / 7;

            this.updateUI(temperature, bpm);
            this.updateChirpLoop();
        }

        private updateUI(temp: number, bpm: number) {
            const displayTemp = temp < 0 ? 0 : temp;

            this.tempValue.textContent = displayTemp.toFixed(1);
            this.bpmLabel.textContent = `${Math.round(bpm)} chirridos/min`;

            this.resultContainer.classList.add("has-value");

            const percent = Math.min(100, Math.max(0, (displayTemp / 45) * 100));
            this.fill.style.height = `${percent}%`;
            this.fill.style.opacity = "0.4";
        }

        private reset() {
            this.taps = [];
            this.tempValue.textContent = "--";
            this.bpmLabel.textContent = "Esperando...";
            this.fill.style.height = "0";
            this.resultContainer.classList.remove("has-value");
            this.stopChirpLoop();
            this.currentBPM = 0;
        }

        private initAudioContext() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || (window as any).webkitAudioContext)();
            }
        }

        private playClickSound() {
            if (!this.ctx) return;

            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();

            osc.frequency.value = 800;
            osc.type = "triangle";

            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.1);

            osc.connect(gain);
            gain.connect(this.ctx.destination);

            osc.start();
            osc.stop(this.ctx.currentTime + 0.1);
        }

        private updateAudioUI() {
            if (this.isAudioEnabled) {
                this.audioStatusText.textContent = "Sonido: On";
                this.audioBtn.classList.replace("text-slate-400", "text-emerald-400");
            } else {
                this.audioStatusText.textContent = "Sonido: Off";
                this.audioBtn.classList.replace("text-emerald-400", "text-slate-400");
            }
        }

        private stopChirpLoop() {
            this.isPlayingLoop = false;
            if (this.loopInterval) {
                window.clearTimeout(this.loopInterval);
                this.loopInterval = undefined;
            }
        }

        private updateChirpLoop() {
            if (!this.isAudioEnabled || this.currentBPM <= 0) return;

            if (!this.isPlayingLoop) {
                this.isPlayingLoop = true;
                this.scheduleNextChirp();
            }
        }

        private scheduleNextChirp() {
            if (!this.isPlayingLoop || !this.isAudioEnabled || this.currentBPM <= 0) {
                this.isPlayingLoop = false;
                return;
            }

            this.playCricketChirp();

            const intervalMs = 60000 / this.currentBPM;
            this.loopInterval = window.setTimeout(() => this.scheduleNextChirp(), intervalMs);
        }

        private playCricketChirp() {
            if (!this.ctx) return;

            const t = this.ctx.currentTime;

            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();

            osc.frequency.setValueAtTime(4500, t);
            osc.type = "sine";

            const osc2 = this.ctx.createOscillator();
            osc2.frequency.setValueAtTime(4650, t);
            osc2.type = "sine";

            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.1, t + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15);

            osc.connect(gain);
            osc2.connect(gain);
            gain.connect(this.ctx.destination);

            osc.start(t);
            osc.stop(t + 0.2);
            osc2.start(t);
            osc2.stop(t + 0.2);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        new CricketThermometer();
    });
</script>
