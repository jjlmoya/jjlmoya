---
import { Icon } from "astro-icon/components";
---

<div class="w-full max-w-5xl mx-auto p-4 font-sans text-slate-900 dark:text-slate-100">
    <div
        id="dashboard"
        class="bg-white dark:bg-slate-900 rounded-3xl p-8 shadow-xl border border-slate-200 dark:border-slate-800 transition-all duration-500"
    >
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
            <div class="space-y-6">
                <div
                    class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 text-xs font-bold uppercase tracking-wider"
                >
                    <Icon name="mdi:monitor-shimmer" class="w-4 h-4" />
                    Utilidad de Pantalla
                </div>
                <h2 class="text-4xl md:text-5xl font-black tracking-tight mb-4">
                    ¿Píxeles Muertos o Atascados?
                </h2>
                <p class="text-lg text-slate-600 dark:text-slate-400 leading-relaxed">
                    Verifica el estado de tu monitor con colores sólidos puros y repara píxeles
                    atascados con nuestra herramienta de estimulación de alta frecuencia.
                </p>

                <div class="flex flex-col sm:flex-row gap-4 pt-4">
                    <button
                        id="btn-start-test"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-all shadow-lg hover:shadow-indigo-500/30 group"
                    >
                        <Icon
                            name="mdi:eye-check-outline"
                            class="w-6 h-6 group-hover:scale-110 transition-transform"
                        />
                        Iniciar Test
                    </button>
                    <button
                        id="btn-start-fix"
                        class="flex-1 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 hover:border-emerald-500 dark:hover:border-emerald-500 text-slate-700 dark:text-slate-200 hover:text-emerald-600 dark:hover:text-emerald-400 px-8 py-4 rounded-xl font-bold flex items-center justify-center gap-3 transition-all"
                    >
                        <Icon
                            name="mdi:hammer-wrench"
                            class="w-6 h-6 animate-pulse group-hover:rotate-12"
                        />
                        Reparar Píxel
                    </button>
                </div>

                <div class="flex items-center gap-4 text-xs text-slate-400 mt-4">
                    <div class="flex items-center gap-1">
                        <kbd
                            class="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600"
                            >F11</kbd
                        >
                        <span>Pantalla Completa</span>
                    </div>
                    <span>•</span>
                    <div class="flex items-center gap-1">
                        <kbd
                            class="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600"
                            >Espacio</kbd
                        >
                        <span>Cambiar Color</span>
                    </div>
                    <span>•</span>
                    <div class="flex items-center gap-1">
                        <kbd
                            class="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600"
                            >ESC</kbd
                        >
                        <span>Salir</span>
                    </div>
                </div>
            </div>

            <div class="relative group cursor-pointer" id="monitor-preview">
                <div
                    class="relative aspect-video bg-slate-950 rounded-2xl border-4 border-slate-800 shadow-2xl flex items-center justify-center overflow-hidden"
                >
                    <div
                        class="absolute inset-0 bg-gradient-to-tr from-white/5 to-transparent pointer-events-none z-10"
                    >
                    </div>

                    <div
                        class="w-full h-full flex transition-colors duration-500"
                        id="preview-screen"
                    >
                        <div class="flex-1 bg-red-500/90"></div>
                        <div class="flex-1 bg-green-500/90"></div>
                        <div class="flex-1 bg-blue-500/90"></div>
                    </div>

                    <div
                        class="absolute top-1/4 right-1/4 w-12 h-12 bg-white animate-pulse shadow-[0_0_20px_rgba(255,255,255,0.5)] z-20 hidden"
                        id="preview-fixer"
                    >
                    </div>
                </div>

                <div class="mx-auto w-24 h-12 bg-slate-800 rounded-b-xl mt-[-4px] relative z-[-1]">
                </div>
                <div class="mx-auto w-48 h-4 bg-slate-900 rounded-full mt-[-20px] shadow-xl"></div>
            </div>
        </div>
    </div>

    <div id="test-overlay" class="hidden fixed inset-0 z-[100] bg-black cursor-none">
        <div id="test-bg" class="absolute inset-0 bg-black transition-colors duration-0"></div>

        <div
            id="fixer-box"
            class="hidden fixed inset-0 z-[110] bg-white cursor-none overflow-hidden group"
        >
            <div class="absolute inset-0 w-full h-full" id="noise-canvas"></div>
            <div
                class="absolute top-0 right-0 p-2 opacity-0 group-hover:opacity-100 transition-opacity bg-black/50 text-white cursor-pointer"
                id="close-fixer"
            >
                <Icon name="mdi:close" class="w-4 h-4" />
            </div>
        </div>

        <div
            id="test-controls"
            class="absolute bottom-12 left-1/2 -translate-x-1/2 bg-slate-900/80 backdrop-blur-md border border-white/10 p-4 rounded-2xl flex items-center gap-4 transition-opacity duration-300 opacity-0 hover:opacity-100"
        >
            <div class="flex gap-2">
                <button
                    class="color-btn w-10 h-10 rounded-full bg-black border-2 border-white/20 hover:scale-110 transition-transform focus:ring-2 ring-white"
                    data-color="#000000"
                    title="Negro"></button>
                <button
                    class="color-btn w-10 h-10 rounded-full bg-white border-2 border-white/20 hover:scale-110 transition-transform focus:ring-2 ring-white"
                    data-color="#ffffff"
                    title="Blanco"></button>
                <button
                    class="color-btn w-10 h-10 rounded-full bg-red-600 border-2 border-white/20 hover:scale-110 transition-transform focus:ring-2 ring-white"
                    data-color="#dc2626"
                    title="Rojo"></button>
                <button
                    class="color-btn w-10 h-10 rounded-full bg-green-600 border-2 border-white/20 hover:scale-110 transition-transform focus:ring-2 ring-white"
                    data-color="#16a34a"
                    title="Verde"></button>
                <button
                    class="color-btn w-10 h-10 rounded-full bg-blue-600 border-2 border-white/20 hover:scale-110 transition-transform focus:ring-2 ring-white"
                    data-color="#2563eb"
                    title="Azul"></button>
            </div>
            <div class="w-px h-8 bg-white/20"></div>
            <button
                id="toggle-fixer"
                class="text-white hover:text-emerald-400 transition-colors p-2 rounded-lg hover:bg-white/10"
                title="Abrir Reparador (Strobe)"
            >
                <Icon name="mdi:hammer-wrench" class="w-6 h-6" />
            </button>
            <div class="w-px h-8 bg-white/20"></div>
            <button
                id="btn-exit"
                class="text-white hover:text-red-400 transition-colors p-2 rounded-lg hover:bg-white/10"
                title="Salir (ESC)"
            >
                <Icon name="mdi:exit-to-app" class="w-6 h-6" />
            </button>
        </div>
    </div>
</div>

<script>
    const els = {
        btnStart: document.getElementById("btn-start-test"),
        btnFix: document.getElementById("btn-start-fix"),
        overlay: document.getElementById("test-overlay"),
        testBg: document.getElementById("test-bg"),
        controls: document.getElementById("test-controls"),
        btnExit: document.getElementById("btn-exit"),
        toggleFixer: document.getElementById("toggle-fixer"),
        fixerBox: document.getElementById("fixer-box"),
        closeFixer: document.getElementById("close-fixer"),
        noiseCanvas: document.getElementById("noise-canvas"),
    };

    let idleTimer: ReturnType<typeof setTimeout>;
    let isStrobing = false;
    let animationFrame: number;
    let currentColorIndex = 0;

    const colors = ["#000000", "#ffffff", "#dc2626", "#16a34a", "#2563eb"];

    function startTest(initialMode = "test") {
        els.overlay?.classList.remove("hidden");
        document.documentElement.requestFullscreen().catch(() => {});

        if (initialMode === "fix") {
            toggleFixerBox(true);
        } else {
            setColor(colors[0]);
        }

        document.addEventListener("mousemove", handleMouseMove);
        document.addEventListener("keydown", handleKeyDown);
        resetIdleTimer();
    }

    function exitTest() {
        if (document.fullscreenElement) {
            document.exitFullscreen().catch(() => {});
        }
        els.overlay?.classList.add("hidden");
        document.removeEventListener("mousemove", handleMouseMove);
        document.removeEventListener("keydown", handleKeyDown);
        toggleFixerBox(false);
    }

    function setColor(hex: string) {
        if (!els.testBg) return;
        els.testBg.style.backgroundColor = hex;
    }

    function rotateColor(direction = 1) {
        currentColorIndex = (currentColorIndex + direction + colors.length) % colors.length;
        setColor(colors[currentColorIndex]);
    }

    function generateNoise(element: HTMLElement) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        const width = window.innerWidth;
        const height = window.innerHeight;
        const ratio = height > 0 ? width / height : 1;
        const baseSize = 64;

        canvas.height = baseSize;
        canvas.width = Math.round(baseSize * ratio);

        canvas.style.width = "100%";
        canvas.style.height = "100%";
        canvas.style.imageRendering = "pixelated";

        element.innerHTML = "";
        element.appendChild(canvas);

        const w = canvas.width;
        const h = canvas.height;
        const idata = ctx.createImageData(w, h);
        const buffer32 = new Uint32Array(idata.data.buffer);

        const step = () => {
            if (!isStrobing) return;

            for (let i = 0; i < buffer32.length; i++) {
                buffer32[i] =
                    (255 << 24) |
                    ((Math.random() * 255) << 16) |
                    ((Math.random() * 255) << 8) |
                    ((Math.random() * 255) << 0);
            }

            ctx.putImageData(idata, 0, 0);
            animationFrame = requestAnimationFrame(step);
        };
        step();
    }

    function toggleFixerBox(show: boolean) {
        if (!els.fixerBox || !els.noiseCanvas) return;

        if (show) {
            els.fixerBox.classList.remove("hidden");
            isStrobing = true;
            generateNoise(els.noiseCanvas);
        } else {
            els.fixerBox.classList.add("hidden");
            isStrobing = false;
            if (animationFrame) cancelAnimationFrame(animationFrame);
        }
    }

    function handleMouseMove() {
        if (!els.controls || !els.overlay) return;

        els.controls.style.opacity = "1";
        els.overlay.style.cursor = "default";

        resetIdleTimer();
    }

    function resetIdleTimer() {
        if (idleTimer) clearTimeout(idleTimer);
        idleTimer = setTimeout(() => {
            if (els.controls && els.overlay) {
                els.controls.style.opacity = "0";
                els.overlay.style.cursor = "none";
            }
        }, 3000);
    }

    function handleKeyDown(e: KeyboardEvent) {
        if (e.key === "Escape") exitTest();
        if (e.key === " " || e.key === "ArrowRight") rotateColor(1);
        if (e.key === "ArrowLeft") rotateColor(-1);
    }

    document.querySelectorAll(".color-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
            const color = (e.target as HTMLElement).getAttribute("data-color");
            if (color) setColor(color);
        });
    });

    els.btnStart?.addEventListener("click", () => startTest("test"));
    els.btnFix?.addEventListener("click", () => startTest("fix"));
    els.btnExit?.addEventListener("click", exitTest);

    els.toggleFixer?.addEventListener("click", () => {
        const isHidden = els.fixerBox?.classList.contains("hidden");
        toggleFixerBox(!!isHidden);
    });

    els.closeFixer?.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleFixerBox(false);
    });
</script>
