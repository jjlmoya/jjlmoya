---
import { Icon } from "astro-icon/components";
---

<div class="w-full max-w-4xl mx-auto" id="roux-calculator">
    <div
        class="bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl overflow-hidden border border-slate-100 dark:border-slate-800 transition-all duration-500"
    >
        <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 relative">
            <div
                id="progress-bar"
                class="absolute top-0 left-0 h-full bg-gradient-to-r from-amber-400 to-orange-600 transition-all duration-500 ease-out"
                style="width: 50%"
            >
            </div>
        </div>

        <div class="p-6 md:p-10 lg:p-12">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <div class="lg:col-span-7 space-y-8">
                    <div class="space-y-4">
                        <label
                            class="flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 dark:text-slate-500"
                        >
                            <span
                                class="w-5 h-5 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-600 flex items-center justify-center text-[10px]"
                                >1</span
                            >
                            Líquido Base
                        </label>

                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <div class="relative flex-1 w-full group">
                                <input
                                    type="number"
                                    id="volume-input"
                                    value="1000"
                                    min="50"
                                    step="50"
                                    class="w-full text-3xl font-black p-4 pr-16 bg-slate-50 dark:bg-slate-800/50 border-2 border-slate-100 dark:border-slate-800 rounded-2xl focus:border-amber-500 focus:outline-none focus:ring-4 focus:ring-amber-500/10 transition-all text-slate-900 dark:text-white"
                                />
                                <span
                                    class="absolute right-6 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm uppercase tracking-widest"
                                    >ml</span
                                >
                            </div>

                            <div
                                class="flex gap-2 p-1.5 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border-2 border-slate-100 dark:border-slate-800 w-full sm:w-auto"
                            >
                                <button
                                    class="liquid-btn p-3 rounded-xl transition-all hover:bg-white dark:hover:bg-slate-700 active"
                                    data-type="leche"
                                    title="Leche"
                                >
                                    <Icon name="mdi:cup-water" class="w-6 h-6 text-blue-400" />
                                </button>
                                <button
                                    class="liquid-btn p-3 rounded-xl transition-all hover:bg-white dark:hover:bg-slate-700"
                                    data-type="claro"
                                    title="Fondo Claro"
                                >
                                    <Icon
                                        name="mdi:pot-mix-outline"
                                        class="w-6 h-6 text-amber-500"
                                    />
                                </button>
                                <button
                                    class="liquid-btn p-3 rounded-xl transition-all hover:bg-white dark:hover:bg-slate-700"
                                    data-type="oscuro"
                                    title="Fondo Oscuro"
                                >
                                    <Icon name="mdi:food-steak" class="w-6 h-6 text-orange-900" />
                                </button>
                                <button
                                    class="liquid-btn p-3 rounded-xl transition-all hover:bg-white dark:hover:bg-slate-700"
                                    data-type="tomate"
                                    title="Tomate"
                                >
                                    <Icon name="mdi:food-apple" class="w-6 h-6 text-red-500" />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <label
                            class="flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 dark:text-slate-500"
                        >
                            <span
                                class="w-5 h-5 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-600 flex items-center justify-center text-[10px]"
                                >2</span
                            >
                            Textura de la Salsa
                        </label>

                        <div class="grid grid-cols-2 gap-3">
                            <button
                                class="texture-btn group p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 text-left transition-all hover:shadow-lg hover:border-amber-200"
                                data-level="1"
                            >
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-1.5 h-6 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden"
                                    >
                                        <div class="w-full h-1/4 bg-amber-300 mt-auto"></div>
                                    </div>
                                    <span
                                        class="text-xs font-bold text-slate-900 dark:text-slate-200"
                                        >Sopa / Crema</span
                                    >
                                </div>
                            </button>
                            <button
                                class="texture-btn group p-4 rounded-2xl border-2 border-amber-500/50 bg-amber-50 dark:bg-amber-900/10 text-left transition-all hover:shadow-lg active"
                                data-level="2"
                            >
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-1.5 h-6 bg-amber-200 dark:bg-amber-800 rounded-full overflow-hidden"
                                    >
                                        <div class="w-full h-2/4 bg-amber-500 mt-auto"></div>
                                    </div>
                                    <span
                                        class="text-xs font-bold text-slate-900 dark:text-slate-200"
                                        >Salsa Normal</span
                                    >
                                </div>
                            </button>
                            <button
                                class="texture-btn group p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 text-left transition-all hover:shadow-lg hover:border-amber-200"
                                data-level="3"
                            >
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-1.5 h-6 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden"
                                    >
                                        <div class="w-full h-3/4 bg-amber-500 mt-auto"></div>
                                    </div>
                                    <span
                                        class="text-xs font-bold text-slate-900 dark:text-slate-200"
                                        >Espesa / Relleno</span
                                    >
                                </div>
                            </button>
                            <button
                                class="texture-btn group p-4 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 text-left transition-all hover:shadow-lg hover:border-amber-200"
                                data-level="4"
                            >
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-1.5 h-6 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden"
                                    >
                                        <div class="w-full h-full bg-amber-600 mt-auto"></div>
                                    </div>
                                    <span
                                        class="text-xs font-bold text-slate-900 dark:text-slate-200"
                                        >Croqueta / Masa</span
                                    >
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-5 flex flex-col gap-6">
                    <div
                        class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden group"
                    >
                        <div
                            class="absolute -right-12 -top-12 w-48 h-48 bg-white/10 rounded-full blur-3xl group-hover:scale-125 transition-transform duration-700"
                        >
                        </div>

                        <div class="relative z-10 space-y-6">
                            <div class="flex items-center justify-between">
                                <span
                                    class="text-[9px] font-black uppercase tracking-widest text-amber-100/70"
                                    >Mezcla Roux</span
                                >
                                <div
                                    class="px-2 py-0.5 bg-black/20 rounded-md text-[9px] font-bold"
                                    id="roux-type-label"
                                >
                                    Blanco
                                </div>
                            </div>

                            <div class="flex items-center justify-around text-center">
                                <div>
                                    <div
                                        class="text-5xl font-black mb-1 tabular-nums"
                                        id="butter-output"
                                    >
                                        50
                                    </div>
                                    <div class="text-[10px] font-bold uppercase opacity-80">
                                        Mantequilla (g)
                                    </div>
                                </div>
                                <div class="text-2xl font-light opacity-30">+</div>
                                <div>
                                    <div
                                        class="text-5xl font-black mb-1 tabular-nums"
                                        id="flour-output"
                                    >
                                        50
                                    </div>
                                    <div class="text-[10px] font-bold uppercase opacity-80">
                                        Harina (g)
                                    </div>
                                </div>
                            </div>

                            <div
                                class="p-4 bg-black/20 rounded-2xl border border-white/5 backdrop-blur-sm"
                            >
                                <div class="flex items-center gap-2 mb-1 text-amber-200">
                                    <Icon name="mdi:fire" class="w-4 h-4" />
                                    <span class="text-[10px] font-black uppercase tracking-wider"
                                        >Instrucciones</span
                                    >
                                </div>
                                <p
                                    class="text-xs font-medium leading-relaxed text-amber-50"
                                    id="cooking-instructions"
                                >
                                    Cocina 2-3 min. No dejes que coja color.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-slate-50 dark:bg-slate-800/40 rounded-3xl p-6 border border-slate-100 dark:border-slate-800/50 flex flex-col h-full space-y-4"
                    >
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                                    <Icon
                                        name="mdi:bookmark-check"
                                        class="w-4 h-4 text-indigo-600 dark:text-indigo-400"
                                    />
                                </div>
                                <span
                                    class="text-sm font-black text-slate-900 dark:text-white"
                                    id="sauce-name">Bechamel</span
                                >
                            </div>
                            <span
                                class="text-[10px] font-black text-slate-400 tabular-nums"
                                id="ratio-display">90g/L</span
                            >
                        </div>

                        <p
                            class="text-[11px] leading-relaxed text-slate-600 dark:text-slate-400 font-light italic bg-white dark:bg-slate-900/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-800"
                            id="chef-tip"
                        >
                            "Añade la leche fría de golpe sobre el roux caliente y remueve
                            vigorosamente para evitar grumos."
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const VISCOSITY_RATIOS: Record<number, number> = {
        1: 50,
        2: 90,
        3: 130,
        4: 185,
    };

    const LIQUID_CONFIG: Record<
        string,
        { name: string; roux: string; color: string; tip: string }
    > = {
        leche: {
            name: "Bechamel",
            roux: "blanco",
            color: "amber",
            tip: "Usa leche fría. Añádela gradualmente al principio o de golpe si bates fuerte.",
        },
        claro: {
            name: "Velouté",
            roux: "rubio",
            color: "amber",
            tip: "Usa fondo de ave o pescado. Deja que el roux huela a galleta antes de ligar.",
        },
        oscuro: {
            name: "Espagnole",
            roux: "oscuro",
            color: "orange",
            tip: "Para salsas oscuras potentes. El roux debe estar color chocolate, pero sin quemarse.",
        },
        tomate: {
            name: "Salsa de Tomate",
            roux: "rubio",
            color: "red",
            tip: "El roux ayudará a dar cuerpo y suavidad a la textura final del tomate.",
        },
    };

    const ROUX_INFO: Record<string, { label: string; time: string; desc: string }> = {
        blanco: {
            label: "Blanco",
            time: "2-3 min",
            desc: "Cocina solo hasta perder el olor a harina cruda. Sin color.",
        },
        rubio: {
            label: "Rubio",
            time: "5-8 min",
            desc: "Busca un color de mantequilla tostada y un aroma a nueces.",
        },
        oscuro: {
            label: "Oscuro",
            time: "15-20 min",
            desc: "Fuego muy suave. Color chocolate. Nota: requiere un 10% más de peso.",
        },
    };

    const state = {
        volume: 1000,
        liquid: "leche",
        level: 2,
    };

    const volumeInput = document.getElementById("volume-input") as HTMLInputElement;
    const liquidBtns = document.querySelectorAll(".liquid-btn");
    const textureBtns = document.querySelectorAll(".texture-btn");
    const progressBar = document.getElementById("progress-bar");

    const butterOut = document.getElementById("butter-output");
    const flourOut = document.getElementById("flour-output");
    const rouxLabel = document.getElementById("roux-type-label");
    const cookInst = document.getElementById("cooking-instructions");
    const sauceName = document.getElementById("sauce-name");
    const ratioDisp = document.getElementById("ratio-display");
    const chefTip = document.getElementById("chef-tip");

    function updateCalculations() {
        const config = LIQUID_CONFIG[state.liquid];
        const baseRatio = VISCOSITY_RATIOS[state.level];
        const liters = state.volume / 1000;

        let correctionFactor = 1.0;
        if (config.roux === "oscuro") correctionFactor = 1.15;

        const totalRoux = Math.round(baseRatio * liters * correctionFactor);
        const each = Math.round(totalRoux / 2);

        if (butterOut) butterOut.textContent = each.toString();
        if (flourOut) flourOut.textContent = each.toString();

        const info = ROUX_INFO[config.roux];
        if (rouxLabel) rouxLabel.textContent = info.label;
        if (cookInst) cookInst.textContent = `${info.desc} (${info.time})`;
        if (sauceName) sauceName.textContent = config.name;
        if (ratioDisp) ratioDisp.textContent = `${totalRoux}g/L`;
        if (chefTip) chefTip.textContent = `"${config.tip}"`;

        if (progressBar) {
            const progress = (state.level / 4) * 100;
            progressBar.style.width = `${progress}%`;
        }
    }

    volumeInput?.addEventListener("input", (e) => {
        state.volume = parseInt((e.target as HTMLInputElement).value) || 0;
        updateCalculations();
    });

    liquidBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            liquidBtns.forEach((b) =>
                b.classList.remove(
                    "active",
                    "bg-white",
                    "dark:bg-slate-700",
                    "shadow-md",
                    "ring-2",
                    "ring-indigo-500/20"
                )
            );
            btn.classList.add(
                "active",
                "bg-white",
                "dark:bg-slate-700",
                "shadow-md",
                "ring-2",
                "ring-indigo-500/20"
            );
            state.liquid = (btn as HTMLElement).dataset.type || "leche";
            updateCalculations();
        });
    });

    textureBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            textureBtns.forEach((b) =>
                b.classList.remove(
                    "active",
                    "border-amber-500/50",
                    "bg-amber-50",
                    "dark:bg-amber-900/10"
                )
            );
            textureBtns.forEach((b) =>
                b.classList.add(
                    "border-slate-100",
                    "dark:border-slate-800",
                    "bg-white",
                    "dark:bg-slate-900"
                )
            );

            btn.classList.remove(
                "border-slate-100",
                "dark:border-slate-800",
                "bg-white",
                "dark:bg-slate-900"
            );
            btn.classList.add(
                "active",
                "border-amber-500/50",
                "bg-amber-50",
                "dark:bg-amber-900/10"
            );
            state.level = parseInt((btn as HTMLElement).dataset.level || "2");
            updateCalculations();
        });
    });

    updateCalculations();
</script>

<style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .liquid-btn.active {
    }
</style>
