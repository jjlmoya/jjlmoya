---
import { Icon } from "astro-icon/components";
---

<div class="w-full max-w-5xl mx-auto space-y-12 select-none" id="roux-calculator">
    <div class="grid lg:grid-cols-12 gap-8 items-start">
        <div
            class="lg:col-span-7 bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl border border-gray-100 dark:border-gray-700 space-y-10 relative overflow-hidden"
        >
            <div
                class="absolute top-0 right-0 w-64 h-64 bg-amber-50 dark:bg-amber-900/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"
            >
            </div>

            <div class="space-y-4 relative">
                <label
                    class="flex items-center justify-between text-sm font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wider"
                >
                    <span class="flex items-center gap-2">
                        <span
                            class="w-6 h-6 rounded-full bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 flex items-center justify-center text-xs"
                            >1</span
                        >
                        Volumen de Líquido
                    </span>
                    <span
                        class="text-amber-600 dark:text-amber-400 text-xs font-mono bg-amber-50 dark:bg-amber-900/30 px-3 py-1 rounded-full border border-amber-100 dark:border-amber-800"
                        >ml / cc</span
                    >
                </label>
                <div class="relative group">
                    <input
                        type="number"
                        id="volume-input"
                        value="1000"
                        min="50"
                        step="50"
                        class="peer w-full text-4xl font-black p-5 pr-20 bg-gray-50 dark:bg-gray-900/50 border-2 border-transparent focus:border-amber-500 rounded-2xl focus:outline-none focus:ring-4 focus:ring-amber-500/10 transition-all text-gray-900 dark:text-white placeholder-gray-300"
                        placeholder="0"
                    />
                    <span
                        class="absolute right-6 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-lg select-none"
                        >ml</span
                    >
                </div>
            </div>

            <div class="space-y-4 relative">
                <span
                    class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wider"
                >
                    <span
                        class="w-6 h-6 rounded-full bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 flex items-center justify-center text-xs"
                        >2</span
                    >
                    Base Líquida
                </span>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <button
                        class="liquid-btn group p-4 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-gray-900/50 hover:bg-white dark:hover:bg-gray-800 hover:shadow-lg hover:-translate-y-1 hover:border-blue-200 dark:hover:border-blue-800 transition-all duration-300 focus:outline-none active"
                        data-type="leche"
                    >
                        <Icon
                            name="mdi:cup-water"
                            class="w-8 h-8 mb-3 mx-auto text-blue-400 group-hover:scale-110 transition-transform"
                        />
                        <div
                            class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wide"
                        >
                            Leche
                        </div>
                    </button>
                    <button
                        class="liquid-btn group p-4 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-gray-900/50 hover:bg-white dark:hover:bg-gray-800 hover:shadow-lg hover:-translate-y-1 hover:border-amber-200 dark:hover:border-amber-800 transition-all duration-300 focus:outline-none"
                        data-type="claro"
                    >
                        <Icon
                            name="mdi:food-drumstick"
                            class="w-8 h-8 mb-3 mx-auto text-amber-400 group-hover:scale-110 transition-transform"
                        />
                        <div
                            class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wide"
                        >
                            F. Claro
                        </div>
                    </button>
                    <button
                        class="liquid-btn group p-4 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-gray-900/50 hover:bg-white dark:hover:bg-gray-800 hover:shadow-lg hover:-translate-y-1 hover:border-red-900/50 transition-all duration-300 focus:outline-none"
                        data-type="oscuro"
                    >
                        <Icon
                            name="mdi:food-steak"
                            class="w-8 h-8 mb-3 mx-auto text-red-800 group-hover:scale-110 transition-transform"
                        />
                        <div
                            class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wide"
                        >
                            F. Oscuro
                        </div>
                    </button>
                    <button
                        class="liquid-btn group p-4 rounded-2xl border-2 border-transparent bg-gray-50 dark:bg-gray-900/50 hover:bg-white dark:hover:bg-gray-800 hover:shadow-lg hover:-translate-y-1 hover:border-red-400 transition-all duration-300 focus:outline-none"
                        data-type="tomate"
                    >
                        <Icon
                            name="mdi:food-apple"
                            class="w-8 h-8 mb-3 mx-auto text-red-500 group-hover:scale-110 transition-transform"
                        />
                        <div
                            class="text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wide"
                        >
                            Tomate
                        </div>
                    </button>
                </div>
            </div>

            <div class="space-y-4 relative">
                <span
                    class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-200 uppercase tracking-wider"
                >
                    <span
                        class="w-6 h-6 rounded-full bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 flex items-center justify-center text-xs"
                        >3</span
                    >
                    Viscosidad Objetivo
                </span>
                <div class="grid grid-cols-1 gap-3">
                    <button
                        class="texture-btn relative p-4 pl-20 rounded-xl border-2 border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 text-left hover:border-amber-400 dark:hover:border-amber-600 transition-all duration-200 focus:outline-none group"
                        data-level="1"
                    >
                        <div
                            class="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600"
                        >
                            <div
                                class="w-full h-1/4 bg-amber-300 absolute bottom-0 transition-all group-hover:bg-amber-400"
                            >
                            </div>
                        </div>
                        <span class="block text-sm font-bold text-gray-900 dark:text-white"
                            >Nivel 1: Sopa / Crema</span
                        >
                        <span class="text-xs text-gray-500 font-medium"
                            >Textura ligera, cuchara limpia.</span
                        >
                    </button>

                    <button
                        class="texture-btn relative p-4 pl-20 rounded-xl border-2 border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 text-left hover:border-amber-400 dark:hover:border-amber-600 transition-all duration-200 focus:outline-none group active"
                        data-level="2"
                    >
                        <div
                            class="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600"
                        >
                            <div
                                class="w-full h-2/4 bg-amber-400 absolute bottom-0 transition-all group-hover:bg-amber-500"
                            >
                            </div>
                        </div>
                        <span class="block text-sm font-bold text-gray-900 dark:text-white"
                            >Nivel 2: Salsa (Nappé)</span
                        >
                        <span class="text-xs text-gray-500 font-medium"
                            >Cubre el dorso de una cuchara.</span
                        >
                    </button>

                    <button
                        class="texture-btn relative p-4 pl-20 rounded-xl border-2 border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 text-left hover:border-amber-400 dark:hover:border-amber-600 transition-all duration-200 focus:outline-none group"
                        data-level="3"
                    >
                        <div
                            class="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600"
                        >
                            <div
                                class="w-full h-3/4 bg-amber-500 absolute bottom-0 transition-all group-hover:bg-amber-600"
                            >
                            </div>
                        </div>
                        <span class="block text-sm font-bold text-gray-900 dark:text-white"
                            >Nivel 3: Relleno / Soufflé</span
                        >
                        <span class="text-xs text-gray-500 font-medium">Espeso pero fluido.</span>
                    </button>

                    <button
                        class="texture-btn relative p-4 pl-20 rounded-xl border-2 border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 text-left hover:border-amber-400 dark:hover:border-amber-600 transition-all duration-200 focus:outline-none group"
                        data-level="4"
                    >
                        <div
                            class="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600"
                        >
                            <div
                                class="w-full h-full bg-amber-600 absolute bottom-0 transition-all group-hover:bg-amber-700"
                            >
                            </div>
                        </div>
                        <span class="block text-sm font-bold text-gray-900 dark:text-white"
                            >Nivel 4: Croqueta / Masa</span
                        >
                        <span class="text-xs text-gray-500 font-medium">Sólido al enfriar.</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-5 flex flex-col gap-6 sticky top-8" id="roux-results">
            <div
                class="bg-gradient-to-br from-amber-500 to-orange-700 rounded-3xl p-8 text-white shadow-2xl shadow-orange-500/20 relative overflow-hidden group"
            >
                <div
                    class="absolute -top-12 -right-12 w-48 h-48 bg-white opacity-10 rounded-full blur-3xl transform group-hover:scale-150 transition-transform duration-700"
                >
                </div>

                <h3
                    class="text-amber-100 uppercase tracking-widest text-xs font-bold mb-8 flex items-center gap-2"
                >
                    <Icon name="mdi:beaker-outline" class="w-4 h-4" />
                    Estructura Base Requerida
                </h3>

                <div class="flex items-center justify-between mb-8 relative z-10">
                    <div
                        class="text-center group-hover:-translate-y-1 transition-transform duration-300"
                    >
                        <div class="flex items-baseline justify-center gap-1 mb-1">
                            <span class="text-6xl font-black tracking-tighter" id="butter-output"
                                >0</span
                            >
                            <span class="text-3xl font-bold text-amber-200">g</span>
                        </div>
                        <span class="text-sm font-bold text-amber-100 uppercase tracking-wide"
                            >Mantequilla</span
                        >
                    </div>
                    <Icon name="mdi:plus" class="w-8 h-8 text-amber-200/50" />
                    <div
                        class="text-center group-hover:-translate-y-1 transition-transform duration-300 delay-75"
                    >
                        <div class="flex items-baseline justify-center gap-1 mb-1">
                            <span class="text-6xl font-black tracking-tighter" id="flour-output"
                                >0</span
                            >
                            <span class="text-3xl font-bold text-amber-200">g</span>
                        </div>
                        <span class="text-sm font-bold text-amber-100 uppercase tracking-wide"
                            >Harina</span
                        >
                    </div>
                </div>

                <div
                    class="bg-black/20 rounded-2xl p-6 backdrop-blur-md border border-white/10 hover:bg-black/30 transition-colors"
                >
                    <div class="flex items-center gap-3 mb-3">
                        <Icon name="mdi:fire" class="w-6 h-6 text-amber-300 animate-pulse" />
                        <span class="font-bold text-xl tracking-tight" id="roux-type"
                            >Roux Blanco</span
                        >
                    </div>
                    <p
                        class="text-sm text-amber-50/90 leading-relaxed font-medium"
                        id="cooking-instructions"
                    >
                        Cocina 2-3 min. No dejes que coja color.
                    </p>
                </div>

                <div
                    id="correction-badge"
                    class="hidden mt-4 bg-red-900/60 rounded-xl p-4 text-xs border border-red-400/30 flex items-start gap-3 backdrop-blur-sm"
                >
                    <Icon name="mdi:alert" class="w-10 h-10 text-red-200 shrink-0" />
                    <p class="text-red-50 leading-relaxed">
                        <span class="font-bold block mb-1">Corrección Aplicada (+10%)</span>
                        El tostado intenso degrada la capacidad espesante del almidón. Hemos ajustado
                        la cantidad automáticamente.
                    </p>
                </div>
            </div>

            <div
                class="bg-white dark:bg-gray-800 p-8 rounded-3xl border border-gray-100 dark:border-gray-700 shadow-lg flex-grow space-y-6"
            >
                <h4 class="font-bold text-gray-900 dark:text-white flex items-center gap-3 text-lg">
                    <div class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg">
                        <Icon
                            name="mdi:school-outline"
                            class="w-6 h-6 text-blue-600 dark:text-blue-400"
                        />
                    </div>
                    Resultado Técnico
                </h4>

                <div class="space-y-6">
                    <div
                        class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl"
                    >
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wide"
                            >Salsa Resultante</span
                        >
                        <span
                            class="font-bold text-xl text-gray-900 dark:text-white"
                            id="sauce-name">Bechamel</span
                        >
                    </div>

                    <div class="flex items-center justify-between px-4">
                        <span class="text-sm font-medium text-gray-500">Ratio Roux/Líquido</span>
                        <span
                            class="font-mono font-bold text-amber-600 dark:text-amber-400"
                            id="ratio-display">90g/L</span
                        >
                    </div>

                    <div class="border-t border-gray-100 dark:border-gray-700 pt-6">
                        <span
                            class="text-xs font-bold text-gray-400 uppercase tracking-wide block mb-3 flex items-center gap-2"
                        >
                            <Icon name="mdi:lightbulb-on-outline" class="w-4 h-4" /> Tip del Chef
                        </span>
                        <p
                            class="text-gray-600 dark:text-gray-300 italic leading-relaxed text-sm bg-amber-50 dark:bg-amber-900/10 p-4 rounded-xl border border-amber-100 dark:border-amber-900/30"
                            id="chef-tip"
                        >
                            "Añade la leche fría de golpe sobre el roux caliente y remueve
                            vigorosamente para evitar grumos."
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const VISCOSITY_RATIOS: Record<number, number> = {
        1: 50,
        2: 90,
        3: 130,
        4: 185,
    };

    const LIQUID_CONFIG: Record<string, { name: string; roux: string; tip: string }> = {
        leche: {
            name: "Bechamel",
            roux: "blanco",
            tip: "Usa leche fría o del tiempo. Si la calientas demasiado, el choque térmico puede ser menor, pero pierdes control.",
        },
        claro: {
            name: "Velouté",
            roux: "rubio",
            tip: "El roux debe oler a nuez tostada antes de añadir el fondo.",
        },
        oscuro: {
            name: "Espagnole",
            roux: "oscuro",
            tip: "Ten paciencia. El roux debe ser color chocolate. Si se quema, tíralo y empieza de nuevo.",
        },
        tomate: {
            name: "Salsa de Tomate Ligada",
            roux: "rubio",
            tip: "Aquí el roux suaviza la acidez y liga el agua del tomate.",
        },
    };

    const ROUX_INFO: Record<string, { label: string; time: string; desc: string }> = {
        blanco: {
            label: "Roux Blanco",
            time: "2-3 min",
            desc: "Cocina solo hasta que burbujee y pierda el olor a crudo. Sin color.",
        },
        rubio: {
            label: "Roux Rubio",
            time: "5-6 min",
            desc: "Cocina hasta obtener un color pajizo y olor a galleta.",
        },
        oscuro: {
            label: "Roux Oscuro",
            time: "15-20 min",
            desc: "Fuego muy lento hasta color marrón oscuro. Remover constantemente.",
        },
    };

    const state = {
        volume: 1000,
        liquid: "leche",
        level: 2,
    };

    const volumeInput = document.getElementById("volume-input") as HTMLInputElement | null;
    const liquidBtns = document.querySelectorAll(".liquid-btn");
    const textureBtns = document.querySelectorAll(".texture-btn");

    const butterOut = document.getElementById("butter-output");
    const flourOut = document.getElementById("flour-output");
    const rouxTypeOut = document.getElementById("roux-type");
    const cookInstOut = document.getElementById("cooking-instructions");
    const correctionBadge = document.getElementById("correction-badge");

    const sauceNameOut = document.getElementById("sauce-name");
    const ratioOut = document.getElementById("ratio-display");
    const chefTipOut = document.getElementById("chef-tip");

    function updateCalculations() {
        if (
            !butterOut ||
            !flourOut ||
            !rouxTypeOut ||
            !cookInstOut ||
            !correctionBadge ||
            !sauceNameOut ||
            !ratioOut ||
            !chefTipOut
        )
            return;

        const config = LIQUID_CONFIG[state.liquid];
        const baseRatio = VISCOSITY_RATIOS[state.level];
        const liters = state.volume / 1000;

        let correctionFactor = 1.0;
        if (config.roux === "oscuro") {
            correctionFactor = 1.1;
        }

        const totalRouxNeeded = baseRatio * liters * correctionFactor;
        const componentAmount = Math.round(totalRouxNeeded / 2);

        butterOut.textContent = componentAmount.toString();
        flourOut.textContent = componentAmount.toString();

        const rInfo = ROUX_INFO[config.roux];
        rouxTypeOut.textContent = rInfo.label;
        cookInstOut.textContent = `${rInfo.desc} (~${rInfo.time})`;

        if (correctionFactor > 1.0) {
            correctionBadge.classList.remove("hidden");
        } else {
            correctionBadge.classList.add("hidden");
        }

        sauceNameOut.textContent = config.name;
        ratioOut.textContent = `${Math.round(baseRatio * correctionFactor)} g/L`;
        chefTipOut.textContent = `"${config.tip}"`;
    }

    function setLiquidActive(btn: Element) {
        liquidBtns.forEach((b) => {
            b.classList.remove(
                "ring-2",
                "ring-blue-500",
                "border-blue-200",
                "bg-white",
                "dark:bg-gray-800",
                "shadow-lg"
            );
            b.classList.add("border-transparent");
        });

        btn.classList.add("ring-2", "ring-blue-500", "bg-white", "dark:bg-gray-800", "shadow-lg");
        btn.classList.remove("border-transparent");
    }

    function setTextureActive(btn: Element) {
        textureBtns.forEach((b) => {
            b.classList.remove(
                "ring-2",
                "ring-amber-500",
                "border-amber-400",
                "bg-amber-50",
                "dark:bg-amber-900/10"
            );
            b.classList.add("border-gray-100", "dark:border-gray-700");
        });

        btn.classList.add(
            "ring-2",
            "ring-amber-500",
            "border-amber-400",
            "bg-amber-50",
            "dark:bg-amber-900/10"
        );
        btn.classList.remove("border-gray-100", "dark:border-gray-700");
    }

    if (volumeInput) {
        volumeInput.addEventListener("input", (e) => {
            const target = e.target as HTMLInputElement;
            const val = parseInt(target.value);
            if (val && val > 0) {
                state.volume = val;
                updateCalculations();
            }
        });
    }

    liquidBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const el = btn as HTMLElement;
            setLiquidActive(el);
            if (el.dataset.type) {
                state.liquid = el.dataset.type;
                updateCalculations();
            }
        });
    });

    textureBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const el = btn as HTMLElement;
            setTextureActive(el);
            if (el.dataset.level) {
                state.level = parseInt(el.dataset.level);
                updateCalculations();
            }
        });
    });

    liquidBtns.forEach((btn) => {
        if (btn.classList.contains("active")) setLiquidActive(btn);
    });
    textureBtns.forEach((btn) => {
        if (btn.classList.contains("active")) setTextureActive(btn);
    });

    updateCalculations();
</script>

<style is:global>
    body.is-widget #roux-calculator {
        space-y: 6 !important;
    }

    body.is-widget #roux-calculator .grid {
        display: flex !important;
        flex-direction: column !important;
        gap: 1.5rem !important;
    }

    body.is-widget #roux-results {
        position: relative !important;
        top: 0 !important;
        width: 100% !important;
    }

    body.is-widget .texture-btn {
        padding: 0.75rem 0.75rem 0.75rem 4rem !important;
    }

    body.is-widget .liquid-btn {
        padding: 0.75rem !important;
    }

    body.is-widget .liquid-btn svg {
        width: 1.5rem !important;
        height: 1.5rem !important;
        margin-bottom: 0.5rem !important;
    }
</style>

<style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>
