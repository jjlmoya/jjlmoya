---
import { TEXTILE_DATA, STAIN_DATA } from "../../../../data/utilities/textiles";
import type { StainType } from "../../../../data/utilities/textiles";
import { Icon } from "astro-icon/components";

const fibers = Object.values(TEXTILE_DATA);
---

<div class="max-w-4xl mx-auto p-2 md:p-8">
    <div
        class="bg-white dark:bg-slate-900 rounded-2xl md:rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-xl overflow-hidden"
    >
        <div
            class="p-5 md:p-12 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-950/20"
        >
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-12">
                <div class="space-y-3">
                    <label
                        class="flex items-center gap-2 text-[10px] font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-widest ml-1"
                    >
                        <Icon name="mdi:tshirt-v-outline" class="text-base" />
                        1. Fibra
                    </label>
                    <div class="relative group">
                        <select
                            id="fiber-select"
                            class="w-full h-14 md:h-16 pl-4 pr-10 bg-white dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-800 rounded-xl md:rounded-2xl appearance-none focus:border-indigo-500 transition-all font-bold text-sm md:text-base text-slate-900 dark:text-white outline-none cursor-pointer"
                        >
                            <option value="" disabled selected>Selecciona el tejido...</option>
                            {
                                fibers.map((fiber) => (
                                    <option
                                        value={fiber.id}
                                        data-fiber-type={
                                            fiber.type === "synthetic"
                                                ? "synthetic"
                                                : fiber.isNoble
                                                  ? "delicate"
                                                  : "natural"
                                        }
                                    >
                                        {fiber.name}
                                    </option>
                                ))
                            }
                        </select>
                        <div
                            class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none transition-colors"
                        >
                            <Icon name="mdi:chevron-down" class="text-lg" />
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label
                        class="flex items-center gap-2 text-[10px] font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-widest ml-1"
                    >
                        <Icon name="mdi:shimmer" class="text-base" />
                        2. Mancha
                    </label>
                    <div class="relative group">
                        <select
                            id="stain-select"
                            class="w-full h-14 md:h-16 pl-4 pr-10 bg-white dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-800 rounded-xl md:rounded-2xl appearance-none focus:border-indigo-500 transition-all font-bold text-sm md:text-base text-slate-900 dark:text-white outline-none cursor-pointer"
                        >
                            <option value="" disabled selected>¿Qué ha ocurrido?</option>
                            {
                                STAIN_DATA.map((stain: StainType) => (
                                    <option value={stain.id}>{stain.name}</option>
                                ))
                            }
                        </select>
                        <div
                            class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none transition-colors"
                        >
                            <Icon name="mdi:chevron-down" class="text-lg" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div
            id="protocol-display"
            class="hidden p-4 md:p-8 animate-in fade-in slide-in-from-bottom-2 duration-700"
        >
            <div
                class="bg-slate-50 dark:bg-slate-900/50 rounded-xl md:rounded-[2.5rem] border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm"
            >
                <div
                    class="px-5 py-6 md:px-8 md:py-8 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center gap-4"
                >
                    <div
                        class="w-10 h-10 md:w-12 md:h-12 rounded-lg md:rounded-xl bg-indigo-600 text-white flex items-center justify-center text-xl md:text-2xl shadow-lg shadow-indigo-600/10 shrink-0"
                    >
                        <Icon name="mdi:flask-outline" />
                    </div>
                    <div>
                        <p
                            class="text-[10px] uppercase font-black text-slate-400 tracking-widest mb-0.5"
                        >
                            Diagnóstico Molecular
                        </p>
                        <h3
                            class="text-xl md:text-2xl font-black text-slate-900 dark:text-white tracking-tight"
                            id="protocol-title"
                        >
                            Mancha
                        </h3>
                    </div>
                </div>

                <div class="p-4 md:p-8 space-y-4 md:space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                        <div
                            class="bg-white dark:bg-slate-950 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col items-center text-center group transition-all hover:border-indigo-500/30"
                        >
                            <div
                                class="w-12 h-12 rounded-full bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400 mb-4 ring-8 ring-indigo-500/5"
                            >
                                <Icon name="mdi:molecule" class="text-2xl" />
                            </div>
                            <span
                                class="text-[9px] uppercase font-black text-slate-400 tracking-[0.2em] mb-2"
                                >Agente Requerido</span
                            >
                            <p
                                class="text-xl md:text-2xl font-black text-slate-900 dark:text-white mb-2"
                                id="protocol-agent"
                            >
                                -
                            </p>
                            <p
                                class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed font-semibold max-w-[200px]"
                                id="protocol-agent-desc"
                            >
                            </p>
                        </div>

                        <div
                            class="bg-white dark:bg-slate-950 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col items-center justify-center text-center group transition-all hover:border-indigo-500/30"
                        >
                            <div
                                class="w-12 h-12 rounded-full bg-orange-50 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 dark:text-orange-400 mb-4 ring-8 ring-orange-500/5"
                            >
                                <Icon name="mdi:water-thermometer-outline" class="text-2xl" />
                            </div>
                            <span
                                class="text-[9px] uppercase font-black text-slate-400 tracking-[0.2em] mb-2"
                                >Condición Térmica</span
                            >
                            <p
                                class="text-3xl md:text-4xl font-black text-slate-900 dark:text-white"
                                id="protocol-temp"
                            >
                                -
                            </p>
                            <p
                                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-2"
                            >
                                Temperatura
                            </p>
                        </div>
                    </div>

                    <div
                        class="bg-indigo-600 dark:bg-indigo-600 rounded-2xl md:rounded-3xl p-6 md:p-8 shadow-xl shadow-indigo-600/10 relative overflow-hidden group"
                    >
                        <div
                            class="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform"
                        >
                            <Icon name="mdi:washing-machine" class="text-8xl text-white" />
                        </div>
                        <div class="relative">
                            <div class="flex items-center gap-3 mb-4">
                                <div
                                    class="w-8 h-8 rounded-lg bg-white/20 backdrop-blur-sm flex items-center justify-center text-white"
                                >
                                    <Icon name="mdi:format-list-bulleted" class="text-lg" />
                                </div>
                                <span
                                    class="text-[10px] uppercase font-black text-indigo-100 tracking-[0.2em]"
                                    >Instrucciones de Limpieza</span
                                >
                            </div>
                            <div
                                class="text-white text-base md:text-lg leading-relaxed font-bold tracking-tight"
                                id="protocol-method"
                            >
                                -
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div
                            id="protocol-warning"
                            class="hidden p-5 rounded-2xl bg-red-50 dark:bg-red-950/30 border border-red-100 dark:border-red-900/30 animate-pulse-slow"
                        >
                            <div class="flex gap-4 items-start">
                                <Icon
                                    name="mdi:shield-alert-outline"
                                    class="text-2xl text-red-600 dark:text-red-400 shrink-0 mt-0.5"
                                />
                                <div class="space-y-1">
                                    <p
                                        class="text-[9px] uppercase font-black text-red-600 dark:text-red-400 tracking-widest"
                                    >
                                        Precaución Crítica
                                    </p>
                                    <p
                                        class="text-sm font-bold text-slate-900 dark:text-slate-100 leading-relaxed"
                                        id="warning-text"
                                    >
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div
                            class="p-5 rounded-2xl bg-slate-100 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700"
                        >
                            <div class="flex gap-4 items-start">
                                <div
                                    class="w-6 h-6 rounded-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 flex items-center justify-center text-[10px] font-black shrink-0 mt-1"
                                >
                                    !
                                </div>
                                <div class="space-y-1">
                                    <p
                                        class="text-[9px] uppercase font-black text-slate-500 dark:text-slate-400 tracking-widest"
                                    >
                                        Nota técnica
                                    </p>
                                    <p
                                        class="text-xs md:text-sm font-bold text-slate-700 dark:text-slate-300 leading-relaxed"
                                    >
                                        Valida siempre la solidez del tinte en una zona no visible
                                        antes de proceder con el tratamiento químico completo.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div
            id="empty-state"
            class="p-10 md:p-16 text-center transition-all bg-white dark:bg-slate-900"
        >
            <div
                class="w-16 h-16 md:w-24 md:h-24 bg-slate-50 dark:bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-6 md:mb-8 shadow-inner"
            >
                <Icon
                    name="mdi:hanger"
                    class="text-3xl md:text-5xl text-slate-200 dark:text-slate-700"
                />
            </div>
            <h4
                class="text-slate-900 dark:text-white font-black text-lg md:text-xl mb-2 md:mb-3 tracking-tight"
            >
                Sistema de Diagnóstico
            </h4>
            <p
                class="text-slate-400 dark:text-slate-500 font-medium text-xs md:text-sm max-w-[240px] md:max-w-[280px] mx-auto leading-relaxed"
            >
                Configura los parámetros textiles para obtener la hoja de ruta de limpieza
            </p>
        </div>
    </div>
</div>

<script>
    import {
        STAIN_DATA,
        CHEMICAL_AGENTS,
        type StainType,
    } from "../../../../data/utilities/textiles";

    const fiberSelect = document.getElementById("fiber-select") as HTMLSelectElement;
    const stainSelect = document.getElementById("stain-select") as HTMLSelectElement;
    const display = document.getElementById("protocol-display");
    const emptyState = document.getElementById("empty-state");

    function updateProtocol() {
        const fiberId = fiberSelect.value;
        const stainId = stainSelect.value;

        if (!fiberId || !stainId || !display || !emptyState) return;

        const fiberOption = fiberSelect.options[fiberSelect.selectedIndex];
        const fiberType = (fiberOption.dataset.fiberType as string) || "natural";

        const stain = STAIN_DATA.find((s) => s.id === stainId);
        if (!stain) return;

        const protocol =
            stain.protocols[fiberType as keyof StainType["protocols"]] || stain.protocols.natural;
        if (!protocol) return;

        const agent = CHEMICAL_AGENTS[protocol.agentId];
        if (!agent) return;

        emptyState.classList.add("hidden");
        display.classList.remove("hidden");

        const titleEl = document.getElementById("protocol-title");
        const agentEl = document.getElementById("protocol-agent");
        const agentDescEl = document.getElementById("protocol-agent-desc");
        const tempEl = document.getElementById("protocol-temp");
        const methodEl = document.getElementById("protocol-method");

        if (titleEl) titleEl.textContent = stain.name;
        if (agentEl) agentEl.textContent = agent.name;
        if (agentDescEl) agentDescEl.textContent = agent.description;
        if (tempEl) tempEl.textContent = protocol.temperature;
        if (methodEl) methodEl.textContent = protocol.method;

        const warningDiv = document.getElementById("protocol-warning");
        const warningText = document.getElementById("warning-text");

        if (!warningDiv || !warningText) return;

        let warning = agent.warning || "";

        if (fiberType === "delicate" && protocol.agentId === "percarbonate") {
            warning =
                "RIESGO DE DEGRADACIÓN MOLECULAR. Fibras animales altamente sensibles al percarbonato. Realizar test en zona no visible.";
        }

        if (warning) {
            warningDiv.classList.remove("hidden");
            warningText.textContent = warning;
        } else {
            warningDiv.classList.add("hidden");
        }
    }

    fiberSelect.addEventListener("change", updateProtocol);
    stainSelect.addEventListener("change", updateProtocol);
</script>

<style>
    .animate-pulse-slow {
        animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0.8;
        }
    }
</style>
