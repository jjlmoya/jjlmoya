---
import { Icon } from "astro-icon/components";
import { FIBER_DATA } from "./FabricEngine";

const fibers = Object.entries(FIBER_DATA)
    .map(([id, data]) => ({ id, ...data }))
    .sort((a, b) => a.name.localeCompare(b.name));
---

<div class="fabric-truth-container max-w-4xl mx-auto p-4 sm:p-8" id="fabric-truth-root">
    <div
        class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden border border-white/20 dark:border-slate-800"
    >
        
        <div class="p-6 sm:p-10 border-b border-slate-100 dark:border-slate-800">
            <h2
                class="text-2xl font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-2"
            >
                <Icon name="mdi:tag-text-outline" class="w-8 h-8 text-indigo-500" />
                Análisis de Composición
            </h2>
            <p class="text-slate-600 dark:text-slate-400 mb-8">
                Añade los porcentajes tal cual aparecen en la etiqueta de tu prenda para descubrir
                la verdad sobre su calidad.
            </p>

            <div id="composition-rows" class="space-y-4 mb-8">
                
            </div>

            <div class="flex flex-col sm:flex-row items-center justify-between gap-6 pt-6 border-t border-slate-100 dark:border-slate-800">
                <button
                    id="add-row-btn"
                    class="flex items-center gap-2 px-6 py-3 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-xl transition-all font-medium"
                >
                    <Icon name="mdi:plus" class="w-5 h-5" />
                    Añadir Fibra
                </button>

                <div id="total-indicator" class="px-6 py-3 rounded-xl font-mono font-bold transition-all">
                    Total: <span id="total-val">0</span>%
                </div>
            </div>
        </div>

        
        <div class="p-6 sm:p-10 bg-slate-50/50 dark:bg-slate-900/50">
            <div id="empty-state" class="text-center py-10">
                <Icon
                    name="mdi:alert-circle-outline"
                    class="w-16 h-16 mx-auto text-slate-300 dark:text-slate-700 mb-4"
                />
                <p class="text-slate-500 font-medium">La composición debe sumar exactamente 100% para ver el veredicto</p>
                <p id="total-helper" class="text-xs text-slate-400 mt-2 italic"></p>
            </div>

            <div
                id="result-content"
                class="hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500"
            >
                
                <div
                    id="verdict-card"
                    class="p-6 rounded-2xl border-l-8 transition-colors duration-500"
                >
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div class="flex-grow">
                            <span
                                class="text-sm font-bold uppercase tracking-wider opacity-70"
                                id="verdict-label-meta">Veredicto</span
                            >
                            <h3 class="text-3xl font-black mb-2" id="verdict-label">
                                Calidad Natural
                            </h3>
                            <p class="text-lg opacity-90" id="verdict-description">
                                Prenda transpirable y duradera. Ideal para pieles sensibles.
                            </p>
                        </div>
                        <div
                            id="verdict-icon-container"
                            class="rounded-full bg-white/20 p-4 hidden sm:block"
                        >
                            <Icon name="mdi:check-decagram" class="w-12 h-12" id="verdict-icon" />
                        </div>
                    </div>
                </div>

                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div
                        class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800"
                    >
                        <div class="flex items-center gap-2 mb-4 text-emerald-500">
                            <Icon name="mdi:wind-power" class="w-5 h-5" />
                            <span class="font-bold uppercase text-xs tracking-widest text-slate-500"
                                >Transpirabilidad</span
                            >
                        </div>
                        <div
                            class="relative h-3 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"
                        >
                            <div
                                id="stat-breathability"
                                class="absolute inset-y-0 left-0 bg-emerald-500 transition-all duration-1000"
                                style="width: 0%"
                            >
                            </div>
                        </div>
                        <div
                            class="mt-2 text-right font-mono text-slate-600 dark:text-slate-400 text-sm"
                            id="stat-val-breathability"
                        >
                            0/10
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800"
                    >
                        <div class="flex items-center gap-2 mb-4 text-blue-500">
                            <Icon name="mdi:shield-check" class="w-5 h-5" />
                            <span class="font-bold uppercase text-xs tracking-widest text-slate-500"
                                >Durabilidad</span
                            >
                        </div>
                        <div
                            class="relative h-3 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"
                        >
                            <div
                                id="stat-durability"
                                class="absolute inset-y-0 left-0 bg-blue-500 transition-all duration-1000"
                                style="width: 0%"
                            >
                            </div>
                        </div>
                        <div
                            class="mt-2 text-right font-mono text-slate-600 dark:text-slate-400 text-sm"
                            id="stat-val-durability"
                        >
                            0/10
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800"
                    >
                        <div class="flex items-center gap-2 mb-4 text-orange-500">
                            <Icon name="mdi:fire-circle" class="w-5 h-5" />
                            <span class="font-bold uppercase text-xs tracking-widest text-slate-500"
                                >Calidez</span
                            >
                        </div>
                        <div
                            class="relative h-3 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"
                        >
                            <div
                                id="stat-warmth"
                                class="absolute inset-y-0 left-0 bg-orange-500 transition-all duration-1000"
                                style="width: 0%"
                            >
                            </div>
                        </div>
                        <div
                            class="mt-2 text-right font-mono text-slate-600 dark:text-slate-400 text-sm"
                            id="stat-val-warmth"
                        >
                            0/10
                        </div>
                    </div>
                </div>

                
                <div
                    class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800/50 p-6 rounded-2xl flex gap-4"
                >
                    <Icon name="mdi:alert-circle" class="w-8 h-8 text-amber-500 shrink-0" />
                    <div>
                        <h4
                            class="font-bold text-amber-900 dark:text-amber-200 mb-1 tracking-wide text-xs"
                        >
                            Aviso de Cuidados Especiales
                        </h4>
                        <p class="text-amber-800 dark:text-amber-300 text-sm" id="care-warning">
                            LAVADO ESTÁNDAR: Sigue siempre las instrucciones de la etiqueta física.
                        </p>
                    </div>
                </div>

                <div class="text-center">
                    <p
                        class="text-[10px] text-slate-400 dark:text-slate-600 uppercase tracking-widest"
                    >
                        Los datos de transpirabilidad, durabilidad y calidez son estimaciones
                        basadas en promedios de la industria para cada tipo de fibra.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<datalist id="perc-list">
    <option value="100">100%</option>
    <option value="95">95%</option>
    <option value="80">80%</option>
    <option value="50">50%</option>
    <option value="30">30%</option>
    <option value="10">10%</option>
    <option value="5">5%</option>
    <option value="2">2%</option>
</datalist>

<template id="fiber-row-template">
    <div
        class="fiber-row flex flex-wrap sm:flex-nowrap items-center gap-3 animate-in fade-in slide-in-from-left-2 duration-300"
    >
        <div class="flex-grow min-w-[200px]">
            <select
                class="fiber-select w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-slate-900 dark:text-white appearance-none cursor-pointer"
            >
                {fibers.map((f) => <option value={f.id}>{f.name}</option>)}
            </select>
        </div>
        <div class="w-32 relative group">
            <input
                type="number"
                min="0"
                max="100"
                step="1"
                placeholder="0"
                list="perc-list"
                class="fiber-perc w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-slate-900 dark:text-white pr-8"
            />
            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none group-hover:text-indigo-500 transition-colors font-bold">%</span>
        </div>
        <button class="remove-row-btn p-3 text-slate-400 hover:text-red-500 transition-colors">
            <Icon name="mdi:close-circle-outline" class="w-6 h-6" />
        </button>
    </div>
</template>

<script>
    import { FabricEngine } from "./FabricEngine";

    const root = document.getElementById("fabric-truth-root");
    if (root) {
        const container = document.getElementById("composition-rows");
        const addBtn = document.getElementById("add-row-btn");
        const template = document.getElementById("fiber-row-template") as HTMLTemplateElement;

        const emptyState = document.getElementById("empty-state");
        const resultContent = document.getElementById("result-content");
        const totalVal = document.getElementById("total-val");
        const totalIndicator = document.getElementById("total-indicator");
        const totalHelper = document.getElementById("total-helper");

        
        const verdictCard = document.getElementById("verdict-card");
        const verdictLabel = document.getElementById("verdict-label");
        const verdictDescription = document.getElementById("verdict-description");
        const careWarning = document.getElementById("care-warning");

        
        const statB = document.getElementById("stat-breathability");
        const statD = document.getElementById("stat-durability");
        const statW = document.getElementById("stat-warmth");
        const valB = document.getElementById("stat-val-breathability");
        const valD = document.getElementById("stat-val-durability");
        const valW = document.getElementById("stat-val-warmth");

        const colors: Record<string, { bg: string; text: string; border: string }> = {
            red: { bg: "bg-red-500", text: "text-white", border: "border-red-600" },
            amber: { bg: "bg-amber-400", text: "text-amber-950", border: "border-amber-500" },
            yellow: { bg: "bg-yellow-400", text: "text-yellow-950", border: "border-yellow-500" },
            emerald: { bg: "bg-emerald-500", text: "text-white", border: "border-emerald-600" },
            blue: { bg: "bg-blue-500", text: "text-white", border: "border-blue-600" },
            indigo: { bg: "bg-indigo-600", text: "text-white", border: "border-indigo-700" },
            gray: { bg: "bg-slate-200", text: "text-slate-600", border: "border-slate-300" },
        };

        function updateAnalysis() {
            const rows = container?.querySelectorAll(".fiber-row");
            if (!rows) return;

            const composition = Array.from(rows)
                .map((row) => {
                    const select = row.querySelector(".fiber-select") as HTMLSelectElement;
                    const input = row.querySelector(".fiber-perc") as HTMLInputElement;
                    return {
                        fiberId: select.value,
                        percentage: parseFloat(input.value) || 0,
                    };
                })
                .filter((c) => c.percentage > 0);

            const total = composition.reduce((acc, c) => acc + c.percentage, 0);

            
            if (totalVal) totalVal.textContent = total.toString();
            if (totalIndicator) {
                if (total === 100) {
                    totalIndicator.className = "px-6 py-3 rounded-xl font-mono font-bold transition-all bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800/50";
                } else if (total > 100) {
                    totalIndicator.className = "px-6 py-3 rounded-xl font-mono font-bold transition-all bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 border border-red-200 dark:border-red-800/50 animate-pulse";
                } else {
                    totalIndicator.className = "px-6 py-3 rounded-xl font-mono font-bold transition-all bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400";
                }
            }

            if (totalHelper) {
                if (total === 100) {
                    totalHelper.textContent = "";
                } else {
                    totalHelper.textContent = `Actual: ${total}% (faltan ${100 - total}%)`;
                }
            }

            if (total !== 100) {
                emptyState?.classList.remove("hidden");
                resultContent?.classList.add("hidden");
                return;
            }

            emptyState?.classList.add("hidden");
            resultContent?.classList.remove("hidden");

            const verdict = FabricEngine.calculateVerdict(composition);
            const averages = FabricEngine.getAverages(composition);
            const warning = FabricEngine.getCareWarning(composition);

            
            if (verdictLabel) verdictLabel.textContent = verdict.label;
            if (verdictDescription) verdictDescription.textContent = verdict.description;

            
            const colorSet = colors[verdict.color] || colors.gray;
            if (verdictCard) {
                verdictCard.className = `p-6 rounded-2xl border-l-8 transition-all duration-500 ${colorSet.bg} ${colorSet.text} ${colorSet.border} shadow-lg shadow-${verdict.color}-500/20`;
            }

            
            if (statB) statB.style.width = `${averages.b * 10}%`;
            if (statD) statD.style.width = `${averages.d * 10}%`;
            if (statW) statW.style.width = `${averages.w * 10}%`;

            if (valB) valB.textContent = `${averages.b.toFixed(1)}/10`;
            if (valD) valD.textContent = `${averages.d.toFixed(1)}/10`;
            if (valW) valW.textContent = `${averages.w.toFixed(1)}/10`;

            if (careWarning) careWarning.textContent = warning;
        }

        function addRow() {
            if (!template || !container) return;

            
            const currentRows = container.querySelectorAll(".fiber-row");
            let currentTotal = 0;
            currentRows.forEach(r => {
                const inp = r.querySelector(".fiber-perc") as HTMLInputElement;
                currentTotal += parseFloat(inp.value) || 0;
            });

            if (currentTotal >= 100) return;

            const clone = template.content.cloneNode(true) as HTMLElement;
            const row = clone.querySelector(".fiber-row") as HTMLElement;
            if (!row) return;

            const select = row.querySelector(".fiber-select") as HTMLSelectElement;
            const input = row.querySelector(".fiber-perc") as HTMLInputElement;
            const removeBtn = row.querySelector(".remove-row-btn");

            
            if (container.children.length === 0) {
                select.value = "cotton";
                input.value = "100";
            } else {
                input.value = (100 - currentTotal).toString();
            }

            select.addEventListener("change", updateAnalysis);
            
            input.addEventListener("input", (e) => {
                const rows = container.querySelectorAll(".fiber-row");
                let otherTotal = 0;
                rows.forEach(r => {
                    if (r === row) return;
                    const inp = r.querySelector(".fiber-perc") as HTMLInputElement;
                    otherTotal += parseFloat(inp.value) || 0;
                });

                let val = parseFloat(input.value) || 0;
                if (val + otherTotal > 100) {
                    val = 100 - otherTotal;
                    input.value = val.toString();
                }
                
                updateAnalysis();
            });

            removeBtn?.addEventListener("click", () => {
                row.remove();
                updateAnalysis();
            });

            container.appendChild(row);
            updateAnalysis();
        }

        addBtn?.addEventListener("click", addRow);

        
        addRow();
    }
</script>

<style>
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type="number"] {
        -moz-appearance: textfield;
    }

    .fiber-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http:
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
    }
</style>
