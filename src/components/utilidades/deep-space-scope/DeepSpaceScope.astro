---
import { Icon } from "astro-icon/components";
---

<script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>

<div
    class="relative w-full h-[600px] md:h-[800px] bg-black rounded-3xl shadow-2xl overflow-hidden group select-none font-sans border border-slate-800 cursor-grab active:cursor-grabbing touch-none"
    id="scope-container"
>
    <div id="world-layer" class="absolute inset-0 w-full h-full will-change-transform">
        <div class="absolute inset-0 w-full h-full z-0">
            <img
                src="/images/utilities/galaxy_bg.webp"
                alt="Deep Space"
                class="w-full h-full object-cover opacity-50"
            />
        </div>

        <canvas id="sky-canvas" class="absolute inset-0 w-full h-full z-0"></canvas>

        <div id="objects-layer" class="absolute inset-0 w-full h-full z-10 pointer-events-none">
        </div>
    </div>

    <div
        class="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_0%,rgba(0,0,0,0.5)_100%)] pointer-events-none z-20"
    >
    </div>
    <div
        id="pollution-layer"
        class="absolute inset-0 z-10 pointer-events-none mix-blend-screen bg-transparent transition-colors duration-500"
    >
    </div>

    <div
        class="absolute top-6 left-1/2 -translate-x-1/2 z-30 opacity-70 pointer-events-none bg-black/50 px-4 py-1 rounded-full text-[10px] text-white uppercase tracking-widest border border-white/10 backdrop-blur-md"
    >
        <span class="md:hidden">Arrastra para explorar 360°</span>
        <span class="hidden md:inline">Haz click y arrastra para explorar el cosmos (360°)</span>
    </div>

    <div
        id="info-modal"
        class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300"
        aria-hidden="true"
    >
        <div
            class="bg-slate-900 border border-white/20 p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-6 transform scale-95 transition-transform duration-300"
            id="modal-content"
        >
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                    <div id="modal-icon" class="text-4xl"></div>
                    <div>
                        <h3 id="modal-title" class="text-xl font-bold text-white leading-none">
                            Object Name
                        </h3>
                        <p
                            id="modal-type"
                            class="text-xs text-slate-400 font-mono uppercase tracking-wider mt-1"
                        >
                            Type
                        </p>
                    </div>
                </div>
                <button id="close-modal" class="text-slate-400 hover:text-white transition-colors">
                    <span class="iconify text-2xl" data-icon="mdi:close"></span>
                </button>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
                    <span class="text-xs text-slate-400 uppercase">Magnitud</span>
                    <span id="modal-mag" class="font-mono text-white font-bold">1.5</span>
                </div>
                <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
                    <span class="text-xs text-slate-400 uppercase">Coordenadas</span>
                    <div class="text-right">
                        <div id="modal-az" class="text-xs text-white font-mono">Az: 120°</div>
                        <div id="modal-alt" class="text-xs text-slate-500 font-mono">Alt: 45°</div>
                    </div>
                </div>
                <p id="modal-desc" class="text-sm text-slate-300 leading-relaxed mt-2">
                    Description text...
                </p>
            </div>
        </div>
    </div>

    <div
        class="absolute bottom-6 left-6 right-6 z-40 flex flex-col items-center gap-4 pointer-events-auto"
    >
        <div
            class="w-full max-w-4xl bg-slate-900/90 backdrop-blur-xl border border-white/20 rounded-2xl p-4 md:p-6 shadow-[0_0_50px_rgba(0,0,0,0.5)]"
        >
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label
                            for="aperture"
                            class="text-xs font-bold uppercase tracking-wider text-cyan-400 flex items-center gap-2"
                        >
                            <Icon name="mdi:telescope" /> Apertura
                        </label>
                        <span
                            id="aperture-display"
                            class="font-mono text-white text-sm bg-white/10 px-2 py-0.5 rounded"
                            >200mm</span
                        >
                    </div>
                    <input
                        type="range"
                        id="aperture"
                        min="0"
                        max="100"
                        step="1"
                        value="50"
                        class="w-full h-1.5 bg-slate-700 rounded-full appearance-none cursor-pointer accent-cyan-500 hover:accent-cyan-400 focus:outline-none"
                    />
                </div>

                <div
                    class="flex flex-col items-center justify-center border-x border-white/10 px-4 select-text"
                >
                    <div class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">
                        Magnitud Límite
                    </div>
                    <div
                        id="limit-mag"
                        class="text-5xl font-black text-white font-mono leading-none drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]"
                    >
                        12.5
                    </div>
                    <div class="text-[10px] text-cyan-300/50 mt-2 font-mono" id="azimuth-display">
                        AZ: 0°
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label
                            for="bortle"
                            class="text-xs font-bold uppercase tracking-wider text-amber-500 flex items-center gap-2"
                        >
                            <Icon name="mdi:weather-night" /> Cielo (Bortle)
                        </label>
                        <span
                            id="bortle-display"
                            class="font-mono text-white text-sm bg-white/10 px-2 py-0.5 rounded"
                            >Class 5</span
                        >
                    </div>
                    <input
                        type="range"
                        id="bortle"
                        min="1"
                        max="9"
                        step="1"
                        value="5"
                        class="w-full h-1.5 bg-slate-700 rounded-full appearance-none cursor-pointer accent-amber-500 hover:accent-amber-400 focus:outline-none"
                    />
                </div>
            </div>
        </div>

        <div
            class="flex gap-4 md:gap-8 text-[10px] font-bold uppercase tracking-widest text-slate-500 bg-black/80 px-6 py-2 rounded-full backdrop-blur-sm border border-white/5 shadow-lg"
        >
            <span class="flex items-center gap-2 text-yellow-100"
                ><Icon name="mdi:circle" /> Planetas</span
            >
            <span class="flex items-center gap-2 text-white"
                ><Icon name="mdi:star-four-points" /> Estrellas</span
            >
            <span class="flex items-center gap-2 text-indigo-300"
                ><Icon name="mdi:creation" /> Espacio Profundo</span
            >
        </div>
    </div>
</div>

<script>
    import { OBJECTS } from "../../../data/utilities/deepSpaceData";

    const container = document.getElementById("scope-container");
    const canvas = document.getElementById("sky-canvas") as HTMLCanvasElement;
    const ctx = canvas?.getContext("2d");
    const objectsLayer = document.getElementById("objects-layer");
    const apertureInput = document.getElementById("aperture") as HTMLInputElement;
    const bortleInput = document.getElementById("bortle") as HTMLInputElement;
    const pollutionLayer = document.getElementById("pollution-layer");
    const limitMagDisplay = document.getElementById("limit-mag");
    const azimuthDisplay = document.getElementById("azimuth-display");

    let panAngle = 0;
    let isDragging = false;
    let startX = 0;
    let startPan = 0;
    let dragDistance = 0;

    const FOV = 100;

    let stars: { az: number; alt: number; mag: number; size: number }[] = [];
    function initStars() {
        stars = [];
        for (let i = 0; i < 3000; i++) {
            stars.push({
                az: Math.random() * 360,
                alt: Math.random() * 100,
                mag: Math.pow(Math.random(), 0.8) * 15,
                size: 0,
            });
        }
    }

    function initObjectsDOM() {
        if (!objectsLayer) return;
        objectsLayer.innerHTML = "";

        OBJECTS.forEach((obj, idx) => {
            const el = document.createElement("div");
            el.id = `obj-${idx}`;
            el.className =
                "absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-center transition-opacity duration-300 will-change-transform pointer-events-auto cursor-pointer group";
            el.dataset.mag = obj.mag.toString();

            el.innerHTML = `
                <div class="text-3xl md:text-5xl drop-shadow-xl ${obj.color} opacity-90 transition-transform duration-300 group-hover:scale-125">
                    <span class="iconify" data-icon="${obj.icon}"></span>
                </div>
                <div class="object-label mt-2 flex flex-col items-center opacity-0 scale-90 transition-all duration-300 group-hover:opacity-100 group-hover:scale-100">
                    <span class="text-[10px] font-bold text-white bg-black/60 px-2 py-0.5 rounded backdrop-blur-md whitespace-nowrap border border-white/10 shadow-lg">${obj.name}</span>
                    <span class="text-[8px] text-slate-400 bg-black/80 px-1 rounded mt-0.5">Mag ${obj.mag}</span>
                </div>
            `;

            el.addEventListener("click", (e) => {
                e.stopPropagation();
                if (dragDistance < 5) {
                    openModal(obj);
                }
            });

            objectsLayer.appendChild(el);
        });
    }

    const modal = document.getElementById("info-modal");
    const modalContent = document.getElementById("modal-content");
    const closeModalBtn = document.getElementById("close-modal");

    function openModal(obj: (typeof OBJECTS)[0]) {
        if (!modal || !modalContent) return;

        document.getElementById("modal-title")!.innerText = obj.name;
        document.getElementById("modal-type")!.innerText = obj.type;
        document.getElementById("modal-mag")!.innerText = obj.mag.toString();
        document.getElementById("modal-az")!.innerText = `Azimuth: ${obj.az}°`;
        document.getElementById("modal-alt")!.innerText = `Altitud: ${obj.alt}°`;

        const iconEl = document.getElementById("modal-icon");
        if (iconEl) {
            iconEl.innerHTML = `<span class="iconify ${obj.color}" data-icon="${obj.icon}"></span>`;
        }

        const descEl = document.getElementById("modal-desc");
        if (descEl) {
            let desc = "";
            if ((obj as any).desc) {
                desc = (obj as any).desc;
            } else {
                if (obj.type === "Planeta")
                    desc = `Uno de los cuerpos principales de nuestro Sistema Solar.`;
                else if (obj.type === "Estrella")
                    desc = `Una estrella brillante observable en el cielo nocturno.`;
                else if (obj.type === "Galaxia")
                    desc = `Una inmensa isla de estrellas fuera de nuestra Vía Láctea.`;
                else if (obj.type === "Nebulosa")
                    desc = `Una nube interestelar de polvo y gas, cuna de nuevas estrellas.`;
                else desc = `Un objeto fascinante del espacio profundo.`;

                desc += ` Con magnitud ${obj.mag}, ${obj.mag < 6 ? "es visible a simple vista en cielos oscuros." : "requiere óptica para ser observado."}`;
            }
            descEl.innerText = desc;
        }

        modal.classList.remove("opacity-0", "pointer-events-none");
        modalContent.classList.remove("scale-95");
        modalContent.classList.add("scale-100");
    }

    function closeModal() {
        if (!modal || !modalContent) return;
        modal.classList.add("opacity-0", "pointer-events-none");
        modalContent.classList.remove("scale-100");
        modalContent.classList.add("scale-95");
    }

    closeModalBtn?.addEventListener("click", closeModal);
    modal?.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
    });

    function getShortestDelta(target: number, current: number) {
        const delta = target - current;
        return ((delta + 540) % 360) - 180;
    }

    function calculateLimit(aperture: number, bortle: number) {
        const mm = 50 + (aperture / 100) * 350;

        const nakedEyeMag = 7.9 - bortle * 0.5;
        const gainMag = 5 * Math.log10(mm / 6);
        let limit = nakedEyeMag + gainMag;
        if (bortle > 4) limit -= (bortle - 4) * 0.3;
        return Math.max(0, Math.min(limit, 16.5));
    }

    function render() {
        if (!ctx || !canvas) return;

        const w = (canvas.width = canvas.offsetWidth);
        const h = (canvas.height = canvas.offsetHeight);
        ctx.clearRect(0, 0, w, h);

        const sliderVal = parseInt(apertureInput.value);
        const bortle = parseInt(bortleInput.value);
        const limit = calculateLimit(sliderVal, bortle);
        const apertureMM = Math.round(50 + (sliderVal / 100) * 350);

        document.getElementById("aperture-display")!.innerText = `${apertureMM}mm`;
        document.getElementById("bortle-display")!.innerText = `Clase ${bortle}`;
        if (limitMagDisplay) limitMagDisplay.innerText = limit.toFixed(1);
        if (azimuthDisplay) azimuthDisplay.innerText = `AZ: ${Math.round(panAngle)}°`;

        if (pollutionLayer) {
            const opacity = (bortle - 1) * 0.08;
            pollutionLayer.style.backgroundColor = `rgba(217, 119, 6, ${opacity})`;
        }

        const ppd = w / FOV;

        stars.forEach((s) => {
            if (s.mag > limit) return;

            const delta = getShortestDelta(s.az, panAngle);

            if (Math.abs(delta) < FOV / 2 + 10) {
                const x = w / 2 + delta * ppd;
                const y = h - (s.alt / 100) * h;

                const margin = limit - s.mag;
                const alpha = Math.min(1, margin * 0.4);
                const size = Math.max(0.6, 3 - s.mag / 4);

                ctx.fillStyle = `rgba(255,255,255, ${alpha})`;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
        });

        OBJECTS.forEach((obj, idx) => {
            const el = document.getElementById(`obj-${idx}`);
            if (!el) return;

            if (obj.mag > limit) {
                el.style.display = "none";
                return;
            }

            const delta = getShortestDelta(obj.az, panAngle);

            if (Math.abs(delta) < FOV / 2 + 20) {
                el.style.display = "flex";
                const x = 50 + (delta / (FOV / 2)) * 50;
                const y = 100 - obj.alt;

                el.style.left = `${x}%`;
                el.style.top = `${y}%`;

                const label = el.querySelector(".object-label");
                const margin = limit - obj.mag;
                if (margin > 2.0) {
                    label?.classList.remove("opacity-0", "scale-90");
                    label?.classList.add("opacity-100", "scale-100");
                } else {
                    label?.classList.add("opacity-0", "scale-90");
                    label?.classList.remove("opacity-100", "scale-100");
                }
            } else {
                el.style.display = "none";
            }
        });
    }

    container?.addEventListener("mousedown", (e) => {
        isDragging = true;
        startX = e.clientX;
        startPan = panAngle;
        dragDistance = 0;
        container.style.cursor = "grabbing";
    });

    window.addEventListener("mousemove", (e) => {
        if (!isDragging || !container) return;
        const dx = e.clientX - startX;
        dragDistance += Math.abs(e.movementX);

        const degreesPerPixel = FOV / container.offsetWidth;
        let newPan = startPan - dx * degreesPerPixel;

        if (newPan < 0) newPan += 360;
        if (newPan >= 360) newPan -= 360;

        panAngle = newPan;
        requestAnimationFrame(render);
    });

    window.addEventListener("mouseup", () => {
        isDragging = false;
        if (container) container.style.cursor = "grab";
    });

    container?.addEventListener("touchstart", (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        startPan = panAngle;
        dragDistance = 0;
    });
    window.addEventListener("touchmove", (e) => {
        if (!isDragging || !container) return;
        const dx = e.touches[0].clientX - startX;
        dragDistance += Math.abs(dx);

        const degreesPerPixel = FOV / container.offsetWidth;
        let newPan = startPan - dx * degreesPerPixel;
        if (newPan < 0) newPan += 360;
        if (newPan >= 360) newPan -= 360;
        panAngle = newPan;
        requestAnimationFrame(render);
    });
    window.addEventListener("touchend", () => (isDragging = false));

    initStars();
    initObjectsDOM();

    apertureInput.addEventListener("input", () => requestAnimationFrame(render));
    bortleInput.addEventListener("input", () => requestAnimationFrame(render));
    window.addEventListener("resize", () => requestAnimationFrame(render));

    setTimeout(render, 50);
</script>
