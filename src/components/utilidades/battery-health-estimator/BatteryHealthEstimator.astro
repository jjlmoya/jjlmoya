---
import { Icon } from "astro-icon/components";
---

<section class="max-w-5xl mx-auto px-4 py-12 relative">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 items-start">
        <div class="lg:col-span-4 space-y-6">
            <div
                class="bg-white/80 dark:bg-zinc-900/80 backdrop-blur-xl border border-slate-200 dark:border-zinc-800 rounded-3xl p-8 shadow-xl"
            >
                <h3
                    class="text-lg font-bold text-slate-900 dark:text-white mb-8 flex items-center gap-2"
                >
                    <Icon
                        name="mdi:battery-check"
                        class="w-5 h-5 text-emerald-600 dark:text-emerald-400"
                    />
                    Parámetros de Celda
                </h3>

                <div class="space-y-8">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label
                                class="text-xs font-bold uppercase tracking-widest text-slate-500 dark:text-zinc-400"
                                >Voltaje Actual</label
                            >
                            <span
                                id="voltage-value"
                                class="text-sm font-mono font-bold text-emerald-600 dark:text-emerald-400"
                                >3.70V</span
                            >
                        </div>
                        <input
                            type="range"
                            id="voltage-slider"
                            min="3.0"
                            max="4.2"
                            step="0.01"
                            value="3.70"
                            class="w-full h-1.5 bg-slate-200 dark:bg-zinc-800 rounded-full appearance-none cursor-pointer accent-emerald-600"
                        />
                        <p class="text-[10px] text-slate-400 dark:text-zinc-500 italic">
                            Rango nominal: 3.0V (vacío) a 4.2V (lleno).
                        </p>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label
                                class="text-xs font-bold uppercase tracking-widest text-slate-500 dark:text-zinc-400"
                                >Ciclos de Carga</label
                            >
                            <span
                                id="cycles-value"
                                class="text-sm font-mono font-bold text-emerald-600 dark:text-emerald-400"
                                >50</span
                            >
                        </div>
                        <input
                            type="range"
                            id="cycles-slider"
                            min="0"
                            max="1000"
                            step="1"
                            value="50"
                            class="w-full h-1.5 bg-slate-200 dark:bg-zinc-800 rounded-full appearance-none cursor-pointer accent-emerald-600"
                        />
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label
                                class="text-xs font-bold uppercase tracking-widest text-slate-500 dark:text-zinc-400"
                                >Temperatura</label
                            >
                            <span
                                id="temp-value"
                                class="text-sm font-mono font-bold text-emerald-600 dark:text-emerald-400"
                                >25°C</span
                            >
                        </div>
                        <input
                            type="range"
                            id="temp-slider"
                            min="0"
                            max="60"
                            step="1"
                            value="25"
                            class="w-full h-1.5 bg-slate-200 dark:bg-zinc-800 rounded-full appearance-none cursor-pointer accent-emerald-600"
                        />
                    </div>
                </div>
            </div>

            <div
                id="status-card"
                class="p-6 transition-colors duration-500 rounded-2xl space-y-4 border"
            >
                <div class="flex items-center gap-3">
                    <Icon id="status-icon" name="mdi:check-decagram" class="w-5 h-5" />
                    <span id="status-text" class="text-sm font-bold uppercase tracking-wider"
                        >Estado Excelente</span
                    >
                </div>
                <div id="recommendations-container" class="space-y-2"></div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-8">
            <div
                class="bg-white dark:bg-zinc-950 border border-slate-200 dark:border-zinc-800 rounded-3xl p-8 shadow-2xl relative min-h-[500px] flex flex-col items-center justify-center overflow-hidden group"
            >
                <div
                    class="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(16,185,129,0.05),transparent)] pointer-events-none"
                >
                </div>

                <div class="relative w-64 h-64 md:w-80 md:h-80 flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle
                            cx="50%"
                            cy="50%"
                            r="45%"
                            stroke="currentColor"
                            stroke-width="12"
                            fill="transparent"
                            class="text-slate-100 dark:text-zinc-900"></circle>
                        <circle
                            id="progress-ring"
                            cx="50%"
                            cy="50%"
                            r="45%"
                            stroke="currentColor"
                            stroke-width="12"
                            fill="transparent"
                            stroke-dasharray="100 100"
                            stroke-linecap="round"
                            class="text-emerald-500 transition-all duration-1000 ease-out"></circle>
                    </svg>

                    <div
                        class="absolute inset-0 flex flex-col items-center justify-center text-center"
                    >
                        <span
                            class="text-xs font-black text-slate-400 dark:text-zinc-500 uppercase tracking-[0.3em] mb-1"
                            >Vida Útil</span
                        >
                        <div class="flex items-end">
                            <span
                                id="soh-display"
                                class="text-6xl md:text-7xl font-black text-slate-900 dark:text-white leading-none"
                                >100</span
                            >
                            <span class="text-2xl font-black text-slate-400 mb-1 ml-1">%</span>
                        </div>
                        <div
                            id="years-badge"
                            class="mt-4 px-4 py-1.5 rounded-full bg-slate-100 dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 shadow-sm"
                        >
                            <span
                                id="years-display"
                                class="text-[10px] font-black uppercase tracking-widest text-slate-600 dark:text-zinc-400"
                                >Est. 5.0 Años</span
                            >
                        </div>
                    </div>
                </div>

                <div class="absolute inset-0 pointer-events-none opacity-20">
                    <div
                        class="absolute top-1/4 left-1/4 w-32 h-32 bg-emerald-500/20 blur-[60px] rounded-full"
                    >
                    </div>
                    <div
                        class="absolute bottom-1/4 right-1/4 w-32 h-32 bg-blue-500/20 blur-[60px] rounded-full"
                    >
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div
                    class="bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 p-6 rounded-2xl shadow-sm"
                >
                    <span
                        class="block text-[10px] font-black text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-2"
                        >Estrés Térmico</span
                    >
                    <div class="flex items-center gap-2">
                        <div id="temp-indicator" class="w-3 h-3 rounded-full bg-emerald-500"></div>
                        <span
                            id="temp-label"
                            class="text-sm font-bold text-slate-800 dark:text-white">Normal</span
                        >
                    </div>
                </div>
                <div
                    class="bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 p-6 rounded-2xl shadow-sm"
                >
                    <span
                        class="block text-[10px] font-black text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-2"
                        >Estrés de Voltaje</span
                    >
                    <div class="flex items-center gap-2">
                        <div id="voltage-indicator" class="w-3 h-3 rounded-full bg-emerald-500">
                        </div>
                        <span
                            id="voltage-label"
                            class="text-sm font-bold text-slate-800 dark:text-white">Bajo</span
                        >
                    </div>
                </div>
                <div
                    class="bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-800 p-6 rounded-2xl shadow-sm"
                >
                    <span
                        class="block text-[10px] font-black text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-2"
                        >Plating de Litio</span
                    >
                    <div class="flex items-center gap-2">
                        <div id="plating-indicator" class="w-3 h-3 rounded-full bg-emerald-500">
                        </div>
                        <span
                            id="plating-label"
                            class="text-sm font-bold text-slate-800 dark:text-white"
                            >Sin Riesgo</span
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #10b981;
        border-radius: 50%;
        cursor: pointer;
        border: 4px solid white;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    .dark input[type="range"]::-webkit-slider-thumb {
        border-color: #18181b;
    }

    #progress-ring {
        transition:
            stroke-dashoffset 1s ease-out,
            stroke 0.5s ease;
    }
</style>

<script>
    import { BatteryLifeEstimator } from "../../../lib/utilidades/battery/BatterySoH";

    const voltageSlider = document.getElementById("voltage-slider") as HTMLInputElement;
    const cyclesSlider = document.getElementById("cycles-slider") as HTMLInputElement;
    const tempSlider = document.getElementById("temp-slider") as HTMLInputElement;

    const voltageVal = document.getElementById("voltage-value");
    const cyclesVal = document.getElementById("cycles-value");
    const tempVal = document.getElementById("temp-value");

    const sohDisplay = document.getElementById("soh-display");
    const yearsDisplay = document.getElementById("years-display");
    const progressRing = document.getElementById("progress-ring") as unknown as SVGCircleElement;

    const statusCard = document.getElementById("status-card");
    const statusText = document.getElementById("status-text");
    const recsContainer = document.getElementById("recommendations-container");

    const indicators = {
        temp: {
            dot: document.getElementById("temp-indicator"),
            label: document.getElementById("temp-label"),
        },
        voltage: {
            dot: document.getElementById("voltage-indicator"),
            label: document.getElementById("voltage-label"),
        },
        plating: {
            dot: document.getElementById("plating-indicator"),
            label: document.getElementById("plating-label"),
        },
    };

    function update() {
        const voltage = parseFloat(voltageSlider.value);
        const cycles = parseInt(cyclesSlider.value);
        const temp = parseInt(tempSlider.value);

        if (voltageVal) voltageVal.textContent = `${voltage.toFixed(2)}V`;
        if (cyclesVal) cyclesVal.textContent = cycles.toString();
        if (tempVal) tempVal.textContent = `${temp}°C`;

        const result = BatteryLifeEstimator.calculate({ voltage, cycles, temperature: temp });

        if (sohDisplay) sohDisplay.textContent = Math.round(result.soh).toString();
        if (yearsDisplay) yearsDisplay.textContent = `Est. ${result.estimatedLife.toFixed(1)} Años`;

        if (progressRing) {
            const radius = progressRing.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (result.soh / 100) * circumference;
            progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
            progressRing.style.strokeDashoffset = offset.toString();

            if (result.soh > 85) progressRing.style.stroke = "#10b981";
            else if (result.soh > 70) progressRing.style.stroke = "#f59e0b";
            else progressRing.style.stroke = "#f43f5e";
        }

        if (indicators.temp.dot && indicators.temp.label) {
            const isHot = temp > 40;
            indicators.temp.dot.style.backgroundColor = isHot ? "#f43f5e" : "#10b981";
            indicators.temp.label.textContent = isHot ? "Crítico" : "Normal";
        }

        if (indicators.voltage.dot && indicators.voltage.label) {
            const isHigh = voltage > 4.1;
            indicators.voltage.dot.style.backgroundColor = isHigh ? "#f59e0b" : "#10b981";
            indicators.voltage.label.textContent = isHigh ? "Alto" : "Bajo";
        }

        if (indicators.plating.dot && indicators.plating.label) {
            const risk = temp < 10;
            indicators.plating.dot.style.backgroundColor = risk ? "#3b82f6" : "#10b981";
            indicators.plating.label.textContent = risk ? "Alto Riesgo" : "Sin Riesgo";
        }

        if (statusCard && statusText && recsContainer) {
            const colors = {
                excelente:
                    "bg-emerald-500/10 border-emerald-500/20 text-emerald-700 dark:text-emerald-400",
                bueno: "bg-blue-500/10 border-blue-500/20 text-blue-700 dark:text-blue-400",
                regular: "bg-amber-500/10 border-amber-500/20 text-amber-700 dark:text-amber-400",
                critico: "bg-rose-500/10 border-rose-500/20 text-rose-700 dark:text-rose-400",
            };
            statusCard.className = `p-6 transition-colors duration-500 rounded-2xl space-y-4 border ${colors[result.healthStatus]}`;
            statusText.textContent = `Estado ${result.healthStatus.charAt(0).toUpperCase() + result.healthStatus.slice(1)}`;

            recsContainer.innerHTML = result.recommendations
                .map(
                    (rec) => `
                <div class="flex gap-2 items-start opacity-80">
                    <span class="mt-1.5 w-1 h-1 rounded-full bg-current shrink-0"></span>
                    <p class="text-xs leading-relaxed">${rec}</p>
                </div>
            `
                )
                .join("");
        }
    }

    [voltageSlider, cyclesSlider, tempSlider].forEach((el) =>
        el?.addEventListener("input", update)
    );
    update();
</script>
