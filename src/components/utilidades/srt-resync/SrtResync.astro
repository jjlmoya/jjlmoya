---
import { Icon } from "astro-icon/components";
---

<div class="w-full max-w-4xl mx-auto space-y-8 user-select-none" id="srt-app">
    <div id="drop-zone" class="relative group cursor-pointer">
        <div
            class="absolute -inset-1 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-2xl blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"
        >
        </div>
        <div
            class="relative w-full min-h-[350px] md:min-h-0 md:aspect-[3/1] bg-white dark:bg-slate-900 rounded-xl flex items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-700 group-hover:border-cyan-500 dark:group-hover:border-blue-400 transition-all p-8 text-center overflow-hidden"
        >
            <input
                type="file"
                id="file-input"
                accept=".srt"
                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
            />

            <div
                class="pointer-events-none transform transition-transform group-hover:scale-110 duration-300"
            >
                <div
                    class="w-20 h-20 bg-cyan-100 dark:bg-cyan-900/30 text-cyan-600 dark:text-cyan-400 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm"
                >
                    <Icon name="mdi:file-upload-outline" class="text-4xl" />
                </div>
                <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200 mb-2">
                    Arrastra tu archivo .SRT aquí
                </h3>
                <p class="text-slate-500 dark:text-slate-400">o haz clic para explorar</p>
                <div
                    id="file-name"
                    class="mt-4 px-4 py-1 bg-cyan-50 dark:bg-cyan-950 text-cyan-600 dark:text-cyan-300 rounded-full text-sm font-medium hidden inline-block animate-fade-in-up"
                >
                </div>
            </div>
        </div>
    </div>

    <div id="controls" class="hidden animate-fade-in space-y-8">
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl p-8 shadow-xl shadow-slate-200/50 dark:shadow-black/20 border border-slate-100 dark:border-slate-800"
        >
            <h2
                class="text-2xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-3"
            >
                <Icon name="mdi:clock-edit-outline" class="text-cyan-500" />
                Ajustar Tiempo
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div>
                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-2"
                        >Desplazamiento (segundos)</label
                    >
                    <div class="relative">
                        <input
                            type="number"
                            id="offset-input"
                            value="0"
                            step="0.1"
                            class="w-full text-4xl font-bold bg-transparent border-b-2 border-slate-200 dark:border-slate-700 focus:border-cyan-500 dark:focus:border-cyan-400 outline-none py-2 text-slate-800 dark:text-white transition-colors"
                        />
                        <span class="absolute right-0 bottom-4 text-slate-400 font-medium">seg</span
                        >
                    </div>
                    <p class="text-xs text-slate-400 mt-2">
                        Usa valores negativos para adelantar (ej: -1.5) y positivos para retrasar.
                    </p>
                </div>

                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-6 flex flex-col gap-4">
                    <div
                        class="flex justify-between items-center border-b border-slate-200 dark:border-slate-700 pb-2"
                    >
                        <span class="text-slate-500 dark:text-slate-400">Líneas</span>
                        <span
                            id="stat-lines"
                            class="font-mono font-bold text-slate-700 dark:text-slate-200">0</span
                        >
                    </div>
                    <div
                        class="flex justify-between items-center border-b border-slate-200 dark:border-slate-700 pb-2"
                    >
                        <span class="text-slate-500 dark:text-slate-400">Primer Subtítulo</span>
                        <span id="stat-first" class="font-mono text-cyan-600 dark:text-cyan-400"
                            >00:00:00,000</span
                        >
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-500 dark:text-slate-400">Último Subtítulo</span>
                        <span id="stat-last" class="font-mono text-cyan-600 dark:text-cyan-400"
                            >00:00:00,000</span
                        >
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
                class="bg-slate-100 dark:bg-black/20 rounded-xl p-6 border border-slate-200 dark:border-slate-800/50"
            >
                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">
                    Original
                </h4>
                <div
                    id="preview-original"
                    class="font-mono text-sm text-slate-600 dark:text-slate-400 space-y-4 max-h-64 overflow-y-auto custom-scrollbar"
                >
                </div>
            </div>

            <div
                class="relative bg-white dark:bg-slate-900 rounded-xl p-6 border border-cyan-100 dark:border-cyan-900/30 shadow-lg shadow-cyan-500/5"
            >
                <div class="absolute -top-3 -right-3">
                    <span
                        class="bg-cyan-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg"
                    >
                        VISTA PREVIA
                    </span>
                </div>
                <h4
                    class="text-xs font-bold text-cyan-600 dark:text-cyan-400 uppercase tracking-wider mb-4"
                >
                    Resultado
                </h4>
                <div
                    id="preview-modified"
                    class="font-mono text-sm text-slate-800 dark:text-slate-200 space-y-4 max-h-64 overflow-y-auto custom-scrollbar"
                >
                </div>
            </div>
        </div>

        <div class="flex justify-center pt-4">
            <button id="download-btn" class="relative inline-flex group perspective-1000">
                <div
                    class="absolute transition-all duration-500 opacity-60 -inset-1 bg-gradient-to-r from-cyan-400 via-blue-500 to-cyan-400 rounded-xl blur-lg group-hover:opacity-100 group-hover:-inset-2 group-hover:duration-200 animate-tilt"
                >
                </div>

                <div
                    class="relative inline-flex items-center justify-center px-8 py-5 text-lg font-black text-white transition-all duration-200 bg-slate-900 border border-slate-700/50 font-pj rounded-xl group-hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-400"
                >
                    <Icon
                        name="mdi:cloud-download-outline"
                        class="mr-3 text-3xl group-hover:animate-bounce"
                    />
                    <span>Descargar Corregido</span>
                    <div
                        class="absolute inset-0 rounded-xl bg-gradient-to-tr from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"
                    >
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>

<script>
    interface SrtItem {
        id: string;
        start: number;
        end: number;
        text: string;
    }

    function parseSRT(data: string): SrtItem[] {
        data = data.replace(/\r/g, "");

        const parts = data.split("\n\n");

        const items = parts
            .map((part) => {
                const lines = part.trim().split("\n");
                if (lines.length < 3) return null;

                const id = lines[0];
                const timeLine = lines[1];
                if (!timeLine.includes("-->")) return null;

                const [start, end] = timeLine.split(" --> ");
                const text = lines.slice(2).join("\n");

                return {
                    id,
                    start: timeMs(start),
                    end: timeMs(end),
                    text,
                };
            })
            .filter((x): x is SrtItem => x !== null);

        return items;
    }

    function timeMs(timeStr: string): number {
        const [hms, ms] = timeStr.split(",");
        const [h, m, s] = hms.split(":").map(Number);
        return h * 3600000 + m * 60000 + s * 1000 + Number(ms);
    }

    function msToTime(duration: number): string {
        const ms = parseInt((((duration % 1000) / 100) * 100) as any);
        const s = parseInt(((duration / 1000) % 60) as any);
        const m = parseInt(((duration / (1000 * 60)) % 60) as any);
        const h = parseInt(((duration / (1000 * 60 * 60)) % 24) as any);

        if (duration < 0) return "00:00:00,000";

        const hh = h < 10 ? "0" + h : h;
        const mm = m < 10 ? "0" + m : m;
        const ss = s < 10 ? "0" + s : s;

        let msStr = ms.toString();
        if (ms < 10) msStr = "00" + ms;
        else if (ms < 100) msStr = "0" + ms;

        return hh + ":" + mm + ":" + ss + "," + msStr;
    }

    function generateSRT(items: SrtItem[]): string {
        return items
            .map((item, index) => {
                return `${index + 1}\n${msToTime(item.start)} --> ${msToTime(item.end)}\n${item.text}`;
            })
            .join("\n\n");
    }

    const fileInput = document.getElementById("file-input") as HTMLInputElement;
    const controls = document.getElementById("controls");
    const previewOriginal = document.getElementById("preview-original");
    const previewModified = document.getElementById("preview-modified");
    const offsetInput = document.getElementById("offset-input") as HTMLInputElement;
    const downloadBtn = document.getElementById("download-btn");
    const fileNameDisplay = document.getElementById("file-name");

    const statLines = document.getElementById("stat-lines");
    const statFirst = document.getElementById("stat-first");
    const statLast = document.getElementById("stat-last");

    let originalItems: SrtItem[] = [];
    let currentFileName = "subtitulos.srt";

    if (fileInput) fileInput.addEventListener("change", handleFile);
    if (offsetInput) offsetInput.addEventListener("input", updatePreview);
    if (downloadBtn) downloadBtn.addEventListener("click", downloadFile);

    function handleFile(e: Event) {
        const target = e.target as HTMLInputElement;
        const file = target.files ? target.files[0] : null;
        if (!file) return;

        currentFileName = file.name;
        if (fileNameDisplay) {
            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.remove("hidden");
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const text = e.target?.result as string;
            originalItems = parseSRT(text);

            if (originalItems.length > 0) {
                if (controls) {
                    controls.classList.remove("hidden");
                    setTimeout(() => {
                        controls.scrollIntoView({ behavior: "smooth", block: "start" });
                    }, 100);
                }
            }

            updatePreview();
        };
        reader.readAsText(file);
    }

    function updatePreview() {
        if (!offsetInput) return;
        const offsetSec = parseFloat(offsetInput.value) || 0;
        const offsetMs = offsetSec * 1000;

        const modifiedItems = originalItems.map((item) => {
            let newStart = item.start + offsetMs;
            let newEnd = item.end + offsetMs;

            if (newStart < 0) newStart = 0;
            if (newEnd < 0) newEnd = 0;

            return {
                ...item,
                start: newStart,
                end: newEnd,
            };
        });

        if (statLines) statLines.textContent = modifiedItems.length.toString();
        if (modifiedItems.length > 0) {
            if (statFirst) statFirst.textContent = msToTime(modifiedItems[0].start);
            if (statLast)
                statLast.textContent = msToTime(modifiedItems[modifiedItems.length - 1].end);
        }

        if (previewOriginal) renderPreviewBlock(previewOriginal, originalItems.slice(0, 5));
        if (previewModified) renderPreviewBlock(previewModified, modifiedItems.slice(0, 5));
    }

    function renderPreviewBlock(container: HTMLElement, items: SrtItem[]) {
        container.innerHTML = "";
        items.forEach((item) => {
            const div = document.createElement("div");
            div.className = "pb-2 border-b border-slate-200 dark:border-slate-800 last:border-0";
            div.innerHTML = `
                <div class="text-xs text-slate-400 mb-1">${msToTime(item.start)} --> ${msToTime(item.end)}</div>
                <div class="text-slate-700 dark:text-slate-300 whitespace-pre-wrap leading-tight">${escapeHtml(item.text)}</div>
            `;
            container.appendChild(div);
        });
    }

    function escapeHtml(text: string): string {
        const map: { [key: string]: string } = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, function (m) {
            return map[m];
        });
    }

    function downloadFile() {
        if (!offsetInput) return;
        const offsetSec = parseFloat(offsetInput.value) || 0;
        const offsetMs = offsetSec * 1000;

        const modifiedItems = originalItems.map((item) => {
            let newStart = item.start + offsetMs;
            let newEnd = item.end + offsetMs;
            if (newStart < 0) newStart = 0;
            if (newEnd < 0) newEnd = 0;
            return {
                ...item,
                start: newStart,
                end: newEnd,
            };
        });

        const newContent = generateSRT(modifiedItems);
        const blob = new Blob([newContent], { type: "text/srt" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;

        const nameParts = currentFileName.split(".");
        if (nameParts.length > 1) {
            const ext = nameParts.pop();
            a.download = `${nameParts.join(".")}_synced.${ext}`;
        } else {
            a.download = `${currentFileName}_synced.srt`;
        }

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #334155;
    }

    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .animate-fade-in-up {
        animation: fade-in-up 0.5s ease-out forwards;
    }

    .animate-fade-in {
        animation: fade-in-up 0.5s ease-out forwards;
    }
</style>
