---
import { Icon } from "astro-icon/components";
---

<div class="w-full max-w-6xl mx-auto space-y-8 select-none">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6">
            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-100 dark:border-gray-700"
            >
                <h3
                    class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2"
                >
                    <Icon name="mdi:cog" class="w-5 h-5 text-gray-400" />
                    Configuración Material
                </h3>

                <div class="flex bg-gray-100 dark:bg-gray-700/50 p-1.5 rounded-lg mb-6">
                    <button
                        class="mode-btn flex-1 py-1.5 text-sm font-bold rounded-md transition-all bg-orange-500 text-white shadow-sm"
                        data-mode="linear"
                    >
                        Lineal (Barras)
                    </button>
                    <button
                        class="mode-btn flex-1 py-1.5 text-sm font-bold rounded-md transition-all text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
                        data-mode="panel"
                    >
                        Panel (Tableros)
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1"
                            >Largo del Material (mm)</label
                        >
                        <input
                            type="number"
                            id="stock-length"
                            value="2400"
                            class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 font-mono font-bold text-gray-900 dark:text-white focus:ring-2 focus:ring-orange-500 outline-none transition-all"
                        />
                    </div>
                    <div id="stock-width-container" class="hidden animate-in slide-in-from-top-2">
                        <label
                            class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1"
                            >Ancho del Material (mm)</label
                        >
                        <input
                            type="number"
                            id="stock-width"
                            value="1200"
                            class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 font-mono font-bold text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                        />
                    </div>
                    <div>
                        <label
                            class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1"
                            >Grosor de Hoja / Kerf (mm)</label
                        >
                        <input
                            type="number"
                            id="kerf-width"
                            value="3"
                            class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 font-mono font-bold text-gray-900 dark:text-white focus:ring-2 focus:ring-orange-500 outline-none transition-all"
                        />
                    </div>
                </div>
            </div>

            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-100 dark:border-gray-700"
            >
                <div class="flex items-center justify-between mb-4">
                    <h3
                        class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2"
                    >
                        <Icon name="mdi:format-list-bulleted" class="w-5 h-5 text-gray-400" />
                        Lista de Cortes
                    </h3>
                    <button
                        id="btn-add-cut"
                        class="p-2 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors"
                    >
                        <Icon name="mdi:plus" class="w-5 h-5" />
                    </button>
                </div>

                <div
                    id="cut-list-container"
                    class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar"
                >
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border border-gray-100 dark:border-gray-700"
                >
                    <div class="text-xs text-gray-400 uppercase font-bold">Material Usado</div>
                    <div
                        class="text-2xl font-black text-gray-800 dark:text-white mt-1"
                        id="stat-stock-used"
                    >
                        0
                    </div>
                </div>
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border border-gray-100 dark:border-gray-700"
                >
                    <div class="text-xs text-gray-400 uppercase font-bold">Cortes Totales</div>
                    <div
                        class="text-2xl font-black text-gray-800 dark:text-white mt-1"
                        id="stat-total-cuts"
                    >
                        0
                    </div>
                </div>
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border border-gray-100 dark:border-gray-700"
                >
                    <div class="text-xs text-gray-400 uppercase font-bold">Desperdicio Total</div>
                    <div class="text-2xl font-black text-red-500 mt-1">
                        <span id="stat-total-waste">0</span>
                        <span class="text-xs text-gray-400 font-normal">mm</span>
                    </div>
                </div>
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow border border-gray-100 dark:border-gray-700"
                >
                    <div class="text-xs text-gray-400 uppercase font-bold">Eficiencia</div>
                    <div class="text-2xl font-black text-green-500 mt-1" id="stat-efficiency">
                        0%
                    </div>
                </div>
            </div>

            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-100 dark:border-gray-700 min-h-[400px]"
            >
                <h3
                    class="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2"
                >
                    <Icon name="mdi:eye-outline" class="w-5 h-5 text-gray-400" />
                    Visualización de Corte
                </h3>

                <div id="visualization-container" class="space-y-8">
                    <div class="flex items-center justify-center h-64 text-gray-400 text-sm italic">
                        Añade cortes y pulsa "Optimizar" para ver el plan de corte.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="cut-row-template">
    <div class="flex items-center gap-2 group animate-in slide-in-from-left-2 duration-300">
        <div class="relative flex-1">
            <input
                type="number"
                placeholder="Largo"
                class="input-length w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg pl-3 pr-4 py-2 text-sm font-mono focus:ring-1 focus:ring-orange-500 outline-none"
            />
            <span
                class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none"
                >mm</span
            >
        </div>
        <div class="relative flex-1 input-width-container hidden">
            <input
                type="number"
                placeholder="Ancho"
                class="input-width w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg pl-3 pr-4 py-2 text-sm font-mono focus:ring-1 focus:ring-blue-500 outline-none"
            />
            <span
                class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none"
                >mm</span
            >
        </div>
        <div class="relative w-20">
            <input
                type="number"
                placeholder="Cant."
                value="1"
                class="input-qty w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg pl-3 pr-2 py-2 text-sm font-mono focus:ring-1 focus:ring-orange-500 outline-none"
            />
        </div>
        <button class="btn-remove p-2 text-gray-400 hover:text-red-500 transition-colors">
            <Icon name="mdi:close" class="w-4 h-4" />
        </button>
    </div>
</template>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.3);
        border-radius: 20px;
    }
</style>

<script>
    import { CutOptimizerService, type CutRequest, type Rect } from "./logic/CutOptimizerService";

    type Mode = "linear" | "panel";
    let currentMode: Mode = "linear";

    const cuts: CutRequest[] = [
        { id: "1", length: 800, width: 400, quantity: 2 },
        { id: "2", length: 450, width: 300, quantity: 3 },
    ];

    const container = document.getElementById("cut-list-container")!;
    const btnAdd = document.getElementById("btn-add-cut")!;

    const template = document.getElementById("cut-row-template") as HTMLTemplateElement;

    const modeToggles = document.querySelectorAll(".mode-btn");

    const stockLengthInput = document.getElementById("stock-length") as HTMLInputElement;
    const stockWidthContainer = document.getElementById("stock-width-container")!;
    const stockWidthInput = document.getElementById("stock-width") as HTMLInputElement;

    const vizContainer = document.getElementById("visualization-container")!;
    const statStockUsed = document.getElementById("stat-stock-used")!;
    const statTotalCuts = document.getElementById("stat-total-cuts")!;
    const statTotalWaste = document.getElementById("stat-total-waste")!;
    const statEfficiency = document.getElementById("stat-efficiency")!;

    function setMode(mode: Mode) {
        currentMode = mode;
        const widthContainers = document.querySelectorAll(".input-width-container");

        if (mode === "panel") {
            stockWidthContainer.classList.remove("hidden");
            widthContainers.forEach((el) => el.classList.remove("hidden"));
        } else {
            stockWidthContainer.classList.add("hidden");
            widthContainers.forEach((el) => el.classList.add("hidden"));
        }

        modeToggles.forEach((btn) => {
            const btnMode = btn.getAttribute("data-mode");
            if (btnMode === mode) {
                btn.classList.add("bg-orange-500", "text-white");
                btn.classList.remove(
                    "bg-gray-200",
                    "dark:bg-gray-700",
                    "text-gray-600",
                    "dark:text-gray-300"
                );
            } else {
                btn.classList.remove("bg-orange-500", "text-white");
                btn.classList.add(
                    "bg-gray-200",
                    "dark:bg-gray-700",
                    "text-gray-600",
                    "dark:text-gray-300"
                );
            }
        });

        renderRows();
        calculate();
    }

    modeToggles.forEach((btn) => {
        btn.addEventListener("click", () => {
            setMode(btn.getAttribute("data-mode") as Mode);
        });
    });

    function renderRows() {
        container.innerHTML = "";
        cuts.forEach((cut, index) => {
            const clone = template.content.cloneNode(true) as DocumentFragment;
            const row = clone.querySelector("div")!;

            const inputLen = row.querySelector(".input-length") as HTMLInputElement;
            const inputWidthContainer = row.querySelector(".input-width-container") as HTMLElement;
            const inputWidth = row.querySelector(".input-width") as HTMLInputElement;
            const inputQty = row.querySelector(".input-qty") as HTMLInputElement;
            const btnRemove = row.querySelector(".btn-remove") as HTMLButtonElement;

            if (currentMode === "panel") {
                inputWidthContainer.classList.remove("hidden");
            } else {
                inputWidthContainer.classList.add("hidden");
            }

            inputLen.value = cut.length.toString();
            inputWidth.value = (cut.width || 0).toString();
            inputQty.value = cut.quantity.toString();

            inputLen.addEventListener("input", (e) => {
                cuts[index].length = parseFloat((e.target as HTMLInputElement).value) || 0;
                debouncedCalculate();
            });
            inputWidth.addEventListener("input", (e) => {
                cuts[index].width = parseFloat((e.target as HTMLInputElement).value) || 0;
                debouncedCalculate();
            });
            inputQty.addEventListener("input", (e) => {
                cuts[index].quantity = parseFloat((e.target as HTMLInputElement).value) || 0;
                debouncedCalculate();
            });
            btnRemove.addEventListener("click", () => {
                cuts.splice(index, 1);
                renderRows();
                debouncedCalculate();
            });

            container.appendChild(row);
        });
    }

    function addRow() {
        cuts.push({ id: crypto.randomUUID(), length: 0, width: 0, quantity: 1 });
        renderRows();
    }

    function calculate() {
        const stockLength = parseFloat(stockLengthInput.value) || 2400;
        const stockWidth = parseFloat(stockWidthInput.value) || 1200;
        const kerf =
            parseFloat((document.getElementById("kerf-width") as HTMLInputElement).value) || 0;

        const validCuts = cuts.filter(
            (c) =>
                c.length > 0 &&
                c.quantity > 0 &&
                (currentMode === "linear" || (c.width && c.width > 0))
        );

        let result: any = {
            totalStockUsed: 0,
            totalWaste: 0,
            totalCuts: 0,
            stockPieces: [],
        };

        if (validCuts.length > 0) {
            if (currentMode === "linear") {
                result = CutOptimizerService.optimize1D(validCuts, stockLength, kerf);
            } else {
                result = CutOptimizerService.optimize2D(validCuts, stockLength, stockWidth, kerf);
            }
        }

        statStockUsed.textContent = result.totalStockUsed.toString();
        statTotalCuts.textContent = result.totalCuts.toString();

        if (currentMode === "linear") {
            statTotalWaste.innerHTML = `${result.totalWaste.toFixed(0)} <span class="text-xs text-gray-400 font-normal">mm</span>`;
            const totalUsedLength = result.stockPieces.reduce(
                (acc: number, p: any) => acc + (p.stockLength - p.waste),
                0
            );
            const totalStockLength = result.totalStockUsed * stockLength;
            const efficiency =
                totalStockLength > 0 ? (totalUsedLength / totalStockLength) * 100 : 0;
            statEfficiency.textContent = `${efficiency.toFixed(1)}%`;
            renderVisualization1D(result.stockPieces, stockLength);
        } else {
            statTotalWaste.innerHTML = `${(result.totalWaste / 1000000).toFixed(4)} <span class="text-xs text-gray-400 font-normal">m²</span>`;
            const totalArea = result.totalStockUsed * (stockLength * stockWidth);
            const usedArea = totalArea - result.totalWaste;
            const efficiency = totalArea > 0 ? (usedArea / totalArea) * 100 : 0;
            statEfficiency.textContent = `${efficiency.toFixed(1)}%`;
            renderVisualization2D(result.stockPieces, stockLength, stockWidth);
        }
    }

    function renderVisualization1D(pieces: any[], stockMax: number) {
        vizContainer.innerHTML = "";
        vizContainer.classList.remove("grid", "grid-cols-1", "gap-8");
        vizContainer.classList.add("space-y-8");

        if (pieces.length === 0) {
            vizContainer.innerHTML =
                '<div class="text-center p-8 text-gray-400">No se pudieron generar cortes válidos. Verifica las medidas.</div>';
            return;
        }

        pieces.forEach((p) => {
            const wrapper = document.createElement("div");
            wrapper.className =
                "bg-gray-50 dark:bg-gray-900/50 rounded-lg p-3 border border-gray-100 dark:border-gray-800";

            const header = document.createElement("div");
            header.className = "flex justify-between text-xs font-bold text-gray-500 mb-2";
            header.innerHTML = `<span>Material #${p.stockId}</span><span>Desperdicio: ${p.waste.toFixed(0)}mm</span>`;
            wrapper.appendChild(header);

            const barContainer = document.createElement("div");
            barContainer.className =
                "h-12 w-full bg-gray-200 dark:bg-gray-700 rounded overflow-hidden flex relative";

            (p.cuts as number[]).forEach((cutLength: number) => {
                const widthPercent = (cutLength / stockMax) * 100;

                const segment = document.createElement("div");
                segment.style.width = `${widthPercent}%`;
                segment.className =
                    "h-full bg-gradient-to-b from-orange-400 to-orange-600 border-r border-white/20 flex items-center justify-center text-white text-xs font-bold shadow-inner relative group";
                segment.title = `${cutLength}mm`;
                segment.textContent = cutLength < 50 ? "" : `${cutLength}`;

                const tooltip = document.createElement("div");
                tooltip.className =
                    "absolute -top-10 left-1/2 -translate-x-1/2 bg-black text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10";
                tooltip.textContent = `${cutLength} mm`;
                segment.appendChild(tooltip);

                barContainer.appendChild(segment);
            });

            wrapper.appendChild(barContainer);
            vizContainer.appendChild(wrapper);
        });
    }

    function renderVisualization2D(pieces: any[], stockLen: number, stockWid: number) {
        vizContainer.innerHTML = "";
        vizContainer.classList.remove("space-y-8");
        vizContainer.classList.add("grid", "grid-cols-1", "gap-8");

        if (pieces.length === 0) {
            vizContainer.innerHTML =
                '<div class="text-center p-8 text-gray-400">No se pudieron generar paneles válidos. Verifica que las piezas quepan en el tablero.</div>';
            return;
        }

        pieces.forEach((p) => {
            const wrapper = document.createElement("div");
            wrapper.className =
                "bg-gray-50 dark:bg-gray-900/50 rounded-lg p-3 border border-gray-100 dark:border-gray-800";

            const header = document.createElement("div");
            header.className = "flex justify-between text-xs font-bold text-gray-500 mb-2";
            header.innerHTML = `<span>Panel #${p.stockId}</span><span>Efic: ${(p.utilization * 100).toFixed(1)}%</span>`;
            wrapper.appendChild(header);

            const sheet = document.createElement("div");
            sheet.className =
                "relative bg-gray-200 dark:bg-gray-700 mx-auto shadow-inner border border-gray-300 dark:border-gray-600";
            sheet.style.width = "100%";
            sheet.style.aspectRatio = `${stockLen}/${stockWid}`;

            (p.cuts as Rect[]).forEach((rect: Rect) => {
                const el = document.createElement("div");
                el.className =
                    "absolute bg-gradient-to-br from-blue-500 to-blue-700 border border-white/50 hover:brightness-110 transition-all flex items-center justify-center text-white text-[10px] font-bold shadow-sm group";

                const left = (rect.x / stockLen) * 100;
                const top = (rect.y / stockWid) * 100;
                const w = (rect.w / stockLen) * 100;
                const h = (rect.h / stockWid) * 100;

                el.style.left = `${left}%`;
                el.style.top = `${top}%`;
                el.style.width = `${w}%`;
                el.style.height = `${h}%`;

                if (rect.w > 50 && rect.h > 50) {
                    el.textContent = `${rect.w}x${rect.h}`;
                }

                const tooltip = document.createElement("div");
                tooltip.className =
                    "absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-20";
                tooltip.textContent = `${rect.w} x ${rect.h}`;
                el.appendChild(tooltip);

                sheet.appendChild(el);
            });

            wrapper.appendChild(sheet);
            vizContainer.appendChild(wrapper);
        });
    }

    const debounce = (fn: (...args: any[]) => void, ms = 300) => {
        let timeoutId: ReturnType<typeof setTimeout>;
        return function (...args: any[]) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => fn(...args), ms);
        };
    };

    const debouncedCalculate = debounce(calculate, 300);

    stockLengthInput.addEventListener("input", debouncedCalculate);
    stockWidthInput.addEventListener("input", debouncedCalculate);
    const kerfInput = document.getElementById("kerf-width") as HTMLInputElement;
    kerfInput.addEventListener("input", debouncedCalculate);

    btnAdd.addEventListener("click", addRow);

    renderRows();
    setMode("linear");
    calculate();
</script>
