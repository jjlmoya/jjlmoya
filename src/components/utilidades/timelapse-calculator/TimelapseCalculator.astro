---
import { Icon } from "astro-icon/components";
---

<div
    class="w-full max-w-5xl mx-auto bg-white dark:bg-slate-900 rounded-3xl shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-700"
>
    <div class="grid grid-cols-1 lg:grid-cols-2">
        <div class="p-8 md:p-12 space-y-8 bg-slate-50 dark:bg-slate-900/50">
            <h3 class="text-xl font-black text-slate-800 dark:text-white flex items-center gap-2">
                <Icon name="mdi:tune-vertical" class="text-indigo-500" />
                Parámetros
            </h3>

            <div class="space-y-6">
                <div class="space-y-3">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-slate-500 delay-100"
                    >
                        ¿Cuánto dura el evento real?
                    </label>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label for="event-hours" class="block text-xs text-slate-400 mb-1 ml-1"
                                >Horas</label
                            >
                            <input
                                type="number"
                                id="event-hours"
                                value="1"
                                min="0"
                                class="w-full bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-2xl font-bold text-slate-700 dark:text-white focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 transition-all"
                            />
                        </div>
                        <div class="flex-1">
                            <label
                                for="event-minutes"
                                class="block text-xs text-slate-400 mb-1 ml-1">Minutos</label
                            >
                            <input
                                type="number"
                                id="event-minutes"
                                value="0"
                                min="0"
                                max="59"
                                class="w-full bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-2xl font-bold text-slate-700 dark:text-white focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 transition-all"
                            />
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label
                        class="text-xs font-bold uppercase tracking-wider text-slate-500 delay-100"
                    >
                        ¿Cómo quieres el video final?
                    </label>
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label
                                for="video-seconds"
                                class="block text-xs text-slate-400 mb-1 ml-1">Duración (seg)</label
                            >
                            <input
                                type="number"
                                id="video-seconds"
                                value="10"
                                min="1"
                                class="w-full bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-2xl font-bold text-slate-700 dark:text-white focus:outline-none focus:border-pink-500 focus:ring-2 focus:ring-pink-200 dark:focus:ring-pink-900 transition-all"
                            />
                        </div>
                        <div class="flex-1">
                            <label for="fps-select" class="block text-xs text-slate-400 mb-1 ml-1"
                                >FPS</label
                            >
                            <div class="relative">
                                <select
                                    id="fps-select"
                                    class="w-full bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-2xl font-bold text-slate-700 dark:text-white focus:outline-none focus:border-pink-500 focus:ring-2 focus:ring-pink-200 dark:focus:ring-pink-900 transition-all appearance-none"
                                >
                                    <option value="24">24</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="60">60</option>
                                </select>
                                <Icon
                                    name="mdi:chevron-down"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xl"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div
            class="p-8 md:p-12 bg-gradient-to-br from-indigo-600 to-violet-700 text-white flex flex-col justify-between"
        >
            <div>
                <h3 class="text-xl font-black text-indigo-100 mb-8 flex items-center gap-2">
                    <Icon name="mdi:equal-box" class="text-indigo-300" />
                    Resultados
                </h3>

                <div class="space-y-2 mb-12">
                    <p class="text-indigo-200 text-sm font-bold uppercase tracking-widest">
                        Configura tu intervalómetro a:
                    </p>
                    <div class="flex items-baseline gap-2">
                        <span
                            id="result-interval"
                            class="text-6xl md:text-7xl font-black tracking-tighter"
                        >
                            15.0
                        </span>
                        <span class="text-2xl md:text-3xl font-bold text-indigo-300">segundos</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <p class="text-indigo-200 text-xs font-bold uppercase tracking-widest mb-1">
                            Total Fotos
                        </p>
                        <p id="result-photos" class="text-3xl font-bold font-mono">240</p>
                    </div>
                    <div>
                        <p class="text-indigo-200 text-xs font-bold uppercase tracking-widest mb-1">
                            Velocidad
                        </p>
                        <p id="result-speed" class="text-3xl font-bold font-mono">360x</p>
                    </div>
                    <div>
                        <p class="text-indigo-200 text-xs font-bold uppercase tracking-widest mb-1">
                            Duración Disparo
                        </p>
                        <p id="result-shutter" class="text-xl font-bold font-mono text-indigo-100">
                            ~7.5s (180°)
                        </p>
                    </div>
                    <div>
                        <p class="text-indigo-200 text-xs font-bold uppercase tracking-widest mb-1">
                            Peso (RAW)
                        </p>
                        <p id="result-storage" class="text-xl font-bold font-mono text-indigo-100">
                            ~6 GB
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-12 pt-8 border-t border-indigo-500/30">
                <div class="flex items-center gap-4 text-indigo-200 text-sm">
                    <Icon name="mdi:information-outline" class="text-2xl flex-shrink-0" />
                    <p class="leading-tight">
                        La regla de los 180° sugiere una velocidad de obturación de la mitad del
                        intervalo para un movimiento fluido.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    class TimelapseMath {
        private static RAW_SIZE_MB = 25;
        private static GB_CONVERSION = 1024;

        static calculate(eventDurationSecs: number, videoTargetSecs: number, fps: number) {
            const totalFrames = videoTargetSecs * fps;
            const interval =
                totalFrames > 0 && eventDurationSecs > 0 ? eventDurationSecs / totalFrames : 0;

            const rawSizeGB = (totalFrames * this.RAW_SIZE_MB) / this.GB_CONVERSION;
            const speedFactor = videoTargetSecs > 0 ? eventDurationSecs / videoTargetSecs : 0;

            const shutterSpeed = interval / 2;

            return {
                interval,
                totalFrames: Math.floor(totalFrames),
                storageGB: rawSizeGB,
                speedFactor,
                shutterSpeed,
            };
        }

        static formatTime(seconds: number): string {
            const h = Math.floor(seconds / 3600)
                .toString()
                .padStart(2, "0");
            const m = Math.floor((seconds % 3600) / 60)
                .toString()
                .padStart(2, "0");
            const s = Math.floor(seconds % 60)
                .toString()
                .padStart(2, "0");
            return h === "00" ? `${m}:${s}` : `${h}:${m}:${s}`;
        }
    }

    class CalculatorUI {
        private elements: Record<string, HTMLElement | HTMLInputElement | HTMLSelectElement>;

        constructor() {
            this.elements = {
                hours: document.getElementById("event-hours") as HTMLInputElement,
                minutes: document.getElementById("event-minutes") as HTMLInputElement,
                seconds: document.getElementById("video-seconds") as HTMLInputElement,
                fps: document.getElementById("fps-select") as HTMLSelectElement,
                interval: document.getElementById("result-interval")!,
                photos: document.getElementById("result-photos")!,
                storage: document.getElementById("result-storage")!,
                speed: document.getElementById("result-speed")!,
                shutter: document.getElementById("result-shutter")!,
                playBtn: document.getElementById("play-btn")!,
                barVideo: document.getElementById("bar-video")!,
                barReal: document.getElementById("bar-real")!,
                simVideoTime: document.getElementById("sim-video-time")!,
                simRealTime: document.getElementById("sim-real-time")!,
            };
        }

        public getInputs() {
            return {
                hours: parseFloat((this.elements.hours as HTMLInputElement).value) || 0,
                minutes: parseFloat((this.elements.minutes as HTMLInputElement).value) || 0,
                videoSeconds: parseFloat((this.elements.seconds as HTMLInputElement).value) || 0,
                fps: parseInt((this.elements.fps as HTMLSelectElement).value) || 24,
            };
        }

        public updateResults(results: any) {
            if (!this.elements.interval) return;

            this.elements.interval.innerText =
                results.interval < 1 ? results.interval.toFixed(2) : results.interval.toFixed(1);

            this.elements.photos.innerText = results.totalFrames.toLocaleString("es-ES");
            this.elements.storage.innerText = `~${results.storageGB.toFixed(1)} GB`;
            this.elements.speed.innerText = `${results.speedFactor.toFixed(0)}x`;

            const shutter = results.shutterSpeed;
            this.elements.shutter.innerText =
                shutter < 1 ? `1/${Math.round(1 / shutter)}s` : `${shutter.toFixed(1)}s`;
        }

        public getElement(id: string) {
            return this.elements[id];
        }

        public bindEvents(callback: () => void) {
            ["hours", "minutes", "seconds", "fps"].forEach((key) => {
                this.elements[key]?.addEventListener("input", callback);
                this.elements[key]?.addEventListener("change", callback);
            });
        }

        public updateSimulation(progress: number, videoTotal: number, realTotal: number) {
            if (this.elements.barVideo) {
                this.elements.barVideo.style.width = `${progress * 100}%`;
            }
            if (this.elements.barReal) {
                this.elements.barReal.style.width = `${progress * 100}%`;
            }
            if (this.elements.simVideoTime) {
                this.elements.simVideoTime.innerText = TimelapseMath.formatTime(
                    progress * videoTotal
                );
            }
            if (this.elements.simRealTime) {
                this.elements.simRealTime.innerText = TimelapseMath.formatTime(
                    progress * realTotal
                );
            }
        }

        public resetSimulation() {
            if (this.elements.barVideo) this.elements.barVideo.style.width = "0%";
            if (this.elements.barReal) this.elements.barReal.style.width = "0%";
            if (this.elements.simVideoTime) this.elements.simVideoTime.innerText = "00:00";
            if (this.elements.simRealTime) this.elements.simRealTime.innerText = "00:00:00";
        }
    }

    class Simulator {
        private isPlaying: boolean = false;
        private animationId: number = 0;
        private readonly DURATION_MS = 5000;

        constructor(private ui: CalculatorUI) {
            const btn = ui.getElement("playBtn");
            btn?.addEventListener("click", () => this.start());
        }

        public start() {
            if (this.isPlaying) return;
            this.isPlaying = true;

            const inputs = this.ui.getInputs();
            const realDurationSecs = inputs.hours * 3600 + inputs.minutes * 60;
            const videoDurationSecs = inputs.videoSeconds;

            const startTime = performance.now();

            const step = (now: number) => {
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / this.DURATION_MS, 1);

                this.ui.updateSimulation(progress, videoDurationSecs, realDurationSecs);

                if (progress < 1) {
                    this.animationId = requestAnimationFrame(step);
                } else {
                    this.isPlaying = false;
                    setTimeout(() => this.ui.resetSimulation(), 1000);
                }
            };

            this.animationId = requestAnimationFrame(step);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const ui = new CalculatorUI();
        const sim = new Simulator(ui);

        const recalculate = () => {
            const inputs = ui.getInputs();
            const eventDurationSecs = inputs.hours * 3600 + inputs.minutes * 60;
            const results = TimelapseMath.calculate(
                eventDurationSecs,
                inputs.videoSeconds,
                inputs.fps
            );
            ui.updateResults(results);
        };

        ui.bindEvents(recalculate);

        recalculate();
    });
</script>
