---
import { Icon } from "astro-icon/components";


const presets = [
    { id: "corn", label: "Maíz", pop: 80000, row: 70, icon: "mdi:corn" },
    { id: "sunflower", label: "Girasol", pop: 55000, row: 70, icon: "mdi:flower" },
    { id: "soy", label: "Soja", pop: 350000, row: 52, icon: "mdi:sprout" },
    { id: "wheat", label: "Trigo", pop: 3000000, row: 17, icon: "mdi:barley" },
];
---

<div class="max-w-5xl mx-auto p-4 select-none">
    
    <div
        class="bg-zinc-950 border-8 border-zinc-800 rounded-[3rem] shadow-2xl overflow-hidden relative"
    >
        
        <div
            class="absolute inset-0 bg-gradient-to-tr from-white/5 to-transparent pointer-events-none z-50 rounded-[2.5rem]"
        >
        </div>

        
        <div
            class="bg-zinc-900 px-8 py-4 flex justify-between items-center border-b border-zinc-800"
        >
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-zinc-400 text-xs font-mono">SYSTEM: CALIBRATED</span>
            </div>
            <div class="flex gap-4">
                <button
                    id="modeMetric"
                    class="text-xs font-bold text-emerald-400 bg-emerald-950/50 px-3 py-1 rounded border border-emerald-900"
                    >MÉTRICO</button
                >
                <button
                    id="modeImperial"
                    class="text-xs font-bold text-zinc-600 hover:text-zinc-400 transition-colors"
                    >IMPERIAL</button
                >
            </div>
        </div>

        <div class="flex flex-col lg:flex-row h-auto lg:h-[600px]">
            
            <div
                class="w-full lg:w-5/12 bg-zinc-900/50 p-6 lg:p-8 flex flex-col gap-8 border-r border-zinc-800 relative"
            >
                
                <div class="grid grid-cols-4 gap-2">
                    {
                        presets.map((p) => (
                            <button
                                class="preset-btn group flex flex-col items-center gap-2 p-2 rounded-xl transition-all hover:bg-zinc-800 opacity-50 hover:opacity-100"
                                data-pop={p.pop}
                                data-row={p.row}
                                aria-label={p.label}
                            >
                                <div class="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center group-hover:bg-emerald-500/20 group-hover:text-emerald-400 transition-colors">
                                    <Icon name={p.icon} class="w-5 h-5" />
                                </div>
                            </button>
                        ))
                    }
                </div>

                
                <div class="control-group relative group">
                    <label
                        class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-2 block"
                        >Población Objetivo</label
                    >
                    <div class="flex items-start justify-between mb-4">
                        <h2 id="valPop" class="text-4xl font-black text-white tracking-tight">
                            80,000
                        </h2>
                        <span class="text-zinc-600 text-xs mt-2 uppercase font-mono">sem/ha</span>
                    </div>
                    <input
                        type="range"
                        id="inputPop"
                        min="10000"
                        max="150000"
                        step="1000"
                        value="80000"
                        class="w-full h-12 bg-transparent appearance-none cursor-ew-resize focus:outline-none z-10 relative opacity-0"
                    />
                    
                    <div
                        class="absolute bottom-3 left-0 right-0 h-4 bg-zinc-800 rounded-full overflow-hidden pointer-events-none"
                    >
                        <div
                            id="barPop"
                            class="h-full bg-emerald-600 w-1/2 transition-all duration-100 ease-out"
                        >
                        </div>
                    </div>
                    
                    <div
                        class="absolute bottom-3 left-0 w-full flex justify-between px-1 pointer-events-none"
                    >
                        <div
                            class="w-4 h-4 bg-white rounded-full shadow-lg transform -translate-y-1/2 mt-2 transition-all duration-100 ease-out"
                            id="thumbPop"
                            style="left: 50%"
                        >
                        </div>
                    </div>
                </div>

                
                <div class="control-group relative group">
                    <label
                        class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-2 block"
                        >Distancia entre Surcos</label
                    >
                    <div class="flex items-start justify-between mb-4">
                        <h2 id="valRow" class="text-4xl font-black text-white tracking-tight">
                            70
                        </h2>
                        <span id="unitRow" class="text-zinc-600 text-xs mt-2 uppercase font-mono"
                            >cm</span
                        >
                    </div>

                    <div class="flex gap-2">
                        <button
                            class="step-btn h-12 w-12 rounded-xl bg-zinc-800 text-white font-bold hover:bg-zinc-700 flex items-center justify-center border border-zinc-700 active:border-emerald-500"
                            data-target="inputRow"
                            data-step="-1"
                        >
                            <Icon name="mdi:minus" />
                        </button>
                        <div
                            class="flex-1 bg-zinc-800 rounded-xl relative border border-zinc-700 flex items-center px-4 overflow-hidden"
                        >
                            <input
                                type="number"
                                id="inputRow"
                                value="70"
                                class="w-full bg-transparent text-center font-mono text-xl text-emerald-400 focus:outline-none"
                            />
                        </div>
                        <button
                            class="step-btn h-12 w-12 rounded-xl bg-zinc-800 text-white font-bold hover:bg-zinc-700 flex items-center justify-center border border-zinc-700 active:border-emerald-500"
                            data-target="inputRow"
                            data-step="1"
                        >
                            <Icon name="mdi:plus" />
                        </button>
                    </div>
                </div>

                
                <div
                    class="mt-auto bg-blue-500/10 border border-blue-500/20 p-4 rounded-xl flex items-start gap-3"
                >
                    <Icon name="mdi:information-variant" class="w-5 h-5 text-blue-400 shrink-0" />
                    <p class="text-xs text-blue-200 leading-relaxed">
                        A mayor velocidad de siembra, mayor probabilidad de desviación. La
                        calibración estática debe verificarse siempre a velocidad de trabajo real.
                    </p>
                </div>
            </div>

            
            <div
                class="w-full lg:w-7/12 bg-[#121214] relative flex flex-col items-center justify-center p-8 overflow-hidden"
            >
                
                <div
                    class="absolute inset-0"
                    style="background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; opacity: 0.2"
                >
                </div>

                
                <div class="relative z-10 text-center mb-12">
                    <h3 class="text-zinc-500 text-sm font-bold uppercase tracking-[0.2em] mb-2">
                        CALIBRACIÓN REQUERIDA
                    </h3>
                    <div class="relative inline-block">
                        <span
                            id="resultVal"
                            class="text-[8rem] leading-none font-black text-white tabular-nums tracking-tighter mix-blend-overlay"
                            >17.9</span
                        >
                        <span
                            id="resultUnit"
                            class="absolute -top-4 -right-12 text-2xl font-bold text-emerald-500"
                            >CM</span
                        >

                        
                        <div class="absolute inset-0 bg-emerald-500/20 blur-[100px] -z-10"></div>
                    </div>
                    <div class="flex justify-center gap-8 mt-4">
                        <div class="text-center">
                            <span class="block text-xl font-bold text-white" id="resSeedsMeter"
                                >5.6</span
                            >
                            <span class="text-[10px] text-zinc-500 uppercase tracking-wider"
                                >Semillas / metro</span
                            >
                        </div>
                        <div class="text-center">
                            <span class="block text-xl font-bold text-white" id="resPopReal"
                                >8.0</span
                            >
                            <span class="text-[10px] text-zinc-500 uppercase tracking-wider"
                                >Plantas / m²</span
                            >
                        </div>
                    </div>
                </div>

                
                <div
                    class="w-full max-w-md h-24 bg-zinc-900 border border-zinc-700 rounded-lg relative overflow-hidden shadow-inner flex items-center"
                >
                    
                    <div
                        class="absolute inset-0 opacity-30"
                        style="background: repeating-linear-gradient(90deg, #666 0px, #666 1px, transparent 1px, transparent 20px);"
                    >
                    </div>
                    <div
                        class="absolute inset-0 opacity-50"
                        style="background: repeating-linear-gradient(90deg, #aaa 0px, #aaa 2px, transparent 2px, transparent 100px);"
                    >
                    </div>

                    
                    <div id="seedTrack" class="absolute h-full w-full flex items-center">
                        
                    </div>

                    
                    <div
                        class="absolute left-1/2 top-0 bottom-0 w-0.5 bg-red-500 shadow-[0_0_10px_red] z-20"
                    >
                    </div>
                    <div
                        class="absolute left-1/2 top-2 -translate-x-1/2 text-[10px] font-bold text-red-500 bg-zinc-900/80 px-1 rounded"
                    >
                        REF
                    </div>
                </div>

                <div class="mt-4 text-center">
                    <p class="text-[10px] text-zinc-600 font-mono">
                        SIMULACIÓN VISUAL (ESCALA APROXIMADA)
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    
    input[type="range"] {
        cursor: grab;
    }
    input[type="range"]:active {
        cursor: grabbing;
    }

    
    @keyframes slideLeft {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(-100%);
            opacity: 1;
        }
    }

    .seed-icon {
        position: absolute;
        width: 12px;
        height: 12px;
        background: #fbbf24;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.8);
        top: 50%;
        margin-top: -6px;
        transition: left 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .seed-line {
        position: absolute;
        top: 30%;
        bottom: 30%;
        border-right: 1px dashed rgba(255, 255, 255, 0.2);
    }
</style>

<script>
    class SeedCalculator extends HTMLElement {
        private els: any = {};
        private state = {
            pop: 80000,
            row: 70, 
            isMetric: true,
        };

        constructor() {
            super();
            this.init();
        }

        private init() {
            
            const q = (s: string) => this.querySelector(s);
            this.els = {
                inputPop: q("#inputPop"),
                valPop: q("#valPop"),
                inputRow: q("#inputRow"),
                valRow: q("#valRow"),

                barPop: q("#barPop"),
                thumbPop: q("#thumbPop"),

                resultVal: q("#resultVal"),
                resultUnit: q("#resultUnit"),
                resSeedsMeter: q("#resSeedsMeter"),
                resPopReal: q("#resPopReal"),

                modeMetric: q("#modeMetric"),
                modeImperial: q("#modeImperial"),
                unitRow: q("#unitRow"),

                seedTrack: q("#seedTrack"),
                presets: this.querySelectorAll(".preset-btn"),
                stepBtns: this.querySelectorAll(".step-btn"),
            };

            
            this.els.inputPop.addEventListener("input", (e: any) => {
                this.state.pop = parseInt(e.target.value);
                this.updateUI();
            });

            this.els.inputRow.addEventListener("change", (e: any) => {
                this.state.row = parseFloat(e.target.value);
                this.updateUI();
            });

            this.els.modeMetric.addEventListener("click", () => this.setMode(true));
            this.els.modeImperial.addEventListener("click", () => this.setMode(false));

            this.els.presets.forEach((btn: HTMLElement) => {
                btn.addEventListener("click", () => {
                    this.state.pop = parseInt(btn.dataset.pop || "0");
                    
                    this.state.row = parseInt(btn.dataset.row || "70");
                    if (!this.state.isMetric) {
                        
                        this.state.row = Math.round(this.state.row / 2.54);
                        
                        this.state.pop = Math.round(this.state.pop / 2.471);
                    }
                    this.updateUI();
                });
            });

            this.els.stepBtns.forEach((btn: HTMLElement) => {
                btn.addEventListener("click", () => {
                    const step = parseFloat(btn.dataset.step || "1");
                    this.state.row = Math.max(1, this.state.row + step);
                    this.updateUI();
                });
            });

            this.updateUI();
        }

        private setMode(metric: boolean) {
            if (this.state.isMetric === metric) return;

            if (metric) {
                
                this.state.pop = Math.round(this.state.pop * 2.471);
                this.state.row = Math.round(this.state.row * 2.54);
                this.els.inputPop.max = 150000;
                this.els.inputPop.min = 10000;
                this.els.inputPop.step = 1000;
            } else {
                
                this.state.pop = Math.round(this.state.pop / 2.471);
                this.state.row = Math.round(this.state.row / 2.54);
                this.els.inputPop.max = 60000;
                this.els.inputPop.min = 4000;
                this.els.inputPop.step = 500;
            }

            this.state.isMetric = metric;
            this.updateUI();
        }

        private updateUI() {
            
            this.els.inputPop.value = this.state.pop;
            this.els.inputRow.value = this.state.row;
            this.els.valPop.textContent = this.state.pop.toLocaleString();
            this.els.valRow.textContent = this.state.row;

            
            const pct =
                ((this.state.pop - parseInt(this.els.inputPop.min)) /
                    (parseInt(this.els.inputPop.max) - parseInt(this.els.inputPop.min))) *
                100;
            this.els.barPop.style.width = `${pct}%`;
            this.els.thumbPop.style.left = `${pct}%`;

            
            if (this.state.isMetric) {
                this.els.modeMetric.className =
                    "text-xs font-bold text-emerald-400 bg-emerald-950/50 px-3 py-1 rounded border border-emerald-900";
                this.els.modeImperial.className =
                    "text-xs font-bold text-zinc-600 hover:text-zinc-400 transition-colors";
                this.els.unitRow.textContent = "CM";
                this.els.resultUnit.textContent = "CM";
            } else {
                this.els.modeImperial.className =
                    "text-xs font-bold text-emerald-400 bg-emerald-950/50 px-3 py-1 rounded border border-emerald-900";
                this.els.modeMetric.className =
                    "text-xs font-bold text-zinc-600 hover:text-zinc-400 transition-colors";
                this.els.unitRow.textContent = "IN";
                this.els.resultUnit.textContent = "IN";
            }

            this.calculate();
        }

        private calculate() {
            let spacing = 0;
            let seedsMeter = 0;
            let plantsSqM = 0;

            if (this.state.isMetric) {
                
                
                const p = Math.max(1, this.state.pop);
                const r = Math.max(1, this.state.row);
                spacing = 10_000_000 / (p * r);

                seedsMeter = 100 / spacing;
                plantsSqM = p / 10000;
            } else {
                
                
                const p = Math.max(1, this.state.pop);
                const r = Math.max(1, this.state.row);
                spacing = 6_272_640 / (p * r);

                seedsMeter = 12 / spacing;
                plantsSqM = p / 43560; 
            }

            this.els.resultVal.textContent = spacing.toFixed(1);
            this.els.resSeedsMeter.textContent = seedsMeter.toFixed(1);
            this.els.resSeedsMeter.nextElementSibling.textContent = this.state.isMetric
                ? "SEMILLAS / METRO"
                : "SEMILLAS / PIE";

            this.els.resPopReal.textContent = this.state.isMetric
                ? plantsSqM.toFixed(1)
                : (this.state.pop / 1000).toFixed(1) + "k";
            this.els.resPopReal.nextElementSibling.textContent = this.state.isMetric
                ? "PLANTAS / M²"
                : "PLANTAS / ACRE";

            this.visualize(spacing);
        }

        private visualize(spacing: number) {
            
            
            
            const containerWidth = this.els.seedTrack.clientWidth;

            
            
            
            const pxPerUnit = 15;

            const gapPx = spacing * pxPerUnit;

            
            const center = containerWidth / 2;

            this.els.seedTrack.innerHTML = "";

            
            
            this.drawSeed(center);

            
            let pos = center + gapPx;
            while (pos < containerWidth) {
                this.drawSeed(pos, true);
                pos += gapPx;
            }

            
            pos = center - gapPx;
            while (pos > 0) {
                this.drawSeed(pos, true);
                pos -= gapPx;
            }
        }

        private drawSeed(left: number, isGhost = false) {
            const seed = document.createElement("div");
            seed.className = "seed-icon";
            if (isGhost) seed.style.opacity = "0.5";
            seed.style.left = `${left}px`;

            
            if (isGhost && left > this.els.seedTrack.clientWidth / 2) {
                
                const line = document.createElement("div");
                line.className = "absolute top-1/2 h-px bg-emerald-500/50";
                line.style.left = `${this.els.seedTrack.clientWidth / 2}px`;
                line.style.width = `${left - this.els.seedTrack.clientWidth / 2}px`;
                this.els.seedTrack.appendChild(line);
            }

            this.els.seedTrack.appendChild(seed);
        }
    }

    customElements.define("calc-siembra", SeedCalculator);
</script>
