---
import { Icon } from "astro-icon/components";
---

<div
    class="relative w-full aspect-[9/16] md:aspect-video rounded-[2rem] overflow-hidden shadow-2xl bg-[#050b14] group border border-white/5 mx-auto max-w-7xl isolate select-none"
>
    <div class="absolute inset-0 z-0 select-none pointer-events-none">
        <div
            class="absolute inset-0 bg-gradient-to-b from-[#02040a] via-[#0b1026] to-[#1e293b] z-0"
        >
        </div>

        <div
            id="layer-stars"
            class="absolute inset-0 z-10 opacity-100 transition-opacity duration-1000 ease-in-out mix-blend-plus-lighter"
        >
            <div
                class="absolute inset-0 bg-[url('/images/utilities/dark-sky/stars-bg.png')] bg-cover bg-center"
            >
            </div>
        </div>

        <div
            id="layer-milkyway"
            class="absolute inset-0 z-20 opacity-100 transition-all duration-1000 ease-in-out mix-blend-screen"
        >
            <div
                class="absolute inset-0 bg-[url('/images/utilities/dark-sky/milky-way.png')] bg-contain bg-center bg-no-repeat opacity-80 scale-125 origin-center [mask-image:radial-gradient(closest-side,black_40%,transparent_100%)] md:[mask-image:radial-gradient(closest-side,black_50%,transparent_90%)]"
            >
            </div>
        </div>

        <div
            id="layer-pollution"
            class="absolute inset-x-0 bottom-0 top-1/4 z-30 opacity-0 transition-opacity duration-1000 ease-in-out"
        >
            <div
                class="absolute inset-0 bg-gradient-to-t from-orange-500 via-amber-200/40 to-transparent mix-blend-hard-light"
            >
            </div>
        </div>

        <div
            id="layer-glow"
            class="absolute inset-0 z-40 bg-blue-100/10 opacity-0 transition-opacity duration-1000 pointer-events-none mix-blend-overlay"
        >
        </div>

        <div class="absolute inset-x-0 bottom-0 h-1/2 z-50 pointer-events-none">
            <div
                class="absolute inset-0 bg-[url('/images/utilities/dark-sky/landscape-silhouette.png')] bg-cover bg-bottom bg-no-repeat"
            >
            </div>
            <div
                class="absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-black via-black/80 to-transparent"
            >
            </div>
        </div>
    </div>

    <div
        class="absolute top-6 inset-x-4 md:top-10 md:left-10 md:right-auto z-[60] flex flex-col items-center md:items-start text-center md:text-left"
    >
        <div class="flex flex-col gap-2">
            <h3
                id="display-title"
                class="text-3xl md:text-5xl font-black text-white tracking-tight drop-shadow-lg transition-all duration-300"
            >
                --
            </h3>

            <div
                class="inline-flex items-center gap-4 bg-black/40 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 shadow-lg"
            >
                <span
                    id="display-class"
                    class="text-xs font-bold text-white border-r border-white/20 pr-4 uppercase tracking-widest"
                >
                    --
                </span>
                <span id="display-nelm" class="font-mono text-emerald-400 font-bold text-sm">
                    NELM --
                </span>
            </div>

            <p
                id="display-description"
                class="hidden md:block max-w-sm text-sm text-white/80 font-medium leading-relaxed mt-2 drop-shadow-md"
            >
                --
            </p>
        </div>
    </div>

    <div class="absolute bottom-8 inset-x-4 md:inset-x-12 z-[70]">
        <p
            id="display-description-mobile"
            class="md:hidden text-center text-sm text-white/90 font-medium leading-relaxed mb-6 drop-shadow-md min-h-[3em]"
        >
            --
        </p>

        <div
            class="relative h-16 flex items-center bg-black/50 backdrop-blur-xl rounded-full border border-white/10 px-2 shadow-2xl"
        >
            <div
                class="absolute inset-x-4 h-2 rounded-full bg-gradient-to-r from-emerald-500 via-yellow-500 to-red-600 opacity-80"
            >
            </div>

            <input
                type="range"
                id="bortle-slider"
                min="1"
                max="9"
                value="1"
                step="1"
                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
            />

            <div
                id="custom-thumb"
                class="absolute h-10 w-10 bg-white border-4 border-indigo-600 rounded-full shadow-[0_0_20px_rgba(255,255,255,0.5)] pointer-events-none transition-all duration-150 flex items-center justify-center z-10 ease-out"
                style="left: 0%"
            >
                <div class="w-2 h-2 bg-indigo-600 rounded-full"></div>
            </div>

            <div
                class="absolute inset-x-4 bottom-2 top-2 flex justify-between pointer-events-none z-0"
            >
                {
                    [1, 2, 3, 4, 5, 6, 7, 8, 9].map((n) => (
                        <div class="flex flex-col items-center justify-center h-full w-4 relative">
                            <div class="w-0.5 h-full bg-white/10" />
                            <span class="absolute text-[10px] font-bold text-white/60 top-full mt-1">
                                {n}
                            </span>
                        </div>
                    ))
                }
            </div>
        </div>
        <div class="text-center mt-6">
            <span class="text-[10px] uppercase tracking-[0.2em] text-white/40 font-bold"
                >Desliza para ajustar la contaminaci√≥n</span
            >
        </div>
    </div>
</div>

<script>
    import { getBortleData } from "../logic/bortle";

    const elements = {
        stars: document.getElementById("layer-stars"),
        milkyway: document.getElementById("layer-milkyway"),
        pollution: document.getElementById("layer-pollution"),
        glow: document.getElementById("layer-glow"),

        title: document.getElementById("display-title"),
        classLabel: document.getElementById("display-class"),
        nelm: document.getElementById("display-nelm"),
        desc: document.getElementById("display-description"),
        descMobile: document.getElementById("display-description-mobile"),

        slider: document.getElementById("bortle-slider"),
        thumb: document.getElementById("custom-thumb"),
    };

    if (elements.slider) {
        function updateAll(val: number) {
            const level = Math.floor(val);
            const data = getBortleData(level);

            if (elements.title) elements.title.innerText = data.title;
            if (elements.classLabel) elements.classLabel.innerText = `CLASE ${level}`;
            if (elements.nelm) elements.nelm.innerText = `NELM ${data.nelm.toFixed(1)}`;
            if (elements.desc) elements.desc.innerText = data.description;
            if (elements.descMobile) elements.descMobile.innerText = data.description;

            if (elements.thumb && elements.slider) {
                const min = parseInt((elements.slider as HTMLInputElement).min);
                const max = parseInt((elements.slider as HTMLInputElement).max);
                const percent = ((val - min) / (max - min)) * 100;

                const thumbWidth = 40;
                const trackPadding = 16;

                elements.thumb.style.left = `calc(${percent}% - 20px)`;
            }

            const skyBrightness = data.skyBrightness;

            const starOpacity = Math.max(0, 1 - skyBrightness * 1.1);
            if (elements.stars) elements.stars.style.opacity = starOpacity.toString();

            let mwOpacity = 0;
            if (level <= 2) mwOpacity = 1;
            else if (level <= 4) mwOpacity = 0.6 - (level - 2) * 0.25;
            else mwOpacity = 0;
            if (elements.milkyway) elements.milkyway.style.opacity = mwOpacity.toString();

            if (elements.pollution) {
                const pollutionOpacity = Math.pow(skyBrightness, 1.5);
                elements.pollution.style.opacity = pollutionOpacity.toString();
            }

            if (elements.glow) {
                elements.glow.style.opacity = (skyBrightness * 0.5).toString();
            }
        }

        elements.slider.addEventListener("input", (e) => {
            const val = parseFloat((e.target as HTMLInputElement).value);
            updateAll(val);
        });

        updateAll(1);
    }
</script>
