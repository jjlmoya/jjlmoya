---

---

<dialog id="search-dialog" class="fixed inset-0 z-[200] w-full h-full p-0 m-0 bg-transparent">
    <div
        class="w-full max-w-2xl bg-neutral-900/90 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 opacity-0 transition-all duration-200 ease-out"
        id="search-panel"
    >
        <div class="relative flex items-center px-4 border-b border-white/10">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-neutral-400"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg
            >
            <input
                type="text"
                id="search-input"
                class="w-full h-16 bg-transparent border-none outline-none text-lg text-white placeholder-neutral-500 px-4 focus:ring-0"
                placeholder="Buscar..."
                autocomplete="off"
            />
            <div class="flex gap-2">
                <kbd
                    class="hidden sm:inline-flex h-6 items-center gap-1 rounded border border-white/10 bg-neutral-800 px-2 font-mono text-[10px] font-medium text-neutral-400"
                >
                    <span class="text-xs">Esc</span>
                </kbd>
            </div>
        </div>

        <div class="max-h-[60vh] overflow-y-auto p-2" id="search-results"></div>

        <div
            class="hidden items-center justify-between border-t border-white/10 px-4 py-2.5 text-xs text-neutral-500"
            id="search-footer"
        >
            <div class="flex gap-4">
                <span class="flex items-center gap-1">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-3.5 h-3.5"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline
                            points="9 22 9 12 15 12 15 22"></polyline></svg
                    >
                    Seleccionar
                </span>
                <span class="flex items-center gap-1">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-3.5 h-3.5"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="M7 15l5 5 5-5"></path><path d="M7 9l5-5 5 5"></path></svg
                    >
                    Navegar
                </span>
            </div>
        </div>
    </div>
</dialog>

<script>
    interface SearchResult {
        id: string;
        title: string;
        url: string;
        description: string;
        category: "Utilidad" | "Concepto" | "Proyecto" | "PÃ¡gina";
        icon: string;
    }

    class SearchController {
        private dialog: HTMLDialogElement | null = null;
        private panel: HTMLElement | null = null;
        private input: HTMLInputElement | null = null;
        private resultsContainer: HTMLElement | null = null;
        private footer: HTMLElement | null = null;
        private items: SearchResult[] = [];
        private selectedIndex = 0;
        private isOpen = false;
        private isLoading = false;

        constructor() {
            this.setup();
        }

        private setup() {
            this.dialog = document.getElementById("search-dialog") as HTMLDialogElement;
            this.panel = document.getElementById("search-panel");
            this.input = document.getElementById("search-input") as HTMLInputElement;
            this.resultsContainer = document.getElementById("search-results");
            this.footer = document.getElementById("search-footer");

            if (
                !this.dialog ||
                !this.panel ||
                !this.input ||
                !this.resultsContainer ||
                !this.footer
            )
                return;

            this.initListeners();
        }

        private initListeners() {
            document.addEventListener("keydown", (e) => {
                const isModifier = e.metaKey || e.ctrlKey;
                const isKeyK = e.key === "k" || e.code === "KeyK";
                const isKeySpace = e.key === " " || e.code === "Space";

                if (isModifier && (isKeyK || isKeySpace)) {
                    e.preventDefault();
                    this.toggle();
                }

                if (e.key === "Escape" && this.isOpen) {
                    this.close();
                }
            });

            document.addEventListener("open-search", () => this.open());

            this.dialog!.addEventListener("click", (e) => {
                if (e.target === this.dialog) {
                    this.close();
                }
            });

            this.input!.addEventListener("input", () => this.filter());
            this.input!.addEventListener("keydown", (e) => this.handleInputKeydown(e));
        }

        private async loadItems() {
            if (this.items.length > 0 || this.isLoading) return;

            this.isLoading = true;
            try {
                const response = await fetch("/api/search-index.json");
                if (response.ok) {
                    this.items = await response.json();

                    if (this.isOpen) {
                        this.filter();
                    }
                }
            } catch (error) {
                console.error("Failed to load search index", error);
            } finally {
                this.isLoading = false;
            }
        }

        private open() {
            if (this.isOpen || !this.dialog || !this.panel || !this.input) return;
            this.isOpen = true;
            this.loadItems();

            this.dialog.showModal();
            this.dialog.classList.remove("hidden");

            requestAnimationFrame(() => {
                this.panel!.classList.remove("scale-95", "opacity-0");
                this.panel!.classList.add("scale-100", "opacity-100");
                this.input!.focus();
            });

            this.input.value = "";
            this.filter();
        }

        private close() {
            if (!this.isOpen || !this.dialog || !this.panel) return;
            this.isOpen = false;

            this.panel.classList.remove("scale-100", "opacity-100");
            this.panel.classList.add("scale-95", "opacity-0");

            setTimeout(() => {
                this.dialog!.close();
                this.dialog!.classList.add("hidden");
            }, 200);
        }

        private toggle() {
            if (this.isOpen) {
                this.close();
            } else {
                this.open();
            }
        }

        private filter() {
            if (!this.input) return;
            const query = this.input.value.toLowerCase();
            const filtered =
                query === ""
                    ? this.items.slice(0, 5)
                    : this.items
                          .filter(
                              (item) =>
                                  item.title.toLowerCase().includes(query) ||
                                  item.description.toLowerCase().includes(query)
                          )
                          .slice(0, 50);

            this.render(filtered);
            this.selectedIndex = 0;
            this.updateSelection();
        }

        private render(results: SearchResult[]) {
            if (!this.resultsContainer || !this.footer) return;

            this.resultsContainer.innerHTML = "";

            if (results.length === 0) {
                this.footer.classList.add("hidden");
                this.resultsContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-neutral-500">
                        <p class="text-sm">No se encontraron resultados</p>
                    </div>
                `;
                return;
            }

            this.footer.classList.remove("hidden");
            const grouped = this.groupByCategory(results);

            Object.entries(grouped).forEach(([category, items]) => {
                const groupTitle = document.createElement("div");
                groupTitle.className =
                    "px-2 py-1.5 text-xs font-semibold text-neutral-500 uppercase tracking-wider";
                groupTitle.textContent = category;
                this.resultsContainer!.appendChild(groupTitle);

                items.forEach((item, index) => {
                    const el = document.createElement("a");
                    el.href = item.url;
                    el.className =
                        "flex items-center gap-3 px-3 py-3 rounded-lg text-neutral-400 hover:text-white hover:bg-white/5 transition-colors cursor-pointer group";
                    el.dataset.index = index.toString();

                    el.innerHTML = `
                        <div class="flex items-center justify-center w-8 h-8 rounded bg-white/5 text-neutral-400 group-hover:text-white group-hover:bg-white/10 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-neutral-200 group-hover:text-white">${item.title}</span>
                            <span class="text-xs text-neutral-500">${item.description}</span>
                        </div>
                    `;
                    this.resultsContainer!.appendChild(el);
                });
            });
        }

        private groupByCategory(results: SearchResult[]) {
            return results.reduce(
                (acc, item) => {
                    if (!acc[item.category]) acc[item.category] = [];
                    acc[item.category].push(item);
                    return acc;
                },
                {} as Record<string, SearchResult[]>
            );
        }

        private handleInputKeydown(e: KeyboardEvent) {
            if (!this.resultsContainer) return;
            const items = this.resultsContainer.querySelectorAll("a");
            if (items.length === 0) return;

            if (e.key === "ArrowDown") {
                e.preventDefault();
                this.selectedIndex = (this.selectedIndex + 1) % items.length;
                this.updateSelection();
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                this.selectedIndex = (this.selectedIndex - 1 + items.length) % items.length;
                this.updateSelection();
            } else if (e.key === "Enter") {
                e.preventDefault();
                const selected = items[this.selectedIndex];
                if (selected) {
                    window.location.href = selected.href;
                }
            }
        }

        private updateSelection() {
            if (!this.resultsContainer) return;
            const items = this.resultsContainer.querySelectorAll("a");
            items.forEach((item, index) => {
                if (index === this.selectedIndex) {
                    item.classList.add("bg-white/10", "text-white");
                    item.scrollIntoView({ block: "nearest" });
                } else {
                    item.classList.remove("bg-white/10", "text-white");
                }
            });
        }
    }

    let controller: SearchController | null = null;

    document.addEventListener("astro:page-load", () => {
        if (!controller) controller = new SearchController();
    });

    document.addEventListener("DOMContentLoaded", () => {
        if (!controller) controller = new SearchController();
    });
</script>

<style>
    dialog[open] {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 15vh;
    }

    dialog::backdrop {
        background: rgba(10, 10, 10, 0.4);
        backdrop-filter: blur(4px);
    }
</style>
