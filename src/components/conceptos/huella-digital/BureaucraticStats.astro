---

---

<section class="w-full max-w-6xl px-6 md:px-8 py-8 border-y-2 border-black/5 bg-white/20 font-sans">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-16 lg:gap-24">
        <div class="lg:col-span-5 space-y-12">
            <div class="space-y-6">
                <h2
                    class="text-4xl md:text-5xl font-black uppercase italic tracking-tighter leading-[0.9]"
                >
                    El Rastro <br />
                    Consolidado
                </h2>
                <div class="w-20 h-1 bg-black"></div>
                <p class="text-lg md:text-xl font-light leading-relaxed text-black/70">
                    Cada interacción en este espacio genera una huella única. Este registro no es
                    una estadística de tráfico convencional; es la acumulación histórica de
                    presencias digitales que han decidido dejar su marca en el archivo.
                </p>
            </div>

            <div class="grid grid-cols-2 gap-8 pt-8 border-t border-black/10">
                <div class="space-y-2">
                    <span class="text-[10px] font-mono font-bold uppercase opacity-40"
                        >Dispositivos</span
                    >
                    <div id="os-summary" class="text-2xl font-black font-mono tracking-tighter">
                        --
                    </div>
                </div>
                <div class="space-y-2">
                    <span class="text-[10px] font-mono font-bold uppercase opacity-40"
                        >Hora Punta</span
                    >
                    <div id="time-summary" class="text-2xl font-black font-mono tracking-tighter">
                        --:00
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-7 space-y-16">
            <div
                class="relative group p-6 border border-black/10 bg-white shadow-[10px_10px_0px_rgba(0,0,0,0.03)]"
            >
                <div class="absolute top-0 right-0 p-4 opacity-10 font-mono text-[8px] uppercase">
                    Ref: HIST-7D-STRATA
                </div>
                <h4
                    class="text-[10px] font-mono font-bold uppercase opacity-40 mb-8 flex items-center gap-2"
                >
                    <span class="w-1.5 h-1.5 bg-black rounded-full animate-pulse"></span>
                    Estratos de Crecimiento (Bloques de 7 Días)
                </h4>

                <div class="flex gap-4">
                    <div
                        id="weekly-y-axis"
                        class="flex flex-col justify-between text-[7px] font-mono opacity-30 py-1 text-right w-12"
                    >
                        <span>-</span>
                        <span>0 huellas</span>
                    </div>

                    <div class="flex-grow">
                        <div
                            id="weekly-chart"
                            class="h-56 flex items-end gap-1 px-2 border-b-2 border-black/20"
                        >
                        </div>
                        <div
                            id="weekly-x-axis"
                            class="flex justify-between mt-2 text-[7px] font-mono opacity-50 uppercase tracking-tighter font-bold"
                        >
                            <span>Origen del Archivo</span>
                            <span class="text-black">Presente</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="p-6 border border-black/10 bg-white/60">
                    <h4 class="text-[10px] font-mono font-bold uppercase opacity-40 mb-6">
                        Hábitat de Sistemas
                    </h4>
                    <div id="os-chart" class="space-y-4"></div>
                </div>
                <div class="p-6 border border-black/10 bg-white/60">
                    <h4 class="text-[10px] font-mono font-bold uppercase opacity-40 mb-6">
                        Ritmo Circadiano
                    </h4>

                    <div class="flex gap-3">
                        <div
                            id="time-y-axis"
                            class="flex flex-col justify-between text-[7px] font-mono opacity-30 py-1 text-right w-3"
                        >
                            <span>-</span>
                            <span>0</span>
                        </div>

                        <div class="flex-grow">
                            <div
                                id="time-chart"
                                class="h-32 flex items-end gap-[1px] pb-1 border-b border-black/10"
                            >
                            </div>
                            <div
                                class="flex justify-between mt-1 text-[6px] font-mono opacity-30 uppercase"
                            >
                                <span>00h</span>
                                <span>12h</span>
                                <span>23h</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div
        class="mt-8 pt-8 border-t border-black/5 flex flex-col md:flex-row justify-between items-end gap-8"
    >
        <div class="max-w-md space-y-3">
            <h3 class="text-[10px] font-mono font-bold uppercase opacity-40">
                Cromática del Rastro
            </h3>
            <p class="text-sm font-light leading-relaxed text-black/60">
                Cada huella es procesada y traducida a un valor cromático basado en sus metadatos
                técnicos. Esta secuencia representa la cronología visual de las últimas capturas
                registradas en el sistema.
            </p>
        </div>
        <div class="w-full md:w-auto flex items-center gap-6">
            <div
                id="color-spectrum"
                class="h-12 flex-grow md:w-64 border border-black/10 flex overflow-hidden"
            >
            </div>
            <div class="text-right">
                <span class="text-[8px] font-mono font-bold uppercase opacity-30 block mb-1"
                    >Última Adquisición</span
                >
                <span
                    id="avg-color-label"
                    class="text-xl font-black font-mono tracking-tighter uppercase">#------</span
                >
            </div>
        </div>
    </div>
</section>

<script>
    type Footprint = [number | string, string, string, string, string, string];

    function handleUpdate(footprints: Footprint[]) {
        if (!footprints || !footprints.length) return;

        const osCounts: Record<string, number> = {};
        footprints.forEach((f) => {
            const os = (f[2] || "").split(")")[0].split("(").pop() || "Other";
            const shortOs = os.split(";")[0].split(" ")[0].toUpperCase();
            osCounts[shortOs] = (osCounts[shortOs] || 0) + 1;
        });

        const osChart = document.getElementById("os-chart");
        const osSummary = document.getElementById("os-summary");
        if (osChart) {
            const sortedOs = Object.entries(osCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 4);
            const max = Math.max(...Object.values(osCounts));

            if (osSummary) osSummary.textContent = sortedOs[0][0];

            osChart.innerHTML = sortedOs
                .map(
                    ([os, count]) => `
                <div class="space-y-1 group">
                    <div class="flex justify-between text-[8px] font-mono font-bold uppercase">
                        <span class="opacity-40 group-hover:opacity-100">${os}</span>
                        <span>${Math.round((count / footprints.length) * 100)}%</span>
                    </div>
                    <div class="w-full h-0.5 bg-black/5">
                        <div class="h-full bg-black transition-all duration-1000" style="width: ${(count / max) * 100}%"></div>
                    </div>
                </div>
            `
                )
                .join("");
        }

        const hourCounts = new Array(24).fill(0);
        footprints.forEach((f) => {
            const hour = new Date(f[0]).getHours();
            if (!isNaN(hour)) hourCounts[hour]++;
        });

        const timeChart = document.getElementById("time-chart");
        const timeSummary = document.getElementById("time-summary");
        const timeYAxis = document.getElementById("time-y-axis");

        if (timeChart) {
            const maxHourValue = Math.max(...hourCounts);
            const peakHour = hourCounts.indexOf(maxHourValue);
            if (timeSummary) timeSummary.textContent = `${peakHour.toString().padStart(2, "0")}:00`;

            if (timeYAxis) {
                timeYAxis.innerHTML = `<span>${maxHourValue}</span><span>0</span>`;
            }

            timeChart.innerHTML = hourCounts
                .map(
                    (count, i) => `
                <div class="flex-grow bg-black/10 hover:bg-black transition-colors relative group" style="height: ${maxHourValue ? (count / maxHourValue) * 100 : 0}%">
                    <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-black text-white text-[7px] px-1 hidden group-hover:block z-10 font-mono">
                        ${i}H
                    </div>
                </div>
            `
                )
                .join("");
        }

        const weeklyChart = document.getElementById("weekly-chart");
        const weeklyYAxis = document.getElementById("weekly-y-axis");
        const weeklyXAxis = document.getElementById("weekly-x-axis");

        if (weeklyChart) {
            const now = new Date();
            now.setHours(23, 59, 59, 999);
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;

            const sorted = [...footprints].sort(
                (a, b) => new Date(a[0]).getTime() - new Date(b[0]).getTime()
            );

            if (sorted.length > 0) {
                const firstTs = new Date(sorted[0][0]).getTime();
                const totalDays = Math.ceil((now.getTime() - firstTs) / (24 * 60 * 60 * 1000));
                const numBuckets = Math.ceil(totalDays / 7);

                const buckets = new Array(numBuckets).fill(0);

                footprints.forEach((f) => {
                    const ts = new Date(f[0]).getTime();
                    const diffMs = now.getTime() - ts;
                    const bucketIndex = Math.floor(diffMs / sevenDaysMs);
                    if (bucketIndex >= 0 && bucketIndex < numBuckets) {
                        buckets[numBuckets - 1 - bucketIndex]++;
                    }
                });

                const maxBucket = Math.max(...buckets, 1);

                if (weeklyYAxis) {
                    weeklyYAxis.innerHTML = `<span>${maxBucket}</span><span>0 huellas</span>`;
                }

                if (weeklyXAxis) {
                    const firstDate = new Date(sorted[0][0]).toLocaleDateString("es-ES", {
                        month: "short",
                        year: "2-digit",
                    });
                    weeklyXAxis.innerHTML = `<span>Inundación Inicial (${firstDate})</span><span class="text-black">Consolidación (Hoy)</span>`;
                }

                weeklyChart.innerHTML = buckets
                    .map((count, i) => {
                        const daysAgoEnd = (numBuckets - 1 - i) * 7;
                        const daysAgoStart = daysAgoEnd + 7;
                        const label =
                            daysAgoEnd === 0
                                ? "ÚLTIMOS 7 DÍAS"
                                : `HACE ${daysAgoEnd}-${daysAgoStart} DÍAS`;

                        return `
                            <div class="flex-grow bg-black/5 hover:bg-black transition-all relative group" style="height: ${count > 0 ? (count / maxBucket) * 100 : 5}%">
                                <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black text-white text-[7px] px-2 py-1 hidden group-hover:block z-10 font-mono whitespace-nowrap shadow-xl">
                                    ${label}: ${count} HUELLAS
                                </div>
                            </div>
                        `;
                    })
                    .join("");
            }
        }

        const spectrumBar = document.getElementById("color-spectrum");
        if (spectrumBar) {
            const samples = footprints.slice(-50);
            spectrumBar.innerHTML = samples
                .map(
                    (f) => `
                <div class="flex-grow h-full" style="background-color: ${f[1]}"></div>
            `
                )
                .join("");

            const lastFootprint = footprints[footprints.length - 1];
            const lastColor = lastFootprint ? lastFootprint[1] : "#------";
            const label = document.getElementById("avg-color-label");
            if (label) label.textContent = lastColor.toUpperCase();
        }
    }

    window.addEventListener("footprints-updated", (e: any) => {
        handleUpdate(e.detail);
    });

    if ((window as any).footprints) {
        handleUpdate((window as any).footprints);
    }
</script>
