---
import { Icon } from "astro-icon/components";

const comparisons = [
    {
        title: "Piso en Propiedad",
        shareTitle: "un piso",
        icon: "mdi:home-city",
        then: { year: 1985, effort: "3 años", effortValue: 30, salary: "9.000€", cost: "27.000€" },
        now: {
            year: 2025,
            effort: "11.5 años",
            effortValue: 100,
            salary: "25.000€",
            cost: "287.000€",
        },
    },
    {
        title: "Coche Nuevo",
        shareTitle: "un coche nuevo",
        icon: "mdi:car-sports",
        then: { year: 1985, effort: "6 meses", effortValue: 25, salary: "9.000€", cost: "4.500€" },
        now: {
            year: 2025,
            effort: "11.5 meses",
            effortValue: 48,
            salary: "25.000€",
            cost: "24.000€",
        },
    },
    {
        title: "Entrada de Cine",
        shareTitle: "una entrada de cine",
        icon: "mdi:ticket-confirmation",
        then: { year: 1980, effort: "20 min", effortValue: 15, salary: "4€/h", cost: "1,50€" },
        now: { year: 2025, effort: "45 min", effortValue: 35, salary: "12€/h", cost: "9,00€" },
    },
    {
        title: "Litro de Aceite",
        shareTitle: "un litro de aceite",
        icon: "mdi:oil",
        then: { year: 2000, effort: "12 min", effortValue: 10, salary: "6€/h", cost: "1,20€" },
        now: { year: 2025, effort: "50 min", effortValue: 45, salary: "12€/h", cost: "10,00€" },
    },
    {
        title: "Alquiler Mensual",
        shareTitle: "un mes de alquiler",
        icon: "mdi:key-variant",
        then: { year: 1995, effort: "5 días", effortValue: 20, salary: "14.000€", cost: "250€" },
        now: { year: 2025, effort: "14 días", effortValue: 65, salary: "25.000€", cost: "950€" },
    },
    {
        title: "Abono Festival",
        shareTitle: "un abono de festival",
        icon: "mdi:speaker-wireless",
        then: { year: 1998, effort: "6 horas", effortValue: 8, salary: "5€/h", cost: "30€" },
        now: { year: 2025, effort: "2.5 días", effortValue: 35, salary: "12€/h", cost: "240€" },
    },
    {
        title: "Carro Semanal",
        shareTitle: "la compra semanal",
        icon: "mdi:cart-variant",
        then: { year: 2000, effort: "4 horas", effortValue: 10, salary: "6€/h", cost: "24€" },
        now: { year: 2025, effort: "1.5 días", effortValue: 25, salary: "12€/h", cost: "120€" },
    },
    {
        title: "Factura Luz/Gas",
        shareTitle: "la factura de la luz",
        icon: "mdi:lightning-bolt",
        then: { year: 1990, effort: "3 horas", effortValue: 5, salary: "4€/h", cost: "12€" },
        now: { year: 2025, effort: "10 horas", effortValue: 18, salary: "12€/h", cost: "120€" },
    },
];
---

<section class="max-w-5xl mx-auto px-4 mb-24" id="effort-calculator">
    <div
        class="mb-12 bg-slate-900/50 p-6 rounded-2xl border border-slate-800 flex flex-col md:flex-row items-center justify-between gap-6 backdrop-blur-sm"
    >
        <div class="text-center md:text-left">
            <h3 class="text-slate-200 font-bold text-lg mb-1">Tu Realidad</h3>
            <p class="text-slate-500 text-sm">Ajusta el salario para ver tu esfuerzo real</p>
        </div>

        <div
            class="flex items-center gap-4 bg-slate-950 p-2 rounded-xl border border-slate-800 shadow-inner"
        >
            <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">€</span>
                <input
                    type="number"
                    id="user-salary"
                    value="25000"
                    class="bg-transparent text-white font-mono text-xl w-32 pl-8 focus:outline-none text-right"
                    step="1000"
                />
            </div>
            <span class="text-slate-500 text-sm font-mono pr-2">/año</span>
        </div>

        <button
            id="reset-salary"
            class="text-xs text-slate-500 hover:text-emerald-400 underline decoration-dotted transition-colors"
        >
            Usar media española
        </button>
    </div>

    <div class="grid gap-2">
        {
            comparisons.map((item) => (
                <div
                    class="comparison-card group"
                    data-base-effort={item.now.effortValue}
                    data-cost={item.now.cost.replace(".", "").replace("€", "").replace(",", ".")}
                >
                    <div class="relative bg-slate-900/80 backdrop-blur-sm rounded-xl border border-slate-800 p-6 md:p-8 overflow-hidden">
                        <div class="flex items-center justify-between mb-8 border-b border-slate-800 pb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-800 rounded-lg flex items-center justify-center text-slate-200 shadow-inner border border-slate-700">
                                    <Icon name={item.icon} class="w-6 h-6" />
                                </div>
                                <h3 class="text-2xl font-black text-white tracking-tight">
                                    {item.title}
                                </h3>
                            </div>

                            <button
                                class="share-btn p-2 rounded-full hover:bg-slate-800 text-slate-500 hover:text-white transition-colors"
                                title="Compartir este dato"
                                data-share-btn
                                data-share-title={item.shareTitle}
                                data-then-year={item.then.year}
                                data-then-effort={item.then.effort}
                                data-now-year={item.now.year}
                                data-now-effort={item.now.effort}
                                data-share-text={`En ${item.then.year}, comprar ${item.shareTitle} costaba ${item.then.effort} de trabajo. Hoy me cuesta ${item.now.effort}. #Inflacion`}
                            >
                                <Icon name="mdi:share-variant" class="w-5 h-5" />
                            </button>
                        </div>

                        <div class="grid md:grid-cols-2 gap-12 relative">
                            <div class="hidden md:block absolute left-1/2 top-0 bottom-0 w-px bg-slate-800 -ml-px" />

                            <div class="space-y-4 opacity-70 grayscale group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-700">
                                <div class="flex justify-between items-end mb-2">
                                    <span class="text-4xl font-black text-emerald-400 tracking-tighter">
                                        {item.then.year}
                                    </span>
                                    <span class="text-xs font-mono text-emerald-400/60 uppercase tracking-widest mb-1">
                                        La "Buena" Época
                                    </span>
                                </div>

                                <div class="relative h-16 bg-slate-950 rounded-lg border border-slate-800 overflow-hidden">
                                    <div
                                        class="absolute left-0 top-0 bottom-0 bg-emerald-500/20 border-r-2 border-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.3)]"
                                        style={`width: ${item.then.effortValue}%`}
                                    />
                                    <div class="relative z-10 h-full flex flex-col justify-center px-4">
                                        <div class="flex justify-between items-baseline">
                                            <span class="text-white font-bold text-lg">
                                                {item.then.effort}
                                            </span>
                                            <span class="text-xs text-slate-500 font-mono">
                                                de trabajo
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-between text-xs font-mono text-slate-500 pt-2">
                                    <span>
                                        Sueldo:{" "}
                                        <span class="text-slate-300">{item.then.salary}</span>
                                    </span>
                                    <span>
                                        Coste: <span class="text-slate-300">{item.then.cost}</span>
                                    </span>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="flex justify-between items-end mb-2">
                                    <span class="text-4xl font-black text-rose-500 tracking-tighter">
                                        {item.now.year}
                                    </span>
                                    <span class="text-xs font-mono text-rose-500/60 uppercase tracking-widest mb-1">
                                        La Cruda Realidad
                                    </span>
                                </div>

                                <div class="relative h-16 bg-slate-950 rounded-lg border border-slate-800 overflow-hidden group-hover:border-slate-700 transition-colors">
                                    <div
                                        class="effort-bar absolute left-0 top-0 bottom-0 bg-rose-500/20 border-r-2 border-rose-500 shadow-[0_0_20px_rgba(244,63,94,0.3)] transition-all duration-1000 ease-out"
                                        style={`width: ${item.now.effortValue}%`}
                                    />
                                    <div class="relative z-10 h-full flex flex-col justify-center px-4">
                                        <div class="flex justify-between items-baseline">
                                            <span class="effort-text text-white font-bold text-lg">
                                                {item.now.effort}
                                            </span>
                                            <span class="text-xs text-slate-500 font-mono">
                                                de trabajo
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-between text-xs font-mono text-slate-500 pt-2">
                                    <span>
                                        Sueldo:{" "}
                                        <span class="user-salary-display text-slate-300 transition-colors duration-300">
                                            {item.now.salary}
                                        </span>
                                    </span>
                                    <span>
                                        Coste: <span class="text-slate-300">{item.now.cost}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            ))
        }
    </div>

    <div class="mt-12 text-center">
        <p class="text-xs text-slate-600 font-mono uppercase tracking-widest">
            * Datos aproximados ajustados a salarios medios
        </p>
    </div>
</section>

<script>
    const salaryInput = document.getElementById("user-salary") as HTMLInputElement;
    const resetButton = document.getElementById("reset-salary");
    const cards = document.querySelectorAll(".comparison-card");
    const salaryDisplays = document.querySelectorAll(".user-salary-display");

    const DEFAULT_SALARY = 25000;
    const WORK_HOURS_YEAR = 1760;

    function formatEffort(years: number): string {
        if (years < 1) {
            const months = years * 12;
            if (months < 1) {
                const days = months * 30;
                if (days < 1) {
                    const hours = days * 8;
                    if (hours < 1) {
                        return Math.round(hours * 60) + " min";
                    }
                    return Math.round(hours) + " hora/s";
                }
                return Math.round(days) + " día/s";
            }
            return months.toFixed(1) + " mes/es";
        }
        return years.toFixed(1) + " año/s";
    }

    function updateCalculations() {
        const salary = parseFloat(salaryInput?.value) || DEFAULT_SALARY;
        const hourlyRate = salary / WORK_HOURS_YEAR;

        salaryDisplays.forEach((display) => {
            const card = display.closest(".comparison-card");
            const isHourlyContext =
                card?.querySelector("h3")?.innerText.includes("Cine") ||
                card?.querySelector("h3")?.innerText.includes("Aceite");

            if (isHourlyContext) {
                display.textContent = `${hourlyRate.toFixed(2)}€/h`;
                display.classList.add("text-rose-400");
            } else {
                display.textContent = `${salary.toLocaleString()}€/año`;
                display.classList.add("text-rose-400");
            }
        });

        cards.forEach((card) => {
            const costStr = (card as HTMLElement).dataset.cost || "0";
            const cost = parseFloat(costStr);
            const effortBar = card.querySelector(".effort-bar") as HTMLElement;
            const effortText = card.querySelector(".effort-text") as HTMLElement;
            const shareBtn = card.querySelector(".share-btn") as HTMLElement;

            let yearsEffort = cost / salary;
            let effortLabel = formatEffort(yearsEffort);

            const isSmallItem = cost < 100;
            if (isSmallItem) {
                const hoursEffort = cost / hourlyRate;
                yearsEffort = hoursEffort / WORK_HOURS_YEAR;
                effortLabel = formatEffort(yearsEffort);
            }

            if (effortText) effortText.textContent = effortLabel;

            if (shareBtn) {
                const data = shareBtn.dataset;

                const shareText = `En ${data.thenYear}, comprar ${data.shareTitle} costaba ${data.thenEffort} de trabajo. Hoy me cuesta ${effortLabel}. #Inflacion`;
                shareBtn.setAttribute("data-share-text", shareText);
            }

            const baseEffortValue = parseFloat((card as HTMLElement).dataset.baseEffort || "50");
            const baseSalary = DEFAULT_SALARY;
            let newWidth = baseEffortValue * (baseSalary / salary);
            newWidth = Math.min(newWidth, 100);

            if (effortBar) effortBar.style.width = `${newWidth}%`;
        });
    }

    salaryInput?.addEventListener("input", updateCalculations);

    resetButton?.addEventListener("click", () => {
        if (salaryInput) salaryInput.value = DEFAULT_SALARY.toString();
        updateCalculations();
        salaryDisplays.forEach((d) => d.classList.remove("text-rose-400"));
    });

    updateCalculations();
</script>
