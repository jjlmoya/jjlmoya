---

---

<section
    class="min-h-screen flex flex-col items-center justify-center relative py-20 bg-neutral-950 text-white"
>
    <div class="container mx-auto px-6 max-w-6xl">
        <div class="text-center mb-16 space-y-4">
            <h2
                class="text-4xl md:text-6xl font-bold bg-clip-text text-transparent bg-gradient-to-b from-white to-neutral-500"
            >
                Tu Huella Digital
            </h2>
            <p class="text-neutral-400 max-w-2xl mx-auto text-lg">
                Hemos estado midiendo tu comportamiento mientras leías sobre la medición. Aquí están
                tus estadísticas de sesión.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-12">
            <div
                class="bg-neutral-900/50 rounded-2xl p-6 border border-neutral-800 backdrop-blur-sm col-span-1 md:col-span-2 lg:col-span-2 relative overflow-hidden group"
            >
                <div
                    class="absolute inset-0 bg-gradient-to-r from-cyan-500/10 to-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
                >
                </div>
                <div class="relative z-10">
                    <div class="flex items-baseline gap-2 mb-2">
                        <span class="text-xs font-mono uppercase tracking-widest text-cyan-400"
                            >Distancia Recorrida</span
                        >
                    </div>
                    <div class="flex items-baseline gap-4">
                        <span
                            id="stat-pixels"
                            class="text-4xl md:text-5xl font-bold font-mono text-white">0</span
                        >
                        <span class="text-neutral-500 font-mono">px</span>
                    </div>
                    <div
                        class="mt-4 flex items-center gap-4 text-sm text-neutral-400 font-mono border-t border-white/5 pt-4"
                    >
                        <div class="flex-1">
                            <span id="stat-meters" class="text-white font-bold">0.00</span> m
                        </div>
                        <div class="w-px h-4 bg-white/10"></div>
                        <div class="flex-1 text-right">
                            <span id="stat-scale" class="text-cyan-200">Microscópico</span>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="bg-neutral-900/50 rounded-2xl p-6 border border-neutral-800 backdrop-blur-sm col-span-1 md:col-span-1 relative overflow-hidden group"
            >
                <div
                    class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-pink-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
                >
                </div>
                <div class="relative z-10">
                    <span class="text-xs font-mono uppercase tracking-widest text-purple-400"
                        >Tiempo de Vida</span
                    >
                    <div class="mt-2 flex items-baseline gap-2">
                        <span id="stat-time" class="text-4xl font-bold font-mono text-white"
                            >00:00</span
                        >
                    </div>
                    <p class="text-xs text-neutral-500 mt-2">Invertido en esta página</p>
                </div>
            </div>

            <div
                class="bg-neutral-900/50 rounded-2xl p-6 border border-neutral-800 backdrop-blur-sm col-span-1 md:col-span-1 relative overflow-hidden group"
            >
                <div
                    class="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-green-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
                >
                </div>
                <div class="relative z-10">
                    <span class="text-xs font-mono uppercase tracking-widest text-emerald-400"
                        >Velocidad</span
                    >
                    <div class="mt-2 flex items-baseline gap-2">
                        <span id="stat-speed" class="text-4xl font-bold font-mono text-white"
                            >0</span
                        >
                        <span class="text-sm text-neutral-500">px/s</span>
                    </div>
                    <p class="text-xs text-neutral-500 mt-2">Ritmo de consumo</p>
                </div>
            </div>

            <div
                class="bg-neutral-900/50 rounded-2xl p-6 border border-neutral-800 backdrop-blur-sm col-span-1 md:col-span-2 lg:col-span-3 relative overflow-hidden group"
            >
                <div
                    class="absolute inset-0 bg-gradient-to-r from-orange-500/10 to-red-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
                >
                </div>
                <div
                    class="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-6"
                >
                    <div>
                        <span class="text-xs font-mono uppercase tracking-widest text-orange-400"
                            >Tu Obsesión</span
                        >
                        <h3
                            id="stat-obsession-title"
                            class="text-2xl md:text-3xl font-serif italic text-white mt-2"
                        >
                            Calculando...
                        </h3>
                        <p class="text-sm text-neutral-400 mt-1">
                            La sección que más ha capturado tu atención.
                        </p>
                    </div>
                    <div class="text-right">
                        <span
                            id="stat-obsession-time"
                            class="text-4xl font-bold font-mono text-orange-200">0s</span
                        >
                        <p class="text-xs text-neutral-500 uppercase tracking-widest mt-1">
                            Dedicados
                        </p>
                    </div>
                </div>
            </div>

            <div
                class="bg-neutral-900/50 rounded-2xl p-6 border border-neutral-800 backdrop-blur-sm col-span-1 md:col-span-1 relative overflow-hidden group"
            >
                <div
                    class="absolute inset-0 bg-gradient-to-br from-yellow-500/10 to-amber-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
                >
                </div>
                <div class="relative z-10">
                    <span class="text-xs font-mono uppercase tracking-widest text-yellow-400"
                        >Eventos</span
                    >
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <div id="stat-clicks" class="text-2xl font-bold font-mono text-white">
                                0
                            </div>
                            <div class="text-[10px] text-neutral-500 uppercase">Clicks</div>
                        </div>
                        <div>
                            <div id="stat-scrolls" class="text-2xl font-bold font-mono text-white">
                                0
                            </div>
                            <div class="text-[10px] text-neutral-500 uppercase">Swipes</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <p class="text-neutral-500 text-sm mb-8 font-mono">
                "Lo que no se mide, no se puede mejorar." — Lord Kelvin <br />
                <span class="text-neutral-700 text-xs"
                    >(Pero lo que se mide demasiado, pierde su alma)</span
                >
            </p>

            <a
                href="/conceptos/"
                class="inline-block px-8 py-3 bg-white text-black hover:bg-neutral-200 transition-colors rounded-full text-sm font-bold uppercase tracking-widest"
            >
                Volver a Conceptos
            </a>
        </div>
    </div>
</section>

<script>
    const pixelsEl = document.getElementById("stat-pixels");
    const metersEl = document.getElementById("stat-meters");
    const scaleEl = document.getElementById("stat-scale");
    const timeEl = document.getElementById("stat-time");
    const speedEl = document.getElementById("stat-speed");
    const obsessionTitleEl = document.getElementById("stat-obsession-title");
    const obsessionTimeEl = document.getElementById("stat-obsession-time");
    const clicksEl = document.getElementById("stat-clicks");
    const scrollsEl = document.getElementById("stat-scrolls");

    const startTime = Date.now();
    let totalClicks = 0;
    let totalScrollEvents = 0;
    let maxScrollY = 0;

    const sectionTimes = new Map<string, number>();
    let currentSectionId: string | null = null;
    let lastSectionEnterTime = Date.now();

    const PIXEL_TO_METER = 0.0002645833;

    function formatTime(ms: number) {
        const seconds = Math.floor(ms / 1000);
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
    }

    function getScaleLabel(meters: number) {
        if (meters < 0.01) return "Microscópico";
        if (meters < 0.1) return "Insecto";
        if (meters < 0.5) return "Manual";
        if (meters < 1.5) return "Humano";
        if (meters < 3.0) return "Habitación";
        if (meters < 10.0) return "Arquitectónico";
        return "Geográfico";
    }

    const observer = new IntersectionObserver(
        (entries: IntersectionObserverEntry[]) => {
            const now = Date.now();

            if (currentSectionId) {
                const timeSpent = now - lastSectionEnterTime;
                const currentTotal = sectionTimes.get(currentSectionId) || 0;
                sectionTimes.set(currentSectionId, currentTotal + timeSpent);
            }

            let maxRatio = 0;
            let bestEntry: IntersectionObserverEntry | null = null;

            entries.forEach((entry) => {
                if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {
                    maxRatio = entry.intersectionRatio;
                    bestEntry = entry;
                }
            });

            if (bestEntry) {
                const target = (bestEntry as IntersectionObserverEntry).target;
                const title =
                    target.querySelector("h2")?.textContent || target.id || "Introducción";

                currentSectionId = title;
                lastSectionEnterTime = now;
            }
        },
        { threshold: [0.2, 0.5, 0.8] }
    );

    document.querySelectorAll("main > section").forEach((section) => {
        observer.observe(section);
    });

    window.addEventListener("click", () => {
        totalClicks++;
        if (clicksEl) clicksEl.innerText = totalClicks.toString();
    });

    let scrollTimeout: number | null = null;
    window.addEventListener("scroll", () => {
        const scrollY = window.scrollY;
        maxScrollY = Math.max(maxScrollY, scrollY);

        if (!scrollTimeout) {
            totalScrollEvents++;
            if (scrollsEl) scrollsEl.innerText = totalScrollEvents.toString();
            scrollTimeout = window.setTimeout(() => {
                scrollTimeout = null;
            }, 100);
        }

        updateRealtimeStats();
    });

    function updateRealtimeStats() {
        const now = Date.now();
        const elapsedSeconds = (now - startTime) / 1000;

        const scrollY = window.scrollY;
        const meters = scrollY * PIXEL_TO_METER;

        if (pixelsEl) pixelsEl.innerText = Math.floor(scrollY).toLocaleString();
        if (metersEl) metersEl.innerText = meters.toFixed(2);
        if (scaleEl) scaleEl.innerText = getScaleLabel(meters);

        if (timeEl) timeEl.innerText = formatTime(now - startTime);

        const speed = elapsedSeconds > 0 ? Math.floor(scrollY / elapsedSeconds) : 0;
        if (speedEl) speedEl.innerText = speed.toString();

        if (currentSectionId) {
            const timeSpent = now - lastSectionEnterTime;
            const currentTotal = sectionTimes.get(currentSectionId) || 0;

            const tempMap = new Map(sectionTimes);
            tempMap.set(currentSectionId, currentTotal + timeSpent);

            let maxTime = 0;
            let maxTitle = "Analizando...";

            tempMap.forEach((time, title) => {
                if (
                    time > maxTime &&
                    !title.includes("Escala Cósmica") &&
                    !title.includes("Huella")
                ) {
                    maxTime = time;
                    maxTitle = title;
                }
            });

            if (obsessionTitleEl)
                obsessionTitleEl.innerText =
                    maxTitle.length > 30 ? maxTitle.substring(0, 30) + "..." : maxTitle;
            if (obsessionTimeEl) obsessionTimeEl.innerText = (maxTime / 1000).toFixed(1) + "s";
        }
    }

    const section = document.querySelector("section");
    const header = document.querySelector(".text-center.mb-16");
    let currentLevelData = null;

    const modalHTML = `
        <div id="registry-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="modal-backdrop"></div>
            <div id="modal-content" class="relative bg-neutral-900 w-full max-w-lg mx-4 rounded-3xl p-8 border border-neutral-800 shadow-2xl transform scale-95 transition-all duration-300 max-h-[80vh] overflow-y-auto custom-scrollbar">
                <button id="modal-close" class="absolute top-4 right-4 text-neutral-500 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <h3 class="text-2xl font-bold text-white mb-2 font-mono uppercase tracking-widest">Registro de Permanencia</h3>
                <p class="text-neutral-400 text-sm mb-6">Tu evolución en el sistema según tu frecuencia de interacción.</p>

                <div class="space-y-3" id="levels-list">

                </div>
                
                <div class="mt-8 text-center pt-6 border-t border-neutral-800">
                    <p class="text-xs text-neutral-500 font-mono">ID ÚNICO: <span id="modal-user-id" class="text-white">...</span></p>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML("beforeend", modalHTML);

    const levels = [
        {
            count: 10000,
            name: "SINGULARIDAD",
            color: "border-white",
            text: "text-white",
            glow: "rgba(255, 255, 255, 0.5)",
        },
        {
            count: 5000,
            name: "VIGILANTE",
            color: "border-fuchsia-500",
            text: "text-fuchsia-500",
            glow: "rgba(217, 70, 239, 0.4)",
        },
        {
            count: 1000,
            name: "DIVINIDAD DIGITAL",
            color: "border-emerald-400",
            text: "text-emerald-400",
            glow: "rgba(52, 211, 153, 0.3)",
        },
        {
            count: 500,
            name: "ARQUITECTO",
            color: "border-rose-500",
            text: "text-rose-500",
            glow: "rgba(244, 63, 94, 0.3)",
        },
        {
            count: 100,
            name: "HABITANTE",
            color: "border-amber-400",
            text: "text-amber-400",
            glow: "rgba(251, 191, 36, 0.3)",
        },
        {
            count: 50,
            name: "VIAJERO FRECUENTE",
            color: "border-purple-500",
            text: "text-purple-500",
            glow: "rgba(168, 85, 247, 0.3)",
        },
        {
            count: 10,
            name: "EXPLORADOR",
            color: "border-cyan-500",
            text: "text-cyan-500",
            glow: "rgba(6, 182, 212, 0.3)",
        },
        {
            count: 0,
            name: "OBSERVADOR",
            color: "border-neutral-700",
            text: "text-neutral-400",
            glow: "transparent",
        },
    ];

    function updateFootprintVisuals() {
        const STORAGE_KEY = "jjlmoya_footprint_v5";
        let visits = 0;
        let userId = "Desconocido";
        try {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
            visits = data.visits || 0;
            userId = data.id || "Desconocido";
        } catch (e) {}

        const currentLevel = levels.find((l) => visits >= l.count) || levels[levels.length - 1];
        currentLevelData = currentLevel;

        const cards = document.querySelectorAll(".bg-neutral-900\\/50");
        cards.forEach((card) => {
            if (currentLevel.count > 0) {
                card.classList.remove("border-neutral-800");
                card.classList.add(currentLevel.color);
                (card as HTMLElement).style.boxShadow = `0 0 30px ${currentLevel.glow}`;
            }
        });

        if (header && !document.getElementById("level-badge")) {
            const container = document.createElement("div");
            container.className = "flex flex-col items-center gap-4 mt-6";

            const badge = document.createElement("div");
            badge.id = "level-badge";
            badge.className = `inline-block px-4 py-1 rounded-full border ${currentLevel.color} text-xs font-mono font-bold uppercase tracking-widest bg-black/50 backdrop-blur-md`;
            badge.style.color = currentLevel.text.replace("text-", "var(--tw-text-opacity) ");
            badge.style.color = currentLevel.glow
                .replace("0.3)", "1)")
                .replace("0.4)", "1)")
                .replace("0.5)", "1)");
            badge.style.boxShadow = `0 0 15px ${currentLevel.glow}`;
            badge.innerText = `Nivel: ${currentLevel.name} (${visits} visitas)`;

            const btn = document.createElement("button");
            btn.innerText = "Ver Registro de Permanencia";
            btn.className =
                "text-xs text-neutral-400 hover:text-white underline underline-offset-4 decoration-neutral-700 hover:decoration-white transition-all";
            btn.onclick = openModal;

            container.appendChild(badge);
            container.appendChild(btn);
            header.appendChild(container);
        }

        const modalId = document.getElementById("modal-user-id");
        if (modalId) modalId.innerText = userId;

        const list = document.getElementById("levels-list");
        if (list) {
            list.innerHTML = levels
                .map((l) => {
                    const isReached = visits >= l.count;
                    const isCurrent = currentLevel.name === l.name;
                    const opacity = isReached ? "opacity-100" : "opacity-30 grayscale";
                    const border = isCurrent ? `border-2 ${l.color}` : "border border-neutral-800";
                    const bg = isCurrent ? "bg-white/5" : "bg-transparent";

                    return `
                    <div class="flex items-center justify-between p-3 rounded-xl ${border} ${bg} ${opacity} transition-all">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full shadow-[0_0_10px_currentColor] ${l.text.replace("text-", "bg-")}"></div>
                            <span class="font-mono text-sm font-bold ${l.text}">${l.name}</span>
                        </div>
                        <span class="text-xs text-neutral-500 font-mono">${l.count}+</span>
                    </div>
                `;
                })
                .join("");
        }

        const modalContent = document.getElementById("modal-content");
        if (modalContent && currentLevel.count > 0) {
            modalContent.className = `relative bg-neutral-900 w-full max-w-lg mx-4 rounded-3xl p-8 border shadow-2xl transform scale-95 transition-all duration-300 max-h-[80vh] overflow-y-auto custom-scrollbar ${currentLevel.color}`;
            modalContent.style.boxShadow = `0 0 40px ${currentLevel.glow}`;
        }
    }

    const modal = document.getElementById("registry-modal");
    const modalContent = document.getElementById("modal-content");
    const backdrop = document.getElementById("modal-backdrop");
    const closeBtn = document.getElementById("modal-close");

    function openModal() {
        if (!modal) return;
        modal.classList.remove("opacity-0", "pointer-events-none");
        modalContent?.classList.remove("scale-95");
        modalContent?.classList.add("scale-100");
        document.body.style.overflow = "hidden";

        updateFootprintVisuals();
    }

    function closeModal() {
        if (!modal) return;
        modal.classList.add("opacity-0", "pointer-events-none");
        modalContent?.classList.remove("scale-100");
        modalContent?.classList.add("scale-95");
        document.body.style.overflow = "";
    }

    backdrop?.addEventListener("click", closeModal);
    closeBtn?.addEventListener("click", closeModal);
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
    });

    setTimeout(updateFootprintVisuals, 100);
</script>
