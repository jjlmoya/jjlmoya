---
// This will be a client-side interactive component
// We'll implement the logic in the script tag
---

<div class="grid lg:grid-cols-2 gap-8 lg:gap-12 max-w-6xl mx-auto">
    <!-- Left Column: Inputs -->
    <div class="space-y-8">
        <!-- Original Mold Section -->
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-800 relative overflow-hidden group"
        >
            <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div>
            <h2
                class="text-lg font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2"
            >
                <span
                    class="w-6 h-6 rounded-full bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 flex items-center justify-center text-xs"
                    >1</span
                >
                Receta Original
            </h2>

            <div class="space-y-6">
                <!-- Shape Selector -->
                <div class="grid grid-cols-3 gap-3">
                    <button
                        class="shape-btn flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-200 bg-slate-900 dark:bg-white text-white dark:text-slate-900 border-transparent shadow-md transform scale-105 active"
                        data-target="original"
                        data-shape="round"
                    >
                        <div class="w-8 h-8 rounded-full border-2 border-current mb-1"></div>
                        <span class="text-xs font-medium">Redondo</span>
                    </button>
                    <button
                        class="shape-btn flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-200 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:border-slate-300 dark:hover:border-slate-600"
                        data-target="original"
                        data-shape="square"
                    >
                        <div class="w-8 h-8 border-2 border-current mb-1"></div>
                        <span class="text-xs font-medium">Cuadrado</span>
                    </button>
                    <button
                        class="shape-btn flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-200 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:border-slate-300 dark:hover:border-slate-600"
                        data-target="original"
                        data-shape="rectangular"
                    >
                        <div class="w-10 h-6 border-2 border-current mb-1"></div>
                        <span class="text-xs font-medium">Rectangular</span>
                    </button>
                </div>

                <!-- Dimensions -->
                <div id="original-inputs" class="space-y-4">
                    <!-- Dynamic inputs injected by JS -->
                </div>
            </div>
        </div>

        <!-- Target Mold Section -->
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-800 relative overflow-hidden group"
        >
            <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
            <h2
                class="text-lg font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2"
            >
                <span
                    class="w-6 h-6 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center text-xs"
                    >2</span
                >
                Tu Molde
            </h2>

            <div class="space-y-6">
                <!-- Shape Selector -->
                <div class="grid grid-cols-3 gap-3">
                    <button
                        class="shape-btn flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-200 bg-slate-900 dark:bg-white text-white dark:text-slate-900 border-transparent shadow-md transform scale-105 active"
                        data-target="target"
                        data-shape="round"
                    >
                        <div class="w-8 h-8 rounded-full border-2 border-current mb-1"></div>
                        <span class="text-xs font-medium">Redondo</span>
                    </button>
                    <button
                        class="shape-btn flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-200 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:border-slate-300 dark:hover:border-slate-600"
                        data-target="target"
                        data-shape="square"
                    >
                        <div class="w-8 h-8 border-2 border-current mb-1"></div>
                        <span class="text-xs font-medium">Cuadrado</span>
                    </button>
                    <button
                        class="shape-btn flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-200 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:border-slate-300 dark:hover:border-slate-600"
                        data-target="target"
                        data-shape="rectangular"
                    >
                        <div class="w-10 h-6 border-2 border-current mb-1"></div>
                        <span class="text-xs font-medium">Rectangular</span>
                    </button>
                </div>

                <!-- Dimensions -->
                <div id="target-inputs" class="space-y-4">
                    <!-- Dynamic inputs injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Visualization & Result -->
    <div class="lg:sticky lg:top-8 space-y-6 h-fit">
        <!-- Result Card -->
        <div
            class="bg-gradient-to-br from-slate-900 to-slate-800 text-white rounded-3xl p-8 shadow-xl relative overflow-hidden"
        >
            <div
                class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"
            >
            </div>

            <div class="relative z-10 text-center">
                <p class="text-slate-300 text-sm font-medium uppercase tracking-wider mb-2">
                    Factor Multiplicador
                </p>
                <div class="flex items-baseline justify-center gap-1 mb-4">
                    <span class="text-6xl font-bold font-display tracking-tight" id="result-factor"
                        >x1.00</span
                    >
                </div>
                <p class="text-slate-300 text-lg" id="result-text">Usa las mismas cantidades.</p>
            </div>
        </div>

        <!-- Visual Comparison -->
        <div
            class="bg-slate-100 dark:bg-slate-950/50 rounded-2xl p-8 border border-slate-200 dark:border-slate-800 flex items-center justify-center min-h-[300px] relative overflow-hidden"
        >
            <div class="absolute inset-0 grid-bg opacity-10 pointer-events-none"></div>

            <!-- SVG Container -->
            <svg
                id="visualizer"
                width="100%"
                height="300"
                viewBox="0 0 400 300"
                class="w-full h-full"
            >
                <g id="viz-container" transform="translate(200, 150)">
                    <!-- Shapes will be drawn here -->
                    <path
                        id="shape-original"
                        d=""
                        fill="rgba(244, 63, 94, 0.2)"
                        stroke="#f43f5e"
                        stroke-width="2"
                        stroke-dasharray="4 4"></path>
                    <path
                        id="shape-target"
                        d=""
                        fill="rgba(16, 185, 129, 0.2)"
                        stroke="#10b981"
                        stroke-width="2"></path>
                </g>
            </svg>

            <!-- Legend -->
            <div class="absolute bottom-4 left-4 flex gap-4 text-xs font-medium">
                <div class="flex items-center gap-2 text-rose-600 dark:text-rose-400">
                    <div class="w-3 h-3 border border-current bg-rose-500/20 rounded-sm"></div>
                    Original
                </div>
                <div class="flex items-center gap-2 text-emerald-600 dark:text-emerald-400">
                    <div class="w-3 h-3 border border-current bg-emerald-500/20 rounded-sm"></div>
                    Tuyo
                </div>
            </div>
        </div>

        <!-- Mini Calculator -->
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-800"
        >
            <h3
                class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-4 flex items-center gap-2"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-4 h-4"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path d="M3 3v18h18"></path><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"
                    ></path></svg
                >
                Calculadora de Ingredientes
            </h3>

            <div id="ingredients-list" class="space-y-3">
                <!-- Ingredients injected by JS -->
            </div>

            <div
                class="flex justify-center mt-4 pt-4 border-t border-slate-100 dark:border-slate-800"
            >
                <button
                    id="add-ingredient-btn"
                    class="flex items-center gap-2 text-sm font-medium text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300 transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-4 h-4"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><line x1="12" y1="5" x2="12" y2="19"></line><line
                            x1="5"
                            y1="12"
                            x2="19"
                            y2="12"></line></svg
                    >
                    Añadir Ingrediente
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .grid-bg {
        background-image: radial-gradient(currentColor 1px, transparent 1px);
        background-size: 20px 20px;
    }
</style>

<script>
    // Logic
    type Shape = "round" | "square" | "rectangular";

    interface MoldState {
        shape: Shape;
        dim1: number; // diameter or width
        dim2: number; // length (for rect)
    }

    interface Ingredient {
        id: string;
        label: string;
        value: number;
    }

    const state = {
        original: { shape: "round", dim1: 20, dim2: 20 } as MoldState,
        target: { shape: "round", dim1: 20, dim2: 20 } as MoldState,
    };

    let ingredients: Ingredient[] = [
        { id: "1", label: "Harina", value: 0 },
        { id: "2", label: "Azúcar", value: 0 },
    ];

    // DOM Elements
    const els = {
        originalInputs: document.getElementById("original-inputs"),
        targetInputs: document.getElementById("target-inputs"),
        resultFactor: document.getElementById("result-factor"),
        resultText: document.getElementById("result-text"),
        shapeOriginal: document.getElementById("shape-original"),
        shapeTarget: document.getElementById("shape-target"),
        ingredientsList: document.getElementById("ingredients-list"),
        addIngredientBtn: document.getElementById("add-ingredient-btn"),
    };

    // Common classes
    const labelClass =
        "block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1.5 uppercase tracking-wide";
    const inputClass =
        "w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white font-medium focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none transition-all";

    // Templates for inputs
    const getInputsHTML = (type: "original" | "target", shape: Shape, values: MoldState) => {
        if (shape === "round") {
            return `
                <div class="input-group">
                    <label class="${labelClass}">Diámetro (cm)</label>
                    <input type="number" value="${values.dim1}" min="1" step="0.5" data-type="${type}" data-key="dim1" class="${inputClass}">
                </div>
            `;
        } else if (shape === "square") {
            return `
                <div class="input-group">
                    <label class="${labelClass}">Lado (cm)</label>
                    <input type="number" value="${values.dim1}" min="1" step="0.5" data-type="${type}" data-key="dim1" class="${inputClass}">
                </div>
            `;
        } else {
            return `
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="${labelClass}">Ancho (cm)</label>
                        <input type="number" value="${values.dim1}" min="1" step="0.5" data-type="${type}" data-key="dim1" class="${inputClass}">
                    </div>
                    <div class="input-group">
                        <label class="${labelClass}">Largo (cm)</label>
                        <input type="number" value="${values.dim2}" min="1" step="0.5" data-type="${type}" data-key="dim2" class="${inputClass}">
                    </div>
                </div>
            `;
        }
    };

    // Calculate Area
    const getArea = (s: MoldState) => {
        if (s.shape === "round") {
            return Math.PI * Math.pow(s.dim1 / 2, 2);
        } else if (s.shape === "square") {
            return s.dim1 * s.dim1;
        } else {
            return s.dim1 * s.dim2;
        }
    };

    // Generate SVG Path
    const getPath = (s: MoldState, scale = 5) => {
        // Center is 0,0
        if (s.shape === "round") {
            const r = (s.dim1 / 2) * scale;
            // Draw circle using arc commands
            return `M 0,${-r} A ${r},${r} 0 1,1 0,${r} A ${r},${r} 0 1,1 0,${-r}`;
        } else {
            const w = s.dim1 * scale;
            const h = (s.shape === "square" ? s.dim1 : s.dim2) * scale;
            const x = -w / 2;
            const y = -h / 2;
            return `M ${x},${y} h ${w} v ${h} h ${-w} Z`;
        }
    };

    // Render Ingredients List
    const renderIngredients = () => {
        if (!els.ingredientsList) return;

        els.ingredientsList.innerHTML = ingredients
            .map(
                (ing) => `
            <div class="grid grid-cols-12 gap-3 items-end group ingredient-row" data-id="${ing.id}">
                <div class="col-span-5">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Ingrediente</label>
                    <input type="text" value="${ing.label}" class="ing-label w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm focus:ring-2 focus:ring-cyan-500 outline-none transition-colors" placeholder="Nombre">
                </div>
                <div class="col-span-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Original</label>
                    <input type="number" value="${ing.value || ""}" class="ing-value w-full px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm font-medium focus:ring-2 focus:ring-cyan-500 outline-none transition-colors" placeholder="0">
                </div>
                <div class="col-span-3">
                    <label class="block text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider mb-1">Final</label>
                    <input type="text" readonly class="ing-result w-full px-3 py-2 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-300 text-sm font-bold outline-none" value="-">
                </div>
                <div class="col-span-1 flex justify-center pb-2">
                    <button class="delete-ing p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors" title="Eliminar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>
        `
            )
            .join("");

        // Re-attach listeners
        els.ingredientsList.querySelectorAll(".ing-label").forEach((el) => {
            el.addEventListener("input", (e) => {
                const id = (e.target as HTMLElement)
                    .closest(".ingredient-row")
                    ?.getAttribute("data-id");
                const ing = ingredients.find((i) => i.id === id);
                if (ing) ing.label = (e.target as HTMLInputElement).value;
            });
        });

        els.ingredientsList.querySelectorAll(".ing-value").forEach((el) => {
            el.addEventListener("input", (e) => {
                const id = (e.target as HTMLElement)
                    .closest(".ingredient-row")
                    ?.getAttribute("data-id");
                const ing = ingredients.find((i) => i.id === id);
                if (ing) {
                    ing.value = parseFloat((e.target as HTMLInputElement).value) || 0;
                    update(); // Recalculate
                }
            });
        });

        els.ingredientsList.querySelectorAll(".delete-ing").forEach((el) => {
            el.addEventListener("click", (e) => {
                const id = (e.target as HTMLElement)
                    .closest(".ingredient-row")
                    ?.getAttribute("data-id");
                ingredients = ingredients.filter((i) => i.id !== id);
                renderIngredients();
                update();
            });
        });
    };

    // Update Calculator
    const updateCalculator = (factor: number) => {
        if (!els.ingredientsList) return;

        els.ingredientsList.querySelectorAll(".ingredient-row").forEach((row) => {
            const id = row.getAttribute("data-id");
            const ing = ingredients.find((i) => i.id === id);
            const resultInput = row.querySelector(".ing-result") as HTMLInputElement;

            if (ing && ing.value) {
                const result = ing.value * factor;
                // Format nicely: if integer, no decimals. If float, up to 1 decimal.
                resultInput.value = Number.isInteger(result)
                    ? result.toString()
                    : result.toFixed(1);
            } else {
                resultInput.value = "-";
            }
        });
    };

    // Update UI
    const update = () => {
        const areaOriginal = getArea(state.original);
        const areaTarget = getArea(state.target);

        let factor = areaTarget / areaOriginal;

        // Round to 2 decimals
        factor = Math.round(factor * 100) / 100;

        if (els.resultFactor) els.resultFactor.textContent = `x${factor.toFixed(2)}`;

        if (els.resultText) {
            if (factor === 1) {
                els.resultText.textContent =
                    "Los moldes son equivalentes. Usa las mismas cantidades.";
            } else if (factor < 1) {
                els.resultText.innerHTML = `Tu molde es más pequeño. <br><span class="text-rose-400 font-bold">Reduce</span> los ingredientes multiplicándolos por <span class="font-bold text-white">${factor}</span>.`;
            } else {
                els.resultText.innerHTML = `Tu molde es más grande. <br><span class="text-emerald-400 font-bold">Aumenta</span> los ingredientes multiplicándolos por <span class="font-bold text-white">${factor}</span>.`;
            }
        }

        // Update Visuals
        // We need a scale factor that fits the largest shape in the viewbox (400x300)
        // Max dimension in cm we want to support visually well is ~40cm?
        // 300px / 40cm = 7.5 px/cm
        const scale = 6;

        if (els.shapeOriginal) els.shapeOriginal.setAttribute("d", getPath(state.original, scale));
        if (els.shapeTarget) els.shapeTarget.setAttribute("d", getPath(state.target, scale));

        // Update Calculator
        updateCalculator(factor);
    };

    const renderInputs = (target: "original" | "target") => {
        const container = target === "original" ? els.originalInputs : els.targetInputs;
        if (container) {
            container.innerHTML = getInputsHTML(target, state[target].shape, state[target]);
        }
    };

    // Event Listeners
    const setupListeners = () => {
        // Shape Buttons
        document.querySelectorAll(".shape-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const target = (e.currentTarget as HTMLElement).dataset.target as
                    | "original"
                    | "target";
                const shape = (e.currentTarget as HTMLElement).dataset.shape as Shape;

                // Update State
                state[target].shape = shape;
                // Reset dims slightly for better UX when switching
                if (shape === "rectangular" && state[target].dim2 === state[target].dim1) {
                    state[target].dim2 = state[target].dim1 + 5;
                }

                // Update UI classes
                document.querySelectorAll(`.shape-btn[data-target="${target}"]`).forEach((b) => {
                    // Reset to inactive state
                    b.classList.remove(
                        "bg-slate-900",
                        "dark:bg-white",
                        "text-white",
                        "dark:text-slate-900",
                        "border-transparent",
                        "shadow-md",
                        "transform",
                        "scale-105",
                        "active"
                    );
                    b.classList.add(
                        "border-slate-200",
                        "dark:border-slate-700",
                        "text-slate-500",
                        "dark:text-slate-400",
                        "hover:bg-slate-50",
                        "dark:hover:bg-slate-800",
                        "hover:border-slate-300",
                        "dark:hover:border-slate-600"
                    );
                });

                // Set active state
                const activeBtn = e.currentTarget as HTMLElement;
                activeBtn.classList.remove(
                    "border-slate-200",
                    "dark:border-slate-700",
                    "text-slate-500",
                    "dark:text-slate-400",
                    "hover:bg-slate-50",
                    "dark:hover:bg-slate-800",
                    "hover:border-slate-300",
                    "dark:hover:border-slate-600"
                );
                activeBtn.classList.add(
                    "bg-slate-900",
                    "dark:bg-white",
                    "text-white",
                    "dark:text-slate-900",
                    "border-transparent",
                    "shadow-md",
                    "transform",
                    "scale-105",
                    "active"
                );

                // Re-render inputs
                renderInputs(target);
                update();
            });
        });

        // Inputs (Delegated)
        const handleInput = (e: Event) => {
            const input = e.target as HTMLInputElement;
            const type = input.dataset.type as "original" | "target";
            const key = input.dataset.key as "dim1" | "dim2";

            if (type && key) {
                state[type][key] = parseFloat(input.value) || 0;
                update();
            }
        };

        els.originalInputs?.addEventListener("input", handleInput);
        els.targetInputs?.addEventListener("input", handleInput);

        // Add Ingredient Button
        els.addIngredientBtn?.addEventListener("click", () => {
            ingredients.push({
                id: Date.now().toString(),
                label: "",
                value: 0,
            });
            renderIngredients();
            update();
        });
    };

    // Init
    renderInputs("original");
    renderInputs("target");
    renderIngredients();
    setupListeners();
    update();
</script>
