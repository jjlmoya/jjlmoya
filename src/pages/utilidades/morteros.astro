---
import Layout from "../../layouts/Layout.astro";
import { Icon } from "astro-icon/components";
---

<Layout
    title="La Calculadora Vitruvio"
    description="Herramienta interactiva de cálculo inverso basada en los tratados de Vitrubio. Descubre cuánto muro puedes restaurar con tus materiales."
>
    <div class="vitruvian-container">
        <!-- Background -->
        <div class="vitruvian-bg"></div>

        <!-- Header -->
        <div class="vitruvian-header">
            <a href="/utilidades" class="back-link">
                <Icon name="mdi:arrow-left" class="w-4 h-4" />
                volver a utilidades
            </a>
            <h1 class="vitruvian-title">La Calculadora Vitruvio</h1>
            <p class="vitruvian-subtitle">
                El arte de la proporción según el Libro VII. Descubre cuánto muro puedes restaurar
                con los materiales que tienes.
            </p>
        </div>

        <!-- Main Three-Panel Layout -->
        <div class="vitruvian-canvas">
            <!-- LEFT PANEL: Roman Column Selector -->
            <div class="panel panel-left">
                <h2 class="panel-title">Sistema Vitrubio</h2>
                <svg class="column-svg" viewBox="0 0 200 480" xmlns="http://www.w3.org/2000/svg">
                    <!-- Brick wall background -->
                    <defs>
                        <pattern
                            id="brick-pattern"
                            x="0"
                            y="0"
                            width="40"
                            height="20"
                            patternUnits="userSpaceOnUse"
                        >
                            <rect width="40" height="20" fill="#8b7355"></rect>
                            <rect
                                x="0"
                                y="0"
                                width="19"
                                height="9"
                                fill="#a0826d"
                                stroke="#6b5d4f"
                                stroke-width="0.5"></rect>
                            <rect
                                x="20"
                                y="0"
                                width="19"
                                height="9"
                                fill="#a0826d"
                                stroke="#6b5d4f"
                                stroke-width="0.5"></rect>
                            <rect
                                x="10"
                                y="10"
                                width="19"
                                height="9"
                                fill="#a0826d"
                                stroke="#6b5d4f"
                                stroke-width="0.5"></rect>
                        </pattern>
                    </defs>

                    <!-- Base brick wall -->
                    <rect
                        x="10"
                        y="50"
                        width="180"
                        height="400"
                        fill="url(#brick-pattern)"
                        stroke="#333"
                        stroke-width="2"></rect>

                    <!-- Layer 3: Marmorato (Enlucido) - Top thin layer -->
                    <g id="capital" class="column-section" data-phase="marmorato">
                        <!-- Smooth finish layer - 4mm -->
                        <rect
                            x="10"
                            y="50"
                            width="180"
                            height="25"
                            fill="#f8f8f8"
                            stroke="#333"
                            stroke-width="2"></rect>
                        <!-- Very smooth texture with subtle shine -->
                        <line
                            x1="15"
                            y1="55"
                            x2="185"
                            y2="55"
                            stroke="#fff"
                            stroke-width="0.5"
                            opacity="0.6"></line>
                        <line
                            x1="15"
                            y1="60"
                            x2="185"
                            y2="60"
                            stroke="#fff"
                            stroke-width="0.3"
                            opacity="0.4"></line>
                        <line
                            x1="15"
                            y1="65"
                            x2="185"
                            y2="65"
                            stroke="#fff"
                            stroke-width="0.3"
                            opacity="0.4"></line>
                        <line
                            x1="15"
                            y1="70"
                            x2="185"
                            y2="70"
                            stroke="#fff"
                            stroke-width="0.3"
                            opacity="0.4"></line>

                        <!-- Label -->
                        <text x="100" y="63" class="column-label" font-size="10">Marmorato</text>
                        <text x="100" y="72" class="column-sublabel" font-size="7"
                            >Enlucido 1:1 (4mm)</text
                        >
                    </g>

                    <!-- Layer 2: Arenato (Revoco) - Middle layer -->
                    <g id="shaft" class="column-section" data-phase="arenato">
                        <!-- Medium layer - 16mm -->
                        <rect
                            x="10"
                            y="75"
                            width="180"
                            height="100"
                            fill="#e6d5c0"
                            stroke="#333"
                            stroke-width="2"></rect>
                        <!-- Medium texture -->
                        <line
                            x1="15"
                            y1="85"
                            x2="185"
                            y2="85"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="95"
                            x2="185"
                            y2="95"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="105"
                            x2="185"
                            y2="105"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="115"
                            x2="185"
                            y2="115"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="125"
                            x2="185"
                            y2="125"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="135"
                            x2="185"
                            y2="135"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="145"
                            x2="185"
                            y2="145"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="155"
                            x2="185"
                            y2="155"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="165"
                            x2="185"
                            y2="165"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>

                        <!-- Small aggregate particles -->
                        <circle cx="30" cy="90" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="60" cy="100" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="90" cy="95" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="120" cy="110" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="150" cy="105" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="170" cy="120" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="40" cy="130" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="70" cy="140" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="100" cy="135" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="130" cy="150" r="1.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="160" cy="145" r="1.5" fill="#333" opacity="0.2"></circle>

                        <!-- Label -->
                        <text x="100" y="120" class="column-label" font-size="11">Arenato</text>
                        <text x="100" y="132" class="column-sublabel" font-size="8"
                            >Revoco 1:2 (16mm)</text
                        >
                    </g>

                    <!-- Layer 1: Trullissatio (Enfoscado) - Base thick layer -->
                    <g id="base" class="column-section active" data-phase="trullissatio">
                        <!-- Thick rough base layer - 30mm -->
                        <rect
                            x="10"
                            y="175"
                            width="180"
                            height="200"
                            fill="#d4c5b0"
                            stroke="#333"
                            stroke-width="2"></rect>
                        <!-- Rough texture with larger aggregate -->
                        <line
                            x1="15"
                            y1="185"
                            x2="185"
                            y2="185"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="200"
                            x2="185"
                            y2="200"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="215"
                            x2="185"
                            y2="215"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="230"
                            x2="185"
                            y2="230"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="245"
                            x2="185"
                            y2="245"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="260"
                            x2="185"
                            y2="260"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="275"
                            x2="185"
                            y2="275"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="290"
                            x2="185"
                            y2="290"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="305"
                            x2="185"
                            y2="305"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="320"
                            x2="185"
                            y2="320"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="335"
                            x2="185"
                            y2="335"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="350"
                            x2="185"
                            y2="350"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>
                        <line
                            x1="15"
                            y1="365"
                            x2="185"
                            y2="365"
                            stroke="#333"
                            stroke-width="0.5"
                            opacity="0.3"></line>

                        <!-- Large aggregate particles for rough texture -->
                        <circle cx="30" cy="190" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="60" cy="205" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="90" cy="195" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="120" cy="210" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="150" cy="200" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="170" cy="220" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="40" cy="235" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="70" cy="250" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="100" cy="240" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="130" cy="265" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="160" cy="255" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="50" cy="280" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="80" cy="295" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="110" cy="285" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="140" cy="310" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="35" cy="325" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="65" cy="340" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="95" cy="330" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="125" cy="355" r="2.5" fill="#333" opacity="0.2"></circle>
                        <circle cx="155" cy="345" r="2.5" fill="#333" opacity="0.2"></circle>

                        <!-- Label -->
                        <text x="100" y="270" class="column-label" font-size="12">Trullissatio</text
                        >
                        <text x="100" y="285" class="column-sublabel" font-size="9"
                            >Enfoscado 1:3 (30mm)</text
                        >
                    </g>

                    <!-- Ground/Foundation -->
                    <rect
                        x="5"
                        y="375"
                        width="190"
                        height="75"
                        fill="#78716c"
                        stroke="#333"
                        stroke-width="2"></rect>
                    <line
                        x1="5"
                        y1="390"
                        x2="195"
                        y2="390"
                        stroke="#333"
                        stroke-width="0.5"
                        opacity="0.3"></line>
                    <line
                        x1="5"
                        y1="405"
                        x2="195"
                        y2="405"
                        stroke="#333"
                        stroke-width="0.5"
                        opacity="0.3"></line>
                    <line
                        x1="5"
                        y1="420"
                        x2="195"
                        y2="420"
                        stroke="#333"
                        stroke-width="0.5"
                        opacity="0.3"></line>
                    <line
                        x1="5"
                        y1="435"
                        x2="195"
                        y2="435"
                        stroke="#333"
                        stroke-width="0.5"
                        opacity="0.3"></line>
                </svg>

                <div class="phase-info">
                    <h3 id="phase-name">Trullissatio</h3>
                    <p id="phase-desc">
                        Capa base rugosa. 2 manos de 15mm. Proporción 1:3 (Cal:Arena de río).
                    </p>
                </div>
            </div>

            <!-- CENTER PANEL: Material Bodegón -->
            <div class="panel panel-center">
                <h2 class="panel-title">Materiales Disponibles</h2>

                <!-- Material Type Selector -->
                <div class="material-selector">
                    <button class="material-btn active" data-material="cal">
                        <Icon name="mdi:bucket" class="w-5 h-5" />
                        Cal
                    </button>
                    <button class="material-btn" data-material="arena">
                        <Icon name="mdi:grain" class="w-5 h-5" />
                        Arena
                    </button>
                </div>

                <!-- Cal Type Toggle -->
                <div class="cal-type-toggle" id="cal-type-container">
                    <label class="toggle-label">
                        <input type="checkbox" id="cal-type-switch" />
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">
                            <span class="type-pasta">Pasta (1.30 kg/L)</span>
                            <span class="type-polvo">Polvo NHL (0.65 kg/L)</span>
                        </span>
                    </label>
                </div>

                <!-- Material Illustration -->
                <svg id="material-bodegon" viewBox="0 0 300 200" class="bodegon-svg">
                    <!-- Sacks of lime/sand -->
                    <g id="sack-pile">
                        <!-- Will be populated dynamically -->
                    </g>
                </svg>

                <!-- Slider Control -->
                <div class="slider-container">
                    <div class="ruler-slider">
                        <input
                            type="range"
                            id="material-slider"
                            min="5"
                            max="500"
                            value="150"
                            step="5"
                        />
                        <div class="ruler-marks">
                            <span>5</span>
                            <span>100</span>
                            <span>200</span>
                            <span>300</span>
                            <span>400</span>
                            <span>500</span>
                        </div>
                    </div>
                    <div class="quantity-display">
                        <span class="quantity-label">Cantidad disponible:</span>
                        <span id="quantity-value" class="quantity-value">150</span>
                        <span class="quantity-unit">kg</span>
                    </div>
                </div>

                <!-- Complementary Material Display -->
                <div class="complementary-material">
                    <div class="complementary-header">
                        <Icon name="mdi:arrow-right-bold" class="w-4 h-4" />
                        <span>Necesitarás también:</span>
                    </div>
                    <div class="complementary-content">
                        <div class="complementary-item">
                            <span id="complementary-label" class="comp-label">Arena</span>
                            <span id="complementary-value" class="comp-value">450</span>
                            <span class="comp-unit">kg</span>
                        </div>
                        <div class="ratio-reminder">
                            <span class="ratio-text">Proporción: </span>
                            <span id="ratio-display" class="ratio-value">3:1</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: The Living Wall -->
            <div class="panel panel-right">
                <h2 class="panel-title">Cobertura Estimada</h2>

                <svg id="living-wall" viewBox="0 0 300 400" class="wall-svg">
                    <!-- Masonry pattern -->
                    <defs>
                        <pattern
                            id="brick-pattern"
                            x="0"
                            y="0"
                            width="60"
                            height="30"
                            patternUnits="userSpaceOnUse"
                        >
                            <rect
                                x="0"
                                y="0"
                                width="60"
                                height="30"
                                fill="none"
                                stroke="#78716c"
                                stroke-width="1"></rect>
                            <line x1="30" y1="0" x2="30" y2="30" stroke="#78716c" stroke-width="1"
                            ></line>
                        </pattern>

                        <!-- Textures for different phases -->
                        <pattern
                            id="texture-rough"
                            x="0"
                            y="0"
                            width="10"
                            height="10"
                            patternUnits="userSpaceOnUse"
                        >
                            <circle cx="2" cy="2" r="1" fill="#000" opacity="0.1"></circle>
                            <circle cx="7" cy="7" r="1" fill="#000" opacity="0.1"></circle>
                        </pattern>

                        <pattern
                            id="texture-medium"
                            x="0"
                            y="0"
                            width="6"
                            height="6"
                            patternUnits="userSpaceOnUse"
                        >
                            <circle cx="2" cy="2" r="0.5" fill="#000" opacity="0.08"></circle>
                            <circle cx="5" cy="5" r="0.5" fill="#000" opacity="0.08"></circle>
                        </pattern>

                        <pattern
                            id="texture-smooth"
                            x="0"
                            y="0"
                            width="4"
                            height="4"
                            patternUnits="userSpaceOnUse"
                        >
                            <circle cx="2" cy="2" r="0.3" fill="#000" opacity="0.05"></circle>
                        </pattern>
                    </defs>

                    <!-- Base wall -->
                    <rect
                        x="0"
                        y="0"
                        width="300"
                        height="400"
                        fill="url(#brick-pattern)"
                        opacity="0.3"></rect>

                    <!-- Mortar coverage (animated) -->
                    <rect
                        id="mortar-coverage"
                        x="150"
                        y="200"
                        width="0"
                        height="0"
                        fill="#d4c5b0"
                        opacity="0.9"
                        style="transform-origin: center;"></rect>

                    <!-- Texture overlay -->
                    <rect
                        id="mortar-texture"
                        x="150"
                        y="200"
                        width="0"
                        height="0"
                        fill="url(#texture-rough)"
                        style="transform-origin: center;"></rect>
                </svg>

                <!-- Coverage Display -->
                <div class="coverage-display">
                    <div class="coverage-label">Cobertura:</div>
                    <span id="coverage-value" class="coverage-value">12.5</span>
                    <span class="coverage-unit">m²</span>
                </div>

                <!-- Technical Details -->
                <div class="technical-details">
                    <div class="detail-row">
                        <span class="detail-label">Espesor total:</span>
                        <span id="thickness-value" class="detail-value">30 mm</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Capas:</span>
                        <span id="layers-value" class="detail-value">2 manos</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Factor de merma:</span>
                        <span class="detail-value">20%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRANULOMETRY INFORMATION SECTION -->
        <div class="granulometry-section">
            <h2 class="section-title">Granulometría del Árido</h2>
            <div class="granulometry-cards">
                <!-- Card 1: Coarse Sand (Trullissatio) -->
                <div class="grain-card" data-grain-type="trullissatio">
                    <div class="grain-header">
                        <h3 class="grain-title">Arena Gruesa (Cero)</h3>
                        <span class="grain-subtitle">Arena de Río</span>
                    </div>
                    <div class="grain-visual">
                        <svg viewBox="0 0 200 120" class="grain-svg">
                            <!-- Large grains -->
                            <circle cx="30" cy="40" r="8" fill="#d4a574" opacity="0.9"></circle>
                            <circle cx="60" cy="35" r="7" fill="#c9985e" opacity="0.9"></circle>
                            <circle cx="90" cy="45" r="9" fill="#d4a574" opacity="0.9"></circle>
                            <circle cx="120" cy="38" r="8" fill="#b8895a" opacity="0.9"></circle>
                            <circle cx="150" cy="42" r="7" fill="#d4a574" opacity="0.9"></circle>
                            <circle cx="170" cy="40" r="8" fill="#c9985e" opacity="0.9"></circle>
                            <circle cx="45" cy="65" r="8" fill="#b8895a" opacity="0.9"></circle>
                            <circle cx="75" cy="70" r="9" fill="#d4a574" opacity="0.9"></circle>
                            <circle cx="105" cy="68" r="7" fill="#c9985e" opacity="0.9"></circle>
                            <circle cx="135" cy="72" r="8" fill="#d4a574" opacity="0.9"></circle>
                            <circle cx="165" cy="65" r="8" fill="#b8895a" opacity="0.9"></circle>
                            <circle cx="30" cy="95" r="9" fill="#d4a574" opacity="0.9"></circle>
                            <circle cx="60" cy="100" r="7" fill="#c9985e" opacity="0.9"></circle>
                            <circle cx="90" cy="98" r="8" fill="#b8895a" opacity="0.9"></circle>
                            <circle cx="120" cy="95" r="9" fill="#d4a574" opacity="0.9"></circle>
                            <circle cx="150" cy="100" r="7" fill="#c9985e" opacity="0.9"></circle>
                            <circle cx="170" cy="95" r="8" fill="#d4a574" opacity="0.9"></circle>
                        </svg>
                    </div>
                    <div class="grain-specs">
                        <div class="spec-item">
                            <span class="spec-label">Tamaño:</span>
                            <span class="spec-value">2-5 mm</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Uso:</span>
                            <span class="spec-value">Enfoscado base</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Densidad:</span>
                            <span class="spec-value">1.6 kg/L</span>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Medium Sand (Arenato) -->
                <div class="grain-card" data-grain-type="arenato">
                    <div class="grain-header">
                        <h3 class="grain-title">Arena Media (Cero Fino)</h3>
                        <span class="grain-subtitle">Arena Lavada</span>
                    </div>
                    <div class="grain-visual">
                        <svg viewBox="0 0 200 120" class="grain-svg">
                            <!-- Medium grains -->
                            <circle cx="25" cy="30" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="45" cy="28" r="3.5" fill="#d9c4a8" opacity="0.9"></circle>
                            <circle cx="65" cy="32" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="85" cy="30" r="3.5" fill="#cdb89a" opacity="0.9"></circle>
                            <circle cx="105" cy="33" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="125" cy="29" r="3.5" fill="#d9c4a8" opacity="0.9"></circle>
                            <circle cx="145" cy="31" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="165" cy="30" r="3.5" fill="#cdb89a" opacity="0.9"></circle>
                            <circle cx="185" cy="32" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="35" cy="55" r="3.5" fill="#d9c4a8" opacity="0.9"></circle>
                            <circle cx="55" cy="58" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="75" cy="56" r="3.5" fill="#cdb89a" opacity="0.9"></circle>
                            <circle cx="95" cy="59" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="115" cy="57" r="3.5" fill="#d9c4a8" opacity="0.9"></circle>
                            <circle cx="135" cy="58" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="155" cy="56" r="3.5" fill="#cdb89a" opacity="0.9"></circle>
                            <circle cx="175" cy="59" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="25" cy="82" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="45" cy="85" r="3.5" fill="#d9c4a8" opacity="0.9"></circle>
                            <circle cx="65" cy="83" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="85" cy="86" r="3.5" fill="#cdb89a" opacity="0.9"></circle>
                            <circle cx="105" cy="84" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="125" cy="85" r="3.5" fill="#d9c4a8" opacity="0.9"></circle>
                            <circle cx="145" cy="83" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="165" cy="86" r="3.5" fill="#cdb89a" opacity="0.9"></circle>
                            <circle cx="185" cy="84" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="35" cy="108" r="3.5" fill="#d9c4a8" opacity="0.9"></circle>
                            <circle cx="55" cy="110" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="75" cy="109" r="3.5" fill="#cdb89a" opacity="0.9"></circle>
                            <circle cx="95" cy="111" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="115" cy="108" r="3.5" fill="#d9c4a8" opacity="0.9"></circle>
                            <circle cx="135" cy="110" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                            <circle cx="155" cy="109" r="3.5" fill="#cdb89a" opacity="0.9"></circle>
                            <circle cx="175" cy="111" r="4" fill="#e6d5c0" opacity="0.9"></circle>
                        </svg>
                    </div>
                    <div class="grain-specs">
                        <div class="spec-item">
                            <span class="spec-label">Tamaño:</span>
                            <span class="spec-value">0.5-2 mm</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Uso:</span>
                            <span class="spec-value">Revoco intermedio</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Densidad:</span>
                            <span class="spec-value">1.5 kg/L</span>
                        </div>
                    </div>
                </div>

                <!-- Card 3: Fine Powder (Marmorato) -->
                <div class="grain-card" data-grain-type="marmorato">
                    <div class="grain-header">
                        <h3 class="grain-title">Polvo Fino</h3>
                        <span class="grain-subtitle">Polvo de Mármol (Marmolina)</span>
                    </div>
                    <div class="grain-visual">
                        <svg viewBox="0 0 200 120" class="grain-svg">
                            <!-- Fine powder - many tiny particles -->
                            <defs>
                                <pattern
                                    id="fine-powder"
                                    x="0"
                                    y="0"
                                    width="10"
                                    height="10"
                                    patternUnits="userSpaceOnUse"
                                >
                                    <circle cx="2" cy="2" r="0.8" fill="#f8f8f8" opacity="0.9"
                                    ></circle>
                                    <circle cx="6" cy="3" r="0.7" fill="#f0f0f0" opacity="0.9"
                                    ></circle>
                                    <circle cx="4" cy="6" r="0.8" fill="#f8f8f8" opacity="0.9"
                                    ></circle>
                                    <circle cx="8" cy="7" r="0.7" fill="#e8e8e8" opacity="0.9"
                                    ></circle>
                                </pattern>
                            </defs>
                            <rect x="10" y="10" width="180" height="100" fill="url(#fine-powder)"
                            ></rect>
                            <!-- Add some slightly larger particles for visual interest -->
                            <circle cx="40" cy="35" r="1.5" fill="#f8f8f8" opacity="0.9"></circle>
                            <circle cx="80" cy="45" r="1.5" fill="#f0f0f0" opacity="0.9"></circle>
                            <circle cx="120" cy="40" r="1.5" fill="#f8f8f8" opacity="0.9"></circle>
                            <circle cx="160" cy="50" r="1.5" fill="#e8e8e8" opacity="0.9"></circle>
                            <circle cx="50" cy="75" r="1.5" fill="#f0f0f0" opacity="0.9"></circle>
                            <circle cx="90" cy="80" r="1.5" fill="#f8f8f8" opacity="0.9"></circle>
                            <circle cx="130" cy="85" r="1.5" fill="#f0f0f0" opacity="0.9"></circle>
                            <circle cx="170" cy="75" r="1.5" fill="#e8e8e8" opacity="0.9"></circle>
                        </svg>
                    </div>
                    <div class="grain-specs">
                        <div class="spec-item">
                            <span class="spec-label">Tamaño:</span>
                            <span class="spec-value">\u003c 0.5 mm</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Uso:</span>
                            <span class="spec-value">Enlucido fino</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Densidad:</span>
                            <span class="spec-value">1.2 kg/L</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDUCATIONAL SECTION: Vitruvius and Mortar Science -->
        <!-- EDUCATIONAL SECTION: Vitruvius and Mortar Science -->
        <div class="educational-section">
            <div class="educational-header-decoration">
                <svg viewBox="0 0 100 20" class="ornament-svg">
                    <path
                        d="M0 10 Q25 0 50 10 T100 10"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1"></path>
                    <circle cx="50" cy="10" r="3" fill="currentColor"></circle>
                </svg>
            </div>

            <h2 class="educational-title">Tratado de los Morteros</h2>
            <p class="educational-subtitle">Extractos y notas sobre el Libro VII de Vitruvio</p>

            <div class="educational-content">
                <!-- BLOCK 1: VITRUVIUS (The Architect) -->
                <div class="educational-block">
                    <div class="block-visual">
                        <img
                            src="/images/morteros/roman_masons.png"
                            alt="Grabado de albañiles romanos construyendo un arco"
                            class="treatise-image"
                        />
                        <div class="visual-caption">Fig. I - El Arte de Construir</div>
                    </div>

                    <div class="block-text-content">
                        <h3 class="block-title">
                            <span class="roman-numeral">I.</span> La Sabiduría de Vitruvio
                        </h3>
                        <p class="block-text">
                            Marco Vitruvio Polión, en el Libro VII de su <em>De Architectura</em>,
                            no solo describió técnicas, sino una filosofía. Entendía que la
                            eternidad de un edificio reside en sus uniones.
                        </p>
                        <p class="block-text">
                            El mortero no es mero pegamento; es el tejido conectivo. Sus
                            proporciones (1:3, 1:2, 1:1) son el legado de siglos de observación
                            empírica romana, buscando el equilibrio perfecto entre resistencia y
                            flexibilidad.
                        </p>
                    </div>
                </div>

                <!-- BLOCK 2: MECHANICAL BONDING (The Science) -->
                <div class="educational-block reverse">
                    <div class="block-text-content">
                        <h3 class="block-title">
                            <span class="roman-numeral">II.</span> El Misterio del Agarre
                        </h3>
                        <p class="block-text">
                            El agarre no es químico, es <strong>mecánico</strong>. Imagina millones
                            de raíces microscópicas. El mortero debe penetrar en los poros del
                            ladrillo para crear una "llave" física.
                        </p>
                        <p class="block-text">
                            Por eso Vitruvio prohibía aplicar capas gruesas sobre superficies lisas.
                            Sin porosidad, no hay anclaje. El muro y el mortero deben convertirse en
                            una sola entidad monolítica.
                        </p>
                    </div>

                    <div class="block-visual">
                        <img
                            src="/images/morteros/mechanical_bonding.png"
                            alt="Diagrama microscópico del agarre mecánico del mortero"
                            class="treatise-image"
                        />
                    </div>
                </div>

                <!-- BLOCK 3: EL FRATASADO (The Technique) - NEW SECTION -->
                <div class="educational-block">
                    <div class="block-visual">
                        <img
                            src="/images/morteros/fratasado.png"
                            alt="Detalle de mano usando un fratás de madera"
                            class="treatise-image"
                        />
                    </div>

                    <div class="block-text-content">
                        <h3 class="block-title">
                            <span class="roman-numeral">III.</span> El Arte del Fratasado
                        </h3>
                        <p class="block-text">
                            El fratasado no es solo alisar; es preparar el futuro. El uso del <strong
                                >fratás de madera</strong
                            > es crucial en las capas base porque "abre el poro", dejando una textura
                            rugosa ideal para que la siguiente capa se agarre.
                        </p>
                        <p class="block-text">
                            La llana de acero, por el contrario, cierra el poro y saca el agua a la
                            superficie ("quemar" el mortero), técnica reservada solo para el
                            enlucido final o estucos.
                        </p>
                        <p class="block-text">
                            El secreto está en el <em>tempo</em>: saber esperar a que el mortero
                            haya "tirado" (endurecido ligeramente) pero siga húmedo. Es un diálogo
                            silencioso entre la herramienta y la cal.
                        </p>
                    </div>
                </div>

                <!-- BLOCK 4: LIME CYCLE (The Chemistry) -->
                <div class="educational-block reverse">
                    <div class="block-text-content">
                        <h3 class="block-title">
                            <span class="roman-numeral">IV.</span> El Ciclo de la Cal
                        </h3>
                        <p class="block-text">
                            A diferencia del cemento moderno, la cal es un material "vivo". Fragua
                            lentamente mediante <strong>carbonatación</strong>: absorbe el CO₂ del
                            aire para volver a convertirse en piedra caliza.
                        </p>
                        <p class="block-text">
                            Es un ciclo eterno: de la piedra venimos y a la piedra volvemos. Esta
                            respiración permite que el edificio se adapte a los movimientos sin
                            agrietarse, sanando sus propias heridas con el tiempo.
                        </p>
                    </div>

                    <div class="block-visual">
                        <img
                            src="/images/morteros/lime_cycle.png"
                            alt="Diagrama circular del ciclo de la cal"
                            class="treatise-image"
                        />
                        <div class="visual-caption">Fig. IV - El Ciclo de la Cal</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @import url("https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap");

        .vitruvian-container {
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .vitruvian-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 30%, rgba(245, 241, 232, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(230, 213, 192, 0.3) 0%, transparent 50%),
                linear-gradient(to bottom, #faf8f3, #f5f1e8);
            z-index: -1;
        }

        :global(.dark) .vitruvian-bg {
            background:
                radial-gradient(circle at 20% 30%, rgba(26, 26, 26, 0.8) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(40, 35, 30, 0.6) 0%, transparent 50%),
                linear-gradient(to bottom, #0a0a0a, #1a1a1a);
        }

        .vitruvian-header {
            max-width: 1400px;
            margin: 0 auto 4rem;
            animation: fadeIn 1s ease-out;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #78716c;
            text-decoration: none;
            margin-bottom: 1.5rem;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: #c1694f;
        }

        .vitruvian-title {
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            font-weight: 900;
            color: #292524;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
            line-height: 1;
        }

        :global(.dark) .vitruvian-title {
            color: #f5f1e8;
        }

        .vitruvian-subtitle {
            font-size: clamp(1rem, 2vw, 1.25rem);
            color: #78716c;
            max-width: 800px;
            line-height: 1.6;
            font-weight: 300;
        }

        .vitruvian-canvas {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Reduced min-width */
            gap: 1.5rem;
            animation: fadeIn 1s ease-out 0.2s both;
        }

        @media (min-width: 1024px) {
            .vitruvian-canvas {
                grid-template-columns: 1fr 1.2fr 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 2px solid #e7e5e4;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
            transition:
                transform 0.3s,
                box-shadow 0.3s;
        }

        :global(.dark) .panel {
            background: rgba(26, 26, 26, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .panel:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #292524;
            margin-bottom: 1.5rem;
            text-align: center;
            letter-spacing: 0.02em;
        }

        :global(.dark) .panel-title {
            color: #f5f1e8;
        }

        /* Roman Column Styles */
        .roman-column {
            width: 100%;
            max-width: 250px;
            margin: 0 auto;
            display: block;
        }

        .column-section {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .column-section:hover {
            filter: brightness(1.1);
        }

        .column-section.active {
            filter: drop-shadow(0 0 10px rgba(193, 105, 79, 0.6));
        }

        .column-label {
            font-size: 14px;
            font-weight: 700;
            text-anchor: middle;
            fill: #292524;
            pointer-events: none;
        }

        .column-sublabel {
            font-size: 10px;
            text-anchor: middle;
            fill: #78716c;
            pointer-events: none;
        }

        .phase-info {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(245, 241, 232, 0.5);
            border-radius: 1rem;
            border: 1px solid #e7e5e4;
        }

        :global(.dark) .phase-info {
            background: rgba(40, 35, 30, 0.5);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .phase-info h3 {
            font-size: 1.25rem;
            color: #c1694f;
            margin-bottom: 0.5rem;
        }

        .phase-info p {
            font-size: 0.875rem;
            color: #57534e;
            line-height: 1.6;
        }

        :global(.dark) .phase-info p {
            color: #a8a29e;
        }

        /* Material Selector */
        .material-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .material-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(245, 241, 232, 0.5);
            border: 2px solid #e7e5e4;
            border-radius: 0.75rem;

            font-weight: 600;
            color: #57534e;
            cursor: pointer;
            transition: all 0.3s;
        }

        :global(.dark) .material-btn {
            background: rgba(40, 35, 30, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
            color: #a8a29e;
        }

        .material-btn:hover {
            border-color: #c1694f;
            transform: translateY(-2px);
        }

        .material-btn.active {
            background: #c1694f;
            border-color: #c1694f;
            color: white;
        }

        /* Cal Type Toggle */
        .cal-type-toggle {
            margin-bottom: 1.5rem;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }

        .toggle-slider {
            position: relative;
            width: 50px;
            height: 26px;
            background: #e7e5e4;
            border-radius: 13px;
            transition: background 0.3s;
        }

        .toggle-slider::before {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        input[type="checkbox"]:checked + .toggle-slider {
            background: #c1694f;
        }

        input[type="checkbox"]:checked + .toggle-slider::before {
            transform: translateX(24px);
        }

        input[type="checkbox"] {
            display: none;
        }

        .toggle-text {
            font-size: 0.875rem;
            color: #57534e;
        }

        :global(.dark) .toggle-text {
            color: #a8a29e;
        }

        .type-polvo {
            display: none;
        }

        input[type="checkbox"]:checked ~ .toggle-text .type-pasta {
            display: none;
        }

        input[type="checkbox"]:checked ~ .toggle-text .type-polvo {
            display: inline;
        }

        /* Bodegón SVG */
        .bodegon-svg {
            width: 100%;
            height: 200px;
            margin: 1.5rem 0;
        }

        /* Slider */
        .slider-container {
            margin-top: 2rem;
        }

        .ruler-slider {
            position: relative;
            margin-bottom: 1rem;
        }

        .ruler-slider input[type="range"] {
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #e7e5e4 0%, #c1694f 50%, #8b7355 100%);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        .ruler-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #c1694f;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .ruler-slider input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .ruler-slider input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #c1694f;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .ruler-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #78716c;
        }

        .quantity-display {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(245, 241, 232, 0.5);
            border-radius: 0.75rem;
            border: 1px solid #e7e5e4;
        }

        :global(.dark) .quantity-display {
            background: rgba(40, 35, 30, 0.5);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .quantity-label {
            font-size: 0.875rem;
            color: #78716c;
        }

        .quantity-value {
            font-size: 2rem;
            font-weight: 600;
            color: #c1694f;
        }

        .quantity-unit {
            font-size: 1rem;
            color: #57534e;
        }

        :global(.dark) .quantity-unit {
            color: #a8a29e;
        }

        /* Complementary Material */
        .complementary-material {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(
                135deg,
                rgba(193, 105, 79, 0.08) 0%,
                rgba(139, 115, 85, 0.05) 100%
            );
            border: 2px solid rgba(193, 105, 79, 0.2);
            border-radius: 1rem;
            transition: all 0.3s;
        }

        :global(.dark) .complementary-material {
            background: linear-gradient(
                135deg,
                rgba(193, 105, 79, 0.15) 0%,
                rgba(139, 115, 85, 0.08) 100%
            );
            border-color: rgba(193, 105, 79, 0.3);
        }

        .complementary-material:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(193, 105, 79, 0.15);
        }

        .complementary-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;

            font-size: 0.875rem;
            font-weight: 600;
            color: #c1694f;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .complementary-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .complementary-item {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 0.75rem;
            border: 1px solid rgba(193, 105, 79, 0.15);
        }

        :global(.dark) .complementary-item {
            background: rgba(26, 26, 26, 0.6);
            border-color: rgba(193, 105, 79, 0.2);
        }

        .comp-label {
            font-size: 1rem;
            font-weight: 600;
            color: #57534e;
        }

        :global(.dark) .comp-label {
            color: #d4c5b0;
        }

        .comp-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #8b7355;
        }

        .comp-unit {
            font-size: 0.875rem;
            color: #78716c;
        }

        .ratio-reminder {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(245, 241, 232, 0.5);
            border-radius: 0.5rem;
        }

        :global(.dark) .ratio-reminder {
            background: rgba(40, 35, 30, 0.5);
        }

        .ratio-text {
            font-size: 0.75rem;
            color: #78716c;
        }

        .ratio-value {
            font-size: 0.875rem;
            font-weight: 700;
            color: #c1694f;
        }

        /* Living Wall */
        .wall-svg {
            width: 100%;
            height: 400px;
            border: 2px solid #e7e5e4;
            border-radius: 0.75rem;
            background: #fafaf9;
        }

        :global(.dark) .wall-svg {
            border-color: rgba(255, 255, 255, 0.1);
            background: #1a1a1a;
        }

        .coverage-display {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.5rem;
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: rgba(193, 105, 79, 0.1);
            border-radius: 1rem;
            border: 2px solid #c1694f;
        }

        .coverage-label {
            font-size: 1.25rem;
            color: #57534e;
        }

        :global(.dark) .coverage-label {
            color: #a8a29e;
        }

        .coverage-value {
            font-size: 3rem;
            font-weight: 600;
            color: #c1694f;
        }

        .coverage-unit {
            font-size: 1.5rem;
            color: #57534e;
        }

        :global(.dark) .coverage-unit {
            color: #a8a29e;
        }

        /* Technical Details */
        .technical-details {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(245, 241, 232, 0.3);
            border-radius: 0.5rem;
        }

        :global(.dark) .detail-row {
            background: rgba(40, 35, 30, 0.3);
        }

        .detail-label {
            font-size: 0.875rem;
            color: #78716c;
        }

        .detail-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #292524;
        }

        :global(.dark) .detail-value {
            color: #f5f1e8;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mortar coverage animation */
        #mortar-coverage,
        #mortar-texture {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Granulometry Section */
        .granulometry-section {
            max-width: 1400px;
            margin: 4rem auto 2rem;
            padding: 0 1rem;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            color: #292524;
            margin-bottom: 3rem;
            position: relative;
        }

        :global(.dark) .section-title {
            color: #f5f1e8;
        }

        .section-title::after {
            content: "";
            display: block;
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #c1694f, transparent);
            margin: 1rem auto 0;
        }

        .granulometry-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Reduced min-width */
            gap: 2rem;
            margin-bottom: 4rem;
            justify-content: center; /* Center cards */
        }

        .grain-card {
            background: #fafaf9;
            border: 2px solid #e7e5e4;
            border-radius: 1rem;
            padding: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.6;
            transform: scale(0.98);
        }

        :global(.dark) .grain-card {
            background: #1c1917;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .grain-card:hover {
            transform: scale(1);
            opacity: 0.8;
        }

        .grain-card.active {
            opacity: 1;
            transform: scale(1.02);
            border-color: #c1694f;
            box-shadow: 0 8px 32px rgba(193, 105, 79, 0.2);
            background: #ffffff;
        }

        :global(.dark) .grain-card.active {
            background: #292524;
            border-color: #c1694f;
            box-shadow: 0 8px 32px rgba(193, 105, 79, 0.3);
        }

        .grain-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .grain-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #292524;
            margin: 0 0 0.5rem 0;
        }

        :global(.dark) .grain-title {
            color: #f5f1e8;
        }

        .grain-subtitle {
            font-size: 0.875rem;
            color: #78716c;
            font-weight: 500;
        }

        :global(.dark) .grain-subtitle {
            color: #a8a29e;
        }

        .grain-visual {
            background: #f5f5f4;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e7e5e4;
        }

        :global(.dark) .grain-visual {
            background: #0a0a0a;
            border-color: rgba(255, 255, 255, 0.05);
        }

        .grain-svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .grain-specs {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .spec-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e7e5e4;
        }

        :global(.dark) .spec-item {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        .spec-item:last-child {
            border-bottom: none;
        }

        .spec-label {
            font-size: 0.875rem;
            color: #78716c;
            font-weight: 500;
        }

        :global(.dark) .spec-label {
            color: #a8a29e;
        }

        .spec-value {
            font-size: 0.875rem;
            color: #292524;
            font-weight: 600;
        }

        :global(.dark) .spec-value {
            color: #f5f1e8;
        }

        /* Educational Section Styles - Treatise Aesthetic */
        .educational-section {
            max-width: 1000px;
            margin: 6rem auto 0;
            padding: 3rem 2rem; /* Reduced padding */
            background: #fdfbf7; /* Parchment-like off-white */
            border: 1px solid #e7e5e4;
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.05),
                0 2px 4px -1px rgba(0, 0, 0, 0.03),
                inset 0 0 40px rgba(193, 169, 130, 0.1); /* Inner glow for aged paper feel */
            position: relative;
            animation: fadeIn 1s ease-out 0.4s both;
        }

        :global(.dark) .educational-section {
            background: #1c1917;
            border-color: #44403c;
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.3),
                inset 0 0 40px rgba(0, 0, 0, 0.5);
        }

        /* Decorative Header */
        .educational-header-decoration {
            text-align: center;
            margin-bottom: 2rem;
            color: #c1694f;
            opacity: 0.8;
        }

        .ornament-svg {
            width: 120px;
            height: 24px;
        }

        .educational-title {
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 900;
            color: #292524;
            text-align: center;
            margin-bottom: 0.5rem;
            letter-spacing: -0.03em;
            line-height: 1.1;
        }

        :global(.dark) .educational-title {
            color: #e7e5e4;
        }

        .educational-subtitle {
            font-size: 1rem;
            color: #78716c;
            text-align: center;
            margin-bottom: 4rem;
            font-style: italic;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        :global(.dark) .educational-subtitle {
            color: #a8a29e;
        }

        .educational-content {
            display: flex;
            flex-direction: column;
            gap: 6rem;
        }

        /* Educational Block Layout */
        .educational-block {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            align-items: center;
        }

        .educational-block.reverse {
            direction: rtl; /* Visual trick for alternating layout */
        }

        .educational-block.reverse .block-text-content {
            direction: ltr; /* Reset text direction */
        }

        /* Visual Container */
        .block-visual {
            position: relative;
            padding: 1rem;
            background: #fff;
            border: 1px solid #e7e5e4;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        :global(.dark) .block-visual {
            background: #292524;
            border-color: #44403c;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .block-visual:hover {
            transform: translateY(-5px);
        }

        .visual-caption {
            font-size: 0.75rem;
            color: #78716c;
            text-align: center;
            margin-top: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* SVGs */
        .engraving-svg,
        .technical-svg,
        .diagram-svg {
            width: 100%;
            height: auto;
            display: block;
            color: #44403c; /* Ink color */
        }

        :global(.dark) .engraving-svg,
        :global(.dark) .technical-svg,
        :global(.dark) .diagram-svg {
            color: #d6d3d1;
        }

        /* Text Content */
        .block-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #292524;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
        }

        :global(.dark) .block-title {
            color: #e7e5e4;
        }

        .roman-numeral {
            color: #c1694f;
            font-size: 1.25rem;
            font-weight: 400;
        }

        .block-text {
            font-size: 1.125rem;
            line-height: 1.7;
            color: #44403c;
            margin-bottom: 1.5rem;
            text-align: justify; /* Justified text for book feel */
        }

        .block-text:last-child {
            margin-bottom: 0;
        }

        :global(.dark) .block-text {
            color: #d6d3d1;
        }

        .block-text em,
        .block-text strong {
            color: #292524;
        }

        :global(.dark) .block-text em,
        :global(.dark) .block-text strong {
            color: #fff;
        }

        /* Responsive Design */
        @media (max-width: 900px) {
            .educational-section {
                padding: 2rem 1.5rem; /* Reduced padding */
                margin-top: 4rem;
            }

            .educational-block,
            .educational-block.reverse {
                grid-template-columns: 1fr;
                gap: 2rem;
                direction: ltr;
            }

            .block-visual {
                order: -1; /* Visual always on top on mobile */
                width: 100%;
                max-width: 100%; /* Ensure full width on mobile */
                margin: 0 auto;
            }

            .educational-title {
                font-size: 2rem;
            }

            .block-text {
                text-align: left;
                font-size: 1rem;
            }
        }
    </style>

    <script>
        // Vitruvian Constants
        const VITRUVIAN_PHASES = {
            trullissatio: {
                name: "Trullissatio",
                commonName: "Enfoscado",
                layers: 2,
                ratio: { cal: 1, arena: 3 },
                thickness: 30,
                density: 1.6,
                color: "#d4c5b0",
                texture: "texture-rough",
                description:
                    "Capa base rugosa. 2 manos de 15mm. Proporción 1:3 (Cal:Arena de río).",
            },
            arenato: {
                name: "Arenato",
                commonName: "Revoco",
                layers: 2,
                ratio: { cal: 1, arena: 2 },
                thickness: 16,
                density: 1.5,
                color: "#e6d5c0",
                texture: "texture-medium",
                description: "Capa intermedia. 2 manos de 8mm. Proporción 1:2 (Cal:Arena lavada).",
            },
            marmorato: {
                name: "Marmorato",
                commonName: "Enlucido",
                layers: 1,
                ratio: { cal: 1, marmol: 1 },
                thickness: 4,
                density: 1.2,
                color: "#f8f8f8",
                texture: "texture-smooth",
                description:
                    "Acabado fino. 1 mano doble de 4mm. Proporción 1:1 (Cal:Polvo de mármol).",
            },
        };

        const CAL_DENSITY = {
            pasta: 1.3,
            polvo: 0.65,
        };

        const WASTE_FACTOR = 1.2;

        // State
        let state = {
            phase: "trullissatio",
            materialType: "cal",
            calType: "pasta",
            materialKg: 150,
        };

        // Elements
        const elements = {
            columnSections: document.querySelectorAll(".column-section"),
            phaseName: document.getElementById("phase-name"),
            phaseDesc: document.getElementById("phase-desc"),
            materialBtns: document.querySelectorAll(".material-btn"),
            calTypeSwitch: document.getElementById("cal-type-switch"),
            calTypeContainer: document.getElementById("cal-type-container"),
            materialSlider: document.getElementById("material-slider"),
            quantityValue: document.getElementById("quantity-value"),
            sackPile: document.getElementById("sack-pile"),
            mortarCoverage: document.getElementById("mortar-coverage"),
            mortarTexture: document.getElementById("mortar-texture"),
            coverageValue: document.getElementById("coverage-value"),
            thicknessValue: document.getElementById("thickness-value"),
            layersValue: document.getElementById("layers-value"),
            complementaryLabel: document.getElementById("complementary-label"),
            complementaryValue: document.getElementById("complementary-value"),
            ratioDisplay: document.getElementById("ratio-display"),
        };

        // Calculate coverage
        function calculateCoverage() {
            const phase = VITRUVIAN_PHASES[state.phase];
            const materialKg = state.materialKg;

            let area = 0;

            if (state.materialType === "cal") {
                const calDensity = CAL_DENSITY[state.calType];
                const volumeLiters = materialKg / calDensity;

                const calParts = phase.ratio.cal;
                const totalParts = phase.ratio.cal + (phase.ratio.arena || phase.ratio.marmol || 0);
                const calFraction = calParts / totalParts;

                const thicknessMeters = phase.thickness / 1000;
                const unitConsumption = thicknessMeters * calFraction;

                area = volumeLiters / (unitConsumption * 1000 * WASTE_FACTOR);
            } else {
                const volumeLiters = materialKg / phase.density;
                const thicknessMeters = phase.thickness / 1000;

                area = volumeLiters / (thicknessMeters * 1000 * WASTE_FACTOR);
            }

            return Math.max(0, area);
        }

        // Update UI
        function updateUI() {
            const phase = VITRUVIAN_PHASES[state.phase];

            // Update phase info
            elements.phaseName.textContent = phase.name;
            elements.phaseDesc.textContent = phase.description;

            // Update column selection
            elements.columnSections.forEach((section) => {
                const sectionPhase = section.getAttribute("data-phase");
                if (sectionPhase === state.phase) {
                    section.classList.add("active");
                } else {
                    section.classList.remove("active");
                }
            });

            // Update material buttons
            elements.materialBtns.forEach((btn) => {
                const material = btn.getAttribute("data-material");
                if (material === state.materialType) {
                    btn.classList.add("active");
                } else {
                    btn.classList.remove("active");
                }
            });

            // Show/hide cal type toggle
            if (state.materialType === "cal") {
                elements.calTypeContainer.style.display = "block";
            } else {
                elements.calTypeContainer.style.display = "none";
            }

            // Update quantity display
            elements.quantityValue.textContent = state.materialKg;

            // Update sack pile visualization
            updateSackPile();

            // Calculate and display coverage
            const coverage = calculateCoverage();
            elements.coverageValue.textContent = coverage.toFixed(1);

            // Update wall visualization
            updateWallVisualization(coverage);

            // Calculate and display complementary material
            let complementaryAmount = 0;
            let complementaryName = "";
            let ratioText = "";

            if (state.materialType === "cal") {
                // User has Cal, show how much Arena/Mármol they need
                // CRITICAL: Ratios are by VOLUME, not weight!
                // Must convert kg → liters → apply ratio → convert back to kg

                const calDensity = CAL_DENSITY[state.calType]; // 0.65 for polvo, 1.30 for pasta
                const calVolumeLiters = state.materialKg / calDensity;

                const aggregateParts = phase.ratio.arena || phase.ratio.marmol || 0;
                const arenaVolumeLiters = calVolumeLiters * aggregateParts;

                // Convert arena volume back to kg using arena density
                const arenaDensity = phase.density; // 1.6 for arena, 1.2 for marmol
                complementaryAmount = arenaVolumeLiters * arenaDensity;

                complementaryName = phase.ratio.arena ? "Arena" : "Mármol";
                ratioText = `${phase.ratio.cal}:${aggregateParts}`;
            } else {
                // User has Arena, show how much Cal they need
                // Same logic: convert to volume first

                const arenaDensity = phase.density;
                const arenaVolumeLiters = state.materialKg / arenaDensity;

                const calParts = phase.ratio.cal;
                const aggregateParts = phase.ratio.arena || phase.ratio.marmol || 0;
                const calVolumeLiters = arenaVolumeLiters * (calParts / aggregateParts);

                // Convert cal volume back to kg using selected cal type density
                const calDensity = CAL_DENSITY[state.calType];
                complementaryAmount = calVolumeLiters * calDensity;

                complementaryName = "Cal";
                ratioText = `${calParts}:${aggregateParts}`;
            }

            if (elements.complementaryLabel) {
                elements.complementaryLabel.textContent = complementaryName;
            }
            if (elements.complementaryValue) {
                elements.complementaryValue.textContent =
                    Math.round(complementaryAmount).toString();
            }
            if (elements.ratioDisplay) {
                elements.ratioDisplay.textContent = ratioText;
            }

            // Update technical details
            elements.thicknessValue.textContent = `${phase.thickness} mm`;
            elements.layersValue.textContent = `${phase.layers} ${phase.layers === 1 ? "mano" : "manos"}`;

            // Update granulometry cards highlighting
            updateGranulometryCards();
        }

        // Update granulometry cards to highlight the active one
        function updateGranulometryCards() {
            const grainCards = document.querySelectorAll(".grain-card");
            grainCards.forEach((card) => {
                const grainType = card.getAttribute("data-grain-type");
                if (grainType === state.phase) {
                    card.classList.add("active");
                } else {
                    card.classList.remove("active");
                }
            });
        }

        // Update sack pile
        function updateSackPile() {
            const totalSacks = state.materialKg / 25; // Exact number including decimals
            const fullSacks = Math.floor(totalSacks);
            const hasHalfSack = totalSacks - fullSacks >= 0.25; // Show half sack if at least 0.25 remaining

            let svg = "";
            const sackWidth = 40;
            const sackHeight = 50;
            const cols = 4;

            // Draw full sacks
            for (let i = 0; i < fullSacks; i++) {
                const row = Math.floor(i / cols);
                const col = i % cols;
                const x = 30 + col * (sackWidth + 10);
                const y = 150 - row * (sackHeight - 10);

                svg += `
                    <rect x="${x}" y="${y}" width="${sackWidth}" height="${sackHeight}" 
                          fill="${state.materialType === "cal" ? "#f5f5f5" : "#e6c288"}" 
                          stroke="#333" stroke-width="1.5" rx="3"/>
                    <line x1="${x + 5}" y1="${y + 15}" x2="${x + sackWidth - 5}" y2="${y + 15}" 
                          stroke="#333" stroke-width="1" opacity="0.3"/>
                    <line x1="${x + 5}" y1="${y + 25}" x2="${x + sackWidth - 5}" y2="${y + 25}" 
                          stroke="#333" stroke-width="1" opacity="0.3"/>
                `;
            }

            // Draw half sack if needed
            if (hasHalfSack) {
                const i = fullSacks;
                const row = Math.floor(i / cols);
                const col = i % cols;
                const x = 30 + col * (sackWidth + 10);
                const y = 150 - row * (sackHeight - 10);

                // Half sack with diagonal cut
                const halfColor = state.materialType === "cal" ? "#f5f5f5" : "#e6c288";
                const lightColor = state.materialType === "cal" ? "#fafafa" : "#f0d5a8";

                svg += `
                    <defs>
                        <clipPath id="half-sack-clip">
                            <polygon points="${x},${y} ${x + sackWidth},${y} ${x + sackWidth},${y + sackHeight} ${x},${y + sackHeight / 2}" />
                        </clipPath>
                    </defs>
                    <rect x="${x}" y="${y}" width="${sackWidth}" height="${sackHeight}" 
                          fill="${lightColor}" 
                          stroke="#333" stroke-width="1.5" stroke-dasharray="3,3" rx="3"/>
                    <rect x="${x}" y="${y}" width="${sackWidth}" height="${sackHeight}" 
                          fill="${halfColor}" 
                          clip-path="url(#half-sack-clip)"
                          stroke="none"/>
                    <line x1="${x}" y1="${y + sackHeight / 2}" x2="${x + sackWidth}" y2="${y + sackHeight}" 
                          stroke="#333" stroke-width="1.5"/>
                    <line x1="${x + 5}" y1="${y + 15}" x2="${x + sackWidth - 5}" y2="${y + 15}" 
                          stroke="#333" stroke-width="1" opacity="0.3"/>
                `;
            }

            elements.sackPile.innerHTML = svg;
        }

        // Update wall visualization
        function updateWallVisualization(coverage) {
            const phase = VITRUVIAN_PHASES[state.phase];
            const maxCoverage = 50;
            const coverageRatio = Math.min(coverage / maxCoverage, 1);

            const maxWidth = 300;
            const maxHeight = 400;
            const width = maxWidth * Math.sqrt(coverageRatio);
            const height = maxHeight * Math.sqrt(coverageRatio);

            const x = (maxWidth - width) / 2;
            const y = (maxHeight - height) / 2;

            elements.mortarCoverage.setAttribute("x", x.toString());
            elements.mortarCoverage.setAttribute("y", y.toString());
            elements.mortarCoverage.setAttribute("width", width.toString());
            elements.mortarCoverage.setAttribute("height", height.toString());
            elements.mortarCoverage.setAttribute("fill", phase.color);

            elements.mortarTexture.setAttribute("x", x.toString());
            elements.mortarTexture.setAttribute("y", y.toString());
            elements.mortarTexture.setAttribute("width", width.toString());
            elements.mortarTexture.setAttribute("height", height.toString());
            elements.mortarTexture.setAttribute("fill", `url(#${phase.texture})`);
        }

        // Event listeners
        elements.columnSections.forEach((section) => {
            section.addEventListener("click", () => {
                state.phase = section.getAttribute("data-phase");
                updateUI();
            });
        });

        elements.materialBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                state.materialType = btn.getAttribute("data-material");
                updateUI();
            });
        });

        elements.calTypeSwitch.addEventListener("change", (e) => {
            state.calType = e.target.checked ? "polvo" : "pasta";
            updateUI();
        });

        elements.materialSlider.addEventListener("input", (e) => {
            state.materialKg = parseInt(e.target.value);
            updateUI();
        });

        // Initial render
        updateUI();
    </script>
</Layout>
