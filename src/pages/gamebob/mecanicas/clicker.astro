---
import MechanicPage from "../../../components/gamebob/mechanics/MechanicPage.astro";
import MechanicCanvas from "../../../components/gamebob/mechanics/MechanicCanvas.astro";
import MechanicInfo from "../../../components/gamebob/mechanics/MechanicInfo.astro";
import { Icon } from "astro-icon/components";

const GITHUB_BASE = "https://github.com/jjlmoya/jjlmoya/tree/main/src/lib/mechanics/clicker";
const CODE_URL =
    "https://github.com/jjlmoya/jjlmoya/blob/main/src/lib/mechanics/clicker/ClickerMechanic.ts";
---

<MechanicPage
    title="Clicker"
    description="El poder del crecimiento exponencial. Un click hoy, un imperio ma√±ana."
    githubUrl={GITHUB_BASE}
    codeUrl={CODE_URL}
>
    <Icon slot="icon" name="mdi:cursor-default-click" class="text-yellow-400" />

    <div class="relative">
        <MechanicCanvas
            id="game-canvas"
            instruction="Haz Click"
            subInstruction="Genera monedas"
            verticalOnMobile={true}
        >
            <!-- Custom Button Overlay -->
            <div class="absolute inset-0 flex items-center justify-center z-20 pointer-events-none">
                <button
                    id="click-btn"
                    class="w-48 h-48 rounded-full bg-gradient-to-br from-[#fbbf24] to-[#d97706] shadow-[0_0_50px_rgba(251,191,36,0.3)] active:scale-95 transition-transform duration-75 flex items-center justify-center group pointer-events-auto cursor-pointer"
                >
                    <Icon
                        name="mdi:cursor-default-click"
                        class="w-24 h-24 text-white drop-shadow-md group-hover:scale-110 transition-transform"
                    />
                </button>
            </div>

            <!-- Currency Display Overlay -->
            <div class="absolute top-8 left-0 right-0 text-center z-20 pointer-events-none">
                <h2 class="text-4xl font-black text-[#fbbf24] drop-shadow-lg" id="currency-display">
                    0
                </h2>
                <p class="text-white/50 font-mono text-xs mt-1">MONEDAS</p>
                <p class="text-[#fbbf24]/70 font-mono text-xs mt-0.5" id="gps-display">
                    0 por segundo
                </p>
            </div>
        </MechanicCanvas>
    </div>

    <div class="mt-8">
        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
            <Icon name="mdi:store" class="text-green-400" />
            Tienda de Mejoras
        </h3>
        <div id="upgrades-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Upgrades injected here -->
        </div>
    </div>

    <MechanicInfo>
        <Fragment slot="how-it-works">
            <li class="flex items-start gap-2">
                <span class="text-blue-400 mt-1">‚Ä¢</span>
                <span>Clics manuales generan recursos inmediatos.</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="text-blue-400 mt-1">‚Ä¢</span>
                <span>Inversi√≥n en automatizaci√≥n para crecimiento pasivo.</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="text-blue-400 mt-1">‚Ä¢</span>
                <span>Escalado exponencial de costes y producci√≥n.</span>
            </li>
        </Fragment>

        <Fragment slot="controls">
            <div class="bg-zinc-800 p-3 rounded-lg text-center col-span-2">
                <span class="block text-white font-bold">Click / Tap</span>
                <span class="text-xs text-zinc-400">Generar Monedas</span>
            </div>
        </Fragment>
    </MechanicInfo>
</MechanicPage>

<script>
    import { ClickerGame, formatNumber } from "../../../lib/mechanics/clicker/ClickerGame";

    const canvas = document.getElementById("game-canvas") as HTMLCanvasElement;
    const overlay = document.getElementById("game-canvas-overlay");
    const clickBtn = document.getElementById("click-btn");
    const currencyDisplay = document.getElementById("currency-display");
    const gpsDisplay = document.getElementById("gps-display");
    const upgradesList = document.getElementById("upgrades-list");

    let game: ClickerGame | null = null;

    if (canvas && overlay && clickBtn && currencyDisplay && gpsDisplay && upgradesList) {
        // Initialize Game
        game = new ClickerGame(canvas);

        // Hide overlay on first interaction
        const start = () => {
            overlay.style.opacity = "0";
            overlay.style.pointerEvents = "none";
        };
        overlay.addEventListener("click", start);
        clickBtn.addEventListener("click", start);

        // Click Handler
        clickBtn.addEventListener("mousedown", (e) => {
            if (!game) return;
            // Calculate relative position for particles
            const rect = canvas.getBoundingClientRect();
            // Center of button roughly
            const x = rect.width / 2;
            const y = rect.height / 2;

            // Or use mouse position relative to canvas
            // const mouseX = (e as MouseEvent).clientX - rect.left;
            // const mouseY = (e as MouseEvent).clientY - rect.top;

            // Randomize slightly around center
            game.click(x + (Math.random() - 0.5) * 50, y + (Math.random() - 0.5) * 50);

            updateUI();

            // Animation
            clickBtn.style.transform = "scale(0.90)";
            setTimeout(() => (clickBtn.style.transform = "scale(1)"), 50);
        });

        // Shop UI Generation
        function initShop() {
            if (!game || !upgradesList) return;
            const state = game.state;
            upgradesList.innerHTML = "";

            state.upgrades.forEach((u) => {
                const btn = document.createElement("button");
                btn.id = `upgrade-btn-${u.id}`;
                btn.className =
                    "w-full p-4 rounded-xl border text-left transition-all bg-zinc-800 border-zinc-700 hover:bg-zinc-700";

                btn.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-white">${u.name}</span>
                        <span class="font-mono text-[#fbbf24]" id="upgrade-count-${u.id}">${u.count}</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <div class="text-xs text-zinc-400">
                            ${u.type === "click" ? "+" + u.power + " clic" : "+" + u.power + "/s"}
                        </div>
                        <div class="font-mono text-sm" id="upgrade-cost-${u.id}">
                            ${formatNumber(u.cost)} üí∞
                        </div>
                    </div>
                `;

                btn.onclick = () => {
                    if (game && game.buyUpgrade(u.id)) {
                        updateUI();
                        // Animation
                        btn.style.transform = "scale(0.98)";
                        setTimeout(() => (btn.style.transform = "scale(1)"), 50);
                    }
                };

                upgradesList.appendChild(btn);
            });
        }

        function updateUI() {
            if (!game) return;
            const state = game.state;

            if (currencyDisplay) currencyDisplay.innerText = formatNumber(state.currency);
            if (gpsDisplay)
                gpsDisplay.innerText = `${formatNumber(state.autoClickRate)} por segundo`;

            // Update Shop Buttons
            state.upgrades.forEach((u) => {
                const btn = document.getElementById(`upgrade-btn-${u.id}`);
                const countEl = document.getElementById(`upgrade-count-${u.id}`);
                const costEl = document.getElementById(`upgrade-cost-${u.id}`);

                if (!btn || !countEl || !costEl) return;

                const canAfford = state.currency >= u.cost;

                if (canAfford) {
                    btn.classList.remove("opacity-50", "cursor-not-allowed");
                    btn.classList.add("cursor-pointer", "hover:border-[#fbbf24]/50");
                    costEl.classList.remove("text-red-400");
                    costEl.classList.add("text-[#fbbf24]");
                } else {
                    btn.classList.add("opacity-50", "cursor-not-allowed");
                    btn.classList.remove("cursor-pointer", "hover:border-[#fbbf24]/50");
                    costEl.classList.remove("text-[#fbbf24]");
                    costEl.classList.add("text-red-400");
                }

                countEl.innerText = u.count.toString();
                costEl.innerText = `${formatNumber(u.cost)} üí∞`;
            });
        }

        // Loop for UI updates (auto-currency)
        function uiLoop() {
            if (game && game.state.autoClickRate > 0) {
                updateUI();
            }
            requestAnimationFrame(uiLoop);
        }

        window.addEventListener("resize", () => {
            if (game) game.resize();
        });

        // Save on unload
        window.addEventListener("beforeunload", () => {
            if (game) game.save();
        });

        initShop();
        updateUI();
        uiLoop();
    }
</script>
