---
import Layout from "../../layouts/Layout.astro";
import { sections } from "../../data/utilities/index";
import { getWidgetHtml } from "../../utils/widget";
import WidgetSidebar from "../../components/widgets/WidgetSidebar.astro";
import WidgetHeader from "../../components/widgets/WidgetHeader.astro";
import WidgetPreview from "../../components/widgets/WidgetPreview.astro";
import WidgetEmbedCodes from "../../components/widgets/WidgetEmbedCodes.astro";
import WidgetEducation from "../../components/widgets/WidgetEducation.astro";
import WidgetPlatforms from "../../components/widgets/WidgetPlatforms.astro";
import WidgetWordPressGuide from "../../components/widgets/WidgetWordPressGuide.astro";
import WidgetBenefits from "../../components/widgets/WidgetBenefits.astro";

const sectionsWithHtml = sections.map((section) => ({
    title: section.title,
    utilities: section.utilities.map((utility) => {
        const utilityName = utility.href.split("/").filter(Boolean).pop() || "utility";
        const widgetId = `wj-${utilityName}`;
        const widgetUrl = `https://www.jjlmoya.es${utility.href}${utility.href.endsWith("/") ? "" : "/"}?widget=true`;
        const cleanUrl = `https://www.jjlmoya.es${utility.href}`;

        return {
            ...utility,
            widgetId,
            html: getWidgetHtml({ widgetId, widgetUrl, cleanUrl }),
        };
    }),
}));

const flatUtilities = sectionsWithHtml.flatMap((s) => s.utilities);

const title = "Widget Studio: Calculadoras Gratis e Interacción para tu Web | jjlmoya";
const description =
    "Potencia tu sitio con herramientas interactivas. Inserta calculadoras de cocina, utilidades técnicas y widgets personalizados gratis. Optimizado para WordPress y sitios personalizados.";
const image = "/assets/widgets/hero.webp";
---

<Layout title={title} description={description} image={image} fullWidth={true}>
    <div
        class="flex flex-col lg:flex-row min-h-[calc(100vh-60px)] pt-0 overflow-hidden relative bg-slate-50 dark:bg-black"
    >
        <WidgetSidebar sections={sectionsWithHtml} />

        <main class="flex-grow flex flex-col overflow-y-auto custom-scrollbar relative">
            <WidgetHeader />

            <div class="p-4 lg:p-10 pb-32">
                <div class="max-w-5xl mx-auto space-y-8 lg:space-y-16">
                    <WidgetPreview />
                    <WidgetEmbedCodes />

                    <div class="mt-20 space-y-16">
                        <WidgetEducation />
                        <WidgetPlatforms />
                        <WidgetWordPressGuide />
                    </div>
                </div>
            </div>

            <WidgetBenefits />
        </main>
    </div>
</Layout>

<script is:inline define:vars={{ flatUtilities }}>
    const searchInput = document.getElementById("widget-search");
    const buttons = document.querySelectorAll(".utility-btn");
    const toggles = document.querySelectorAll(".category-toggle");
    const display = document.getElementById("canvas-inner");
    const canvas = document.getElementById("preview-canvas");
    const titleEl = document.getElementById("current-title");
    const descEl = document.getElementById("current-desc");
    const categoryBadge = document.getElementById("current-category-badge");
    const embedSection = document.getElementById("embed-section");
    const codeUrl = document.getElementById("code-url");
    const codeIframe = document.getElementById("code-iframe");
    const copyUrlBtn = document.getElementById("copy-url");
    const copyIframeBtn = document.getElementById("copy-iframe");

    toggles.forEach((toggle) => {
        toggle.addEventListener("click", () => {
            const group = toggle.closest(".category-group");
            const content = group.querySelector(".category-content");
            const chevron = toggle.querySelector(".chevron");
            const isHidden = content.classList.contains("hidden");

            document.querySelectorAll(".category-group").forEach((otherGroup) => {
                if (otherGroup !== group) {
                    otherGroup.querySelector(".category-content").classList.add("hidden");
                    otherGroup.querySelector(".chevron").classList.remove("rotate-180");
                    otherGroup.classList.remove(
                        "ring-1",
                        "ring-indigo-500/20",
                        "border-indigo-500/30"
                    );
                    otherGroup.classList.add("border-slate-100", "dark:border-slate-800/50");
                }
            });

            if (isHidden) {
                content.classList.remove("hidden");
                chevron.classList.add("rotate-180");
                group.classList.add("ring-1", "ring-indigo-500/20", "border-indigo-500/30");
                group.classList.remove("border-slate-100", "dark:border-slate-800/50");
            } else {
                content.classList.add("hidden");
                chevron.classList.remove("rotate-180");
                group.classList.remove("ring-1", "ring-indigo-500/20", "border-indigo-500/30");
                group.classList.add("border-slate-100", "dark:border-slate-800/50");
            }
        });
    });

    searchInput?.addEventListener("input", (e) => {
        const term = e.target.value.toLowerCase();

        document.querySelectorAll(".category-group").forEach((group) => {
            const groupContent = group.querySelector(".category-content");
            const groupToggle = group.querySelector(".category-toggle");
            const groupBtns = group.querySelectorAll(".utility-btn");
            const chevron = groupToggle.querySelector(".chevron");

            let groupHasMatch = false;

            groupBtns.forEach((btn) => {
                const title = btn.dataset.title.toLowerCase();
                const isMatch = title.includes(term);
                btn.style.display = isMatch ? "flex" : "none";
                if (isMatch) groupHasMatch = true;
            });

            group.style.display = groupHasMatch || term === "" ? "block" : "none";

            if (term !== "" && groupHasMatch) {
                groupContent.classList.remove("hidden");
                chevron.classList.add("rotate-180");
            } else if (term === "") {
                groupContent.classList.add("hidden");
                chevron.classList.remove("rotate-180");
            }
        });
    });

    document.querySelectorAll(".bg-toggle").forEach((btn) => {
        btn.addEventListener("click", () => {
            const bg = btn.dataset.bg;
            document.querySelectorAll(".bg-toggle").forEach((b) => b.classList.remove("active-bg"));
            btn.classList.add("active-bg");

            canvas.className =
                "rounded-[2rem] p-0 sm:p-10 min-h-[300px] flex items-center justify-center border transition-all duration-500 shadow-2xl relative overflow-hidden";

            if (bg === "white") canvas.classList.add("bg-white", "border-slate-200");
            if (bg === "black") canvas.classList.add("bg-black", "border-slate-800");
            if (bg === "grid")
                canvas.classList.add(
                    "bg-slate-50",
                    "border-slate-200",
                    "bg-[linear-gradient(to_right,#80808011_1px,transparent_1px),linear-gradient(to_bottom,#80808011_1px,transparent_1px)]",
                    "bg-[size:14px_24px]"
                );
        });
    });

    window.addEventListener("message", (e) => {
        if (e.data && e.data.jjlmoyaId && e.data.jjlmoyaHeight) {
            const iframe = document.getElementById(e.data.jjlmoyaId);
            if (iframe) {
                iframe.style.height = e.data.jjlmoyaHeight + 2 + "px";
                iframe.style.opacity = "1";
            }
            const loader = document.getElementById(e.data.jjlmoyaId + "-loader");
            if (loader) {
                loader.style.opacity = "0";
                setTimeout(() => (loader.style.display = "none"), 400);
            }
        }
    });

    buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
            buttons.forEach((b) => b.classList.remove("active-tool"));
            btn.classList.add("active-tool");

            const href = btn.dataset.href;
            const category = btn.dataset.category;
            const utData = flatUtilities.find((u) => u.href === href);
            if (!utData) return;

            titleEl.textContent = utData.title;
            categoryBadge.textContent = category;
            categoryBadge.classList.remove("opacity-0");
            descEl.textContent = utData.description || "Widget profesional para tu sitio web.";

            codeUrl.textContent = `https://www.jjlmoya.es${href}`;
            codeIframe.textContent = utData.html.trim();

            embedSection.classList.remove("hidden");
            setTimeout(() => {
                embedSection.classList.remove("opacity-0", "translate-y-4", "pointer-events-none");
            }, 50);

            const range = document.createRange();
            const fragment = range.createContextualFragment(utData.html);
            display.innerHTML = "";
            display.appendChild(fragment);

            if (window.innerWidth < 1024) {
                titleEl.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        });
    });

    function setupCopy(btn, target) {
        btn.addEventListener("click", () => {
            const text = target.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const original = btn.innerHTML;
                btn.innerHTML =
                    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-white"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                setTimeout(() => (btn.innerHTML = original), 2000);
            });
        });
    }
    setupCopy(copyUrlBtn, codeUrl);
    setupCopy(copyIframeBtn, codeIframe);
</script>

<style is:global>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.2);
        border-radius: 10px;
    }

    .active-bg {
        border-color: #4f46e5 !important;
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15);
    }

    .active-tool {
        color: #4f46e5 !important;
        border-color: #4f46e5 !important;
        background-color: rgba(79, 70, 229, 0.05) !important;
    }

    @media (min-width: 1024px) {
        .active-tool {
            background-color: rgba(79, 70, 229, 0.08) !important;
            border: none !important;
        }
    }
</style>
