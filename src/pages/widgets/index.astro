---
import Layout from "../../layouts/Layout.astro";
import { sections } from "../../data/utilities/index";
import { getWidgetHtml } from "../../utils/widget";
import { Icon } from "astro-icon/components";

const sectionsWithHtml = sections.map((section) => ({
    title: section.title,
    utilities: section.utilities.map((utility) => {
        const utilityName = utility.href.split("/").filter(Boolean).pop() || "utility";
        const widgetId = `wj-${utilityName}`;
        const widgetUrl = `${utility.href}${utility.href.endsWith("/") ? "" : "/"}?widget=true`;
        const cleanUrl = utility.href;

        return {
            ...utility,
            widgetId,
            html: getWidgetHtml({ widgetId, widgetUrl, cleanUrl }),
        };
    }),
}));

const flatUtilities = sectionsWithHtml.flatMap((s) => s.utilities);

const title = "Widget Studio: Calculadoras Gratis para tu Web | jjlmoya";
const description =
    "Convierte tu web en una plataforma interactiva. Inserta nuestras calculadoras y herramientas gratis con un solo clic. Widgets 100% personalizables, transparentes y optimizados para SEO.";
---

<Layout title={title} description={description} fullWidth={true}>
    <div
        class="flex flex-col lg:flex-row min-h-[calc(100vh-60px)] pt-0 overflow-hidden relative bg-slate-50 dark:bg-black"
    >
        <aside
            class="w-full lg:w-80 border-b lg:border-b-0 lg:border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-zinc-950 flex flex-col z-30 shrink-0"
        >
            <div class="p-4 lg:p-6 border-b border-slate-100 dark:border-slate-900">
                <h1
                    class="text-xl font-black tracking-tight text-indigo-600 dark:text-indigo-400 flex items-center gap-2"
                >
                    <Icon name="mdi:widgets-outline" class="w-6 h-6" />
                    Studio
                </h1>
                <p class="text-[10px] text-slate-500 mt-1 uppercase tracking-[0.2em] font-bold">
                    Catálogo Categorizado
                </p>

                <div class="mt-6 relative">
                    <input
                        type="text"
                        id="widget-search"
                        placeholder="Buscar herramienta..."
                        class="w-full pl-10 pr-4 py-2.5 bg-slate-100 dark:bg-slate-900 border-none rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 transition-all font-medium"
                    />
                    <Icon
                        name="mdi:magnify"
                        class="absolute left-3 top-2.5 w-5 h-5 text-slate-400"
                    />
                </div>
            </div>

            <nav
                class="flex-grow overflow-y-auto px-4 py-4 lg:py-6 space-y-2 lg:space-y-4 custom-scrollbar scroll-smooth"
            >
                {
                    sectionsWithHtml.map((section, idx) => {
                        const isOpenByDefault =
                            section.title.toLowerCase().includes("cocina") ||
                            (idx === 0 &&
                                !sectionsWithHtml.some((s) =>
                                    s.title.toLowerCase().includes("cocina")
                                ));

                        return (
                            <div
                                class={`category-group border rounded-2xl overflow-hidden transition-all duration-300 ${isOpenByDefault ? "ring-1 ring-indigo-500/20 border-indigo-500/30" : "border-slate-100 dark:border-slate-800/50"}`}
                            >
                                <button
                                    class="category-toggle w-full flex items-center justify-between px-4 py-4 bg-slate-50/50 dark:bg-zinc-900/50 hover:bg-slate-100 dark:hover:bg-zinc-900 transition-colors group"
                                    data-group={idx}
                                >
                                    <span class="text-[10px] lg:text-[11px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-[0.2em] group-hover:text-indigo-500 transition-colors">
                                        {section.title}
                                    </span>
                                    <Icon
                                        name="mdi:chevron-down"
                                        class={`w-4 h-4 text-slate-300 group-hover:text-indigo-400 transform transition-transform duration-300 chevron ${isOpenByDefault ? "rotate-180" : ""}`}
                                    />
                                </button>

                                <div
                                    class={`category-content overflow-hidden bg-white dark:bg-zinc-950 ${isOpenByDefault ? "" : "hidden"}`}
                                >
                                    <div class="p-2 space-y-1">
                                        {section.utilities.map((u) => (
                                            <button
                                                class="utility-btn w-full text-left px-4 py-3 rounded-xl text-xs lg:text-[13px] font-bold transition-all hover:bg-indigo-50 dark:hover:bg-indigo-900/10 flex flex-col group active:scale-[0.98]"
                                                data-href={u.href}
                                                data-title={u.title}
                                                data-desc={u.description}
                                                data-category={section.title}
                                            >
                                                <span class="text-slate-600 dark:text-slate-400 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors uppercase tracking-wider">
                                                    {u.title}
                                                </span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        );
                    })
                }
            </nav>
        </aside>

        <main class="flex-grow flex flex-col overflow-y-auto custom-scrollbar relative">
            <div
                class="sticky top-0 z-20 bg-slate-50/90 dark:bg-black/90 backdrop-blur-md px-6 lg:px-10 py-4 lg:py-6 border-b border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4"
            >
                <div class="text-center sm:text-left w-full">
                    <div
                        id="current-category-badge"
                        class="inline-block px-2 py-0.5 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 text-[9px] font-black uppercase tracking-widest rounded-md mb-2 opacity-0 transition-opacity"
                    >
                        Categoría
                    </div>
                    <h2
                        id="current-title"
                        class="text-xl lg:text-3xl font-black tracking-tighter text-slate-900 dark:text-white leading-tight"
                    >
                        Explorador de Widgets
                    </h2>
                    <p
                        id="current-desc"
                        class="hidden sm:block text-sm text-slate-500 dark:text-slate-400 font-light mt-1"
                    >
                        Personaliza e integra herramientas en tu web gratis.
                    </p>
                </div>

                <div
                    class="flex items-center gap-2 bg-white dark:bg-zinc-900 p-1.5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm shrink-0"
                >
                    <button
                        data-bg="white"
                        class="bg-toggle w-9 h-9 rounded-xl bg-white border border-slate-200 shadow-sm active-bg"
                        title="Fondo Blanco"></button>
                    <button
                        data-bg="black"
                        class="bg-toggle w-9 h-9 rounded-xl bg-black border border-slate-800"
                        title="Fondo Negro"></button>
                    <button
                        data-bg="grid"
                        class="bg-toggle w-9 h-9 rounded-xl bg-slate-100 border border-slate-200 overflow-hidden relative"
                        title="Fondo Cuadrícula"
                    >
                        <div
                            class="absolute inset-0 bg-[linear-gradient(to_right,#80808022_1px,transparent_1px),linear-gradient(to_bottom,#80808022_1px,transparent_1px)] bg-[size:4px_4px]"
                        >
                        </div>
                    </button>
                </div>
            </div>

            <div class="p-4 lg:p-10 pb-32">
                <div class="max-w-5xl mx-auto space-y-8 lg:space-y-16">
                    <section id="preview-section" class="space-y-4">
                        <div
                            class="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-widest px-2"
                        >
                            <Icon name="mdi:eye-outline" class="w-4 h-4" />
                            Vista Previa
                        </div>
                        <div
                            id="preview-canvas"
                            class="bg-white rounded-[2rem] p-0 sm:p-10 min-h-[300px] flex items-center justify-center border border-slate-200 dark:border-slate-800 shadow-2xl transition-all duration-500 relative overflow-hidden"
                        >
                            <div id="canvas-inner" class="w-full">
                                <div
                                    id="empty-canvas-msg"
                                    class="flex flex-col items-center justify-center text-center p-12 lg:p-20 space-y-4"
                                >
                                    <div
                                        class="w-16 h-16 lg:w-20 lg:h-20 bg-indigo-50 dark:bg-indigo-950/30 rounded-full flex items-center justify-center"
                                    >
                                        <Icon
                                            name="mdi:mouse-left-click-outline"
                                            class="w-8 h-8 lg:w-10 lg:h-10 text-indigo-500"
                                        />
                                    </div>
                                    <p
                                        class="text-slate-400 font-medium italic text-sm lg:text-base"
                                    >
                                        Elige una utilidad para empezar
                                    </p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <div
                        id="embed-section"
                        class="opacity-0 translate-y-4 transition-all duration-700 pointer-events-none"
                    >
                        <div class="grid md:grid-cols-2 gap-6 lg:gap-10">
                            <div
                                class="bg-white dark:bg-zinc-950 rounded-3xl p-6 lg:p-8 border border-slate-200 dark:border-slate-800 shadow-sm space-y-6"
                            >
                                <div class="flex items-center justify-between">
                                    <h3
                                        class="text-xs font-black uppercase tracking-widest text-indigo-600 dark:text-indigo-400"
                                    >
                                        Enlace oEmbed
                                    </h3>
                                    <Icon name="mdi:link-variant" class="w-5 h-5 text-slate-300" />
                                </div>
                                <p
                                    class="text-[11px] text-slate-500 leading-relaxed uppercase tracking-wider font-bold opacity-70 italic"
                                >
                                    Ideal para redes sociales y WordPress.
                                </p>
                                <div class="flex items-center gap-2">
                                    <code
                                        id="code-url"
                                        class="flex-grow bg-slate-50 dark:bg-black p-4 rounded-2xl text-[10px] sm:text-xs font-mono text-slate-600 dark:text-slate-400 truncate border border-slate-100 dark:border-slate-900 italic"
                                        >https://jjlmoya.es/...</code
                                    >
                                    <button
                                        id="copy-url"
                                        class="p-4 bg-indigo-600 hover:bg-slate-900 text-white rounded-2xl transition-all shadow-lg shadow-indigo-600/20 active:scale-95 shrink-0"
                                    >
                                        <Icon name="mdi:content-copy" class="w-5 h-5" />
                                    </button>
                                </div>
                            </div>

                            <div
                                class="bg-white dark:bg-zinc-950 rounded-3xl p-6 lg:p-8 border border-slate-200 dark:border-slate-800 shadow-sm space-y-6"
                            >
                                <div class="flex items-center justify-between">
                                    <h3
                                        class="text-xs font-black uppercase tracking-widest text-indigo-600 dark:text-indigo-400"
                                    >
                                        Código iFrame
                                    </h3>
                                    <Icon name="mdi:code-tags" class="w-5 h-5 text-slate-300" />
                                </div>
                                <p
                                    class="text-[11px] text-slate-500 leading-relaxed uppercase tracking-wider font-bold opacity-70 italic"
                                >
                                    Para blogs y sitios web personalizados.
                                </p>
                                <div class="flex flex-col gap-3">
                                    <div class="relative">
                                        <pre
                                            id="code-iframe"
                                            class="bg-slate-50 dark:bg-black p-4 rounded-2xl text-[9px] sm:text-[10px] font-mono text-slate-500 dark:text-slate-500 overflow-x-auto border border-slate-100 dark:border-slate-900 max-h-24">Cargando...</pre>
                                        <div
                                            class="absolute inset-0 bg-gradient-to-t from-slate-50 dark:from-black to-transparent pointer-events-none opacity-40"
                                        >
                                        </div>
                                    </div>
                                    <button
                                        id="copy-iframe"
                                        class="w-full py-4 bg-slate-900 dark:bg-indigo-600 hover:opacity-90 text-white rounded-2xl text-xs font-black flex items-center justify-center gap-3 transition-all active:scale-95 shadow-xl"
                                    >
                                        <Icon name="mdi:content-copy" class="w-4 h-4" />
                                        COPIAR iFRAME
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script is:inline define:vars={{ flatUtilities }}>
        const searchInput = document.getElementById("widget-search");
        const buttons = document.querySelectorAll(".utility-btn");
        const toggles = document.querySelectorAll(".category-toggle");
        const display = document.getElementById("canvas-inner");
        const canvas = document.getElementById("preview-canvas");
        const titleEl = document.getElementById("current-title");
        const descEl = document.getElementById("current-desc");
        const categoryBadge = document.getElementById("current-category-badge");
        const embedSection = document.getElementById("embed-section");
        const codeUrl = document.getElementById("code-url");
        const codeIframe = document.getElementById("code-iframe");
        const copyUrlBtn = document.getElementById("copy-url");
        const copyIframeBtn = document.getElementById("copy-iframe");

        toggles.forEach((toggle) => {
            toggle.addEventListener("click", () => {
                const group = toggle.closest(".category-group");
                const content = group.querySelector(".category-content");
                const chevron = toggle.querySelector(".chevron");
                const isHidden = content.classList.contains("hidden");

                document.querySelectorAll(".category-group").forEach((otherGroup) => {
                    if (otherGroup !== group) {
                        otherGroup.querySelector(".category-content").classList.add("hidden");
                        otherGroup.querySelector(".chevron").classList.remove("rotate-180");
                        otherGroup.classList.remove(
                            "ring-1",
                            "ring-indigo-500/20",
                            "border-indigo-500/30"
                        );
                        otherGroup.classList.add("border-slate-100", "dark:border-slate-800/50");
                    }
                });

                if (isHidden) {
                    content.classList.remove("hidden");
                    chevron.classList.add("rotate-180");
                    group.classList.add("ring-1", "ring-indigo-500/20", "border-indigo-500/30");
                    group.classList.remove("border-slate-100", "dark:border-slate-800/50");
                } else {
                    content.classList.add("hidden");
                    chevron.classList.remove("rotate-180");
                    group.classList.remove("ring-1", "ring-indigo-500/20", "border-indigo-500/30");
                    group.classList.add("border-slate-100", "dark:border-slate-800/50");
                }
            });
        });

        searchInput?.addEventListener("input", (e) => {
            const term = e.target.value.toLowerCase();

            document.querySelectorAll(".category-group").forEach((group) => {
                const groupContent = group.querySelector(".category-content");
                const groupToggle = group.querySelector(".category-toggle");
                const groupBtns = group.querySelectorAll(".utility-btn");
                const chevron = groupToggle.querySelector(".chevron");

                let groupHasMatch = false;

                groupBtns.forEach((btn) => {
                    const title = btn.dataset.title.toLowerCase();
                    const isMatch = title.includes(term);
                    btn.style.display = isMatch ? "flex" : "none";
                    if (isMatch) groupHasMatch = true;
                });

                group.style.display = groupHasMatch || term === "" ? "block" : "none";

                if (term !== "" && groupHasMatch) {
                    groupContent.classList.remove("hidden");
                    chevron.classList.add("rotate-180");
                } else if (term === "") {
                    groupContent.classList.add("hidden");
                    chevron.classList.remove("rotate-180");
                }
            });
        });

        document.querySelectorAll(".bg-toggle").forEach((btn) => {
            btn.addEventListener("click", () => {
                const bg = btn.dataset.bg;
                document
                    .querySelectorAll(".bg-toggle")
                    .forEach((b) => b.classList.remove("active-bg"));
                btn.classList.add("active-bg");

                canvas.className =
                    "rounded-[2rem] p-0 sm:p-10 min-h-[300px] flex items-center justify-center border transition-all duration-500 shadow-2xl relative overflow-hidden";

                if (bg === "white") canvas.classList.add("bg-white", "border-slate-200");
                if (bg === "black") canvas.classList.add("bg-black", "border-slate-800");
                if (bg === "grid")
                    canvas.classList.add(
                        "bg-slate-50",
                        "border-slate-200",
                        "bg-[linear-gradient(to_right,#80808011_1px,transparent_1px),linear-gradient(to_bottom,#80808011_1px,transparent_1px)]",
                        "bg-[size:14px_24px]"
                    );
            });
        });

        window.addEventListener("message", (e) => {
            if (e.data && e.data.jjlmoyaId && e.data.jjlmoyaHeight) {
                const iframe = document.getElementById(e.data.jjlmoyaId);
                if (iframe) {
                    iframe.style.height = e.data.jjlmoyaHeight + 2 + "px";
                    iframe.style.opacity = "1";
                }
                const loader = document.getElementById(e.data.jjlmoyaId + "-loader");
                if (loader) {
                    loader.style.opacity = "0";
                    setTimeout(() => (loader.style.display = "none"), 400);
                }
            }
        });

        buttons.forEach((btn) => {
            btn.addEventListener("click", () => {
                buttons.forEach((b) => b.classList.remove("active-tool"));
                btn.classList.add("active-tool");

                const href = btn.dataset.href;
                const category = btn.dataset.category;
                const utData = flatUtilities.find((u) => u.href === href);
                if (!utData) return;

                titleEl.textContent = utData.title;
                categoryBadge.textContent = category;
                categoryBadge.classList.remove("opacity-0");
                descEl.textContent = utData.description || "Widget profesional para tu sitio web.";

                codeUrl.textContent = `https://jjlmoya.es${href}`;
                codeIframe.textContent = utData.html.trim();

                embedSection.classList.remove("opacity-0", "translate-y-4", "pointer-events-none");

                const range = document.createRange();
                const fragment = range.createContextualFragment(utData.html);
                display.innerHTML = "";
                display.appendChild(fragment);

                if (window.innerWidth < 1024) {
                    titleEl.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            });
        });

        function setupCopy(btn, target) {
            btn.addEventListener("click", () => {
                const text = target.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    const original = btn.innerHTML;
                    btn.innerHTML =
                        '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-white"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                    setTimeout(() => (btn.innerHTML = original), 2000);
                });
            });
        }
        setupCopy(copyUrlBtn, codeUrl);
        setupCopy(copyIframeBtn, codeIframe);
    </script>

    <style is:global>
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.2);
            border-radius: 10px;
        }

        .active-bg {
            border-color: #4f46e5 !important;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15);
        }

        .active-tool {
            color: #4f46e5 !important;
            border-color: #4f46e5 !important;
            background-color: rgba(79, 70, 229, 0.05) !important;
        }

        @media (min-width: 1024px) {
            .active-tool {
                background-color: rgba(79, 70, 229, 0.08) !important;
                border: none !important;
            }
        }
    </style>
</Layout>
