---
import Layout from "../../layouts/Layout.astro";
import LibraryHeader from "../../components/pages/biblioteca/LibraryHeader.astro";
import LibraryInput from "../../components/pages/biblioteca/LibraryInput.astro";
import SleepSection from "../../components/pages/biblioteca/SleepSection.astro";
import WaterSection from "../../components/pages/biblioteca/WaterSection.astro";
import StepsSection from "../../components/pages/biblioteca/StepsSection.astro";
import BreathsSection from "../../components/pages/biblioteca/BreathsSection.astro";
import HeartbeatSection from "../../components/pages/biblioteca/HeartbeatSection.astro";
---

<Layout
    title="biblioteca de tu vida"
    description="Visualiza tu vida en datos: horas de sueño, litros de agua, pasos caminados y más. Una perspectiva diferente sobre el tiempo vivido."
>
    <div class="min-h-screen bg-[#f4f1ea] text-[#4a4a4a] font-serif p-8">
        <div class="max-w-4xl mx-auto">
            <LibraryHeader>
                <LibraryInput />
            </LibraryHeader>

            <div id="library-container" class="hidden space-y-16">
                <SleepSection />
                <WaterSection />
                <StepsSection />
                <BreathsSection />
                <HeartbeatSection />
            </div>
        </div>
    </div>
</Layout>

<script>
    import {
        calculateLifeStats,
        calculateSleepStats,
        calculateWaterStats,
        calculateStepsStats,
        calculateBreathStats,
        calculateHeartbeatStats,
    } from "../../utils/libraryLogic";

    document.addEventListener("astro:page-load", () => {
        const monthInput = document.getElementById("month") as HTMLSelectElement;
        const yearInput = document.getElementById("year") as HTMLSelectElement;
        const generateBtn = document.getElementById("generate-btn");
        const libraryContainer = document.getElementById("library-container");

        const shelfSleep = document.getElementById("shelf-sleep");
        const statSleep = document.getElementById("stat-sleep");

        const shelfWater = document.getElementById("shelf-water");
        const statWater = document.getElementById("stat-water");

        const shelfSteps = document.getElementById("shelf-steps");
        const statSteps = document.getElementById("stat-steps");

        const shelfBreaths = document.getElementById("shelf-breaths");
        const statBreaths = document.getElementById("stat-breaths");

        const heartbeatCounter = document.getElementById("heartbeat-counter");

        const generateLibrary = () => {
            const m = parseInt(monthInput.value);
            const y = parseInt(yearInput.value);
            const birthdate = new Date(y, m, 1);

            if (isNaN(birthdate.getTime())) return;

            const lifeStats = calculateLifeStats(birthdate);

            if (!lifeStats) {
                if (libraryContainer) {
                    libraryContainer.classList.remove("hidden");
                    libraryContainer.innerHTML = `
                    <div class="text-center py-20">
                        <h2 class="text-4xl font-serif italic text-[#2c2c2c] mb-4">Ojalá vivas una gran vida ✨</h2>
                        <p class="text-xl opacity-60">El futuro está por escribir.</p>
                    </div>
                 `;
                }
                return;
            }

            const { daysAlive, hoursAlive } = lifeStats;

            if (!libraryContainer) return;
            libraryContainer.classList.remove("hidden");

            if (!document.getElementById("shelf-sleep")) {
                window.location.reload();
                return;
            }

            const { hoursSlept, booksCount } = calculateSleepStats(hoursAlive);
            let sleepHtml = "";
            const colors = ["bg-[#4a6fa5]", "bg-[#3e5c8a]", "bg-[#2d456b]", "bg-[#1f304a]"];

            for (let i = 0; i < booksCount; i++) {
                const height = 40 + Math.random() * 60;
                const color = colors[Math.floor(Math.random() * colors.length)];
                sleepHtml += `<div class="${color} w-5 rounded-sm mx-[1px] shadow-sm hover:-translate-y-2 transition-transform cursor-pointer border-l border-white/10 border-r border-black/20" style="height: ${height}px;" title="Volumen ${i + 1}: 1000 horas de sueños"></div>`;
            }
            if (shelfSleep) shelfSleep.innerHTML = sleepHtml;
            if (statSleep)
                statSleep.innerText = `${hoursSlept.toLocaleString()} horas dormidas (${daysAlive} días vividos)`;

            const { litersDrunk, bottlesCount } = calculateWaterStats(daysAlive);
            let waterHtml = "";
            const dropSvg = `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-blue-500"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`;

            for (let i = 0; i < bottlesCount; i++) {
                waterHtml += `<div class="hover:scale-125 transition-transform cursor-help" title="500 Litros">${dropSvg}</div>`;
            }
            if (shelfWater) shelfWater.innerHTML = waterHtml;
            if (statWater)
                statWater.innerText = `${litersDrunk.toLocaleString()} litros de agua consumidos`;

            const { stepsTaken, stepsCount } = calculateStepsStats(daysAlive);
            let stepsHtml = "";
            const footSvg = `<svg viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-orange-800 opacity-60"><path d="M13.5,5.5c1.1,0,2-0.9,2-2s-0.9-2-2-2s-2,0.9-2,2S12.4,5.5,13.5,5.5z M13.5,6.5c-2.2,0-4,1.8-4,4v6c0,2.2,1.8,4,4,4s4-1.8,4-4v-6C17.5,8.3,15.7,6.5,13.5,6.5z"/></svg>`;

            for (let i = 0; i < stepsCount; i++) {
                stepsHtml += `<div class="hover:scale-125 transition-transform cursor-help" title="250.000 Pasos">${footSvg}</div>`;
            }
            if (shelfSteps) shelfSteps.innerHTML = stepsHtml;
            if (statSteps) statSteps.innerText = `${stepsTaken.toLocaleString()} pasos caminados`;

            const { breathsTaken, breathsCount } = calculateBreathStats(daysAlive);
            let breathsHtml = "";
            const cloudSvg = `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-sky-300 opacity-80"><path d="M17.5,19C19.97,19 22,16.97 22,14.5C22,12.12 20.18,10.17 17.85,10.04C17.46,6.86 14.75,4.5 11.5,4.5C8.13,4.5 5.27,7.05 5.03,10.43C2.72,10.9 1,12.95 1,15.5C1,18.53 3.47,21 6.5,21H17.5V19Z"/></svg>`;

            for (let i = 0; i < breathsCount; i++) {
                breathsHtml += `<div class="hover:scale-125 transition-transform cursor-help animate-pulse" style="animation-duration: ${2 + Math.random()}s" title="500.000 Respiraciones">${cloudSvg}</div>`;
            }
            if (shelfBreaths) shelfBreaths.innerHTML = breathsHtml;

            const { totalHeartbeats } = calculateHeartbeatStats(daysAlive);
            let totalBreaths = breathsTaken;

            let currentHeart = 0;
            const step = totalHeartbeats / 100;

            if ((window as any).heartInterval) clearInterval((window as any).heartInterval);
            if ((window as any).liveInterval) clearInterval((window as any).liveInterval);

            const animationInterval = setInterval(() => {
                currentHeart += step;
                if (currentHeart >= totalHeartbeats) {
                    currentHeart = totalHeartbeats;
                    clearInterval(animationInterval);
                    startLiveUpdates(totalHeartbeats, totalBreaths);
                }
                if (heartbeatCounter)
                    heartbeatCounter.innerText = Math.floor(currentHeart).toLocaleString();
                if (statBreaths)
                    statBreaths.innerText = `${Math.floor(totalBreaths).toLocaleString()} respiraciones tomadas`;
            }, 20);

            (window as any).heartInterval = animationInterval;
        };

        const startLiveUpdates = (startHeartbeats: number, startBreaths: number) => {
            let currentH = startHeartbeats;
            let currentB = startBreaths;

            const heartRatePerMs = 80 / 60 / 1000;
            const breathRatePerMs = 20 / 60 / 1000;

            let lastTime = Date.now();

            const liveInterval = setInterval(() => {
                const now = Date.now();
                const delta = now - lastTime;
                lastTime = now;

                currentH += heartRatePerMs * delta;
                currentB += breathRatePerMs * delta;

                if (heartbeatCounter)
                    heartbeatCounter.innerText = Math.floor(currentH).toLocaleString();
                if (statBreaths)
                    statBreaths.innerText = `${Math.floor(currentB).toLocaleString()} respiraciones tomadas`;
            }, 100);

            (window as any).liveInterval = liveInterval;
        };

        generateBtn?.addEventListener("click", generateLibrary);
    });
</script>
