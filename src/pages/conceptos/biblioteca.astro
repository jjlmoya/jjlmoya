---
import Layout from "../../layouts/Layout.astro";
import DeathDialogue from "../../components/pages/biblioteca/DeathDialogue.astro";
import DeathInput from "../../components/pages/biblioteca/DeathInput.astro";
import LifeBook from "../../components/pages/biblioteca/LifeBook.astro";
---

<Layout
    title="La Biblioteca de la Muerte - El libro de tu vida"
    description="Tu vida es un libro en la inmensa biblioteca del tiempo. Deja que ELLA te lo muestre."
    fullWidth={true}
    footerClass="bg-black text-white"
    image="/images/biblioteca_og_scythe.webp"
>
    <!-- Google Fonts for Pratchett Vibe -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&display=swap"
        rel="stylesheet"
    />

    <main
        class="min-h-screen bg-[#0c0a09] text-[#e7e5e4] overflow-hidden relative flex flex-col items-center justify-center p-4"
    >
        <div class="absolute inset-0 pointer-events-none opacity-20"></div>

        <div id="stage-intro" class="z-10 w-full max-w-4xl transition-opacity duration-1000">
            <div id="intro-initial" class="transition-opacity duration-1000">
                <DeathDialogue
                    text="DISCULPAD LA MOLESTIA. HAY DEMASIADOS LIBROS AQU√ç Y PARECE QUE CADA VEZ SOIS M√ÅS. NECESITO AYUDA PARA LOCALIZAR EL VUESTRO."
                    speed={150}
                    delay={400}
                    mode="word"
                />
            </div>
            <div id="intro-next" class="hidden transition-opacity duration-1000 opacity-0">
                <DeathDialogue
                    text="¬øEN QU√â A√ëO EMPEZASTEIS?"
                    speed={150}
                    delay={0}
                    autoStart={false}
                    mode="word"
                />
            </div>

            <div id="intro-month" class="hidden transition-opacity duration-1000 opacity-0">
                <DeathDialogue
                    text="COMPRENDO. NECESITO M√ÅS PRECISI√ìN. EL TIEMPO ES UN ASUNTO DELICADO Y LAS ESTANTER√çAS SON INFINITAS. <br><br> ¬øY EL MES?"
                    speed={150}
                    autoStart={false}
                    mode="word"
                />
            </div>

            <DeathInput />
        </div>

        <!-- STAGE 2: CONFIRMATION -->
        <div
            id="stage-confirmation"
            class="hidden z-10 w-full max-w-4xl transition-opacity duration-1000"
        >
            <DeathDialogue
                text="AH, S√ç. AQU√ç EST√Å. <br><br> VAYA... ES UN TOMO M√ÅS PESADO DE LO QUE ESPERABA. <br><br> VEAMOS QU√â DICE."
                speed={150}
                delay={500}
                mode="word"
            />
        </div>

        <!-- STAGE 3: THE BOOK -->
        <div
            id="stage-book"
            class="hidden z-10 w-full h-screen absolute inset-0 transition-opacity duration-1000 opacity-0"
        >
            <LifeBook />
        </div>

        <!-- Death of Rats Easter Egg -->
        <div
            id="death-of-rats"
            class="fixed bottom-4 right-8 z-50 text-xl cursor-pointer hover:scale-125 transition-transform duration-200 select-none opacity-50 hover:opacity-100"
            title="¬°IIIIK!"
        >
            üêÄ
        </div>
    </main>

    <script is:inline>
        document.addEventListener("DOMContentLoaded", () => {
            // --- RAT EASTER EGG ---
            const rat = document.getElementById("death-of-rats");
            if (rat) {
                // Clone to remove old listeners if any, just to be safe and clean
                const newRat = rat.cloneNode(true);
                rat.parentNode.replaceChild(newRat, rat);
                newRat.addEventListener("click", () => {
                    if (window.toast) {
                        window.toast.show("¬°IIIIK!", "info");
                    }
                });
            }

            // --- STATE MANAGEMENT ---
            const stageIntro = document.getElementById("stage-intro");
            const introInitial = document.getElementById("intro-initial");
            const introNext = document.getElementById("intro-next");
            const introMonth = document.getElementById("intro-month");
            const stageConfirmation = document.getElementById("stage-confirmation");
            const stageBook = document.getElementById("stage-book");

            // --- CHECK EXISTING SESSION ---
            const storedData = localStorage.getItem("life-birthdate");
            let hasSkippedIntro = false;

            if (storedData) {
                try {
                    const { year, month } = JSON.parse(storedData);
                    if (year && month !== undefined) {
                        hasSkippedIntro = true;
                        // Skip directly to book
                        if (stageIntro) stageIntro.classList.add("hidden");
                        if (stageConfirmation) stageConfirmation.classList.add("hidden");

                        if (stageBook) {
                            stageBook.classList.remove("hidden");
                            stageBook.classList.remove("opacity-0");

                            // Dispatch event for LifeBook
                            setTimeout(() => {
                                const initEvent = new CustomEvent("init-life-book", {
                                    detail: { year, month },
                                });
                                document.dispatchEvent(initEvent);
                            }, 100);
                        }
                    }
                } catch (e) {
                    console.error("Error parsing stored birthdate", e);
                }
            }

            // --- SEQUENCE LOGIC (Only if not skipped) ---
            if (!hasSkippedIntro) {
                // Re-query elements to ensure we have the fresh ones from the current page render
                const firstDialogue = document.querySelector(
                    "#intro-initial .death-dialogue-container"
                );
                const nextDialogue = document.querySelector(
                    "#intro-next .death-dialogue-container"
                );
                const monthDialogue = document.querySelector(
                    "#intro-month .death-dialogue-container"
                );

                // 1. First Dialogue Complete -> Show Year Question
                if (firstDialogue) {
                    // We use a named handler to avoid duplication if we weren't cloning,
                    // but since these are fresh DOM nodes on navigation, addEventListener is fine.
                    firstDialogue.addEventListener("dialogue-complete", () => {
                        setTimeout(() => {
                            if (introInitial) introInitial.style.opacity = "0";
                            setTimeout(() => {
                                if (introInitial) introInitial.classList.add("hidden");
                                if (introNext) {
                                    introNext.classList.remove("hidden");
                                    void introNext.offsetWidth; // Force reflow
                                    introNext.classList.remove("opacity-0");

                                    // Trigger typing for the next dialogue
                                    setTimeout(() => {
                                        if (nextDialogue)
                                            nextDialogue.dispatchEvent(new Event("start-typing"));
                                    }, 500);
                                }
                            }, 1000);
                        }, 4000); // Wait a bit for user to read
                    });
                }

                // 2. Year Question Complete -> Show Year Input
                if (nextDialogue) {
                    nextDialogue.addEventListener("dialogue-complete", () => {
                        setTimeout(() => {
                            document.dispatchEvent(new Event("show-death-year-input"));
                        }, 500);
                    });
                }

                // 3. Month Question Complete -> Show Month Input
                if (monthDialogue) {
                    monthDialogue.addEventListener("dialogue-complete", () => {
                        setTimeout(() => {
                            document.dispatchEvent(new Event("show-death-month-input"));
                        }, 500);
                    });
                }

                // --- EVENT HANDLERS FOR INPUTS ---

                // Handler for Year Selection
                const handleYearSelected = () => {
                    if (introNext) introNext.style.opacity = "0";
                    setTimeout(() => {
                        if (introNext) introNext.classList.add("hidden");
                        if (introMonth) {
                            introMonth.classList.remove("hidden");
                            void introMonth.offsetWidth;
                            introMonth.classList.remove("opacity-0");

                            // Trigger typing for month dialogue
                            setTimeout(() => {
                                if (monthDialogue)
                                    monthDialogue.dispatchEvent(new Event("start-typing"));
                            }, 500);
                        }
                    }, 1000);
                };

                // Handler for Birthdate (Final) Selection
                const handleBirthdateSelected = (e) => {
                    const { year, month } = e.detail;
                    window.localStorage.setItem("life-birthdate", JSON.stringify({ year, month }));

                    if (stageIntro) {
                        stageIntro.style.opacity = "0";
                        setTimeout(() => {
                            stageIntro.classList.add("hidden");
                            if (stageConfirmation) stageConfirmation.classList.remove("hidden");
                        }, 1000);
                    }

                    // Show Confirmation then Book
                    setTimeout(() => {
                        if (stageConfirmation) {
                            stageConfirmation.style.opacity = "0";
                            setTimeout(() => {
                                stageConfirmation.classList.add("hidden");
                                if (stageBook) {
                                    stageBook.classList.remove("hidden");
                                    void stageBook.offsetWidth;
                                    stageBook.classList.remove("opacity-0");

                                    const initEvent = new CustomEvent("init-life-book", {
                                        detail: { year, month },
                                    });
                                    document.dispatchEvent(initEvent);
                                }
                            }, 1000);
                        }
                    }, 8000);
                };

                // Clean up and attach global listeners
                // Since 'document' persists, we MUST remove old listeners to avoid duplicates/stacking
                if (window._handleYearSelected) {
                    document.removeEventListener("year-selected", window._handleYearSelected);
                }
                window._handleYearSelected = handleYearSelected;
                document.addEventListener("year-selected", handleYearSelected);

                if (window._handleBirthdateSelected) {
                    document.removeEventListener(
                        "birthdate-selected",
                        window._handleBirthdateSelected
                    );
                }
                window._handleBirthdateSelected = handleBirthdateSelected;
                document.addEventListener("birthdate-selected", handleBirthdateSelected);
            }
        });
    </script>

    <style is:global>
        body {
            background-color: #0c0a09;
        }

        /* Custom Scrollbar for the book pages */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1c1917;
        }
        ::-webkit-scrollbar-thumb {
            background: #44403c;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #57534e;
        }
    </style>
</Layout>
