---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="biblioteca de vida | jjlmoya">
    <div class="min-h-screen bg-[#f4f1ea] text-[#4a4a4a] font-serif p-8">
        <div class="max-w-4xl mx-auto">
            <header class="text-center mb-16">
                <h1
                    class="text-5xl md:text-7xl font-serif italic mb-4 text-[#2c2c2c]"
                >
                    La Biblioteca de tu Vida
                </h1>
                <p class="text-lg md:text-xl font-sans opacity-60">
                    Introduce tu fecha de nacimiento para generar tus volúmenes.
                </p>

                <div class="mt-12 flex flex-col items-center gap-8">
                    <div class="flex gap-4 items-end font-mono">
                        <div class="flex flex-col items-center group">
                            <label
                                class="text-xs uppercase opacity-50 mb-2 group-focus-within:text-blue-600 transition-colors"
                                >Mes</label
                            >
                            <select
                                id="month"
                                class="w-40 h-16 text-2xl bg-white rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] border-2 border-black focus:translate-y-1 focus:shadow-none outline-none text-center cursor-pointer appearance-none"
                            >
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                            </select>
                        </div>
                        <div class="flex flex-col items-center group">
                            <label
                                class="text-xs uppercase opacity-50 mb-2 group-focus-within:text-blue-600 transition-colors"
                                >Año</label
                            >
                            <select
                                id="year"
                                class="w-32 h-16 text-2xl bg-white rounded-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] border-2 border-black focus:translate-y-1 focus:shadow-none outline-none text-center cursor-pointer appearance-none"
                            >
                                <!-- Years injected by JS -->
                            </select>
                        </div>
                    </div>

                    <button
                        id="generate-btn"
                        class="bg-[#2c2c2c] text-[#f4f1ea] px-12 py-4 text-xl font-sans font-bold uppercase tracking-widest hover:bg-blue-600 hover:scale-105 transition-all shadow-lg rounded-full"
                        >Calcular Mi Vida</button
                    >
                </div>
            </header>

            <div id="library-container" class="hidden space-y-16">
                <!-- Shelf 1: Sleep -->
                <section class="shelf-section">
                    <h2
                        class="text-2xl font-sans uppercase tracking-widest mb-4 border-b border-[#dcd9d2] pb-2"
                    >
                        Sueño
                    </h2>
                    <div
                        class="shelf bg-[#e8e5de] p-8 shadow-inner rounded-sm flex flex-wrap gap-1 items-end min-h-[200px]"
                        id="shelf-sleep"
                    >
                        <!-- Books generated here -->
                    </div>
                    <p
                        class="mt-4 text-right font-sans text-sm opacity-50"
                        id="stat-sleep"
                    >
                        0 horas dormidas
                    </p>
                </section>

                <!-- Shelf 2: Water -->
                <section class="shelf-section">
                    <h2
                        class="text-2xl font-sans uppercase tracking-widest mb-4 border-b border-[#dcd9d2] pb-2"
                    >
                        Hidratación
                    </h2>
                    <div
                        class="shelf bg-[#e8e5de] p-8 shadow-inner rounded-sm flex flex-wrap gap-2 items-end min-h-[200px]"
                        id="shelf-water"
                    >
                        <!-- Bottles generated here -->
                    </div>
                    <p
                        class="mt-4 text-right font-sans text-sm opacity-50"
                        id="stat-water"
                    >
                        0 litros bebidos
                    </p>
                </section>

                <!-- Shelf 3: Steps -->
                <section class="shelf-section">
                    <h2
                        class="text-2xl font-sans uppercase tracking-widest mb-4 border-b border-[#dcd9d2] pb-2 flex justify-between items-center"
                    >
                        <span>Pasos</span>
                        <span
                            class="text-sm opacity-50 normal-case font-serif italic"
                            >~7,500/día</span
                        >
                    </h2>
                    <div
                        class="shelf bg-[#e8e5de] p-8 shadow-inner rounded-sm flex flex-wrap gap-1 items-end min-h-[150px] overflow-hidden relative"
                        id="shelf-steps"
                    >
                        <!-- Footprints generated here -->
                    </div>
                    <p
                        class="mt-4 text-right font-sans text-sm opacity-50"
                        id="stat-steps"
                    >
                        0 pasos caminados
                    </p>
                </section>

                <!-- Shelf 4: Breaths -->
                <section class="shelf-section">
                    <h2
                        class="text-2xl font-sans uppercase tracking-widest mb-4 border-b border-[#dcd9d2] pb-2 flex justify-between items-center"
                    >
                        <span>Respiraciones</span>
                        <span
                            class="text-sm opacity-50 normal-case font-serif italic"
                            >~20,000/día</span
                        >
                    </h2>
                    <div
                        class="shelf bg-[#e8e5de] p-8 shadow-inner rounded-sm flex flex-wrap gap-2 items-end min-h-[150px]"
                        id="shelf-breaths"
                    >
                        <!-- Clouds generated here -->
                    </div>
                    <p
                        class="mt-4 text-right font-sans text-sm opacity-50"
                        id="stat-breaths"
                    >
                        0 respiraciones tomadas
                    </p>
                </section>

                <!-- Shelf 5: Heartbeats (Featured) -->
                <section class="shelf-section col-span-full">
                    <h2
                        class="text-2xl font-sans uppercase tracking-widest mb-4 border-b border-[#dcd9d2] pb-2"
                    >
                        Latidos
                    </h2>
                    <div
                        class="shelf bg-[#e8e5de] p-12 shadow-inner rounded-sm flex flex-col items-center justify-center min-h-[300px] relative overflow-hidden"
                    >
                        <div
                            class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none"
                        >
                            <svg
                                viewBox="0 0 24 24"
                                class="w-[500px] h-[500px] text-red-500 fill-current"
                                ><path
                                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                                ></path></svg
                            >
                        </div>
                        <div
                            class="z-10 text-[10vw] md:text-8xl font-black text-[#2c2c2c] tracking-tighter break-all text-center leading-none"
                            id="heartbeat-counter"
                        >
                            0
                        </div>
                        <div class="text-xl font-serif italic opacity-60 mt-4">
                            Latidos totales estimados
                        </div>

                        <div class="absolute bottom-4 right-4 animate-beat">
                            <svg
                                viewBox="0 0 24 24"
                                class="w-12 h-12 text-red-600 fill-current"
                                ><path
                                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                                ></path></svg
                            >
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { differenceInDays, differenceInHours } from "date-fns";

    const monthInput = document.getElementById("month") as HTMLSelectElement;
    const yearInput = document.getElementById("year") as HTMLSelectElement;

    const generateBtn = document.getElementById("generate-btn");
    const libraryContainer = document.getElementById("library-container");

    const shelfSleep = document.getElementById("shelf-sleep");
    const statSleep = document.getElementById("stat-sleep");

    const shelfWater = document.getElementById("shelf-water");
    const statWater = document.getElementById("stat-water");

    const shelfSteps = document.getElementById("shelf-steps");
    const statSteps = document.getElementById("stat-steps");

    const shelfBreaths = document.getElementById("shelf-breaths");
    const statBreaths = document.getElementById("stat-breaths");

    const heartbeatCounter = document.getElementById("heartbeat-counter");

    // Populate years
    const currentYear = new Date().getFullYear();
    if (yearInput) {
        for (let i = currentYear; i >= 1900; i--) {
            const option = document.createElement("option");
            option.value = i.toString();
            option.text = i.toString();
            yearInput.appendChild(option);
        }
        // Set default to 2000
        yearInput.value = "2000";
    }

    const generateLibrary = () => {
        const m = parseInt(monthInput.value);
        const y = parseInt(yearInput.value);

        // Assume 1st day of month
        const birthdate = new Date(y, m, 1);
        if (isNaN(birthdate.getTime())) return; // Invalid date

        const now = new Date();

        if (birthdate > now) {
            if (libraryContainer) {
                libraryContainer.classList.remove("hidden");
                libraryContainer.innerHTML = `
                    <div class="text-center py-20">
                        <h2 class="text-4xl font-serif italic text-[#2c2c2c] mb-4">Ojalá vivas una gran vida ✨</h2>
                        <p class="text-xl opacity-60">El futuro está por escribir.</p>
                    </div>
                 `;
            }
            return;
        }

        const daysAlive = differenceInDays(now, birthdate);
        const hoursAlive = differenceInHours(now, birthdate);

        if (!libraryContainer) return;
        libraryContainer.classList.remove("hidden");
        // Reset container content in case it was overwritten by future message
        if (!document.getElementById("shelf-sleep")) {
            // Reload page to restore structure if needed, or better, just re-inject structure.
            // For simplicity, we'll just reload if structure is missing, but ideally we should preserve it.
            // Actually, let's just hide the future message and show the original structure if it exists.
            // Since we overwrote innerHTML, we need to restore it.
            // A better approach is to have a separate message container.
            window.location.reload();
            return;
        }

        // 1. Sleep Shelf
        // Avg 8 hours/day = 1/3 of life
        const hoursSlept = Math.floor(hoursAlive / 3);
        const booksCount = Math.min(100, Math.floor(hoursSlept / 1000)); // 1 book = 1000 hours

        let sleepHtml = "";
        const colors = [
            "bg-[#4a6fa5]",
            "bg-[#3e5c8a]",
            "bg-[#2d456b]",
            "bg-[#1f304a]",
        ];

        for (let i = 0; i < booksCount; i++) {
            const height = 40 + Math.random() * 60;
            const color = colors[Math.floor(Math.random() * colors.length)];
            sleepHtml += `<div class="${color} w-5 rounded-sm mx-[1px] shadow-sm hover:-translate-y-2 transition-transform cursor-pointer border-l border-white/10 border-r border-black/20" style="height: ${height}px;" title="Volumen ${i + 1}: 1000 horas de sueños"></div>`;
        }
        if (shelfSleep) shelfSleep.innerHTML = sleepHtml;
        if (statSleep)
            statSleep.innerText = `${hoursSlept.toLocaleString()} horas dormidas (${daysAlive} días vividos)`;

        // 2. Water Shelf
        // Avg 2 liters/day
        const litersDrunk = daysAlive * 2;
        const bottlesCount = Math.min(80, Math.floor(litersDrunk / 500)); // 1 bottle icon = 500 liters

        let waterHtml = "";
        const dropSvg = `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-blue-500"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`;

        for (let i = 0; i < bottlesCount; i++) {
            waterHtml += `<div class="hover:scale-125 transition-transform cursor-help" title="500 Litros">${dropSvg}</div>`;
        }
        if (shelfWater) shelfWater.innerHTML = waterHtml;
        if (statWater)
            statWater.innerText = `${litersDrunk.toLocaleString()} litros de agua consumidos`;

        // 3. Steps Shelf
        // Logic:
        // 0-1 year: 0 steps
        // 1-12 years: 12,000 steps (high activity)
        // 12-30 years: 10,000 steps
        // 30-60 years: 7,000 steps
        // 60+ years: 4,000 steps

        let remainingDays = daysAlive;
        let stepsTaken = 0;

        // Stage 1: Infant (0-1) - 1 year
        const daysInfant = Math.min(remainingDays, 365);
        stepsTaken += daysInfant * 0;
        remainingDays -= daysInfant;

        // Stage 2: Child (1-12) - 11 years
        if (remainingDays > 0) {
            const daysChild = Math.min(remainingDays, 11 * 365);
            stepsTaken += daysChild * 12000;
            remainingDays -= daysChild;
        }

        // Stage 3: Young (12-30) - 18 years
        if (remainingDays > 0) {
            const daysYoung = Math.min(remainingDays, 18 * 365);
            stepsTaken += daysYoung * 10000;
            remainingDays -= daysYoung;
        }

        // Stage 4: Adult (30-60) - 30 years
        if (remainingDays > 0) {
            const daysAdult = Math.min(remainingDays, 30 * 365);
            stepsTaken += daysAdult * 7000;
            remainingDays -= daysAdult;
        }

        // Stage 5: Senior (60+) - Remaining
        if (remainingDays > 0) {
            stepsTaken += remainingDays * 4000;
        }

        const stepsCount = Math.min(100, Math.floor(stepsTaken / 250000)); // 1 icon = 250k steps

        let stepsHtml = "";
        // Clearer shoe print icon
        const footSvg = `<svg viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-orange-800 opacity-60"><path d="M13.5,5.5c1.1,0,2-0.9,2-2s-0.9-2-2-2s-2,0.9-2,2S12.4,5.5,13.5,5.5z M13.5,6.5c-2.2,0-4,1.8-4,4v6c0,2.2,1.8,4,4,4s4-1.8,4-4v-6C17.5,8.3,15.7,6.5,13.5,6.5z"/></svg>`;

        for (let i = 0; i < stepsCount; i++) {
            stepsHtml += `<div class="hover:scale-125 transition-transform cursor-help" title="250.000 Pasos">${footSvg}</div>`;
        }
        if (shelfSteps) shelfSteps.innerHTML = stepsHtml;
        if (statSteps)
            statSteps.innerText = `${stepsTaken.toLocaleString()} pasos caminados`;

        // 4. Breaths Shelf
        // Avg 20,000 breaths/day
        const breathsTaken = daysAlive * 20000;
        const breathsCount = Math.min(120, Math.floor(breathsTaken / 500000)); // 1 icon = 500k breaths

        let breathsHtml = "";
        const cloudSvg = `<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-sky-300 opacity-80"><path d="M17.5,19C19.97,19 22,16.97 22,14.5C22,12.12 20.18,10.17 17.85,10.04C17.46,6.86 14.75,4.5 11.5,4.5C8.13,4.5 5.27,7.05 5.03,10.43C2.72,10.9 1,12.95 1,15.5C1,18.53 3.47,21 6.5,21H17.5V19Z"/></svg>`;

        for (let i = 0; i < breathsCount; i++) {
            breathsHtml += `<div class="hover:scale-125 transition-transform cursor-help animate-pulse" style="animation-duration: ${2 + Math.random()}s" title="500.000 Respiraciones">${cloudSvg}</div>`;
        }
        if (shelfBreaths) shelfBreaths.innerHTML = breathsHtml;

        // 5. Heartbeats
        // Avg 80 bpm * 60 * 24 = ~115,200 per day
        let totalHeartbeats = daysAlive * 115200;
        let totalBreaths = breathsTaken;

        // Animate counter initially
        let currentHeart = 0;
        const step = totalHeartbeats / 100;

        // Clear any existing intervals if re-generating
        if ((window as any).heartInterval)
            clearInterval((window as any).heartInterval);
        if ((window as any).liveInterval)
            clearInterval((window as any).liveInterval);

        const animationInterval = setInterval(() => {
            currentHeart += step;
            if (currentHeart >= totalHeartbeats) {
                currentHeart = totalHeartbeats;
                clearInterval(animationInterval);

                // Start real-time updates after initial animation
                startLiveUpdates(totalHeartbeats, totalBreaths);
            }
            if (heartbeatCounter)
                heartbeatCounter.innerText =
                    Math.floor(currentHeart).toLocaleString();
            if (statBreaths)
                statBreaths.innerText = `${Math.floor(totalBreaths).toLocaleString()} respiraciones tomadas`;
        }, 20);

        (window as any).heartInterval = animationInterval;
    };

    const startLiveUpdates = (
        startHeartbeats: number,
        startBreaths: number,
    ) => {
        let currentH = startHeartbeats;
        let currentB = startBreaths;

        // Heart rate: ~80 bpm => ~1.33 bps => update every 750ms
        // Breath rate: ~15 bpm => ~0.25 bps => update every 4000ms

        // We'll update the display every 100ms for smoothness, adding fractional amounts
        const heartRatePerMs = 80 / 60 / 1000;
        const breathRatePerMs = 20 / 60 / 1000; // ~20k/day is ~14/min

        let lastTime = Date.now();

        const liveInterval = setInterval(() => {
            const now = Date.now();
            const delta = now - lastTime;
            lastTime = now;

            currentH += heartRatePerMs * delta;
            currentB += breathRatePerMs * delta;

            if (heartbeatCounter)
                heartbeatCounter.innerText =
                    Math.floor(currentH).toLocaleString();
            if (statBreaths)
                statBreaths.innerText = `${Math.floor(currentB).toLocaleString()} respiraciones tomadas`;
        }, 100); // Update UI every 100ms

        (window as any).liveInterval = liveInterval;
    };

    generateBtn?.addEventListener("click", generateLibrary);
</script>

<style>
    .shelf {
        box-shadow: inset 0 10px 20px rgba(0, 0, 0, 0.05);
        border-bottom: 12px solid #dcd9d2;
    }

    @keyframes beat {
        0%,
        100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.1);
        }
    }
    .animate-beat {
        animation: beat 0.8s infinite ease-in-out;
    }
</style>
