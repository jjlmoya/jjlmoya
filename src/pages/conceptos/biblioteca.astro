---
import Layout from "../../layouts/Layout.astro";
import DeathDialogue from "../../components/pages/biblioteca/DeathDialogue.astro";
import DeathInput from "../../components/pages/biblioteca/DeathInput.astro";
import LifeBook from "../../components/pages/biblioteca/LifeBook.astro";
---

<Layout
    title="La Biblioteca de la Muerte - El libro de tu vida"
    description="Tu vida es un libro en la inmensa biblioteca del tiempo. Deja que ELLA te lo muestre."
    fullWidth={true}
    footerClass="bg-black text-white"
    image="/images/biblioteca_og_scythe.webp"
>
    <!-- Google Fonts for Pratchett Vibe -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&display=swap"
        rel="stylesheet"
    />

    <main
        class="min-h-screen bg-[#0c0a09] text-[#e7e5e4] overflow-hidden relative flex flex-col items-center justify-center p-4"
    >
        <div class="absolute inset-0 pointer-events-none opacity-20"></div>

        <div id="stage-intro" class="z-10 w-full max-w-4xl transition-opacity duration-1000">
            <div id="intro-initial" class="transition-opacity duration-1000">
                <DeathDialogue
                    text="DISCULPAD LA MOLESTIA. HAY DEMASIADOS LIBROS AQU√ç Y PARECE QUE CADA VEZ SOIS M√ÅS. NECESITO AYUDA PARA LOCALIZAR EL VUESTRO."
                    speed={150}
                    delay={400}
                    mode="word"
                />
            </div>
            <div id="intro-next" class="hidden transition-opacity duration-1000 opacity-0">
                <DeathDialogue
                    text="¬øEN QU√â A√ëO EMPEZASTEIS?"
                    speed={150}
                    delay={0}
                    autoStart={false}
                    mode="word"
                />
            </div>

            <div id="intro-month" class="hidden transition-opacity duration-1000 opacity-0">
                <DeathDialogue
                    text="COMPRENDO. NECESITO M√ÅS PRECISI√ìN. EL TIEMPO ES UN ASUNTO DELICADO Y LAS ESTANTER√çAS SON INFINITAS. <br><br> ¬øY EL MES?"
                    speed={150}
                    autoStart={false}
                    mode="word"
                />
            </div>

            <DeathInput />
        </div>

        <!-- STAGE 2: CONFIRMATION -->
        <div
            id="stage-confirmation"
            class="hidden z-10 w-full max-w-4xl transition-opacity duration-1000"
        >
            <DeathDialogue
                text="AH, S√ç. AQU√ç EST√Å. <br><br> VAYA... ES UN TOMO M√ÅS PESADO DE LO QUE ESPERABA. <br><br> VEAMOS QU√â DICE."
                speed={150}
                delay={500}
                mode="word"
            />
        </div>

        <!-- STAGE 3: THE BOOK -->
        <div
            id="stage-book"
            class="hidden z-10 w-full h-screen absolute inset-0 transition-opacity duration-1000 opacity-0"
        >
            <LifeBook />
        </div>

        <!-- Death of Rats Easter Egg -->
        <div
            id="death-of-rats"
            class="fixed bottom-4 right-8 z-50 text-xl cursor-pointer hover:scale-125 transition-transform duration-200 select-none opacity-50 hover:opacity-100"
            title="¬°IIIIK!"
        >
            üêÄ
        </div>
    </main>

    <script>
        const rat = document.getElementById("death-of-rats");
        rat?.addEventListener("click", () => {
            if ((window as any).toast) {
                (window as any).toast.show("¬°IIIIK!", "info");
            }
        });
    </script>
</Layout>

<script>
    // State Management
    const stageIntro = document.getElementById("stage-intro");
    const introInitial = document.getElementById("intro-initial");
    const introNext = document.getElementById("intro-next");
    const introMonth = document.getElementById("intro-month");
    const stageConfirmation = document.getElementById("stage-confirmation");
    const stageBook = document.getElementById("stage-book");

    // Check for existing session
    const storedData = localStorage.getItem("life-birthdate");
    let hasSkippedIntro = false;

    if (storedData) {
        try {
            const { year, month } = JSON.parse(storedData);
            if (year && month !== undefined) {
                hasSkippedIntro = true;
                // Skip directly to book
                if (stageIntro) stageIntro.classList.add("hidden");
                if (stageConfirmation) stageConfirmation.classList.add("hidden");

                if (stageBook) {
                    stageBook.classList.remove("hidden");
                    stageBook.classList.remove("opacity-0");

                    // Small delay to ensure components are ready
                    setTimeout(() => {
                        const initEvent = new CustomEvent("init-life-book", {
                            detail: { year, month },
                        });
                        document.dispatchEvent(initEvent);
                    }, 100);
                }
            }
        } catch (e) {
            console.error("Error parsing stored birthdate", e);
        }
    }

    // Sequence Logic (Only if not skipped)
    if (!hasSkippedIntro) {
        const firstDialogue = document.querySelector("#intro-initial .death-dialogue-container");
        const nextDialogue = document.querySelector("#intro-next .death-dialogue-container");
        const monthDialogue = document.querySelector("#intro-month .death-dialogue-container");

        // 1. After first sentence, wait, then ask for year
        firstDialogue?.addEventListener("dialogue-complete", () => {
            // Wait for user to read
            setTimeout(() => {
                if (introInitial) introInitial.style.opacity = "0";

                setTimeout(() => {
                    if (introInitial) introInitial.classList.add("hidden");
                    if (introNext) {
                        introNext.classList.remove("hidden");
                        void introNext.offsetWidth;
                        introNext.classList.remove("opacity-0");

                        setTimeout(() => {
                            nextDialogue?.dispatchEvent(new Event("start-typing"));
                        }, 500);
                    }
                }, 1000);
            }, 5000);
        });

        // 2. Show year input after question
        nextDialogue?.addEventListener("dialogue-complete", () => {
            setTimeout(() => {
                const event = new Event("show-death-year-input");
                document.dispatchEvent(event);
            }, 500);
        });

        // 3. Show month input after question
        monthDialogue?.addEventListener("dialogue-complete", () => {
            setTimeout(() => {
                const event = new Event("show-death-month-input");
                document.dispatchEvent(event);
            }, 500);
        });

        document.addEventListener("year-selected", () => {
            if (introNext) introNext.style.opacity = "0";

            setTimeout(() => {
                if (introNext) introNext.classList.add("hidden");

                if (introMonth) {
                    introMonth.classList.remove("hidden");
                    void introMonth.offsetWidth;
                    introMonth.classList.remove("opacity-0");

                    setTimeout(() => {
                        monthDialogue?.dispatchEvent(new Event("start-typing"));
                    }, 500);
                }
            }, 1000);
        });
    }

    document.addEventListener("birthdate-selected", (e: any) => {
        const { year, month } = e.detail;

        window.localStorage.setItem("life-birthdate", JSON.stringify({ year, month }));

        if (stageIntro) {
            stageIntro.style.opacity = "0";
            setTimeout(() => {
                stageIntro.classList.add("hidden");

                if (stageConfirmation) {
                    stageConfirmation.classList.remove("hidden");
                }
            }, 1000);
        }

        setTimeout(() => {
            if (stageConfirmation) {
                stageConfirmation.style.opacity = "0";
                setTimeout(() => {
                    stageConfirmation.classList.add("hidden");

                    if (stageBook) {
                        stageBook.classList.remove("hidden");
                        void stageBook.offsetWidth;
                        stageBook.classList.remove("opacity-0");

                        const initEvent = new CustomEvent("init-life-book", {
                            detail: { year, month },
                        });
                        document.dispatchEvent(initEvent);
                    }
                }, 1000);
            }
        }, 8000); // Time for "Ahh, ya te veo..."
    });
</script>

<style is:global>
    body {
        background-color: #0c0a09;
    }

    /* Custom Scrollbar for the book pages */
    ::-webkit-scrollbar {
        width: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #1c1917;
    }
    ::-webkit-scrollbar-thumb {
        background: #44403c;
        border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #57534e;
    }
</style>
